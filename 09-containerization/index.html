<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
<title>Containerisation and Orchestration</title>
<meta name="description" content="Practical introduction to Containerisation and Orchestration with Docker">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="/reveal-js/dist/reset.css">
<link rel="stylesheet" href="/reveal-js/dist/reveal.css">
  <link rel="stylesheet" href="/css/custom-theme.min.f2c7adbc4e1966516650f994979920854f1f6804d229d73c7cb5f507ac9e61f7.css" id="theme"><link rel="stylesheet" href="/highlight-js/default.min.css">
<link rel="stylesheet" href="https://raw.githubusercontent.com/DanySK/css-blur-animation/master/blur.css">
<link href="https://fonts.googleapis.com/css?family=Roboto Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Oxygen Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Ubuntu Mono" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<script src="https://unibo-spe.github.io//plantuml.js"></script>

  </head>
  <body>
    
    <div class="reveal">
      <div class="slides">
  

    <section><style>
.reveal blockquote {
    font-family: 'Georgia';
}
.reveal blockquote::before{
    content: "";
}
.reveal blockquote::after{
    content: "";
}
</style>
<h1 id="containerisation-and-orchestration">Containerisation and Orchestration</h1>
<h2 id="hahahugoshortcode1s0hbhb">Software Process Engineering</h2>
<br>
<h3 id="giovanni-ciatto-----giovanniciattouniboitmailtogiovanniciattouniboit"><a href="mailto:giovanni.ciatto@unibo.it">Giovanni Ciatto — <code>giovanni.ciatto@unibo.it</code></a></h3>
<br>
<p>Compiled on: 2024-12-21
 — <a href="?print-pdf&amp;pdfSeparateFragments=false"><i class="fa fa-print" aria-hidden="true"></i> printable version</a></p>
<p><a href=".."><i class="fa fa-undo" aria-hidden="true"></i> back</a></p>
</section><section>
<h2 id="preliminaries">Preliminaries</h2>
<blockquote>
<p>[Software] <strong>Deployment</strong> $:=$ all of the activities that make a software system available for use</p>
</blockquote>
<ul>
<li><a href="https://www.mlsu.ac.in/econtents/16_EBOOK-7th_ed_software_engineering_a_practitioners_approach_by_roger_s._pressman_.pdf"><em>Software Engineering: A Practitioner’s Approach</em>, Roger S. Pressman</a></li>
</ul>
<br>
<h3 id="general-need-in-software-engineering">General need in Software Engineering</h3>
<p>To govern the <em>deployment</em> of <strong>software systems</strong> onto some <strong>infrastructure</strong></p>
<ul>
<li>
<p><strong>software system</strong>: multiple interacting software <em>components</em>, each one having its <em>computational requirements</em></p>
<ul>
<li>component $\approx$ process</li>
</ul>
</li>
<li>
<p><strong>infrastructure</strong>: the available <em>hardware</em> and <em>software</em> <strong>substratum</strong> supporting the execution of software components</p>
<ul>
<li>hardware $\approx$ CPU, memory, storage, network</li>
<li>software $\approx$ operating system, drivers, runtimes, libraries</li>
</ul>
</li>
<li>
<p><strong>deployment</strong>: orderly <em>instantiating</em> software components onto the infrastructure, while</p>
<ul>
<li><em>satisfying</em> the computational <em>requirements</em> of each component</li>
<li><em>optimising</em> the <em>exploitation</em> of the infrastructural facilities</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="what-to-deploy-pt-1">What to deploy? (pt. 1)</h2>
<ul>
<li>
<p><strong>Short-lived tasks</strong> (a.k.a. <strong>jobs</strong>): tasks which eventually terminate</p>
<ul>
<li>e.g. data processing or generation tasks</li>
<li>e.g. simulations</li>
</ul>
</li>
<li>
<p><strong>Long-lived tasks</strong> (a.k.a. <strong>services</strong>) tasks which run indefinitely</p>
<ul>
<li>e.g. web servers</li>
<li>e.g. databases</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="what-to-deploy-pt-2">What to deploy? (pt. 2)</h2>
<h3 id="short-lived-tasks">Short-lived tasks</h3>
<blockquote>
<p><strong>Short-lived</strong> tasks are bare computational activities aimed at <strong>processing/generating</strong> some data</p>
</blockquote>
<ul>
<li>
<p>Pure <strong>algorithms</strong> <em>accepting data</em> as input and/or <em>producing data</em> as output.</p>
</li>
<li>
<p>They will eventually reach their natural <strong>termination</strong></p>
<ul>
<li><em>without</em> requiring external <em>intervention</em></li>
</ul>
</li>
<li>
<p>Common workflow:</p>
<ol>
<li>users <em>provide</em> the <em>code</em> and the <em>input</em> data,</li>
<li>they <em>start</em> the task,</li>
<li>they are interested in <em>getting the output</em> data</li>
</ol>
</li>
<li>
<p><strong>Parallelism</strong> may be exploited to <em>speed up</em> the computations</p>
</li>
</ul>
</section><section>
<h2 id="what-to-deploy-pt-3">What to deploy? (pt. 3)</h2>
<h3 id="long-lived-tasks">Long-lived tasks</h3>
<blockquote>
<p><strong>Long-lived</strong> are computational activities which are <strong>not meant to terminate</strong> automatically (unless <em>explicitly stopped</em>)</p>
</blockquote>
<ul>
<li>
<p>Infinite <em>loops</em>, just <em>waiting</em> for <em>requests</em>, and <em>serving</em> them as soon as possible</p>
</li>
<li>
<p><strong>Interactivity</strong> is a key aspect:</p>
<ul>
<li><strong>clients</strong> <em>interact</em> with the service,</li>
<li>the service <strong>reacts</strong> to the clients’ requests</li>
<li>clients may be <em>humans</em> or <em>other software</em> components</li>
</ul>
</li>
<li>
<p>Common workflow:</p>
<ul>
<li>users <em>provide</em> the <em>code</em> and some <em>deployment-automation</em> script</li>
<li>they <em>start</em> the task,</li>
<li>they are interested in <em>interacting</em> with the service
<ul>
<li>e.g. via the shell, via some GUI, via the browser, etc.</li>
</ul>
</li>
</ul>
</li>
<li>
<p><strong>Parallelism</strong> may be exploited to support <strong>replication</strong></p>
<ul>
<li>e.g. for <strong>fault tolerance</strong></li>
<li>e.g. for <strong>load balancing</strong></li>
<li>e.g. for <strong>scaling</strong></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="execution-context-of-a-computational-task">Execution context of a computational task</h2>
<p>Regardless of their life-span, computational tasks may require <strong>computational resources</strong> of various sorts:</p>
<ul>
<li>
<p>specific <strong>hardware capabilities</strong></p>
<ul>
<li>e.g. quick / multi-core CPUs for computation intensive tasks</li>
<li>e.g. GPUs for tasks requiring parallelism</li>
<li>e.g. primary memory (RAM)</li>
<li>e.g. large / quick storage (SSD, HDD, etc.)</li>
<li>e.g. quick networks connection (e.g. optical fiber)</li>
</ul>
</li>
<li>
<p>specific <strong>operative systems</strong> (Linux, MacOS, Windows, etc.) or specific <strong>architectures</strong> (x86, ARM, etc.)</p>
</li>
<li>
<p>specific <strong>runtime platforms</strong> (e.g. JVM, Python, .NET etc.)</p>
</li>
<li>
<p>specific <strong>infrastructural components</strong> (e.g. database, reverse proxy, load-balancer, broker, etc.)</p>
</li>
<li>
<p>specific <strong>libraries</strong> (e.g. CUDA, <code>numpy</code>, etc.)</p>
</li>
</ul>
</section><section>
<h2 id="the-need-for-encapsulation-pt-1">The need for encapsulation (pt. 1)</h2>
<!-- > __Encapsulation__ is the __hiding__ of the __implementation details__ of a __component__ from its __clients__.
> Encapsulated components have a clear __interface__ which is the only way to interact with them. -->
<blockquote>
<p>Why can’t we simply configure bare-metal machines to host our tasks?</p>
</blockquote>
<ul>
<li>
<p>Need for <strong>multi-tenancy</strong> (i.e. sharing) on computational resources</p>
<ol>
<li>one may have <em>$N$ machines</em> and <em>$M$ applications</em>…
<ul>
<li>… and be willing to <strong>decouple</strong> applications from machines</li>
</ul>
</li>
<li>different software components may have <strong>incompatible</strong> HW / SW requirements</li>
</ol>
</li>
<li>
<p>Need for <strong>isolation</strong></p>
<ul>
<li>preventing <em>spurious interactions</em> among different tenants</li>
<li>a common requirement in multi-tenant scenarios</li>
</ul>
</li>
<li>
<p>Need to <strong>formalize / control / reproduce</strong> the <em>computational environment</em> of applications</p>
<ul>
<li>formalisation is a <em>pre-requisite</em> for <strong>automation</strong></li>
<li>automation <em>enables</em> <strong>control</strong> and <strong>scale</strong></li>
</ul>
</li>
<li>
<p>Need to <strong>automate deployment</strong> of applications into <strong>production</strong> / <strong>testing</strong> environments</p>
<ul>
<li>this is the immediate <em>benefit for engineers</em></li>
</ul>
</li>
<li>
<p>Need for <strong>flexibility</strong> (in <em>re-deployment</em>), and <strong>scalability</strong></p>
<ul>
<li><em>effort minimisation</em> for application <strong>startup</strong> or <strong>transfer</strong></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="the-need-for-encapsulation-pt-2">The need for encapsulation (pt. 2)</h2>
<p>Some abstraction is needed to encapsulate applications, and their computational environment, into a single unit</p>
<blockquote>
<p><strong>Encapsulation</strong> is the <strong>hiding</strong> of the <strong>implementation details</strong> of a <strong>component</strong> from its <strong>clients</strong>.
Encapsulated components have a clear <strong>interface</strong> which is the only way to interact with them.</p>
</blockquote>
</section><section>
<h2 id="how-to-achieve-encapsulation-pt-1">How to achieve encapsulation? (pt. 1)</h2>
<ul>
<li>
<p><strong>Virtual machines</strong> (VM) on top of VM <em>hypervisors</em> (VMH)</p>
</li>
<li>
<p><strong>Containers</strong> on top of container <em>engines</em> (CE)</p>
</li>
</ul>
</section><section>
<h2 id="how-to-achieve-encapsulation-pt-2">How to achieve encapsulation? (pt. 2)</h2>
<h3 id="virtual-machines-and-hypervisors-vmh">Virtual machines and hypervisors (VMH)</h3>
<ul>
<li>
<p>VMH run <em>on/as</em> the <em>OS</em> of a bare-metal machine, <strong>abstracting</strong> HW and SW peculiarities away</p>
<ul>
<li>VM have <em>virtualised HW</em> and SW resources, different from the host’s ones</li>
</ul>
</li>
<li>
<p>VMH may instantiate <strong>multiple VM</strong> on the <em>same physical machine</em></p>
<ul>
<li>partitioning actual resources ahead of time</li>
</ul>
</li>
<li>
<p>each VM runs <strong>its own OS</strong>, and may host multiple applications</p>
<ul>
<li>in the eyes of the user, the VM is <em>undistinguishable</em> from a bare-metal machine</li>
</ul>
</li>
<li>
<p>VM may be <em>paused</em>, <em>snapshot</em> (into file), <em>resumed</em>, and possibly <em>migrated</em></p>
<ul>
<li>snapshots are files containing the whole file-system of the VM</li>
</ul>
</li>
<li>
<p>VM are <strong>coarse</strong>-grained <strong>encapsulation</strong> units</p>
<ul>
<li>they are <em>heavy</em>-weight (GBs)</li>
<li>they are <em>slow</em> to start, run, migrate, snapshot</li>
<li>VM commonly encapsulate <em>multiple application</em>-level components
<ul>
<li>database, server, plus all their runtimes and libraries, etc.</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Many industry-ready <strong>technologies</strong>:</p>
<ul>
<li>VMWare, VirtualBox, KVM, Xen, Hyper-V, QEMU, Proxmox, etc.</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="how-to-achieve-encapsulation-pt-3">How to achieve encapsulation? (pt. 3)</h2>
<h3 id="containers-and-container-engines-ce">Containers and container engines (CE)</h3>
<ul>
<li>
<p>CE run <em>on</em> the <em>OS</em> of a <em>bare-metal/virtual</em> machine, <strong>abstracting</strong> the runtime, storage, and network environment away</p>
<ul>
<li>the CPU, memory, OS kernel, drivers, and hardware are <strong>not virtualised</strong></li>
</ul>
</li>
<li>
<p>one may instantiate <strong>multiple containers</strong> on the same machine</p>
<ul>
<li>sharing the actual resources dynamically (<em>overbooking</em> support)</li>
</ul>
</li>
<li>
<p>each container <strong>shares the OS kernel</strong> of the host, yet having its own runtime(s), storage, and network facilities</p>
<ul>
<li>in the eyes of the user, the container is a <em>process</em> running on top of a <em>minimal OS</em></li>
</ul>
</li>
<li>
<p>each container is <em>instance</em> of an <strong>image</strong>, i.e. a <em>read-only template</em> containing deployment instructions</p>
<ul>
<li>differences w.r.t. that image constitute the <em>state of the container</em> (these can be <em>snapshot</em> into file of minimal size)</li>
</ul>
</li>
<li>
<p>containers are <strong>fine</strong>-grained <strong>encapsulation</strong> units</p>
<ul>
<li>they are <em>light</em>-weight (MBs)</li>
<li>they are <em>fast</em> to start, run, snapshot</li>
<li>they are commonly used to encapsulate <em>single application</em>-level components
<ul>
<li>e.g. a database instance, a web-server instance, etc.</li>
<li>the final application should consist of <em>several</em>, inter-communicating <em>containers</em></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Many industry-ready <strong>technologies</strong>:</p>
<ul>
<li>Docker, LXC, LXD, Podman, etc.</li>
</ul>
</li>
</ul>
</section><section>
<!-- this file includes generated content. Do not edit. Edit content/09-containerization/_generator.md, instead. -->
<h2 id="bare-metal-vs-vms-vs-containers">Bare-metal vs. VMs vs. Containers</h2>


  


<figure>
  <img src="https://g.gravizo.com/svg?%0adigraph%20structs%20%7b%0arankdir%3dLR%0agraph%20%5bfontname%3d%22helvetica%22%2c%20layout%3dneato%5d%0aedge%20%5bfontname%3d%22helvetica%22%5d%0anode%20%5bfontname%3d%22helvetica%22%2c%20shape%3drecord%2c%20style%3d%22rounded%2c%20filled%22%2c%20fontcolor%3dwhite%2c%20fixedsize%3dtrue%2c%20width%3d3%5d%3b%0a%22Bare%20metal%22%20%5bshape%3dplaintext%2c%20style%3d%22%22%2c%20fontcolor%3dblack%20fontsize%3d20%2c%20pos%3d%220%2c0%21%22%2c%20layout%3dneato%5d%0aPhysical%20%5bfillcolor%3dblack%2c%20pos%3d%220%2c0.5%21%22%5d%0a%22Operating%20System%22%20%5bfillcolor%3dgray%2c%20pos%3d%220%2c1.1%21%22%5d%0aRuntime%20%5bfillcolor%3dgreen%2c%20pos%3d%220%2c1.7%21%22%5d%0aApp1%20%5bfillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%22-1.025%2c2.3%21%22%5d%0aApp2%20%5bfillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%220%2c2.3%21%22%5d%0aApp3%20%5bfillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%221.025%2c2.3%21%22%5d%0a%0a%20%20%20%20%22Virtual%20Machine%22%20%5bshape%3dplaintext%2c%20style%3d%22%22%2c%20fontcolor%3dblack%20fontsize%3d20%2c%20pos%3d%223.5%2c0%21%22%5d%0a%20%20%20%20VM_Phy%20%5blabel%3dPhysical%2c%20fillcolor%3dblack%2c%20pos%3d%223.5%2c0.5%21%22%5d%0a%20%20%20%20%22Host%20Operating%20System%22%20%5bfillcolor%3dgray%2c%20pos%3d%223.5%2c1.1%21%22%5d%0a%20%20%20%20Hypervisor%20%5bfillcolor%3dorange%2c%20pos%3d%223.5%2c1.7%21%22%2c%20fontcolor%3dblack%5d%0a%20%20%20%20GuestOS1%20%5bfillcolor%3dgray%2c%20width%3d0.95%2c%20pos%3d%222.475%2c2.3%21%22%5d%0a%20%20%20%20GuestOS2%20%5bfillcolor%3dgray%2c%20width%3d0.95%2c%20pos%3d%223.5%2c2.3%21%22%5d%0a%20%20%20%20GuestOS3%20%5bfillcolor%3dgray%2c%20width%3d0.95%2c%20pos%3d%224.525%2c2.3%21%22%5d%0a%20%20%20%20Runtime1%20%5bfillcolor%3dgreen%2c%20width%3d0.95%2c%20pos%3d%222.475%2c2.9%21%22%5d%0a%20%20%20%20Runtime2%20%5bfillcolor%3dgreen%2c%20width%3d0.95%2c%20pos%3d%223.5%2c2.9%21%22%5d%0a%20%20%20%20Runtime3%20%5bfillcolor%3dgreen%2c%20width%3d0.95%2c%20pos%3d%224.525%2c2.9%21%22%5d%0a%20%20%20%20VM_App1%20%5blabel%3dApp1%2c%20fillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%222.475%2c3.5%21%22%5d%0a%20%20%20%20VM_App2%20%5blabel%3dApp2%2c%20fillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%223.5%2c3.5%21%22%5d%0a%20%20%20%20VM_App3%20%5blabel%3dApp3%2c%20fillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%224.525%2c3.5%21%22%5d%0a%0a%20%20%20%20%22Container%22%20%5bshape%3dplaintext%2c%20style%3d%22%22%2c%20fontcolor%3dblack%20fontsize%3d20%2c%20pos%3d%227%2c0%21%22%5d%0a%20%20%20%20C_Phy%20%5blabel%3dPhysical%2c%20fillcolor%3dblack%2c%20pos%3d%227%2c0.5%21%22%5d%0a%20%20%20%20C_K%20%5blabel%3d%22Operating%20System%22%2c%20fillcolor%3dgray%2c%20pos%3d%227%2c1.1%21%22%5d%0a%20%20%20%20%22Container%20Service%22%20%5bfillcolor%3dblue%2c%20pos%3d%227%2c1.7%21%22%5d%0a%20%20%20%20C_Rt1%20%5blabel%3dRuntime1%2c%20fillcolor%3dgreen%2c%20width%3d0.95%2c%20pos%3d%225.975%2c2.3%21%22%5d%0a%20%20%20%20C_Rt2%20%5blabel%3dRuntime2%2c%20fillcolor%3dgreen%2c%20width%3d0.95%2c%20pos%3d%227%2c2.3%21%22%5d%0a%20%20%20%20C_Rt3%20%5blabel%3dRuntime3%2c%20fillcolor%3dgreen%2c%20width%3d0.95%2c%20pos%3d%228.025%2c2.3%21%22%5d%0a%20%20%20%20C_App1%20%5blabel%3dApp1%2c%20fillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%225.975%2c2.9%21%22%5d%0a%20%20%20%20C_App2%20%5blabel%3dApp2%2c%20fillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%227%2c2.9%21%22%5d%0a%20%20%20%20C_App3%20%5blabel%3dApp3%2c%20fillcolor%3dred%2c%20width%3d0.95%2c%20pos%3d%228.025%2c2.9%21%22%5d%0a%7d%0a" alt="">
    <figcaption></figcaption>
</figure>

<p>Containers provide <strong>runtime isolation</strong> <em>without</em> operating <strong>system replication</strong></p>
</section><section>
<h2 id="lightweight-virtual-machines">Lightweight virtual machines?</h2>
<p><img src="https://raw.githubusercontent.com/DanySK/shared-slides/6824b93d3d52b841386a744f57953a73ccb67378/containerization/lightweight-container.jpg" alt=""></p>
</section><section>
<h2 id="closer-to-confined-processes">Closer to confined processes</h2>
<p><img src="https://raw.githubusercontent.com/DanySK/shared-slides/6824b93d3d52b841386a744f57953a73ccb67378/containerization/chroot.jpeg" alt=""></p>
</section><section>
<h2 id="scaling-up-to-the-cluster-level">Scaling up to the cluster level</h2>
<blockquote>
<p><strong>Cluster</strong> $\approx$ a set of <em>similarly configured</em> <strong>machines</strong> (a.k.a. <strong>nodes</strong>) <strong>interconnected</strong> via a <strong>network</strong> in order to let users exploit their <strong>joint</strong> computational power</p>
</blockquote>
<ul>
<li>
<p>Users may want to <strong>deploy</strong> their applications on the <em>cluster</em></p>
<ul>
<li>by means of a <em>single access point</em>
<ul>
<li>e.g. a Web dashboard, or a CLI</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Deployment shall <strong>allocate</strong> tasks on the cluster <em>efficiently</em></p>
<ul>
<li>meeting the tasks’ <em>computational requirements</em></li>
<li><em>balancing</em> the <em>load</em> among the nodes</li>
<li><em>matching requirements</em> on actual capabilities of nodes</li>
</ul>
</li>
<li>
<p><strong>Infrastructure-as-a-service</strong> (IaaS) cloud technologies support deploying tasks on clusters, <em>as VM</em></p>
<ul>
<li>e.g. OpenStack, VSphere, etc.</li>
</ul>
</li>
<li>
<p><strong>Container orchestrators</strong> support deploying tasks on clusters, <em>as containers</em></p>
<ul>
<li>e.g. Kubernetes, Docker Swarm, etc.</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="why-containers-pt-1">Why containers? (pt. 1)</h2>

<div class="multiCol">
    

<div class="col  ">
    <p><img src="https://raw.githubusercontent.com/DanySK/shared-slides/6824b93d3d52b841386a744f57953a73ccb67378/containerization/works-on-my-machine.jpeg" alt=""></p>

</div>

<div class="col  ">
    <p><img src="https://raw.githubusercontent.com/DanySK/shared-slides/6824b93d3d52b841386a744f57953a73ccb67378/containerization/docker-born.jpeg" alt=""></p>

</div>

</div>

</section><section>
<h2 id="why-containers-pt-2">Why containers? (pt. 2)</h2>
<ul>
<li>more fine-grained encapsulation (than VM)</li>
<li>faster to start, stop, snapshot, migrate (w.r.t. VM)</li>
<li>more modular, more scalable (than VM)</li>
<li>useful for dev-ops, and CI/CD</li>
<li>most-likely, it’s the future of cloud computing</li>
</ul>
</section><section>
<h2 id="containerisation-vs-orchestration">Containerisation vs. Orchestration</h2>
<ul>
<li>
<p><strong>Containerisation</strong> $\approx$ the process of <em>encapsulating</em> an application into a <em>container</em></p>
</li>
<li>
<p><strong>Orchestration</strong> $\approx$ the process of <em>deploying</em> one or more container onto <em>one or more</em> machines</p>
</li>
<li>
<p><strong>Containerisation</strong> is a <em>pre-requisite</em> for <strong>orchestration</strong></p>
</li>
<li>
<p>Two syntaxes involved:</p>
<ul>
<li>one to <em>containerise</em> (i.e. create container images)</li>
<li>one to <em>orchestrate</em> (i.e. deploy containers)</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="main-abstractions">Main abstractions</h2>
<h3 id="encapsulation-level">Encapsulation level</h3>
<ul>
<li><strong>Container</strong>: a sandbox for running a process and its computational environment</li>
<li><strong>Image</strong>: a template for creating containers</li>
<li><strong>Layer</strong>: a single, cacheable, step in the creation of an image</li>
<li><strong>Host</strong>: the machine hosting the containers</li>
<li><strong>Registry</strong>: a repository of images (possibly external w.r.t. the host)</li>
<li><strong>Network</strong>: a virtual network for connecting containers (among each others and with the host)</li>
<li><strong>Volume</strong>: a bridge for letting containers share data with the host</li>
<li><strong>Engine</strong> (a.k.a. <strong>daemon</strong>): the software running on the host, managing containers, images, volumes, layers, and networks</li>
</ul>


<span class="fragment ">
  <h3 id="orchestration-level">Orchestration level</h3>
<ul>
<li><strong>Cluster</strong>: a set of machines, joint together by the same container orchestrator</li>
<li><strong>Node</strong>: a machine in the cluster (each one acting as a host, and running the container engine)</li>
<li><strong>Service</strong>: a set of replicas of the same container</li>
<li><strong>Stack</strong>: a set of inter-related services</li>
<li><strong>Secret</strong>: encrypted information to be made available on containers</li>
</ul>

</span>

</section><section>
<h2 id="about-technologies">About technologies</h2>
<p><strong>Docker</strong>: the most famous container technology, actually consisting of several components</p>
<ul>
<li><strong>Docker Engine</strong>: the container engine managing containers and images, locally</li>
<li><strong>Docker CLI</strong>: the command line interface for Docker Engine (this is what you use)</li>
<li><strong>Docker Desktop</strong>: a GUI for Docker Engine, mostly for inspection purposes</li>
<li><strong>Docker Hub</strong>: the default registry for Docker images, available online</li>
<li><strong>Docker Compose</strong>: a tool for orchestrating containers on a single machine</li>
<li><strong>Docker Swarm</strong>: a tool for orchestrating containers on a cluster of machines</li>
</ul>
<p><img src="./architecture.svg" alt=""></p>
</section><section>
<h2 id="configure-docker-locally">Configure Docker locally</h2>
<ol>
<li>Install Docker
<ul>
<li><a href="https://docs.docker.com/engine/install/">https://docs.docker.com/engine/install/</a></li>
<li>most commonly available on package managers</li>
</ul>
</li>
<li>[Linux only] Add your user to the <code>docker</code> group
<ul>
<li><code>sudo usermod -aG docker $USER</code></li>
<li>log out and log in again</li>
</ul>
</li>
<li>Enable and start the Docker service
<ul>
<li>on most Linux distributions <code>sudo systemctl enable docker; sudo systemctl start docker</code></li>
<li>on MacOS and Windows, start the Docker Desktop application</li>
</ul>
</li>
<li>Test your installation
<ul>
<li><code>docker run hello-world</code></li>
</ul>
</li>
<li>Explore admissible sub-commands with <code>docker --help</code>
<ul>
<li>general command structure <code>docker &lt;resource&gt; &lt;command&gt; &lt;options&gt; &lt;args&gt;</code>
<ul>
<li>sometimes, when it’s obvious, <code>&lt;resource&gt;</code> can be omitted</li>
</ul>
</li>
</ul>
</li>
</ol>
<br>
<blockquote>
<p>Subsequent examples work on Linux, but they should work on any platform</p>
<ul>
<li>provided that a <code>bash</code> or <code>zsh</code> shell is available</li>
</ul>
</blockquote>
</section><section>
<h2 id="running-containers">Running containers</h2>
<ol>
<li>Pull an image: <code>docker pull adoptopenjdk</code></li>
<li>Run a container: <code>docker run adoptopenjdk</code></li>
</ol>
<p>Every image provides a <em>default command</em>, running without options runs such default in a <em>non-interactive</em> terminal.</p>
<p>Running in interactive mode can be achieved with the <code>-i</code> option</p>
<p>Running a custom command <em>inside the container</em> can be achieved with writing the command after the image name</p>
<ul>
<li>e.g., <code>docker run -i adoptopenjdk bash</code></li>
<li>parameters for the custom command can follow</li>
<li>use the <code>t</code> option to run in a <em>pseudo-tty</em> (always use it whenever you use <code>-i</code>)</li>
<li>use the <code>--rm</code> to remove the container after use</li>
</ul>
</section><section>
<h2 id="interaction-with-the-outside-world">Interaction with the outside world</h2>
<p>A docker container runs <em>in isolation</em>, w.r.t. the host and other containers.</p>
<p>Environment variables, network ports, and file system folders are <strong>not</strong> shared.</p>
<p>Sharing must be explicit and requires options to be specified after <code>docker run</code>:</p>
<ul>
<li>Passing environment variables: <code>-e &lt;name&gt;=&lt;value&gt;</code></li>
<li>Mounting volumes: <code>-v &lt;host&gt;:&lt;guest&gt;:&lt;options&gt;</code>
<ul>
<li><code>&lt;host&gt;</code> is the path (or volume name) on the host system</li>
<li><code>&lt;guest&gt;</code> is the location where it will be mounted on the container</li>
<li><code>&lt;options&gt;</code> can be optionally specified as mount options (e.g., <code>rw</code>, <code>ro</code>)</li>
</ul>
</li>
<li>Publishing ports: <code>-p &lt;host&gt;:&lt;guest&gt;</code>
<ul>
<li><code>&lt;host&gt;</code> is the port on the host system</li>
<li><code>&lt;guest&gt;</code> is the corresponding port on the container</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="managing-images">Managing images</h2>
<p>Every image has a unique <strong>ID</strong>, and may have an associated <strong>tag</strong></p>
<p>The subcommand <code>images</code> lists the pulled images and their associated information</p>
<p>The subcommand <code>image</code> allows for running maintenance tasks, e.g.</p>
<ul>
<li><code>docker image ls</code> – same as <code>docker images</code></li>
<li><code>docker image prune</code> – removes unused images</li>
<li><code>docker image rm</code> – removes images by name</li>
<li><code>docker image tag</code> – associates a tag to an image</li>
</ul>
</section><section>
<h2 id="creating-docker-images">Creating Docker images</h2>
<p>Docker images are written in a <code>Dockerfile</code></p>
<ul>
<li>
<p>Every command inside a Dockerfile generates a new <em>layer</em></p>
</li>
<li>
<p>The final stack of layers creates the final <em>image</em></p>
</li>
<li>
<p>The <code>docker build</code> command interprets the <code>Dockerfile</code> commands to produce a <em>sequence of layers</em></p>
</li>
<li>
<p>Changes to a layer do <em>not</em> invalidate previous layers</p>
</li>
</ul>
</section><section>


<section data-shortcode-section="">
<h2 id="dockerfile-syntax">Dockerfile syntax</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># Pulls an image from docker hub with this name. Alternatively, "scratch" can be used for an empty container</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">FROM</span><span style="color:#d20;background-color:#fff0f0"> alpine:latest</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Runs a command</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">RUN</span> apk update; apk add nodejs npm<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Copies a file/directory from the host into the image</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">COPY</span> path/to/my/nodejs/project /my-project<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Sets the working directory</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">WORKDIR</span><span style="color:#d20;background-color:#fff0f0"> /my-project</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Runs a command</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">RUN</span> npm install<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Adds a new environment variable</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">ENV</span> <span style="color:#369">SERVICE_PORT</span>=<span style="color:#00d;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#888"># Exposes a port</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">EXPOSE</span><span style="color:#d20;background-color:#fff0f0"> 8080</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Configures the default command to execute</span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#080;font-weight:bold">CMD</span> npm run service<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div><p>to be built by means of the command: <code>docker build -t PATH</code></p>
<ul>
<li><code>PATH</code> is the host path containing the <code>Dockerfile</code></li>
</ul>
</section><section>
<h2 id="content-of-the-pathtomynodejsproject-directory">Content of the <code>path/to/my/nodejs/project</code> DIRECTORY</h2>
<div class="multiCol">
<div class="col col-4 ">
    <ol>
<li>
<p><code>Dockerfile</code> as for the previous slide</p>
</li>
<li>
<p>File <code>.dockerignore</code></p>
</li>
</ol>
<pre tabindex="0"><code class="nohighlight" data-noescape="">node_modules/
</code></pre>
</div>
<div class="col col-4 ">
    <ol start="3">
<li>File <code>package.json</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"name"</span>: <span style="color:#d20;background-color:#fff0f0">"example"</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"version"</span>: <span style="color:#d20;background-color:#fff0f0">"1.0.0"</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"description"</span>: <span style="color:#d20;background-color:#fff0f0">"Example Express WS for exemplifying Docker usage"</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"main"</span>: <span style="color:#d20;background-color:#fff0f0">"index.mjs"</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"scripts"</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#b06;font-weight:bold">"service"</span>: <span style="color:#d20;background-color:#fff0f0">"node index.mjs"</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"dependencies"</span>: {
</span></span><span style="display:flex;"><span>    <span style="color:#b06;font-weight:bold">"express"</span>: <span style="color:#d20;background-color:#fff0f0">"^4.18.2"</span>
</span></span><span style="display:flex;"><span>  },
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"author"</span>: <span style="color:#d20;background-color:#fff0f0">"gciatto"</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#b06;font-weight:bold">"license"</span>: <span style="color:#d20;background-color:#fff0f0">"ISC"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col col-4 ">
    <ol start="4">
<li>File <code>index.mjs</code></li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> { env } from <span style="color:#d20;background-color:#fff0f0">'process'</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> express from <span style="color:#d20;background-color:#fff0f0">'express'</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> { randomBytes } from <span style="color:#d20;background-color:#fff0f0">'crypto'</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> port = <span style="color:#d20;background-color:#fff0f0">'SERVICE_PORT'</span> <span style="color:#080;font-weight:bold">in</span> env ? env.SERVICE_PORT : <span style="color:#00d;font-weight:bold">8080</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> hostname = <span style="color:#d20;background-color:#fff0f0">'HOSTNAME'</span> <span style="color:#080;font-weight:bold">in</span> env ? env.HOSTNAME : <span style="color:#d20;background-color:#fff0f0">'localhost'</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> serverID = randomBytes(<span style="color:#00d;font-weight:bold">8</span>).toString(<span style="color:#d20;background-color:#fff0f0">'hex'</span>) <span style="color:#888">// 8-char random string
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> server = express()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">let</span> counter = <span style="color:#00d;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>server.get(<span style="color:#d20;background-color:#fff0f0">'/'</span>, <span style="color:#080;font-weight:bold">function</span> (req, res) {
</span></span><span style="display:flex;"><span>  res.send(<span style="color:#d20;background-color:#fff0f0">`[</span><span style="color:#33b;background-color:#fff0f0">${</span>serverID<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">@</span><span style="color:#33b;background-color:#fff0f0">${</span>hostname<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">:</span><span style="color:#33b;background-color:#fff0f0">${</span>port<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">] Hit </span><span style="color:#33b;background-color:#fff0f0">${</span>++counter<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0"> times`</span>)
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>console.log(<span style="color:#d20;background-color:#fff0f0">`Service </span><span style="color:#33b;background-color:#fff0f0">${</span>serverID<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0"> listening on </span><span style="color:#33b;background-color:#fff0f0">${</span>hostname<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">:</span><span style="color:#33b;background-color:#fff0f0">${</span>port<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">`</span>)
</span></span><span style="display:flex;"><span>server.listen(port)
</span></span></code></pre></div><p>i.e. a Web service listening on the port indicated by the <code>SERIVICE_PORT</code> env var, showing Web pages of the form</p>
<pre tabindex="0"><code>[$SERVER_ID@$HOST_NAME:PORT] Hit $VIEW_COUNT times
</code></pre>
</div>
</div>

</section>
</section><section>
<h2 id="layers-and-caching-pt-1">Layers and caching (pt. 1)</h2>
<p>Every <em>line</em> in a <code>Dockerfile</code> generates a <em>new layer</em>:</p>
<p><img src="./layers-1.png" alt=""></p>
<p>A layer is a <em>diff</em> w.r.t. the previous one</p>
<p>In other words, Docker keeps track of what information is added to the image at each step</p>
</section><section>
<h2 id="layers-and-caching-pt-2">Layers and caching (pt. 2)</h2>
<p>When a <code>Dockerfile</code> is built, Docker checks whether the layer has already been built in the <em>recent past</em></p>
<p>If so, it reuses the <strong>cached layer</strong>, and skips the execution of the corresponding command</p>
<p><img src="./layers-2.png" alt=""></p>
</section><section>
<h2 id="layers-and-caching-pt-3">Layers and caching (pt. 3)</h2>
<p>When the container is run, the images layers are <em>read-only</em>, and the container has a <em>read-write</em> layer on top of them</p>
<p><img src="./rw-layer.png" alt=""></p>
<p>So, when a container is stopped, the read-write layer is discarded, and the image layers are kept</p>
<p>In this way, the <em>space occupied</em> by the container is <em>minimal</em></p>
</section><section>
<h2 id="naming-images">Naming images</h2>
<p>Image naming is done via <strong>tags</strong></p>
<ul>
<li>
<p>The easiest way to do so is assigning tags at <em>build time</em> with the <code>-t</code> options of <code>docker build</code></p>
</li>
<li>
<p>The option can be repeated multiple times to make multiple tags</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>docker build -t <span style="color:#d20;background-color:#fff0f0">"myImage:latest"</span> -t <span style="color:#d20;background-color:#fff0f0">"myImage:0.1.0"</span> /path/to/Dockerfile/container
</span></span></code></pre></div></li>
<li>
<p><code>latest</code> is usually used to identify the most recent version of some image</p>
</li>
<li>
<p>For instance, you may build the image from a few slides ago with:</p>
<ul>
<li><code>docker build -t my-service path/to/my/nodejs/project</code>
<ul>
<li>the image <code>my-service:latest</code> is automatically created</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="publishing-docker-images">Publishing Docker images</h2>
<p>Images get published in <strong>registries</strong></p>
<ul>
<li>
<p>The most famous, free for publicly available images, is <em>Docker Hub</em></p>
</li>
<li>
<p>By default, Docker uses Docker Hub as registry (both for <code>pull</code> and <code>push</code> operations)</p>
</li>
<li>
<p>Docker Hub requires registration and CLI login:</p>
<ul>
<li><code>docker login docker.io</code></li>
</ul>
</li>
<li>
<p>Once done, publication is performed via <code>push</code>:</p>
<ul>
<li><code>docker push &lt;image name&gt;</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="building-docker-images-in-ci">Building Docker images in CI</h2>
<ul>
<li>
<p>Of course, as any other software, <em>custom docker images should get built in CI</em></p>
</li>
<li>
<p>Several integrators use <em>containers</em> as <strong>build environments</strong>:</p>
<ul>
<li>it is possible to <em>build a container using a container</em></li>
</ul>
</li>
<li>
<p>More in general: there is <em>no inherent limit to nesting containers</em></p>
</li>
<li>
<p>For instance:</p>
<ul>
<li>you may run DIND (Docker-in-Docker) via: <code>docker run --privileged --rm -it docker:dind</code></li>
<li>you may use the Docker CLI in a container: <code>docker run -it --rm docker:cli</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="volumes">Volumes</h2>
<p>Volumes are <em>bridges</em> between the <em>host’s</em> <strong>file system</strong> and the <em>container’s</em> one</p>
<br>
<p>Their support several use cases:</p>
<ul>
<li><strong>sharing</strong> data between the host and the container</li>
<li><strong>persisting</strong> containers’ data</li>
<li>sharing data among containers</li>
</ul>
</section><section>
<h2 id="sorts-of-volumes-pt-1">Sorts of volumes (pt. 1)</h2>
<p><img src="./volume-types-bind.png" alt=""></p>
<ul>
<li><strong>Bind mount</strong>: a host directory is <strong>mounted</strong> into the container
<ul>
<li>the host directory is specified as <code>&lt;host path&gt;:&lt;guest path&gt;</code> (both must be <strong>absolute paths</strong>)
<ul>
<li>e.g. <code>docker run -v /home/user/my-project:/my-project ...</code></li>
</ul>
</li>
<li>data present in <code>&lt;host path&gt;</code> can be read within the container at <code>&lt;guest path&gt;</code></li>
<li>data written within the container at <code>&lt;guest path&gt;</code> can be accessed on <code>&lt;host path&gt;</code>
<ul>
<li>even after the container is stopped / deleted</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="sorts-of-volumes-pt-2">Sorts of volumes (pt. 2)</h2>
<p><img src="./volume-types-named.png" alt=""></p>
<ul>
<li><strong>Named volume</strong>: virtual drives managed by Docker
<ul>
<li>they are created with <code>docker volume create &lt;name&gt;</code></li>
<li>they are mounted into containers as <code>&lt;name&gt;:&lt;guest path&gt;</code></li>
<li>their content’s life span is independent of any container</li>
<li>they can be attached to containers at run-time, referencing their name:
<ul>
<li>e.g. <code>docker run -v my-volume:/my-project ...</code></li>
</ul>
</li>
<li>technically, they are just directories on the host’s file system, yet handled by Docker
<ul>
<li><code>/var/lib/docker/volumes/&lt;name&gt;/_data</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="sorts-of-volumes-pt-3">Sorts of volumes (pt. 3)</h2>
<p><img src="./volume-types-temp.png" alt=""></p>
<ul>
<li><strong>Tmpfs mount</strong> [Linux-only]: a temporary file system, living only as long as the container is alive
<ul>
<li>it is mounted into containers as <code>tmpfs:&lt;guest path&gt;</code></li>
<li>it is useful for storing temporary data</li>
<li>do not use it for sharing or persisting data</li>
<li>it is like an anonymous, ephemeral named volume</li>
<li>created by means of a <code>--tmpfs</code> option to <code>docker run</code>
<ul>
<li>e.g. <code>docker run --tmpfs &lt;guest path&gt; ...</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="example-containers-data-is-ephemeral">Example: containers’ data is ephemeral</h2>
<ol>
<li>
<p>Let’s open a Linux shell in a container: <code>docker run -it --rm alpine:latest sh</code></p>
</li>
<li>
<p>Let’s create folder in there: <code>mkdir -p /data</code></p>
</li>
<li>
<p>Let’s create a file in there: <code>echo "Hello world" &gt; /data/hello.txt</code></p>
</li>
<li>
<p>Does the file exist? <code>ls -la /data</code></p>
<pre tabindex="0"><code>/ # ls -la /data
total 12
drwxr-xr-x    2 root     root          4096 Nov  2 09:28 .
drwxr-xr-x    1 root     root          4096 Nov  2 09:28 ..
-rw-r--r--    1 root     root             5 Nov  2 09:28 hello.txt
</code></pre></li>
<li>
<p>Let’s exit the container: <code>exit</code></p>
</li>
<li>
<p>Let’s open a new shell in a new container: <code>docker run -it --rm alpine:latest sh</code></p>
</li>
<li>
<p>Does the file exist? <code>ls -la /data</code></p>
<pre tabindex="0"><code>ls: /data: No such file or directory
</code></pre></li>
<li>
<p>Why?</p>
<ul>
<li>the second <code>docker run ...</code> command created a new container</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="example-sharing-data-with-bind-mounts-pt-1">Example: sharing data with bind mounts (pt. 1)</h2>
<ol>
<li>
<p>Let’s create a folder on the host: <code>mkdir -p $(pwd)/shared</code></p>
</li>
<li>
<p>Let’s create 10 containers</p>
<ol>
<li>each one creating a file in <code>./shared/</code></li>
<li>named <code>container-&lt;i&gt;.txt</code></li>
<li>containing random data from <code>/dev/random</code>, encoded in base64</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">for</span> i in <span style="color:#080;font-weight:bold">$(</span>seq <span style="color:#00d;font-weight:bold">1</span> 10<span style="color:#080;font-weight:bold">)</span>; <span style="color:#080;font-weight:bold">do</span> 
</span></span><span style="display:flex;"><span>    docker run --rm -d <span style="color:#04d;background-color:#fff0f0">\ </span>          <span style="color:#888"># detached mode</span>
</span></span><span style="display:flex;"><span>        -v <span style="color:#080;font-weight:bold">$(</span><span style="color:#038">pwd</span><span style="color:#080;font-weight:bold">)</span>/shared:/data <span style="color:#04d;background-color:#fff0f0">\ </span>  <span style="color:#888"># bind mount</span>
</span></span><span style="display:flex;"><span>        --hostname container-<span style="color:#369">$i</span> <span style="color:#04d;background-color:#fff0f0">\ </span> <span style="color:#888"># parametric hostname inside the container</span>
</span></span><span style="display:flex;"><span>        alpine sh -c <span style="color:#04d;background-color:#fff0f0">\
</span></span></span><span style="display:flex;"><span><span style="color:#04d;background-color:#fff0f0"></span>        <span style="color:#d20;background-color:#fff0f0">'cat /dev/random | head -n 1 | base64 &gt; /data/$(hostname).txt'</span>  
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">done</span>
</span></span></code></pre></div></li>
<li>
<p>Let’s have at the shared directory: <code>ls -la ./shared</code></p>
<pre tabindex="0"><code>ls -la ./shared 
totale 56
drwxr-xr-x  2 user    user     4096  2 nov 10.51 .
drwxr-xr-x 79 user    user    12288  2 nov 10.56 ..
-rw-r--r--  1 root    root      329  2 nov 10.51 container-10.txt
-rw-r--r--  1 root    root      333  2 nov 10.51 container-1.txt
-rw-r--r--  1 root    root      381  2 nov 10.51 container-2.txt
-rw-r--r--  1 root    root      167  2 nov 10.51 container-3.txt
-rw-r--r--  1 root    root      110  2 nov 10.51 container-4.txt
-rw-r--r--  1 root    root      102  2 nov 10.51 container-5.txt
-rw-r--r--  1 root    root        9  2 nov 10.51 container-6.txt
-rw-r--r--  1 root    root      106  2 nov 10.51 container-7.txt
-rw-r--r--  1 root    root      766  2 nov 10.51 container-8.txt
-rw-r--r--  1 root    root      203  2 nov 10.51 container-9.txt
</code></pre></li>
</ol>
</section><section>
<h2 id="example-sharing-data-with-bind-mounts-pt-2">Example: sharing data with bind mounts (pt. 2)</h2>
<ol start="4">
<li>Things to notice:
<ul>
<li>the files are owned by <code>root</code> (inside the container)</li>
<li>the files are still owned by <code>root</code> on the host (outside the container)
<ul>
<li>despite the fact that the host user is <code>user</code></li>
<li>if <code>user</code> has no superuser privileges, they cannot delete the files</li>
</ul>
</li>
<li>when creating the container, bind mounts should be <strong>absolute</strong> paths
<ul>
<li>hence the need for <code>$(pwd)</code> to get the current working directory</li>
</ul>
</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="example-sharing-data-with-named-volumes-pt-1">Example: sharing data with named volumes (pt. 1)</h2>
<ol>
<li>
<p>Let’s create a named volume: <code>docker volume create my-volume</code></p>
</li>
<li>
<p>Same 10 containers as before, but using the named volume instead of the bind mount</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">for</span> i in <span style="color:#080;font-weight:bold">$(</span>seq <span style="color:#00d;font-weight:bold">1</span> 10<span style="color:#080;font-weight:bold">)</span>; <span style="color:#080;font-weight:bold">do</span> 
</span></span><span style="display:flex;"><span>    docker run --rm -d <span style="color:#04d;background-color:#fff0f0">\ </span>          <span style="color:#888"># detached mode</span>
</span></span><span style="display:flex;"><span>        -v my-volume:/data <span style="color:#04d;background-color:#fff0f0">\ </span>      <span style="color:#888"># reference to volume my-volume</span>
</span></span><span style="display:flex;"><span>        --hostname container-<span style="color:#369">$i</span> <span style="color:#04d;background-color:#fff0f0">\ </span> <span style="color:#888"># parametric hostname inside the container</span>
</span></span><span style="display:flex;"><span>        alpine sh -c <span style="color:#04d;background-color:#fff0f0">\
</span></span></span><span style="display:flex;"><span><span style="color:#04d;background-color:#fff0f0"></span>        <span style="color:#d20;background-color:#fff0f0">'cat /dev/random | head -n 1 | base64 &gt; /data/$(hostname).txt'</span>  
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">done</span>
</span></span></code></pre></div></li>
<li>
<p>How to access the data now?</p>
<ol>
<li>by means of another container, attached to the same volume</li>
<li>by means of the host, inspecting the volume’s file system</li>
</ol>
</li>
</ol>
</section><section>
<h2 id="example-sharing-data-with-named-volumes-pt-2">Example: sharing data with named volumes (pt. 2)</h2>
<h3 id="accessing-the-volume-from-another-container">Accessing the volume from another container</h3>
<ol>
<li>Let’s create yet another <em>interactice</em> container attached to the volume
<ul>
<li><code>docker run --rm -it -v my-volume:/data alpine sh</code></li>
</ul>
</li>
<li>Let’s have a look at the data: <code>ls -la /data</code>
<pre tabindex="0"><code>total 48
drwxr-xr-x    2 root     root          4096 Nov  2 10:15 .
drwxr-xr-x    1 root     root          4096 Nov  2 10:15 ..
-rw-r--r--    1 root     root           608 Nov  2 10:14 container-1.txt
-rw-r--r--    1 root     root           349 Nov  2 10:15 container-10.txt
-rw-r--r--    1 root     root           369 Nov  2 10:14 container-2.txt
-rw-r--r--    1 root     root           304 Nov  2 10:14 container-3.txt
-rw-r--r--    1 root     root           240 Nov  2 10:14 container-4.txt
-rw-r--r--    1 root     root           434 Nov  2 10:14 container-5.txt
-rw-r--r--    1 root     root           150 Nov  2 10:14 container-6.txt
-rw-r--r--    1 root     root            41 Nov  2 10:14 container-7.txt
-rw-r--r--    1 root     root            33 Nov  2 10:15 container-8.txt
-rw-r--r--    1 root     root          1212 Nov  2 10:15 container-9.txt
</code></pre></li>
</ol>
</section><section>
<h2 id="example-sharing-data-with-named-volumes-pt-3">Example: sharing data with named volumes (pt. 3)</h2>
<h3 id="accessing-the-volume-from-the-host">Accessing the volume from the host</h3>
<ol start="3">
<li>
<p>Alternatively, let’s find where the volume is stored on the host</p>
<ul>
<li><code>docker volume inspect my-volume</code></li>
</ul>
</li>
<li>
<p>Let’s analyse the JSON description of the volume:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>[
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"CreatedAt"</span>: <span style="color:#d20;background-color:#fff0f0">"2023-11-02T11:13:56+01:00"</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"Driver"</span>: <span style="color:#d20;background-color:#fff0f0">"local"</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"Labels"</span>: <span style="color:#080;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"Mountpoint"</span>: <span style="color:#d20;background-color:#fff0f0">"/var/lib/docker/volumes/my-volume/_data"</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"Name"</span>: <span style="color:#d20;background-color:#fff0f0">"my-volume"</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"Options"</span>: <span style="color:#080;font-weight:bold">null</span>,
</span></span><span style="display:flex;"><span>        <span style="color:#b06;font-weight:bold">"Scope"</span>: <span style="color:#d20;background-color:#fff0f0">"local"</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div></li>
</ol>
</section><section>
<h2 id="example-sharing-data-with-named-volumes-pt-4">Example: sharing data with named volumes (pt. 4)</h2>
<h3 id="accessing-the-volume-from-the-host-1">Accessing the volume from the host</h3>
<ol start="5">
<li>
<p>The <code>Mountpoint</code> entry reveals the location of the volume on the host’s file system</p>
</li>
<li>
<p>Let’s look into that position (may require <em>super-user</em> access rights):</p>
<ul>
<li>
<p><code>sudo ls -la /var/lib/docker/volumes/my-volume/_data</code></p>
<pre tabindex="0"><code>totale 48
drwxr-xr-x 2 root root 4096  2 nov 11.15 .
drwx-----x 3 root root 4096  2 nov 11.13 ..
-rw-r--r-- 1 root root  349  2 nov 11.15 container-10.txt
-rw-r--r-- 1 root root  608  2 nov 11.14 container-1.txt
-rw-r--r-- 1 root root  369  2 nov 11.14 container-2.txt
-rw-r--r-- 1 root root  304  2 nov 11.14 container-3.txt
-rw-r--r-- 1 root root  240  2 nov 11.14 container-4.txt
-rw-r--r-- 1 root root  434  2 nov 11.14 container-5.txt
-rw-r--r-- 1 root root  150  2 nov 11.14 container-6.txt
-rw-r--r-- 1 root root   41  2 nov 11.14 container-7.txt
-rw-r--r-- 1 root root   33  2 nov 11.15 container-8.txt
-rw-r--r-- 1 root root 1212  2 nov 11.15 container-9.txt
</code></pre></li>
</ul>
</li>
</ol>
</section><section>
<h2 id="how-to-retain-space-from-a-volume">How to retain space from a volume?</h2>
<p>Volumes are NOT automatically <em>cleaned up</em> when containers are <em>deleted</em></p>
<ul>
<li>
<p>Volumes must be <strong>explicitly</strong> deleted by the user</p>
<ul>
<li><code>docker volume rm &lt;volume name&gt;</code></li>
</ul>
</li>
<li>
<p>In our example, remember to delete <code>my-volume</code>:</p>
<ul>
<li><code>docker volume rm my-volume</code>
<ul>
<li>beware: this will delete all the data in the volume!</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="sudo-powered-containers">Sudo-powered containers</h2>
<ul>
<li>
<p>Sometimes one may be willing to let a container access the <em>Docker daemon</em> <strong>of its host</strong></p>
<ul>
<li>this is useful for running containers that will: <em>create/delete</em> other containers, handle images, etc.</li>
</ul>
</li>
<li>
<p>To achieve that one may exploit <strong>bind mounts</strong></p>
<ul>
<li>to share the Docker daemon’s socket with the container</li>
</ul>
</li>
<li>
<p>Explanation:</p>
<ul>
<li>on the host, the Docker daemon is just a <em>service</em> listening for commands on a <a href="https://en.wikipedia.org/wiki/Unix_domain_socket">Unix socket</a></li>
<li>the socket is usually reified as a <em>file</em> on the host’s file system, at <code>/var/run/docker.sock</code></li>
<li>the <code>docker</code> command is just a CLI program writing/reading to/from the socket to govern the daemon</li>
</ul>
</li>
<li>
<p>One may simply create a Docker container with the Docker CLI tool installed on it</p>
<ul>
<li>and share the host’s Docker socket with that container via a bind mount
<ul>
<li><code>docker run -it --rm -v /var/run/docker.sock:/var/run/docker.sock --name sudo docker:cli sh</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>Inside that container one may run the <code>docker</code> command as usual, to govern the host’s Docker daemon</p>
<ul>
<li>e.g. <code>docker ps</code></li>
</ul>
<pre tabindex="0"><code>CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS          PORTS      NAMES
3d9016cd067e   docker:cli   "docker-entrypoint.s…"   5 seconds ago    Up 3 seconds               sudo
</code></pre></li>
</ul>
</section><section>
<h2 id="networks">Networks</h2>
<p>Docker may virtualise container’s <strong>networking facilities</strong></p>
<ol>
<li>network interfaces</li>
<li>IP addresses</li>
<li>layer-4 ports</li>
</ol>
<br>
<p>This is useful to let containers <strong>communicate</strong> with any external entity
<br>most commonly, other containers or the host</p>


<span class="fragment ">
  <br>
<blockquote>
<p><strong>Networks</strong> are virtual entities managed by Docker</p>
<ul>
<li>they mimic the notion of <em>layer-3 network</em></li>
<li>in the eyes of the single container, they are <em>virtual network interfaces</em></li>
<li>overall, their purpose is to <em>delimit</em> the <strong>communication scope</strong> for containers</li>
</ul>
</blockquote>

</span>

</section><section>
<h2 id="sorts-of-networks-pt-1">Sorts of networks (pt. 1)</h2>
<p>Different sorts of networks are available in Docker, depending on the <strong>driver</strong>:</p>
<p><img src="./networks.png" alt=""></p>
</section><section>
<h2 id="sorts-of-networks-pt-2">Sorts of networks (pt. 2)</h2>
<p>Available drivers:</p>
<ul>
<li>
<p><strong>none</strong>: no networking facilities are provided to the container, which is then isolated</p>
</li>
<li>
<p><strong>host</strong>: remove network isolation between the container and the Docker host, and use the host’s networking directly</p>
</li>
<li>
<p><strong>bridge</strong> (default): a virtual network, internal to the host, letting multiple containers communicate with each other</p>
</li>
<li>
<p><strong>overlay</strong>: a virtual network, spanning multiple hosts, letting multiple containers communicate with each other among different nodes of the same cluster</p>
</li>
</ul>
<br>
<p>Other drivers are available as well, cf. <a href="https://docs.docker.com/network/drivers/">https://docs.docker.com/network/drivers/</a></p>
</section><section>
<h3 id="none-network-driver">None network driver</h3>
<figure><img src="/09-containerization/none-network.png" width="20%">
</figure>

<ul>
<li>
<p><strong>No</strong> networking facilities are provided to the container <strong>at all</strong>, which is then <em>isolated</em> w.r.t the external world</p>
</li>
<li>
<p>This is useful for containers that do not need to communicate via the network</p>
<ul>
<li>i.e. they <em>expose no service</em>, and they <strong>must not access</strong> the Internet
<ul>
<li>very rare situation</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Example: <code>docker run --network none -it --rm alpine sh</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>/ <span style="color:#888"># ping 8.8.8.8</span>
</span></span><span style="display:flex;"><span>PING 8.8.8.8 (8.8.8.8): <span style="color:#00d;font-weight:bold">56</span> data bytes
</span></span><span style="display:flex;"><span>ping: sendto: Network unreachable
</span></span></code></pre></div></li>
</ul>
</section><section>
<h3 id="host-driver">Host driver</h3>
<figure><img src="/09-containerization/host-network.png" width="20%">
</figure>

<ul>
<li>
<p><strong>No isolation</strong> between the container and the host</p>
<ul>
<li>the container uses the host’s networking facilities <em>directly</em></li>
</ul>
</li>
<li>
<p>The main consequence is that the container will be assigned with the <strong>same IP address as the host</strong></p>
<ul>
<li>the layer-4 ports used by the container are <strong>also busy</strong> for the host
<ul>
<li>high <strong>collision</strong> probability</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Example: <code>docker run --network host my-service</code></p>
<pre tabindex="0"><code>Service 540c3b7bb7860c6a listening on &lt;your pc's hostname&gt;:8080
</code></pre><ul>
<li>try now to start a service on port 8080 on your host
<ul>
<li>you should get an error message stating that port 8080 is already in use</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="bridge-network-pt-1">Bridge network (pt. 1)</h2>
<figure><img src="/09-containerization/bridge-network.png" width="30%">
</figure>

<ul>
<li>
<p><strong>Virtual network</strong> spanning through <em>one or more containers</em> on the <em>same host</em></p>
<ul>
<li>containers attached to the <em>same</em> network can <strong>communicate</strong> with each other via <em>TCP/IP</em></li>
<li>each container may be attached to <strong>multiple networks</strong>
<ul>
<li>e.g. one for internal communication, one for external communication</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Each container gets assigned with a <strong>private IP address</strong> on the network</p>
<ul>
<li>commonly in the range <code>172.x.y.z</code></li>
<li>the IP address is contactable from the host</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="bridge-network-pt-2">Bridge network (pt. 2)</h2>
<p>To exemplify the usage of IP:</p>
<ol>
<li>
<p>let’s create a container using the <code>my-service</code> image created a few slides ago</p>
<ul>
<li><code>docker run --network bridge -d --rm --name my-container my-service</code></li>
<li>this should be a service listening on port <code>8080</code></li>
<li>we call the container <code>my-container</code></li>
<li>specifying <code>--network bridge</code> is useless, because that’s the default</li>
</ul>
</li>
<li>
<p>let’s inspect the container’s IP address</p>
<ul>
<li><code>docker inspect my-container | grep IPAddress</code>
<ul>
<li>at the time of writing, the IP address is <code>172.17.0.2</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>open your browser and browse to <code>http://172.17.0.2:8080</code></p>
<ul>
<li>you should see a page of the form: <code>[$SERVER_ID@$HOST_NAME:PORT] Hit $VIEW_COUNT times</code></li>
<li>the page is served by the container, contacted by IP</li>
<li>so containes attached to <code>bridge</code>-like networks can be contacted by IP, from the host</li>
</ul>
</li>
<li>
<p>try to contact the container:</p>
<ul>
<li>by host name, from the host
<ul>
<li>this should not work $\Rightarrow$ no host-specific DNS resolution for containers</li>
</ul>
</li>
<li>by IP, from another host (in the same LAN of the host)
<ul>
<li>this should not work $\Rightarrow$ <em>bridge</em> networks are host specific</li>
</ul>
</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="bridge-network-pt-3">Bridge network (pt. 3)</h2>
<p>Let’s create a non-trivial scenario with 2 container attached to the same network:</p>
<ol>
<li>one container (host name: <code>dind</code>) will run the Docker daemon (Docker-in-Docker)</li>
<li>the other container (host name: <code>cli</code>) will run the Docker CLI</li>
<li>let’s call the shared network <code>my-network</code></li>
</ol>
</section><section>
<h2 id="bridge-network-pt-4">Bridge network (pt. 4)</h2>
<ol>
<li>
<p>let’s create the network: <code>docker network create --driver bridge my-network</code></p>
<ul>
<li>a random string is returned: that’s the network’s ID</li>
</ul>
</li>
<li>
<p>let’s create the daemon:</p>
<ul>
<li><code>docker run --privileged -d --rm --network my-network --hostname dind docker:dind</code></li>
</ul>
</li>
<li>
<p>let’s create the client: <code>docker run -it --rm --network my-network --hostname cli docker:cli</code></p>
<ol>
<li>
<p>inside <code>cli</code>, let’s check if <code>dind</code> is contactable by hostname: <code>ping dind</code></p>
<ul>
<li>this should work $\Rightarrow$ networks come with their own <strong>name resolution</strong> support</li>
</ul>
</li>
<li>
<p>inside <code>cli</code>, let’s check if the Docker client works: <code>docker ps</code></p>
<pre tabindex="0"><code>error during connect: Get "http://docker:2375/v1.24/containers/json": dial tcp: lookup docker on 127.0.0.11:53: no such host
</code></pre></li>
<li>
<p>apparently the <code>docker:cli</code> image is preconfigured to contact a daemon on the <code>docker</code> hostname</p>
</li>
</ol>
</li>
<li>
<p>let’s stop <code>dind</code>:</p>
<ul>
<li>you can use <code>docker ps</code> on the host to get the name of the <code>dind</code> container</li>
<li>then <code>docker stop &lt;container name&gt;</code></li>
<li>or <code>docker stop $(docker ps -q --filter ancestor=docker:dind)</code>
<ul>
<li><code>-q</code> (<em>quiet</em>), only display container IDs</li>
<li><code>--filter ancestor=X</code> selects containers whose image is <code>X</code></li>
</ul>
</li>
<li>next time let’s give an explicit name to the container via <code>--name</code></li>
</ul>
</li>
</ol>
</section><section>
<h2 id="bridge-network-pt-5">Bridge network (pt. 5)</h2>
<ol start="5">
<li>
<p>let’s restart a Docker-in-Docker daemon, using the <code>docker</code> hostname:</p>
<ul>
<li><code>docker run --privileged -d --rm --network my-network --name dind --hostname docker docker:dind dockerd --host=tcp://0.0.0.0:2375</code></li>
<li>in general, it would be better to both <code>--name X</code> and <code>--hostname X</code>
<ul>
<li>same name and hostname to avoid confusion!</li>
</ul>
</li>
<li><code>dockerd --host=tcp://0.0.0.0:2375</code> is necessary to force the port the daemon will listen on
<ul>
<li>and to disable TLS security (not recommended in production)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>let’s restart the client: <code>docker run -it --rm --network my-network --hostname cli docker:cli</code></p>
</li>
<li>
<p>let’s run a command on the CLI, say <code>docker run hello-world</code></p>
<ul>
<li>this should work $\Rightarrow$ the client is now able to contact the daemon via the <code>docker</code> hostname</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="exposing-ports-pt-1">Exposing ports (pt. 1)</h2>
<ul>
<li>
<p>When a container wraps a <strong>service</strong> listening on <strong>layer-4 port</strong>…</p>
<ul>
<li>… the port is <strong>not accessible</strong> from the <em>outside</em> world</li>
<li>… unless it is <strong>explicitly exposed</strong> by the container</li>
</ul>
</li>
<li>
<p>When <em>creating</em> a Docker <em>image</em>, the <code>EXPOSE</code> command in the <code>Dockerfile</code> is used to declare ports <em>exposed by default</em></p>
<ul>
<li>e.g. <code>EXPOSE 8080</code></li>
</ul>
</li>
<li>
<p>The port exposed by a container can be inspected via <code>docker ps</code></p>
<ul>
<li>e.g. <code>docker run -d --rm my-service; docker ps</code></li>
</ul>
<pre tabindex="0"><code>CONTAINER ID   IMAGE        COMMAND                  CREATED        STATUS                  PORTS      NAMES
7a14f3bf95cc   my-service   "/bin/sh -c 'npm run…"   1 second ago   Up Less than a second   8080/tcp   wonderful_goldwasser
</code></pre><p>(look at the <code>PORTS</code> column)</p>
</li>
</ul>
</section><section>
<h2 id="exposing-ports-pt-2">Exposing ports (pt. 2)</h2>
<ul>
<li>
<p>When <em>running</em> a Docker <em>container</em>, the exposed port can be mapped to host’s ports via <code>-P</code> option</p>
<ul>
<li>this would make any <code>EXPOSE</code>d port in the image mapped to some <em>random</em> port of the host</li>
<li>e.g. <code>docker run -d --rm -P my-service; docker ps</code></li>
<li>the actual port mapping you should run <code>docker ps</code></li>
</ul>
<pre tabindex="0"><code>CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                                         NAMES
b1470831b62b   my-service   "/bin/sh -c 'npm run…"   6 seconds ago   Up 5 seconds   0.0.0.0:32773-&gt;8080/tcp, :::32773-&gt;8080/tcp   sad_benz
</code></pre></li>
<li>
<p>One may control the mapping of ports via the <code>-p &lt;host port&gt;:&lt;guest port&gt;</code> option</p>
<ul>
<li>e.g. <code>docker run -d --rm -p 8888:8080 my-service; docker ps</code></li>
<li>this would map the container’s port <code>8080</code> to the host’s port <code>8080</code></li>
</ul>
<pre tabindex="0"><code>CONTAINER ID   IMAGE        COMMAND                  CREATED         STATUS         PORTS                                       NAMES
f034da93c476   my-service   "/bin/sh -c 'npm run…"   4 seconds ago   Up 3 seconds   0.0.0.0:8888-&gt;8080/tcp, :::8888-&gt;8080/tcp   bold_booth
</code></pre></li>
</ul>
</section><section>
<h1 id="orchestration">Orchestration</h1>
<h2 id="with-docker-compose">With Docker Compose</h2>
</section><section>
<h2 id="do-we-need-orchestration">Do we need orchestration?</h2>
<blockquote>
<p>Operating containers manually is error prone and low-level</p>
</blockquote>
<ul>
<li>
<p>Docker Compose lets you increase the <strong>abstraction level</strong> on the <strong>single machine</strong></p>
</li>
<li>
<p>Starting from a <strong>user-provided specification</strong> of a <strong>stack</strong>…</p>
<ul>
<li>i.e. a set of containers, their images, their environment, their dependencies</li>
</ul>
</li>
<li>
<p>… Docker Compose can:</p>
<ul>
<li><strong>orderly start</strong> the containers up</li>
<li>while <em>creating</em> all required <em>networks</em> and <em>volumes</em></li>
<li>and <strong>gracefully shut</strong> them <strong>down</strong> upon need</li>
</ul>
</li>
<li>
<p>The only thing the user must do is: creating a <code>docker-compose.yml</code> file</p>
<ul>
<li>a <a href="https://yaml.org/">YAML</a> file describing the stack</li>
<li>following the <a href="https://docs.docker.com/compose/compose-file/">official specification</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="docker-compose-syntax-by-example-pt-1">Docker Compose syntax by example (pt. 1)</h2>
<figure><img src="/09-containerization/compose-example.png" width="50%">
</figure>

<p>The example application is composed of the following parts:</p>
<ul>
<li>2 services, backed by Docker images: <code>webapp</code> and <code>database</code></li>
<li>1 secret (HTTPS certificate), injected into the frontend</li>
<li>1 secret (DB credentials), injected into both services</li>
<li>1 configuration (HTTP), injected into the frontend</li>
<li>1 persistent volume, attached to the backend</li>
<li>2 networks</li>
</ul>
</section><section>
<h2 id="docker-compose-syntax-by-example-pt-2">Docker Compose syntax by example (pt. 2)</h2>

<div class="multiCol">
    

<div class="col col-6 ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">3.9</span><span style="color:#bbb">                    </span><span style="color:#888"># version of the specification</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">                       </span><span style="color:#888"># section defining services composing the stack</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">frontend</span>:<span style="color:#bbb">                     </span><span style="color:#888"># name of the first service (frontend)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>example/webapp      <span style="color:#bbb"> </span><span style="color:#888"># image to use for the first service</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">depends_on</span>:<span style="color:#bbb">                 </span><span style="color:#888"># section for def</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">       </span>- backend               <span style="color:#bbb"> </span><span style="color:#888"># this should be started AFTER the backend service is healthy</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">environment</span>:<span style="color:#bbb">                </span><span style="color:#888"># section for environment variables</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">SERVICE_PORT</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">8043</span><span style="color:#bbb">        </span><span style="color:#888"># env var dictating the port the service will listen on</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">DB_HOST</span>:<span style="color:#bbb"> </span>backend         <span style="color:#bbb"> </span><span style="color:#888"># env variable dictating the hostname of the backend service </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                </span><span style="color:#888"># (equal to the service name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">DB_PORT</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">3306</span><span style="color:#bbb">             </span><span style="color:#888"># env variable dictating the port the backend service will listen on</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">ports</span>:<span style="color:#bbb">                      </span><span style="color:#888"># section for ports to be exposed / mapped on the host</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"443:8043"</span><span style="color:#bbb">              </span><span style="color:#888"># exposing port 8043 of the container as port 443 of the host</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">                   </span><span style="color:#888"># section for networks to be attached to</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- front-tier             <span style="color:#bbb"> </span><span style="color:#888"># attaching the service to the front-tier network (referenced by name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- back-tier              <span style="color:#bbb"> </span><span style="color:#888"># attaching the service to the back-tier network (referenced by name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888"># configs are files to be copied in the service' container, without needing to create a new image</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">configs</span>:<span style="color:#bbb">                    </span><span style="color:#888"># section for configuration files to be injected in the container</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#b06;font-weight:bold">source</span>:<span style="color:#bbb"> </span>httpd-config   <span style="color:#bbb"> </span><span style="color:#888"># reference to the configuration file (by name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">target</span>:<span style="color:#bbb"> </span>/etc/httpd.conf<span style="color:#bbb"> </span><span style="color:#888"># path on the container where the config file will be mounted as read-only</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888"># secrets are reified as read-only files in /run/secrets/&lt;secret_name&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">                    </span><span style="color:#888"># section for secrets to be injected in the service' container</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- server-certificate     <span style="color:#bbb"> </span><span style="color:#888"># reference to the secret (by name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db-credentials         <span style="color:#bbb"> </span><span style="color:#888"># reference to the secret (by name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#888"># assumption: image example/webapp is programmed to look in /run/secrets/&lt;secret_name&gt; </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#888"># and load the secrets therein contained</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">backend</span>:<span style="color:#bbb">                      </span><span style="color:#888"># name of the second service (backend)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>example/database    <span style="color:#bbb"> </span><span style="color:#888"># image to use for the second service</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888"># this is a command to be run inside the service to check whether it is healthy</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">healthcheck</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">test</span>:<span style="color:#bbb"> </span>[<span style="color:#d20;background-color:#fff0f0">"CMD"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"command"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"which"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"should"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"fail"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"if"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"db not healthy"</span>]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">interval</span>:<span style="color:#bbb"> </span>1m30s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">timeout</span>:<span style="color:#bbb"> </span>10s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">retries</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">start_period</span>:<span style="color:#bbb"> </span>40s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">                    </span><span style="color:#888"># section for volumes to be attached to the container</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db-data:/etc/data      <span style="color:#bbb"> </span><span style="color:#888"># the volume db-data (reference by name) will be mounted </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                                </span><span style="color:#888"># as read-write in /etc/data</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- back-tier              <span style="color:#bbb"> </span><span style="color:#888"># attaching the service to the back-tier network (referenced by name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db-credentials         <span style="color:#bbb"> </span><span style="color:#888"># reference to the secret (by name)</span><span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

<div class="col col-6 ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">                   </span><span style="color:#888"># section for volumes to be created in the stack</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db-data</span>:<span style="color:#bbb">                 </span><span style="color:#888"># name of the volume, to be referenced by services</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">driver_opts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">type</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"none"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">o</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"bind"</span><span style="color:#bbb">            </span><span style="color:#888"># this volume is a bind mount</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">device</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"/path/to/db/data/on/the/host"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">configs</span>:<span style="color:#bbb">                   </span><span style="color:#888"># section for configuration files to be created in the stack</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">httpd-config</span>:<span style="color:#bbb">            </span><span style="color:#888"># name of the configuration file, to be referenced by services</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">file</span>:<span style="color:#bbb"> </span>path/to/http/configuration/file/on/the/host<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">                   </span><span style="color:#888"># section for secrets to be created in the stack</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">server-certificate</span>:<span style="color:#bbb">      </span><span style="color:#888"># name of the secret, to be referenced by services</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">file</span>:<span style="color:#bbb"> </span>path/to/certificate/file/on/the/host<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db-credentials</span>:<span style="color:#bbb">          </span><span style="color:#888"># name of the secret, to be referenced by services</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">external</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">         </span><span style="color:#888"># this secret is not created by the stack, but it is expected to be created by the user</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">name</span>:<span style="color:#bbb"> </span>my-db-creds     <span style="color:#bbb"> </span><span style="color:#888"># name of the secret, as created by the user </span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#888"># The presence of these objects is sufficient to define them</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">front-tier</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">back-tier</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="orchestration-level-notions-pt-1">Orchestration-level notions (pt. 1)</h2>
<h3 id="stacks">Stacks</h3>
<p>A <strong>stack</strong> is a set of <em>inter-related</em> services, networks, volumes, secrets, configs</p>
<ul>
<li>all of which are defined in a single <code>docker-compose.yml</code> file</li>
<li>all of which are created / deleted / updated / started / stopped <strong>together</strong></li>
</ul>
<h3 id="services">Services</h3>
<p>From <a href="https://docs.docker.com/compose/compose-file/05-services/">Docker Compose documentation</a>:</p>
<ul>
<li>a <strong>service</strong> is an <em>abstract definition</em> of a computing resource within an <em>application</em> which can be <strong>scaled</strong> or <strong>replaced</strong> independently from other components</li>
<li>they are backed by a <em>set of</em> <strong>containers</strong>, run by the orchestrator according to <strong>replication requirements</strong> and <strong>placement constraints</strong></li>
<li>they are backed by containers, hence they are defined by an <strong>image</strong> and set of <strong>runtime arguments</strong>
<ul>
<li>all containers within a service are <em>identically</em> created with these arguments</li>
</ul>
</li>
<li>they are declared in the <code>services</code> section of the <code>docker-compose.yml</code> file
<ul>
<li>for each service, <em>attributes</em> may be spiecified, <em>overriding</em> the default behaviour of the image</li>
<li>further attributes may be specified to declare <em>dependencies</em> on other services, volumes, networks, and so on
<ul>
<li>these must be declared in the same <code>docker-compose.yml</code> file</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-2">Orchestration-level notions (pt. 2)</h2>
<h3 id="configs">Configs</h3>
<p>From <a href="https://docs.docker.com/compose/compose-file/08-configs/">Docker Compose documentation</a>:</p>
<ul>
<li><strong>configs</strong> are <em>files</em> containing <em>configuration data</em> that can be <em>injected</em> into services upon instantiation</li>
<li>they allow users to configure their services’ behaviour <em>without</em> the need to <strong>(re)build a (new) image</strong></li>
<li>they are <em>read-only</em> files, mounted into services’ containers, similarly to <em>read-only</em> <strong>volumes</strong></li>
<li>they are declared in the <code>configs</code> section of the <code>docker-compose.yml</code> file</li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-3">Orchestration-level notions (pt. 3)</h2>
<h3 id="configs-1">Configs</h3>
<ul>
<li>
<p>one config may either be created <strong>stack-wise</strong> out of a <strong>local file</strong> from the <em>host</em>…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">configs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">config_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">file</span>:<span style="color:#bbb"> </span>/path/to/config/on/the/host<span style="color:#bbb">
</span></span></span></code></pre></div></li>
<li>
<p>… or it can be <strong>manually created</strong> by means of the <code>docker config create [OPTIONS] NAME PATH</code> command</p>
<ul>
<li>in this case they can be referenced in several <code>docker-compose.yml</code> files:
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">configs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">config_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">external</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"the name used when creating the config"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#888"># this may be different than config_name</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>in any case, the config’s mount point should be specified at the service level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">my-service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">configs</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- <span style="color:#b06;font-weight:bold">source</span>:<span style="color:#bbb"> </span>config_name<span style="color:#bbb"> </span><span style="color:#888"># reference to the configs section (by YAML name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#b06;font-weight:bold">target</span>:<span style="color:#bbb"> </span>/path/to/config/on/the/container<span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-3-1">Orchestration-level notions (pt. 3)</h2>
<h3 id="secrets">Secrets</h3>
<p>From <a href="https://docs.docker.com/compose/compose-file/09-secrets/">Docker Compose documentation</a>:</p>
<ul>
<li>
<p><strong>secrets</strong> are configs containing sensitive data that should be <em>kept secret</em></p>
</li>
<li>
<p>put it simply, Docker makes it harder to inspect the content of secrets both on the host</p>
</li>
<li>
<p>one secret may be either be created <strong>stack-wise</strong> out of a <strong>local file</strong> or an <strong>environment variable</strong> from the <em>host</em>…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">                                            </span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">secret_name</span>:<span style="color:#bbb">                                        </span><span style="color:#b06;font-weight:bold">secret_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">file</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"/path/to/secret/on/the/host"</span><span style="color:#bbb">                 </span><span style="color:#b06;font-weight:bold">environment</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"NAME_OF_THE_VARIABLE_ON_THE_HOST"</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
<li>
<p>… or it can be <strong>manually created</strong> by means of the <code>docker secret create [OPTIONS] NAME PATH|-</code> command</p>
<ul>
<li>in this case they can be referenced in several <code>docker-compose.yml</code> files:
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">secret_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">external</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"the name used when creating the secret"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#888"># this may be different than secret_name</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>in any case, the secret’s mount point should be specified at the service level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">my-service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#888"># short syntax, mounted on /run/secrets/&lt;secret_name&gt;</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- secret_name<span style="color:#bbb"> </span><span style="color:#888"># reference to the secrets section (by YAML name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#888"># long syntax</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- <span style="color:#b06;font-weight:bold">source</span>:<span style="color:#bbb"> </span>secret_name<span style="color:#bbb"> </span><span style="color:#888"># reference to the secrets section (by YAML name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span><span style="color:#b06;font-weight:bold">target</span>:<span style="color:#bbb"> </span>/path/to/secret/on/the/container<span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-4">Orchestration-level notions (pt. 4)</h2>
<h3 id="about-secrets-and-configs">About secrets and configs</h3>
<p>Important remark:</p>
<ul>
<li>in the eyes of the container, secrets and configs are just <em>read-only files</em> mounted on some <code>PATH</code></li>
<li>the containerised application is responsible for reading the secrets / configs from the mounted <code>PATH</code></li>
<li>when <strong>using</strong> <em>somebody else’s image</em>, you may <em>expect</em> the image to be programmed to read secrets / configs from <strong>customisable paths</strong></li>
<li>when <strong>creating</strong> your own image, you <em>should</em> make the application able to read secrets / configs from <strong>customisable paths</strong>
<ul>
<li>e.g. via environment variables</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-5">Orchestration-level notions (pt. 5)</h2>
<h3 id="volumes-1">Volumes</h3>
<p>From <a href="https://docs.docker.com/compose/compose-file/07-volumes/">Docker Compose documentation</a>:</p>
<ul>
<li>volumes in compose are no different than the ones we have already discussed</li>
<li>they are declared in the <code>volumes</code> section of the <code>docker-compose.yml</code> file</li>
<li>one volume may be created <strong>stack-wise</strong> out of a <strong>local folder</strong> from the <em>host</em>…
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volume_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">driver</span>:<span style="color:#bbb"> </span>local<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">driver_opts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#b06;font-weight:bold">type</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"none"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#b06;font-weight:bold">o</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"bind"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#b06;font-weight:bold">device</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"/path/to/folder/on/the/host"</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
<li>… or maybe some remote folder exposed by some <a href="https://en.wikipedia.org/wiki/Network_File_System">NFS</a> service on the network
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volume_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">driver</span>:<span style="color:#bbb"> </span>local<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">driver_opts</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#b06;font-weight:bold">type</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"nfs"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#888"># meaning of options: https://wiki.archlinux.org/title/NFS#Mount_using_/etc/fstab</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#b06;font-weight:bold">o</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"addr=NFS_SERVER_ADDRESS,nolock,soft,rw"</span><span style="color:#bbb"> </span><span style="color:#888"># cf. nfs</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#b06;font-weight:bold">device</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">":/path/on/the/nfs/server/"</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-6">Orchestration-level notions (pt. 6)</h2>
<h3 id="volumes-contd">Volumes (cont’d)</h3>
<ul>
<li>
<p>… or it can be <strong>manually created</strong> by means of the <code>docker volume create [OPTIONS] NAME</code> command</p>
<ul>
<li>in this case they can be referenced in several <code>docker-compose.yml</code> files:
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volume_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">external</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"the name used when creating the volume"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#888"># this may be different than volume_name</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>in any case, the volume’s mount point should be specified at the service level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">my-service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- <span style="color:#b06;font-weight:bold">type</span>:<span style="color:#bbb"> </span>volume<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#b06;font-weight:bold">source</span>:<span style="color:#bbb"> </span>volume_name<span style="color:#bbb"> </span><span style="color:#888"># reference to the volumes section (by YAML name)</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#b06;font-weight:bold">target</span>:<span style="color:#bbb"> </span>/path/to/folder/on/the/container<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#888"># alternatively, one may define a service-specific bind mount on the fly</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- <span style="color:#b06;font-weight:bold">type</span>:<span style="color:#bbb"> </span>bind<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#b06;font-weight:bold">source</span>:<span style="color:#bbb"> </span>/path/to/folder/on/the/host<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">              </span><span style="color:#b06;font-weight:bold">target</span>:<span style="color:#bbb"> </span>/path/to/folder/on/the/container<span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="orchestration-level-notions-pt-7">Orchestration-level notions (pt. 7)</h2>
<h3 id="networks-1">Networks</h3>
<p>From <a href="https://docs.docker.com/compose/compose-file/06-networks/">Docker Compose documentation</a>:</p>
<ul>
<li>
<p>networks in compose are no different than the ones we have already discussed</p>
</li>
<li>
<p>they are declared in the <code>networks</code> section of the <code>docker-compose.yml</code> file</p>
</li>
<li>
<p>one network may be created <strong>stack-wise</strong> out of a <strong>local folder</strong> from the <em>host</em>…</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">network_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">driver</span>:<span style="color:#bbb"> </span>overlay<span style="color:#bbb"> </span><span style="color:#888"># default choice in swarm</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">driver_opts</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span><span style="color:#888"># many options, covering many advanced use cases for network engineering</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
<li>
<p>… or it can be <strong>manually created</strong> by means of the <code>docker network create [OPTIONS] NAME</code> command</p>
<ul>
<li>in this case they can be referenced in several <code>docker-compose.yml</code> files:
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">network_name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">external</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">name</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"the name used when creating the network"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#888"># this may be different than network_name</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</li>
<li>
<p>in any case, the network’s mount point should be specified at the service level:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">my-service</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>- network_name<span style="color:#bbb"> </span><span style="color:#888"># reference to the networks section (by YAML name)</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="docker-compose-commands">Docker Compose commands</h2>
<ul>
<li>
<p>See all possibilities with <code>docker compose --help</code></p>
</li>
<li>
<p><code>docker compose up</code> starts the stack</p>
<ul>
<li>if the stack is not present, it is created</li>
<li>if the stack is already present, it is updated</li>
<li>if the stack is already present, and it is up-to-date, nothing happens</li>
<li>interesting optional flags (see all with <code>--help</code>)
<ul>
<li><code>-d</code> (<em>detached mode</em>): run containers in the background</li>
<li><code>--wait</code> wait for services to be running or healthy (implies detached mode)</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>docker compose down</code> stops the stack</p>
<ul>
<li>if the stack is not present, nothing happens</li>
<li>if the stack is present, it is stopped</li>
<li>interesting optional flags (see all with <code>--help</code>)
<ul>
<li><code>--remove-orphans</code> remove containers for services not defined in the Compose file (e.g. residuals from previous versions)</li>
<li><code>-v</code> remove named volumes declared in the “volumes” section of the Compose file and anonymous volumes attached to containers</li>
</ul>
</li>
</ul>
</li>
</ul>
<blockquote>
<p>All commands assume a <code>docker-compose.yml</code> file is present in the <strong>current working directory</strong></p>
</blockquote>
</section><section>
<h2 id="working-example-pt-1">Working example (pt. 1)</h2>

<div class="multiCol">
    

<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"3.9"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>mariadb:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">command</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">'--default-authentication-plugin=mysql_native_password'</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db_data:/var/lib/mysql<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">restart</span>:<span style="color:#bbb"> </span>always<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- back-tier<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">MYSQL_ROOT_PASSWORD</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"..Password1.."</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">MYSQL_DATABASE</span>:<span style="color:#bbb"> </span>wordpress_db<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">MYSQL_USER</span>:<span style="color:#bbb"> </span>wordpress_user<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">MYSQL_PASSWORD</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">",,Password2,,"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">healthcheck</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">test</span>:<span style="color:#bbb"> </span>[<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"CMD"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"healthcheck.sh"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"--su-mysql"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"--connect"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"--innodb_initialized"</span><span style="color:#bbb"> </span>]<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">start_period</span>:<span style="color:#bbb"> </span>1m<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">start_interval</span>:<span style="color:#bbb"> </span>10s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">interval</span>:<span style="color:#bbb"> </span>1m<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">timeout</span>:<span style="color:#bbb"> </span>5s<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">retries</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">wordpress</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">depends_on</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>wordpress:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- wordpress_data:/var/www/html<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"8000:80"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">restart</span>:<span style="color:#bbb"> </span>always<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- back-tier<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">WORDPRESS_DB_HOST</span>:<span style="color:#bbb"> </span>db:3306<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">WORDPRESS_DB_USER</span>:<span style="color:#bbb"> </span>wordpress_user<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">WORDPRESS_DB_PASSWORD</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">",,Password2,,"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">WORDPRESS_DB_NAME</span>:<span style="color:#bbb"> </span>wordpress_db<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db_data</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">wordpress_data</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">back-tier</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

<div class="col  ">
    <blockquote>
<p><strong>Beware</strong>: this is unsafe as passwords are in clear text!</p>
</blockquote>
<br>
<h3 id="todo">TODO</h3>
<ol>
<li>
<p>Copy-paste this code in a file named <code>your-dir/docker-compose.yml</code></p>
</li>
<li>
<p><code>cd your-dir</code></p>
</li>
<li>
<p><code>docker compose up</code> and then inspect the logs</p>
</li>
<li>
<p>open your browser and browse to <a href="http://localhost:8000">http://localhost:8000</a></p>
</li>
<li>
<p><code>docker ps</code> and have a look to the running containers</p>
<ul>
<li>and <code>docker network ls</code></li>
<li>and <code>docker volume ls</code></li>
</ul>
</li>
<li>
<p>Press <code>Ctrl+C</code> to stop the stack</p>
</li>
<li>
<p><code>docker compose down --volumes</code> to delete the stack</p>
</li>
</ol>

</div>

</div>

</section><section>
<h2 id="working-example-pt-2">Working example (pt. 2)</h2>
<ul>
<li>
<p>Example of <code>docker compose up</code> logs:</p>
<pre tabindex="0"><code>docker compose up
[+] Building 0.0s (0/0) docker:default
[+] Running 5/5
✔ Network your-dir_back-tier        Created  0.1s 
✔ Volume "your-dir_wordpress_data"  Created  0.1s 
✔ Volume "your-dir_db_data"         Created  0.0s 
✔ Container your-dir-db-1           Created  0.8s 
✔ Container your-dir-wordpress-1    Created  0.9s 
Attaching to db-1, wordpress-1
db-1         | 2023-11-23 14:24:57+00:00 [Note] [Entrypoint]: Entrypoint script for MariaDB Server 1:11.2.2+maria~ubu2204 started.
db-1         | 2023-11-23 14:24:57+00:00 [Note] [Entrypoint]: Switching to dedicated user 'mysql'
db-1         | 2023-11-23 14:24:57+00:00 [Note] [Entrypoint]: Entrypoint script for MariaDB Server 1:11.2.2+maria~ubu2204 started.
db-1         | 2023-11-23 14:24:57+00:00 [Note] [Entrypoint]: Initializing database files
wordpress-1  | WordPress not found in /var/www/html - copying now...
wordpress-1  | Complete! WordPress has been successfully copied to /var/www/html
wordpress-1  | No 'wp-config.php' found in /var/www/html, but 'WORDPRESS_...' variables supplied; copying 'wp-config-docker.php' (WORDPRESS_DB_HOST WORDPRESS_DB_NAME WORDPRESS_DB_PASSWORD WORDPRESS_DB_USER)
wordpress-1  | AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 172.22.0.3. Set the 'ServerName' directive globally to suppress this message
wordpress-1  | AH00558: apache2: Could not reliably determine the server's fully qualified domain name, using 172.22.0.3. Set the 'ServerName' directive globally to suppress this message
wordpress-1  | [Thu Nov 23 14:24:58.289485 2023] [mpm_prefork:notice] [pid 1] AH00163: Apache/2.4.56 (Debian) PHP/8.0.30 configured -- resuming normal operations
wordpress-1  | [Thu Nov 23 14:24:58.289516 2023] [core:notice] [pid 1] AH00094: Command line: 'apache2 -D FOREGROUND'
db-1         | 2023-11-23 14:24:58 0 [Warning] 'default-authentication-plugin' is MySQL 5.6 / 5.7 compatible option. To be implemented in later versions.
...
</code></pre><ul>
<li>notice that the outputs of the two containers are interleaved</li>
</ul>
</li>
<li>
<p>Example of <code>docker ps</code> logs:</p>
<pre tabindex="0"><code>CONTAINER ID   IMAGE              COMMAND                  CREATED         STATUS                   PORTS                                   NAMES
4691a9641135   wordpress:latest   "docker-entrypoint.s…"   9 minutes ago   Up 9 minutes             0.0.0.0:8000-&gt;80/tcp, :::8000-&gt;80/tcp   your-dir-wordpress-1
314feb9d42ab   mariadb:latest     "docker-entrypoint.s…"   9 minutes ago   Up 9 minutes (healthy)   3306/tcp                                your-dir-db-1
</code></pre></li>
<li>
<p>Example of <code>docker network ls</code> logs:</p>
<pre tabindex="0"><code>NETWORK ID     NAME                 DRIVER    SCOPE
b304d1ae5404   bridge               bridge    local
1bb39315ff98   host                 host      local
03c8700dee6a   none                 null      local
470d81d26296   your-dir_back-tier   bridge    local
</code></pre></li>
</ul>
</section><section>
<h2 id="working-example-pt-3">Working example (pt. 3)</h2>

<div class="multiCol">
    

<div class="col  ">
    <h3 id="lets-make-the-stack-more-secure">Let’s make the stack more secure</h3>
<ol>
<li>
<p>Let’s create a file containing the DB root password, say <code>db-root-password.txt</code>:</p>
<ul>
<li><code>echo -n "..Password1.." &gt; your-dir/db-root-password.txt</code></li>
</ul>
</li>
<li>
<p>Let’s create a file containing the DB user password, say <code>db-password.txt</code>:</p>
<ul>
<li><code>echo -n ",,Password2,," &gt; your-dir/db-password.txt</code></li>
</ul>
</li>
<li>
<p>Let’s edit the stack as described on the right</p>
</li>
</ol>

</div>

<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"3.9"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">MYSQL_ROOT_PASSWORD_FILE</span>:<span style="color:#bbb"> </span>/run/secrets/db_root_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">MYSQL_PASSWORD_FILE</span>:<span style="color:#bbb"> </span>/run/secrets/db_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...    <span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db_root_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">wordpress</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">environment</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">WORDPRESS_DB_PASSWORD_FILE</span>:<span style="color:#bbb"> </span>/run/secrets/db_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db_password<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db_data</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">wordpress_data</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">back-tier</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">secrets</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db_password</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">file</span>:<span style="color:#bbb"> </span>db_password.txt<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db_root_password</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">file</span>:<span style="color:#bbb"> </span>db_root_password.txt<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="docker-compose-for-testing">Docker Compose for testing</h2>
<ul>
<li>
<p>Docker Compose is also useful for software <strong>testing</strong></p>
</li>
<li>
<p>E.g. whenever the system under test relies on some <em>infrastructural component</em></p>
<ul>
<li>e.g. a database, a message broker, a cache, etc.</li>
</ul>
</li>
<li>
<p>Usual workflow for testing:</p>
<ol>
<li><strong>start</strong> the component</li>
<li><strong>run</strong> the system under test</li>
<li><strong>stop</strong> the component</li>
</ol>
</li>
<li>
<p>Docker Compose may be coupled with some <strong>test framework</strong> of choice to <strong>automate</strong> the process</p>
</li>
</ul>
</section><section>
<h2 id="example-docker-compose-for-testing--junit-pt-1">Example: Docker Compose for testing + JUnit (pt. 1)</h2>
<h3 id="domain-model">Domain model</h3>

<figure id="plantuml-figure-13" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
    
interface Customer {
    + id: CustomerID
    + firstName: String 
    + lastName: String
    + birthDate: LocalDate
    ...
    + name: String
    + isPerson: Boolean
    + isCompany: Boolean
}
note bottom: Entity

interface CustomerID {
    + value: Any
}
note right: Value Object

interface TaxCode {
    + value: String
}
note left: Value Object

interface VatNumber {
    + value: Long
}
note right: Value Object

VatNumber -d-|&gt; CustomerID
TaxCode -d-|&gt; CustomerID

Customer *-r- CustomerID

interface CustomerRepository {
    + findById(id: CustomerID): Iterable<customer>
    + findByName(name: String): Iterable<customer>
    + add(customer: Customer)
    + update(oldId: CustomerID, customer: Customer)
    + remove(id: CustomerID)
}
note left: Repository

CustomerRepository o-r- Customer


</customer></customer></figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-13");
</script>

</section><section>
<h2 id="example-docker-compose-for-testing--junit-pt-2">Example: Docker Compose for testing + JUnit (pt. 2)</h2>
<h3 id="implementation-details">Implementation details</h3>

<figure id="plantuml-figure-14" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
    

interface CustomerRepository {
    + findById(id: CustomerID): Iterable<customer>
    + findByName(name: String): Iterable<customer>
    + add(customer: Customer)
    + update(oldId: CustomerID, customer: Customer)
    + remove(id: CustomerID)
}

class SqlCustomerRepository {
    - connections: ConnectionFactory
    - tableName: String
    + createTable(replaceIfPresent: Boolean = false)
}

SqlCustomerRepository --|&gt; CustomerRepository

package "db" {
    interface ConnectionFactory {
        + connect(): Connection
    }
    interface MariaDB {
        + database: String
        + username: String
        + password: String
        + host: String
        + port: Int
    }
    class MariaDBConnection
    MariaDBConnection --|&gt; MariaDB
    MariaDBConnectionFactory --|&gt; ConnectionFactory
    MariaDBConnectionFactory ..&gt; MariaDBConnection: creates
}

SqlCustomerRepository .r.&gt; MariaDBConnectionFactory: uses

package "java sql" {
    interface Connection
    ConnectionFactory ..&gt; Connection: creates
    MariaDBConnection --|&gt; Connection
}


</customer></customer></figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-14");
</script>

</section><section>
<h2 id="example-docker-compose-for-testing--junit-pt-3">Example: Docker Compose for testing + JUnit (pt. 3)</h2>

<div class="multiCol">
    

<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">TestMariaDBCustomerRepository</span> {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">companion</span> <span style="color:#080;font-weight:bold">object</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#555">@BeforeClass</span> <span style="color:#555">@JvmStatic</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">setUpMariaDb</span>() { TODO(<span style="color:#d20;background-color:#fff0f0">"start MariaDB via Docker Compose"</span>) }
</span></span><span style="display:flex;"><span>        <span style="color:#555">@AfterClass</span> <span style="color:#555">@JvmStatic</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">tearDownMariaDb</span>() { TODO(<span style="color:#d20;background-color:#fff0f0">"stop MariaDB via Docker Compose"</span>) }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">connectionFactory</span> = MariaDBConnectionFactory(DATABASE, USER, PASSWORD, HOST, PORT)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">lateinit</span> <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">repository</span>: SqlCustomerRepository
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@Before</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">createFreshTable</span>() {
</span></span><span style="display:flex;"><span>        repository = SqlCustomerRepository(connectionFactory, TABLE)
</span></span><span style="display:flex;"><span>        repository.createTable(replaceIfPresent = <span style="color:#080;font-weight:bold">true</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">taxCode</span> = TaxCode(<span style="color:#d20;background-color:#fff0f0">"CTTGNN92D07D468M"</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">person</span> = <span style="color:#b06;font-weight:bold">Customer</span>.person(taxCode, <span style="color:#d20;background-color:#fff0f0">"Giovanni"</span>, <span style="color:#d20;background-color:#fff0f0">"Ciatto"</span>, <span style="color:#b06;font-weight:bold">LocalDate</span>.of(<span style="color:#00d;font-weight:bold">1992</span>, <span style="color:#00d;font-weight:bold">4</span>, <span style="color:#00d;font-weight:bold">7</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">person2</span> = person.clone(birthDate = <span style="color:#b06;font-weight:bold">LocalDate</span>.of(<span style="color:#00d;font-weight:bold">1992</span>, <span style="color:#00d;font-weight:bold">4</span>, <span style="color:#00d;font-weight:bold">8</span>), id = TaxCode(<span style="color:#d20;background-color:#fff0f0">"CTTGNN92D08D468M"</span>))
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">vatNumber</span> = VatNumber(<span style="color:#00d;font-weight:bold">12345678987L</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">company</span> = <span style="color:#b06;font-weight:bold">Customer</span>.company(vatNumber, <span style="color:#d20;background-color:#fff0f0">"ACME"</span>, <span style="color:#d20;background-color:#fff0f0">"Inc."</span>, <span style="color:#b06;font-weight:bold">LocalDate</span>.of(<span style="color:#00d;font-weight:bold">1920</span>, <span style="color:#00d;font-weight:bold">1</span>, <span style="color:#00d;font-weight:bold">1</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@Test</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">complexTestWhichShouldActuallyBeDecomposedInSmallerTests</span>() {
</span></span><span style="display:flex;"><span>        assertEquals(
</span></span><span style="display:flex;"><span>            expected = emptyList(),
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">actual</span> = repository.findById(taxCode),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        assertEquals(
</span></span><span style="display:flex;"><span>            expected = emptyList(),
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">actual</span> = repository.findById(vatNumber),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        repository.add(person)
</span></span><span style="display:flex;"><span>        repository.add(company)
</span></span><span style="display:flex;"><span>        assertEquals(
</span></span><span style="display:flex;"><span>            expected = listOf(person),
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">actual</span> = repository.findById(taxCode),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        assertEquals(
</span></span><span style="display:flex;"><span>            expected = listOf(company),
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">actual</span> = repository.findById(vatNumber),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        repository.remove(vatNumber)
</span></span><span style="display:flex;"><span>        repository.update(taxCode, person2)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

<div class="col  ">
    <ul>
<li>
<p>Unit thest for the <code>SqlCustomerRepository</code> class</p>
</li>
<li>
<p>Requires an instance of MariaDB to be tested</p>
</li>
<li>
<p>Let’s use Docker Compose to start / stop MariaDB</p>
</li>
<li>
<p>Try to complete the implementation of the <code>setUpMariaDb</code> and <code>tearDownMariaDb</code> methods</p>
<ul>
<li>use Java’s <code>ProcessBuilder</code>s to call <code>docker compose</code> commands</li>
</ul>
</li>
<li>
<p>Template for Docker Compose files available among test resources</p>
<ul>
<li><a href="https://github.com/unibo-spe/docker-compose-testing/blob/exercise/src/test/resources/it/unibo/spe/compose/docker-compose.yml.template"><code>docker-compose.yml.template</code></a>
<ul>
<li>does it require edits? why?</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Code for the exercise:</p>
<ul>
<li><a href="https://github.com/unibo-spe/docker-compose-testing">https://github.com/unibo-spe/docker-compose-testing</a></li>
</ul>
</li>
</ul>

</div>

</div>

</section><section>
<h1 id="orchestration-1">Orchestration</h1>
<h2 id="with-docker-swarm">With Docker Swarm</h2>
</section><section>
<h2 id="building-the-cluster-theory">Building the cluster (theory)</h2>
<ul>
<li>In a Docker Swarm cluster, there are two kinds of nodes:
<ul>
<li><strong>manager</strong> nodes, who coordinate the cluster by means of the <a href="https://docs.docker.com/engine/swarm/raft/">RAFT consensus protocol</a>
<ul>
<li>they may also act as worker nodes</li>
</ul>
</li>
<li><strong>worker</strong> nodes, who simply run containers</li>
</ul>
</li>
</ul>
<br>
<ul>
<li>To set up a cluster, one must:
<ol>
<li><strong>initialise</strong> Swarm mode on <em>one node of choice</em>
<ul>
<li>that will become the first <strong>manager</strong> node</li>
</ul>
</li>
<li>optionally, let other nodes <strong>join</strong> the cluster as worker nodes</li>
<li>optionally, <strong>elevate</strong> some worker nodes to manager nodes
<ul>
<li>this operation can <em>only</em> be done by a client connected to some <em>manager</em> node</li>
<li>it is better to <strong>multiple</strong> manager nodes for redundancy</li>
<li>it is better to have an <strong>odd</strong> number of manager nodes
<ul>
<li>e.g. 3, 5, 7, etc.</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="building-the-cluster-practice">Building the cluster (practice)</h2>
<ol>
<li>
<p>On one node running the Docker deamon (say, the teacher’s machine), initialise Swarm mode as follows:</p>
<ul>
<li><code>docker swarm init</code></li>
<li>this will output a command to be run on other nodes to join the cluster:
<pre tabindex="0"><code>Swarm initialized: current node (&lt;NODE_ID&gt;) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token &lt;SECRET_TOKEN&gt; &lt;NODE_ADDRESS&gt;:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
</code></pre></li>
</ul>
</li>
<li>
<p>On other nodes running the Docker daemon (say students’ machines), initialise Swarm mode as follows:</p>
<ul>
<li><code>docker swarm join --token &lt;SECRET_TOKEN&gt; &lt;NODE_ADDRESS&gt;:2377</code>
<ul>
<li>where <code>SECRET_TOKEN</code> and <code>NODE_ADDRESS</code> are the ones provided by the <code>docker swarm init</code> command above</li>
</ul>
</li>
</ul>
</li>
<li>
<p>On the master node, one may inspect the node composition of the cluster via <code>docker node ls</code></p>
<pre tabindex="0"><code>ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
4q3q3q3q3q3q3q3q3q3q3q3q3q *  node-1              Ready               Active              Leader              24.0.7
5q4q4q4q4q4q4q4q4q4q4q4q4q    node-2              Ready               Active                                  24.0.7
6q5q5q5q5q5q5q5q5q5q5q5q5q    node-3              Ready               Active                                  24.0.7
</code></pre></li>
<li>
<p>The master node may <strong>promote</strong> other nodes to manager nodes via <code>docker node promote &lt;NODE_ID&gt;</code>…</p>
<ul>
<li>and it may <strong>demote</strong> manager nodes to worker nodes via <code>docker node demote &lt;NODE_ID&gt;</code></li>
<li>it also may <strong>remove</strong> nodes from the cluster via <code>docker node rm &lt;NODE_ID&gt;</code></li>
</ul>
</li>
<li>
<p>Whenever done with this lecture, one may leave the Swarm via <code>docker swarm leave --force</code></p>
<ul>
<li><em>recall to do this after the lecture</em>, otherwise you won’t be able to use Swarm at home!</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="building-the-cluster-troubleshooting">Building the cluster (troubleshooting)</h2>
<h3 id="things-that-may-go-wrong">Things that may go wrong</h3>
<ol>
<li>
<p>There may be a firewall blocking the communication among nodes</p>
<ul>
<li>e.g. Windows Defender, the lab’s firewall, your home router’s firewall, etc.</li>
<li>you may notice the presence of a firewall by the fact that <code>docker swarm join</code> hangs or fails with a timeout
<ul>
<li>in lack of a firewall, the command should succeed or fail almost immediately</li>
</ul>
</li>
<li>troubleshouting:
<ol>
<li>identify which and how many firewalls are in place</li>
<li>ensure that the firewall allows communication for <a href="https://docs.docker.com/engine/swarm/swarm-tutorial/#open-protocols-and-ports-between-the-hosts">Docker Swarm ports</a>
<ul>
<li>commonly: <code>2377/tcp</code>, <code>7946/tcp</code>, <code>7946/udp</code>, <code>4789/udp</code></li>
</ul>
</li>
</ol>
</li>
</ul>
</li>
<li>
<p>You use Docker on <em>Windows or Mac</em>, hence the Docker daemon runs on a <em>virtual machine</em></p>
<ul>
<li>in this chase the IP of the virtual machine is different than the IP of your machine</li>
<li>the <code>NODE_ADDRESS</code> in <code>docker swarm join --token &lt;SECRET_TOKEN&gt; &lt;NODE_ADDRESS&gt;:2377</code> returned by <code>docker swarm init</code> is the IP of the virtual machine</li>
<li>troubleshouting:
<ol>
<li>find the actual IP of your machine (e.g. <code>ipconfig</code> on Windows, <code>ifconfig</code> on Mac), let’s call it <code>ACTUAL_IP</code></li>
<li>configure your host to redirect Swarm traffic received by <code>ACTUAL_IP</code> towards <code>NODE_ADDRESS</code>
<ul>
<li>for all ports listed above (<code>2377</code>, <code>7946</code>, <code>4789</code>)</li>
</ul>
</li>
<li>let other nodes use <code>ACTUAL_IP</code> insteaf of <code>NODE_ADDRESS</code> in <code>docker swarm join</code> when joining the cluster</li>
</ol>
</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="troubleshouting-example-on-windows">Troubleshouting example on Windows</h2>
<h3 id="opening-ports-on-windows-defender">Opening ports on Windows Defender</h3>
<p>On an administrator Powershell, run the following commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>netsh advfirewall firewall add rule name=<span style="color:#d20;background-color:#fff0f0">"Docker Swarm Intra-manager"</span> dir=<span style="color:#080;font-weight:bold">in</span> action=allow protocol=TCP localport=<span style="color:#00d;font-weight:bold">2377</span>
</span></span><span style="display:flex;"><span>netsh advfirewall firewall add rule name=<span style="color:#d20;background-color:#fff0f0">"Docker Swarm Overlay Network Discovery TCP"</span> dir=<span style="color:#080;font-weight:bold">in</span> action=allow protocol=TCP localport=<span style="color:#00d;font-weight:bold">7946</span>
</span></span><span style="display:flex;"><span>netsh advfirewall firewall add rule name=<span style="color:#d20;background-color:#fff0f0">"Docker Swarm Overlay Network Discovery UDP"</span> dir=<span style="color:#080;font-weight:bold">in</span> action=allow protocol=UDP localport=<span style="color:#00d;font-weight:bold">7946</span>
</span></span><span style="display:flex;"><span>netsh advfirewall firewall add rule name=<span style="color:#d20;background-color:#fff0f0">"Docker Swarm Overlay Network Traffic"</span> dir=<span style="color:#080;font-weight:bold">in</span> action=allow protocol=UDP localport=<span style="color:#00d;font-weight:bold">4789</span>
</span></span></code></pre></div><ul>
<li>this operation should be done on all nodes of the cluster running on Windows</li>
</ul>
<h3 id="forwarding-ports-on-windows">Forwarding ports on Windows</h3>
<p>On an administrator Powershell, run the following commands:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>netsh interface portproxy add v4tov4 listenport=<span style="color:#00d;font-weight:bold">2377</span> listenaddress=<span style="color:#369">$ACTUAL_IP</span> connectport=<span style="color:#00d;font-weight:bold">2377</span> connectaddress=<span style="color:#369">$NODE_ADDRESS</span>
</span></span><span style="display:flex;"><span>netsh interface portproxy add v4tov4 listenport=<span style="color:#00d;font-weight:bold">7946</span> listenaddress=<span style="color:#369">$ACTUAL_IP</span> connectport=<span style="color:#00d;font-weight:bold">7946</span> connectaddress=<span style="color:#369">$NODE_ADDRESS</span>
</span></span><span style="display:flex;"><span>netsh interface portproxy add v4tov4 listenport=<span style="color:#00d;font-weight:bold">4789</span> listenaddress=<span style="color:#369">$ACTUAL_IP</span> connectport=<span style="color:#00d;font-weight:bold">4789</span> connectaddress=<span style="color:#369">$NODE_ADDRESS</span>
</span></span></code></pre></div><ul>
<li>this operation should be done on the very first master node of the cluster, if it’s running on Windows</li>
</ul>
</section><section>
<h2 id="stacks-on-swarms">Stacks on Swarms</h2>
<ul>
<li>
<p>One may deploy a stack on a Swarm cluster via <code>docker stack deploy -c &lt;COMPOSE_FILE_PATH&gt; &lt;STACK_NAME&gt;</code></p>
<ul>
<li>where <code>COMPOSE_FILE_PATH</code> is the path to a <code>.yml</code> file following the Docker Compose syntax</li>
<li>and <code>STACK_NAME</code> is the name of the stack to be deployed</li>
</ul>
</li>
<li>
<p>The command must be run on a client connected to some <strong>manager</strong> node</p>
<ul>
<li>try to run it on a <em>worker</em> node and see what happens</li>
<li>try to run it on a <em>manager</em> node when <em>50% of the nodes are down</em> and see what happens</li>
</ul>
</li>
<li>
<p>Other operations one may do on stacks (via a master node):</p>
<ul>
<li><code>docker stack ls</code> to list stacks</li>
<li><code>docker stack ps &lt;STACK_NAME&gt;</code> to list containers in a stack</li>
<li><code>docker stack services &lt;STACK_NAME&gt;</code> to list services in a stack</li>
<li><code>docker stack rm &lt;STACK_NAME&gt;</code> to remove a stack</li>
</ul>
</li>
<li>
<p>Semantics of stack <em>deployment</em> on Swarms is <strong>different than Docker Compose</strong>:</p>
<ul>
<li>different services may be <strong>allocated</strong> on different nodes</li>
<li>services may be <strong>replicated</strong> on different nodes</li>
<li>networks must rely on the <code>overlay</code> driver, to support inter-node communication among containers</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="stack-deploy-example-portainerhttpswwwportainerio">Stack Deploy Example: <a href="https://www.portainer.io/">Portainer</a></h2>

<div class="multiCol">
    

<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">'3.2'</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">agent</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>portainer/agent:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- /var/run/docker.sock:/var/run/docker.sock<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- /var/lib/docker/volumes:/var/lib/docker/volumes<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- agents_network<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">mode</span>:<span style="color:#bbb"> </span>global<span style="color:#bbb"> </span><span style="color:#888"># i.e., one (and only one) replica per node</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">webservice</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>portainer/portainer-ce:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">command</span>:<span style="color:#bbb"> </span>-H tcp://tasks.agent:9001 --tlsskipverify<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"443:9443"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"9000:9000"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"8000:8000"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- portainer_data:/data<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- agents_network<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">mode</span>:<span style="color:#bbb"> </span>replicated<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">placement</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">constraints</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.role == manager<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">agents_network</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">driver</span>:<span style="color:#bbb"> </span>overlay<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">attachable</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">true</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">portainer_data</span>:<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

<div class="col  ">
    <ul>
<li>
<p>Portainer is a Web-based dashboard for cluster administration</p>
<ul>
<li>it works with both Docker Swarm and Kubernetes</li>
</ul>
</li>
<li>
<p>It is composed of two services:</p>
<ul>
<li><code>webservice</code>, the actual dashboard</li>
<li><code>agent</code>, a service running on each node, which exposes the Docker API to the <code>webservice</code> service</li>
</ul>
</li>
</ul>
<br>
<ol>
<li>
<p>Let’s save the code on the left in a file named <code>portainer.yml</code></p>
</li>
<li>
<p>Let’s deploy the stack via <code>docker stack deploy -c portainer.yml portainer</code></p>
</li>
<li>
<p>Let’s then browse to <a href="https://localhost">https://localhost</a> on some master node</p>
</li>
</ol>

</div>

</div>

</section><section>
<h2 id="portainers-initial-configuration">Portainer’s Initial Configuration</h2>
<figure><img src="/09-containerization/portainer-setup.png" width="50%">
</figure>

<p>let’s use <code>software-process-engineering</code> as password for the <code>admin</code> user</p>
</section><section>
<h2 id="portainers-home-page">Portainer’s Home Page</h2>
<p>Upon login, one is presented with the <em>home page</em>, asking you to select one <strong>enviroment</strong></p>
<ul>
<li><strong>environments</strong> are clusters (one Portainer instance may manage multiple clusters)</li>
</ul>
<figure><img src="/09-containerization/portainer-hello.png" width="50%">
</figure>

</section><section>
<h2 id="portainers-dashboard">Portainer’s Dashboard</h2>
<p>Upon environment selection, one is presented with the <em>dashboard</em>, showing the <strong>status of the cluster</strong></p>
<figure><img src="/09-containerization/portainer-dashboard.png" width="50%">
</figure>

</section><section>
<h2 id="things-to-notice-via-portainer">Things to notice via Portainer</h2>
<p>After selecting the only environment available, one may observe:</p>
<ul>
<li>
<p>which and how many <strong>nodes</strong> compose the cluster (<em>Dashboard</em> section)</p>
<ul>
<li>you may use the <em>cluster visualiser</em> to spot your machien in the cluster
<ul>
<li>(assuming that you managed to join the cluster)</li>
</ul>
</li>
</ul>
</li>
<li>
<p>which <strong>stacks</strong> are running on the cluster (<em>Services</em> section)</p>
<ul>
<li>you may observe that the <code>portainer</code> stack is running</li>
</ul>
</li>
<li>
<p>which <strong>services</strong> are running on the cluster (<em>Services</em> section)</p>
<ul>
<li>you may observe that the <code>portainer</code> stack is composed of two services: <code>agent</code> and <code>webservice</code></li>
</ul>
</li>
<li>
<p>which <strong>containers</strong> are running on the cluster (<em>Containers</em> section)</p>
<ul>
<li>you may observe that the <code>portainer_agent</code> service is composed by <em>one container per node</em></li>
<li>you may observe that the <code>portainer_webservice</code> service is composed by <em>one container</em> which is <em>running on some master node</em></li>
</ul>
</li>
<li>
<p>which <strong>volumes</strong> are present on the cluster (<em>Volumes</em> section)</p>
<ul>
<li>you may observe that the <code>portainer_portainer_data</code> volume is present <em>on the same master node</em> of <code>portainer_webservice</code></li>
</ul>
</li>
<li>
<p>which <strong>networks</strong> are present on the cluster (<em>Networks</em> section)</p>
<ul>
<li>you may observe that the <code>portainer_agents_network</code> network is present, using the <code>overlay</code> driver</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="labelling-nodes">Labelling nodes</h2>
<blockquote>
<p>Nodes may be <strong>labelled</strong> with <code>key=value</code> pairs</p>
</blockquote>
<ul>
<li>
<p>Labels may be used to <strong>mark nodes</strong> with respect to their <strong>properties</strong></p>
<ul>
<li>e.g. hardware / software <strong>capabilities</strong>
<ul>
<li>e.g. <code>capabilities.cpu=yes</code></li>
<li>e.g. <code>capabilities.web=yes</code></li>
<li>e.g. <code>capabilities.storage=yes</code></li>
</ul>
</li>
</ul>
</li>
<li>
<p>This can be done <em>programmatically</em>….</p>
<ul>
<li>e.g. via <code>docker node update --label-add KEY=VALUE NODE_ID</code></li>
</ul>
</li>
<li>
<p>… or via <strong>Portainer</strong>:</p>
<figure><img src="/09-containerization/portainer-node-labels.png" width="50%">
    </figure>

</li>
<li>
<p>labels can be used to set <em>placement</em> <strong>constraints</strong> or <strong>preferences</strong> for services:</p>
<ul>
<li>placement <em>constraints</em>: one service can only be deployed onto nodes with given labels</li>
<li>placement <em>preferences</em>: one service’s <em>replicas</em> will be <em>spreaded</em> among nodes with given labels</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="example-of-placement-constraints">Example of placement constraints</h2>

<div class="multiCol">
    

<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"3.9"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>mariadb:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">placement</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">constraints</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.labels.capabilities.storage==yes<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">wordpress</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">depends_on</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- db<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>wordpress:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"8889:80"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">placement</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">constraints</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.labels.capabilities.web==yes<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">db_data</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">wordpress_data</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">networks</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">back-tier</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

<div class="col  ">
    <ul>
<li>
<p>Let’s define a stack for Wordpress, with <strong>placement constraints</strong></p>
<ul>
<li><code>db</code> service on a node with <em>storage</em> capabilities</li>
<li><code>wordpress</code> service on a node with <em>web</em> capabilities</li>
</ul>
</li>
<li>
<p>On the <code>starwai</code> cluster:</p>
<ul>
<li>node <code>storage1.stairwai.ce.almaai.unibo.it</code> has <em>storage</em> capabilities</li>
<li>node <code>inference2.stairwai.ce.almaai.unibo.it</code> has <em>web</em> capabilities</li>
</ul>
</li>
<li>
<p>The deployment is as follows:
<img src="./portainer-wordpress-services.png" alt="Deployment with labels"></p>
</li>
</ul>

</div>

</div>

</section><section>
<h2 id="exposing-ports-on-the-swarm">Exposing ports on the Swarm</h2>
<p>When a service <em>exposes a port</em>, and that’s deployed on a <em>Swarm</em>:</p>
<ul>
<li>
<p>the service is exposed on <strong>all master nodes</strong> in the Swarm</p>
</li>
<li>
<p>so, the <code>wordpress</code> service above could be visited from several URL:</p>
<ul>
<li><a href="http://storage1.stairwai.ce.almaai.unibo.it:8889">http://storage1.stairwai.ce.almaai.unibo.it:8889</a></li>
<li><a href="http://inference1.stairwai.ce.almaai.unibo.it:8889">http://inference1.stairwai.ce.almaai.unibo.it:8889</a></li>
<li><a href="http://inference4.stairwai.ce.almaai.unibo.it:8889">http://inference4.stairwai.ce.almaai.unibo.it:8889</a></li>
</ul>
</li>
<li>
<p>… as well as from the node which is actually hosting the service:</p>
<ul>
<li><a href="http://inference2.stairwai.ce.almaai.unibo.it:8889">http://inference2.stairwai.ce.almaai.unibo.it:8889</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="service-replication">Service replication</h2>
<ul>
<li>
<p>Services may be <strong>replicated</strong> for the sake scalability / load-balancing / fault-tolerance, etc.</p>
</li>
<li>
<p>Two types of services:</p>
<ul>
<li><code>global</code>: replicated <em>exactly</em> <strong>once per node</strong></li>
<li><code>replicated</code>: replicated <code>N</code> times (with <code>N=1</code> by <em>default</em>)</li>
</ul>
</li>
<li>
<p>General case:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">service-name</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>...<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">mode</span>:<span style="color:#bbb"> </span>replicated<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">N</span><span style="color:#bbb">                  </span><span style="color:#888"># this should be a number!</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">placement</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">constraints</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.role == manager<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.labels.mylabel=myvalue<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">preferences</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#b06;font-weight:bold">spread</span>:<span style="color:#bbb"> </span>node.labels.mylabel<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">max_replicas_per_node</span>:<span style="color:#bbb"> </span>M     <span style="color:#bbb"> </span><span style="color:#888"># this should be a number!</span><span style="color:#bbb">
</span></span></span></code></pre></div></li>
<li>
<p>How to read it:</p>
<ul>
<li><code>N</code> replicas of the service will be deployed</li>
<li>each one will be deployed on a <strong>manager node</strong> having the <code>mylabel</code> label set to <code>myvalue</code></li>
<li>replicas will be evenly <em>spreaded</em> among the admissible nodes, possibly <em>evenly</em></li>
<li>no more of <code>M</code> replicas will be put on the same node</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="example-of-placement-preferences">Example of placement preferences</h2>

<div class="multiCol">
    

<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"3.9"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">ws</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>pikalab/hitcounter:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">ports</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#d20;background-color:#fff0f0">"8890:8080"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">10</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">placement</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">constraints</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.labels.capabilities.cpu==yes<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">preferences</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- <span style="color:#b06;font-weight:bold">spread</span>:<span style="color:#bbb"> </span>node.labels.capabilities.cpu<span style="color:#bbb">
</span></span></span></code></pre></div><br>
<ol start="2">
<li>
<p>Try to query it multiple times:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">while</span> true; <span style="color:#080;font-weight:bold">do</span>                                                                                                                                                                     INT ✘ 
</span></span><span style="display:flex;"><span>    curl http://clusters.almaai.unibo.it:8890; 
</span></span><span style="display:flex;"><span>    <span style="color:#038">echo</span> 
</span></span><span style="display:flex;"><span>    sleep <span style="color:#00d;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">done</span>
</span></span></code></pre></div><p>expected outcome:</p>
<pre tabindex="0"><code>[9a6f89a39f8fd379@a3838ab6a606:8080] Hit 1 times
[26c39b9f3d7f0cab@4ad25c3e148c:8080] Hit 1 times
[97945332d20e71ed@969586109dee:8080] Hit 1 times
[3b3256852103312a@5d3479044fac:8080] Hit 2 times
[49e75aaae823c1e4@36e31b946486:8080] Hit 2 times
[497583c21d17ad58@7c10a84858f3:8080] Hit 2 times
[cf82689c910dfdf3@8aaa34535824:8080] Hit 2 times
[9a456666c413f4a4@5ba876916f68:8080] Hit 2 times
[41cadc9e0d7b0225@6cf54f65cda6:8080] Hit 2 times
[84dbbff08ac91e74@4006352af1e0:8080] Hit 2 times
[9a6f89a39f8fd379@a3838ab6a606:8080] Hit 2 times
[26c39b9f3d7f0cab@4ad25c3e148c:8080] Hit 2 times
[97945332d20e71ed@969586109dee:8080] Hit 2 times
[3b3256852103312a@5d3479044fac:8080] Hit 3 times
[49e75aaae823c1e4@36e31b946486:8080] Hit 3 times
...
</code></pre></li>
</ol>

</div>

<div class="col  ">
    <ol>
<li>
<p>Serval replicas of the same service are created:</p>
<p><img src="./portainer-replicated-service.png" alt="Deployment with replicas"></p>
</li>
</ol>
<br>
<ol start="3">
<li>Requests will be forwarded to replicas in a <strong>non-deterministc</strong> fashion</li>
</ol>

</div>

</div>

</section><section>
<h2 id="docker-swarm-and-volumes">Docker Swarm and Volumes</h2>

<div class="multiCol">
    

<div class="col  ">
    <blockquote>
<p>Volumes are <strong>always local</strong> w.r.t. the node the current container is deployed onto</p>
</blockquote>
<br>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#b06;font-weight:bold">version</span>:<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"3.9"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">services</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">  </span><span style="color:#b06;font-weight:bold">simulation</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">image</span>:<span style="color:#bbb"> </span>pikalab/fakesim:latest<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">restart</span>:<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">on</span>-failure<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">deploy</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">replicas</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">3</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span><span style="color:#b06;font-weight:bold">placement</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">constraints</span>:<span style="color:#bbb"> 
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">          </span>- node.labels.capabilities.cpu==yes<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">max_replicas_per_node</span>:<span style="color:#bbb"> </span><span style="color:#00d;font-weight:bold">1</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">      </span>- <span style="color:#b06;font-weight:bold">type</span>:<span style="color:#bbb"> </span>volume<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">source</span>:<span style="color:#bbb"> </span>shared_volume<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#b06;font-weight:bold">target</span>:<span style="color:#bbb"> </span>/data<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#b06;font-weight:bold">volumes</span>:<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#b06;font-weight:bold">shared_volume</span>:<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>

<div class="col  ">
    <ol>
<li>
<p>Several replicas of the simulation are created…</p>
<p><img src="./portainer-fake-simulation.png" alt="Deployment with replicas"></p>
</li>
<li>
<p>… as well as several volumes!</p>
<p><img src="./portainer-fake-simulation-volumes.png" alt="Deployment with replicas"></p>
<ul>
<li>one per replica, on the same node of the replica</li>
</ul>
</li>
<li>
<p>How to share data?</p>
</li>
</ol>

</div>

</div>

</section>

  


</div>
      

    </div>
<script type="text/javascript" src="/reveal-hugo/object-assign.js"></script>

<a href="/reveal-js/dist/print/" id="print-location" style="display: none;"></a>

<script type="application/json" id="reveal-hugo-site-params">{"custom_theme":"custom-theme.scss","custom_theme_compile":true,"height":"1080","history":true,"mermaid":[{"fontFamily":"Inconsolata","gitGraph":{"mainBranchName":"master","rotateCommitLabel":true},"startOnLoad":false,"theme":"default","useMaxWidth":false}],"pdfseparatefragments":false,"slide_number":true,"theme":"white","transition":"slide","transition_speed":"fast","width":"1920"}</script>
<script type="application/json" id="reveal-hugo-page-params">{"custom_theme_options":{"enablesourcemap":true,"targetpath":"css/custom-theme.css"}}</script>

<script src="/reveal-js/dist/reveal.js"></script>


  
  
  <script type="text/javascript" src="/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/zoom/zoom.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/notes/notes.js"></script>
  
  
  <script type="text/javascript" src="/reveal-js/plugin/notes/notes.js"></script>




<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };

  var revealHugoPlugins = {
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom ]
   };
  var revealHugoSiteParams = JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);
  var revealHugoPageParams = JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);
  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins));
  Reveal.initialize(options);
</script>







  
    
  
  

  
    
  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  



  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({"fontFamily":"Inconsolata","gitGraph":{"mainBranchName":"master","rotateCommitLabel":true},"startOnLoad":false,"theme":"default","useMaxWidth":false});

    let render = (event) => {
      let mermaidElems = event.currentSlide.querySelectorAll('.mermaid');
      if (!mermaidElems.length){
          return
      }
      mermaidElems.forEach(mermaidElem => {
          let processed = mermaidElem.getAttribute('data-processed');
          if (!processed){
              
              mermaid.init(undefined, mermaidElem);
          }
      });
    };
    
    render({currentSlide: Reveal.getCurrentSlide()});

    Reveal.on('slidechanged', render);
    Reveal.on('ready', render);
  </script>



    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
</script>

<script type="text/javascript" id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

<script>
  if (/.*?(\?|&)print-pdf/.test(window.location.toString())) {
      var ytVideos = document.getElementsByTagName("iframe")
      for (let i = 0; i < ytVideos.length; i++) {
          var videoFrame = ytVideos[i]
          var isYouTube = /^https?:\/\/(www.)youtube\.com\/.*/.test(videoFrame.src)
          if (isYouTube) {
              var div = videoFrame.parentElement
              var parent = div.parentElement
              videoFrame.remove()
              div.remove()
              var p = document.createElement('p')
              p.append(
                  document.createTextNode(
                      "There was an embedded video here, but it is disabled in the printed version of the slides."
                  )
              )
              p.append(document.createElement('br'))
              p.append(document.createTextNode("Visit instead:"))
              p.append(document.createElement('br'))
              const anchor1 = document.createElement('a');
              anchor1.href = videoFrame.src;
              anchor1.textContent = videoFrame.src;
              p.append(anchor1);
              p.append(document.createElement('br'))
              const altSrc = videoFrame.src.replace(
                  /(^https?:\/\/(www.)youtube\.com)\/(embed\/)(\w+).*/,
                  "https://www.youtube.com/watch?v=$4"
              );
              const anchor2 = document.createElement('a');
              anchor2.href = altSrc;
              anchor2.textContent = altSrc;
              p.append(document.createTextNode("or:"))
              p.append(document.createElement('br'))
              p.append(anchor2);
              p.append(document.createElement('br'))
              p.append(document.createTextNode("to watch the content."))
              parent.appendChild(p)
          }
      }
  }
</script>

    
  

</body></html>