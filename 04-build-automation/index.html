<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
<title>Build Automation</title>
<meta name="description" content="The art of letting machines do the job for you, with Gradle as example">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="/reveal-js/dist/reset.css">
<link rel="stylesheet" href="/reveal-js/dist/reveal.css">
  <link rel="stylesheet" href="/css/custom-theme.min.6a44d86464a459488af8a1a0352e2b78c31bfc6ab27751ac1ebc2f5881bf95d0.css" id="theme"><link rel="stylesheet" href="/highlight-js/default.min.css">
<link rel="stylesheet" href="https://raw.githubusercontent.com/DanySK/css-blur-animation/master/blur.css">
<link href="https://fonts.googleapis.com/css?family=Roboto Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Oxygen Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Ubuntu Mono" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.1/css/all.min.css">
<script src="https://unibo-spe.github.io//plantuml.js"></script>

  </head>
  <body>
    
    <div class="reveal">
      <div class="slides">
  

    <section><h1 id="build-automation">Build Automation</h1>
<h2 id="hahahugoshortcode1s0hbhb">Software Process Engineering</h2>
<br>
<h3 id="danilo-pianini"><a href="mailto:danilo.pianini@unibo.it">Danilo Pianini — <code>danilo.pianini@unibo.it</code></a></h3>
<br>
<p>Compiled on: 2025-11-03
 — <a href="?print-pdf&amp;pdfSeparateFragments=false"><i class="fa fa-print" aria-hidden="true"></i> printable version</a></p>
<p><a href=".."><i class="fa fa-undo" aria-hidden="true"></i> back</a></p>
</section><section>
<h1 id="overview">Overview</h1>
<ul>
<li>Build automation:
<ul>
<li>The software lifecycle</li>
<li>Automation styles</li>
</ul>
</li>
<li>Gradle as paradigmatic build automator
<ul>
<li>Core concepts and basics</li>
<li>Dependency management and configurations</li>
<li>The build system as a dependency</li>
<li>Hierarchial organization</li>
<li>Isolation of imperativity</li>
<li>Declarativity via DSLs</li>
<li>Reuse via plug-ins</li>
<li>Testing plug-ins</li>
<li>Existing plugins</li>
</ul>
</li>
</ul>
</section><section>
<!-- this file includes generated content. Do not edit. Edit content/04-build-automation/_generator.md, instead. -->
<h2 id="the-build-life-cycle">The build “life cycle”</h2>
<h4 id="not-to-be-confused-with-the-system-development-life-cycle-sdlc">(Not to be confused with the system development life cycle (SDLC))</h4>
<p>The process of creating <em>tested deployable software artifacts</em>
<br>
from <em>source</em> code</p>
<p>May include, depending on the system specifics:</p>
<ul>
<li><em>Source code manipulation</em> and generation</li>
<li>Source code <em>quality assurance</em></li>
<li><em>Dependency management</em></li>
<li><em>Compilation</em>, linking</li>
<li>Binary <em>quality assurance</em></li>
<li><em>Binary manipulation</em></li>
<li><em>Test execution</em></li>
<li>Test <em>quality assurance</em> (e.g., coverage)</li>
<li>API <em>documentation</em></li>
<li><em>Packaging</em></li>
<li><em>Delivery</em></li>
<li><em>Deployment</em></li>
</ul>
</section><section>
<h2 id="build-automation-1">Build automation</h2>
<p>Automation of the build lifecycle</p>
<ul>
<li>In principle, the lifecycle could be executed manually</li>
<li>In reality <em>time is precious</em> and <em>repetition is boring</em></li>
</ul>
<p>$\Rightarrow$ Create software that automates the building of some software!</p>
<ul>
<li>All those concerns that hold for software creation hold for build systems creation…</li>
</ul>
</section><section>
<h2 id="build-automation-basics-and-styles">Build automation: basics and styles</h2>
<p><strong>Imperative</strong>/<strong>Custom</strong>: write a script that tells the system what to do to get
from code to artifacts</p>
<ul>
<li><em>Examples</em>: make, cmake, Apache Ant</li>
<li><em>Abstraction gap</em>: verbose, repetitive</li>
<li>Configuration (<em>declarative</em>) and actionable (<em>imperative</em>) logics <em>mixed</em> together</li>
<li>Highly <em>configurable</em> and <em>flexible</em></li>
<li>Difficult to <em>adapt</em> and <em>port</em> across projects</li>
</ul>
<p><strong>Declarative</strong>/<strong>Standard</strong>: adhere to some convention, customizing some settings</p>
<ul>
<li><em>Examples</em>: Apache Maven, Python Poetry</li>
<li>Separation between <em>what</em> to do and <em>how</em> to do it
<ul>
<li>The build system decides how to do the stuff</li>
</ul>
</li>
<li>Easy to <em>adapt</em> and <em>port</em> across projects</li>
<li><em>Configuration limited</em> by the provided options</li>
</ul>
</section><section>
<h2 id="hybrid-automators">Hybrid automators</h2>
<p>Create a <em>declarative infrastructure</em> upon an <em>imperative basis</em>, and
<em>allow easy access to the underlying machinery</em></p>
<p><strong>DSL</strong>s are helpful in this context: they can “hide” imperativity without ruling it out</p>
<p>Still, many challenges remain open:</p>
<ul>
<li>How to reuse the build logic?
<ul>
<li>within a project, and among projects</li>
</ul>
</li>
<li>How to structure multiple logical and interdependent parts?</li>
</ul>
</section><section>
<!-- this file includes generated content. Do not edit. Edit content/04-build-automation/_generator.md, instead. -->
<h2 id="dependencies-in-software">Dependencies in software</h2>
<blockquote>
<p>nos esse quasi nanos gigantium humeris insidentes
<cite>Bernard of Chartres</cite></p>
</blockquote>
<p>All modern software depends on other software!</p>
<ul>
<li>the operating system</li>
<li>the runtime environment (e.g., the Java Virtual Machine, the Python interpreter…)</li>
<li>the base libraries</li>
<li>third-party libraries</li>
<li>external resources (icons, sounds, application data)</li>
</ul>
<p>All the software we build and use depends on other software</p>
<ul>
<li>Which depends on other software
<ul>
<li>Which depends on other software
<ul>
<li>Which depends on other software
<ul>
<li>Which depends on other software
<ul>
<li>Which depends on other software
<ul>
<li>Which depends on other software
<ul>
<li>Which depends on other software
<ul>
<li>…</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>$\Rightarrow$ Applications have a <strong>dependency</strong> tree!</p>
</section><section>
<h2 id="transitive-dependencies">Transitive dependencies</h2>
<p>Indirect dependencies (dependencies of dependencies) are called <em>transitive</em></p>
<p>In non-toy projects, transitive dependencies are the <em>majority</em></p>
<ul>
<li>It’s very easy to end up with more than 50 dependencies</li>
</ul>
<h4 id="complexity-quickly-gets-out-of-hand">Complexity quickly gets out of hand!</h4>
<p>We need a tool that can:</p>
<ul>
<li><em>Find</em> (for example in known archives) the libraries we need</li>
<li><em>Download</em> them (if found)</li>
<li>Include them into a discoverable path</li>
</ul>
<p>To do this, however, we need to know some repositories and how to refer and locate artifacts</p>
<ul>
<li>We need a <em>name</em> and a <em>version</em> for each library</li>
<li>There is no standard, <strong>every ecosystem has its own conventions</strong>
<ul>
<li>Some created with the programming language (e.g., Rust)</li>
<li>Some evolved later with the ecosystem (Maven for Java, npm for JavaScript…)</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="transitive-dependency-conflicts">Transitive dependency conflicts</h2>
<p>When two libraries depend on different versions of the same library, we have a <em>conflict</em></p>
<ul>
<li>e.g.: dependency <code>A</code> requires <code>B</code> at version <code>1</code>, dependency <code>C</code> requires <code>B</code> at version <code>2</code></li>
<li>How would you solve this conflict?
<ul>
<li>Pick the latest and hope for the best?</li>
<li>Pick the earliest and hope for the best?</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="dependency-ranges">Dependency ranges</h2>
<p>To reduce the risk of conflicts, some systems allow specifying <em>ranges</em> of acceptable versions</p>
<ul>
<li>A range is a <em>relaxed constraint</em> on the version specification</li>
</ul>
<h3 id="examples">Examples</h3>
<ul>
<li><strong>Maven</strong> (Java)
<ul>
<li><code>[1.2,2.0)</code> means “from <code>1.2</code> (inclusive) to <code>2.0</code> (exclusive)”</li>
<li><code>[1.2,1.3)</code> means “from <code>1.2</code> (inclusive) to <code>1.3</code> (exclusive)”</li>
<li><code>[1.2,1.3]</code> means “from <code>1.2</code> (inclusive) to <code>1.3</code> (inclusive)”</li>
<li><code>(,1.3]</code> means “up to <code>1.3</code> (inclusive)”</li>
<li><code>[1.2,)</code> means “from <code>1.2</code> (inclusive) onwards”</li>
</ul>
</li>
<li><strong>Gradle</strong> (Java, Kotlin, multiple languages)
<ul>
<li>Same syntax as Maven, plus “rich versions”: <code>1.2+</code> means “any <code>1.2</code> version”, i.e., <code>&gt;=1.2.0 &lt;1.3.0</code></li>
</ul>
</li>
<li><strong>npm</strong> / <strong>pnpm</strong> / <strong>yarn</strong> (JavaScript/TypeScript)
<ul>
<li><code>^1.2.3</code> means “compatible with <code>1.2.3</code>”, i.e., <code>&gt;=1.2.3 &lt;2.0.0</code></li>
<li><code>~1.2.3</code> means “approximately <code>1.2.3</code>”, i.e., <code>&gt;=1.2.3 &lt;1.3.0</code></li>
<li><code>1.2.x</code> means “any <code>1.2</code> version”, i.e., <code>&gt;=1.2.0 &lt;1.3.0</code></li>
</ul>
</li>
<li><strong>Python</strong> (PEP 440)
<ul>
<li><code>&gt;=1.2, &lt;2.0</code> means “from <code>1.2</code> (inclusive) to <code>2.0</code> (exclusive)”</li>
<li><code>&gt;=1.2, &lt;1.3</code> means “from <code>1.2</code> (inclusive) to <code>1.3</code> (exclusive)”</li>
<li><code>&gt;=1.2, &lt;=1.3</code> means “from <code>1.2</code> (inclusive) to <code>1.3</code> (inclusive)”</li>
<li><code>&lt;1.3</code> means “up to <code>1.3</code> (exclusive)”</li>
<li><code>&gt;=1.2</code> means “from <code>1.2</code> (inclusive) onwards”</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="dependency-ranges-resolution">Dependency ranges resolution</h2>
<p>When multiple ranges are specified for the same dependency, the system must find a version that satisfies all constraints.</p>
<p>The resolver typically relies on a <strong>dependency graph</strong>:</p>
<ul>
<li>Input: <em>roots</em> (direct dependencies) with version ranges, and <em>recursive dependencies</em> with version ranges</li>
<li>Build a <em>graph</em>: nodes are dependencies, edges are “depends on”</li>
<li>Traverse the graph, starting from the roots (or the most constrained nodes), and <em>reduce the ranges</em> removing incompatible versions</li>
<li>If a node ends up with an <em>empty range</em>, there is a <strong>conflict that cannot be resolved</strong></li>
<li>Otherwise, all nodes have non-empty ranges, <em>pick a version for each node</em> (typically the latest in the range)</li>
</ul>
</section><section>
<h2 id="dependency-locking">Dependency locking</h2>
<p>Introducing ranges leads to the <strong>explosion of the version combinations</strong> space.</p>
<ul>
<li>Testing all combinations is <em>impossible</em>!</li>
<li>Different tests may resolve to different versions, leading to <em>inconsistent results</em></li>
</ul>
<p><strong>Dependency locking</strong> is a technique to fix the versions of all dependencies (including transitive ones)
to a known good set.</p>
<ul>
<li>The <em>specified versions</em> are typically <em>ranges</em>, in the main project manifest</li>
<li>The <em>locked versions</em> are stored in a <em>dedicated file</em></li>
</ul>
<h4 id="there-is-a-trade-off-between-flexibility-and-reproducibility">There is a trade-off between flexibility and reproducibility!</h4>
<p><strong>exact pins</strong> trade <em>low maintenance risk</em> for <em>high ongoing cost</em> and <em>poor ecosystem fit</em>:</p>
<ul>
<li>Libraries become uncomposable. If two libs pin different exact transitives, resolvers can’t find a common graph</li>
<li>Pins don’t freeze transitives anyway. Without a lock you still get drift downstream</li>
</ul>
<table>
  <thead>
      <tr>
          <th></th>
          <th>Ranges, no lock</th>
          <th>Ranges + lock</th>
          <th>Fixed versions (exact pins)</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Updates</td>
          <td><em>Instant</em></td>
          <td>Manual (regenerate lock file)</td>
          <td>Manual (change version)</td>
      </tr>
      <tr>
          <td>Reproducibility</td>
          <td>Low</td>
          <td><em>Maximum</em> (transitive dependencies are locked)</td>
          <td>High (transitive drift remains)</td>
      </tr>
      <tr>
          <td>Reliability</td>
          <td>Low (uncontrolled updates)</td>
          <td>Medium (testing all ranges is impossible)</td>
          <td><em>High</em> (controlled updates, transitive drift)</td>
      </tr>
  </tbody>
</table>
</section><section>
<h2 id="dependency-scopes">Dependency scopes</h2>
<p>Dependencies may be needed in different contexts:</p>
<ul>
<li><strong>Compile-time</strong>: needed to compile the code (e.g., libraries whose types are used in method signatures)</li>
<li><strong>Runtime</strong>: needed to run the code (e.g., libraries whose types are used in method bodies)
<ul>
<li>Note: it is common for runtime dependencies to be a <em>superset</em> of compile-time dependencies
(some dependencies are runtime-only, e.g., JDBC drivers)</li>
<li>Note: even though most of the time runtime dependencies are also compile-time dependencies,
this is not always the case (e.g., some components of ANTLR4…)</li>
</ul>
</li>
<li><strong>Test</strong>: needed to compile and run tests (e.g., testing frameworks)</li>
<li><strong>Test runtime</strong>: needed to run tests (e.g., mocking frameworks)
<ul>
<li>Note: similar to the runtime scope, test runtime dependencies are often a <em>superset</em> of test dependencies</li>
</ul>
</li>
<li><strong>Build time</strong>: needed to build the code (e.g., code generators, linters, documentation tools)</li>
<li>…</li>
</ul>
<p>Scopes are typically <em>pre-defined in <strong>declarative</strong> build systems</em> and <em>manually defined in <strong>imperative</strong> ones</em>
(there are exceptions to this rule).</p>
<p><em><strong>Hybrid</strong> automators</em> often provide <em>pre-defined scopes</em> and <em>ways to define additional custom scopes</em>.</p>
</section><section>
<h2 id="imperative-build-tool-example-cmake">Imperative build tool example: CMake</h2>
<p><a href="https://cmake.org/">CMake</a> is a widely used <em>imperative</em> build automation tool, especially in C and C++ projects.</p>
<ul>
<li><strong>Imperative configuration</strong>: Build instructions are specified in <code>CMakeLists.txt</code> using CMake’s own scripting language.</li>
<li><strong>Cross-platform</strong>: Generates native build files for various platforms (Makefiles, Visual Studio projects, etc.).</li>
<li><strong>Dependency management</strong>: Supports finding and linking against external libraries.</li>
<li><strong>Build targets</strong>: Allows defining multiple build targets (executables, libraries) within a single project.</li>
<li><strong>Custom commands</strong>: Supports custom build commands and scripts for specialized tasks.</li>
</ul>
</section><section>
<p><a href="https://github.com/krux02/minimal_cmake_example/blob/master/CMakeLists.txt">CMake build file example</a></p>
<p>CMake version and project name, declarative:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#038">cmake_minimum_required</span>(<span style="color:#d20;background-color:#fff0f0">VERSION</span> <span style="color:#d20;background-color:#fff0f0">3.0</span>) <span style="color:#888"># setting this is required
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">project</span>(<span style="color:#d20;background-color:#fff0f0">example_project</span>)            <span style="color:#888"># this sets the project name
</span></span></span></code></pre></div><p>File globbing: search of what to build is manual/imperative:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># These instructions search the directory tree when cmake is
</span></span></span><span style="display:flex;"><span><span style="color:#888"># invoked and put all files that match the pattern in the variables 
</span></span></span><span style="display:flex;"><span><span style="color:#888"># `sources` and `data`.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">file</span>(<span style="color:#d20;background-color:#fff0f0">GLOB_RECURSE</span> <span style="color:#d20;background-color:#fff0f0">sources</span>      <span style="color:#d20;background-color:#fff0f0">src/main/*.cpp</span> <span style="color:#d20;background-color:#fff0f0">src/main/*.h</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#038">file</span>(<span style="color:#d20;background-color:#fff0f0">GLOB_RECURSE</span> <span style="color:#d20;background-color:#fff0f0">sources_test</span> <span style="color:#d20;background-color:#fff0f0">src/test/*.cpp</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#038">file</span>(<span style="color:#d20;background-color:#fff0f0">GLOB_RECURSE</span> <span style="color:#d20;background-color:#fff0f0">data</span> <span style="color:#d20;background-color:#fff0f0">resources/*</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># You can use set(sources src/main.cpp) etc if you don't want to
</span></span></span><span style="display:flex;"><span><span style="color:#888"># use globbing to find files automatically.
</span></span></span></code></pre></div><p>Target definitions, imperative:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># The data is just added to the executable, because in some IDEs (QtCreator) 
</span></span></span><span style="display:flex;"><span><span style="color:#888"># files are invisible when they are not explicitly part of the project.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">add_executable</span>(<span style="color:#d20;background-color:#fff0f0">example</span> ${<span style="color:#369">sources</span>} ${<span style="color:#369">data</span>})<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Just for example add some compiler flags.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">target_compile_options</span>(<span style="color:#d20;background-color:#fff0f0">example</span> <span style="color:#d20;background-color:#fff0f0">PUBLIC</span> <span style="color:#d20;background-color:#fff0f0">-std=c++1y</span> <span style="color:#d20;background-color:#fff0f0">-Wall</span> <span style="color:#d20;background-color:#fff0f0">-Wfloat-conversion</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># This allows to include files relative to the root of the src directory with a &lt;&gt; pair
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">target_include_directories</span>(<span style="color:#d20;background-color:#fff0f0">example</span> <span style="color:#d20;background-color:#fff0f0">PUBLIC</span> <span style="color:#d20;background-color:#fff0f0">src/main</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># This copies all resource files in the build directory.
</span></span></span><span style="display:flex;"><span><span style="color:#888"># We need this, because we want to work with paths relative to the executable.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">file</span>(<span style="color:#d20;background-color:#fff0f0">COPY</span> ${<span style="color:#369">data</span>} <span style="color:#d20;background-color:#fff0f0">DESTINATION</span> <span style="color:#d20;background-color:#fff0f0">resources</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div></section><section>
<p>Depedency management, imperative:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># This defines the variables Boost_LIBRARIES that containts all library names
</span></span></span><span style="display:flex;"><span><span style="color:#888"># that we need to link into the program.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">find_package</span>(<span style="color:#d20;background-color:#fff0f0">Boost</span> <span style="color:#d20;background-color:#fff0f0">1.36.0</span> <span style="color:#d20;background-color:#fff0f0">COMPONENTS</span> <span style="color:#d20;background-color:#fff0f0">filesystem</span> <span style="color:#d20;background-color:#fff0f0">system</span> <span style="color:#d20;background-color:#fff0f0">REQUIRED</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#038">target_link_libraries</span>(<span style="color:#d20;background-color:#fff0f0">example</span> <span style="color:#d20;background-color:#fff0f0">PUBLIC</span>
</span></span><span style="display:flex;"><span>  ${<span style="color:#369">Boost_LIBRARIES</span>}
</span></span><span style="display:flex;"><span>  <span style="color:#888"># here you can add any library dependencies
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div><p>Testing with googletest, imperative:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#038">find_package</span>(<span style="color:#d20;background-color:#fff0f0">GTest</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#038">if</span>(<span style="color:#d20;background-color:#fff0f0">GTEST_FOUND</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span>  <span style="color:#038">add_executable</span>(<span style="color:#d20;background-color:#fff0f0">unit_tests</span> ${<span style="color:#369">sources_test</span>} ${<span style="color:#369">sources</span>})<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span>  <span style="color:#888"># This define is added to prevent collision with the main.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#888"># It might be better solved by not adding the source with the main to the
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#888"># testing target.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#038">target_compile_definitions</span>(<span style="color:#d20;background-color:#fff0f0">unit_tests</span> <span style="color:#d20;background-color:#fff0f0">PUBLIC</span> <span style="color:#d20;background-color:#fff0f0">UNIT_TESTS</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span>  <span style="color:#888"># This allows us to use the executable as a link library, and inherit all 
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#888"># linker options and library dependencies from it, by simply adding it as dependency.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>  <span style="color:#038">set_target_properties</span>(<span style="color:#d20;background-color:#fff0f0">example</span> <span style="color:#d20;background-color:#fff0f0">PROPERTIES</span> <span style="color:#d20;background-color:#fff0f0">ENABLE_EXPORTS</span> <span style="color:#d20;background-color:#fff0f0">on</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span>  <span style="color:#038">target_link_libraries</span>(<span style="color:#d20;background-color:#fff0f0">unit_tests</span> <span style="color:#d20;background-color:#fff0f0">PUBLIC</span> ${<span style="color:#369">GTEST_BOTH_LIBRARIES</span>} <span style="color:#d20;background-color:#fff0f0">example</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span>  <span style="color:#038">target_include_directories</span>(<span style="color:#d20;background-color:#fff0f0">unit_tests</span> <span style="color:#d20;background-color:#fff0f0">PUBLIC</span> ${<span style="color:#369">GTEST_INCLUDE_DIRS</span>})<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#038">endif</span>()<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div></section><section>
<p>Packaging with CPack, mostly imperative with some declarative parts:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># All install commands get the same destination. this allows us to use paths
</span></span></span><span style="display:flex;"><span><span style="color:#888"># relative to the executable.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">install</span>(<span style="color:#d20;background-color:#fff0f0">TARGETS</span> <span style="color:#d20;background-color:#fff0f0">example</span> <span style="color:#d20;background-color:#fff0f0">DESTINATION</span> <span style="color:#d20;background-color:#fff0f0">example_destination</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># This is basically a repeat of the file copy instruction that copies the
</span></span></span><span style="display:flex;"><span><span style="color:#888"># resources in the build directory, but here we tell cmake that we want it
</span></span></span><span style="display:flex;"><span><span style="color:#888"># in the package.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">install</span>(<span style="color:#d20;background-color:#fff0f0">DIRECTORY</span> <span style="color:#d20;background-color:#fff0f0">resources</span> <span style="color:#d20;background-color:#fff0f0">DESTINATION</span> <span style="color:#d20;background-color:#fff0f0">example_destination</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># Now comes everything we need, to create a package
</span></span></span><span style="display:flex;"><span><span style="color:#888"># there are a lot more variables you can set, and some
</span></span></span><span style="display:flex;"><span><span style="color:#888"># you need to set for some package types, but we want to
</span></span></span><span style="display:flex;"><span><span style="color:#888"># be minimal here.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">set</span>(<span style="color:#d20;background-color:#fff0f0">CPACK_PACKAGE_NAME</span> <span style="color:#d20;background-color:#fff0f0">"MyExample"</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#038">set</span>(<span style="color:#d20;background-color:#fff0f0">CPACK_PACKAGE_VERSION</span> <span style="color:#d20;background-color:#fff0f0">"1.0.0"</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># We don't want to split our program up into several incomplete pieces.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">set</span>(<span style="color:#d20;background-color:#fff0f0">CPACK_MONOLITHIC_INSTALL</span> <span style="color:#d20;background-color:#fff0f0">1</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2">
</span></span></span><span style="display:flex;"><span><span style="color:#a61717;background-color:#e3d2d2"></span><span style="color:#888"># This must be last
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#038">include</span>(<span style="color:#d20;background-color:#fff0f0">CPack</span>)<span style="color:#a61717;background-color:#e3d2d2">
</span></span></span></code></pre></div></section><section>
<h2 id="declarative-build-tool-example-python-poetry">Declarative build tool example: Python Poetry</h2>
<p><a href="https://python-poetry.org/">Poetry</a> is a modern, <em>declarative</em> build and dependency management tool for Python.</p>
<ul>
<li><strong>Declarative configuration</strong>: All project metadata, dependencies, and build instructions are specified in <code>pyproject.toml</code>.
<ul>
<li>Declarative build tools tend to favor markup files over scripts:
<ul>
<li>XML (Maven)</li>
<li>TOML (Poetry, Rust’s Cargo)</li>
<li>JSON (Node.js’s npm)</li>
<li>YAML (JetBrains’ Amper)</li>
</ul>
</li>
</ul>
</li>
<li><strong>Scripted tasks</strong>: Allows definition of custom scripts for automation.</li>
<li><strong>Dependency resolution</strong>: Handles dependency resolution and locking via <code>poetry.lock</code>.</li>
<li><strong>Virtual environments</strong>: Automatically manages isolated Python environments per project.</li>
<li><strong>Build and publish</strong>: Supports building and publishing packages to PyPI or other repositories.</li>
</ul>
</section><section>
<h2 id="pythons-conflicting-standards">Python’s conflicting standards</h2>
<p><img src="https://imgs.xkcd.com/comics/python_environment.png" alt="xkcd"></p>
<p>Since there were no standard management systems originally,
multiple tools <em>proliferated</em></p>
<ul>
<li>
<p>The Python Packaging Authority (PyPA) is inconsistent in its suggestions:</p>
<ul>
<li>Recommends <a href="https://docs.python.org/3/library/venv.html"><code>venv</code></a></li>
<li>Also recommends <a href="https://pipenv.pypa.io/en/latest/">Pipenv</a> , which uses <a href="https://virtualenv.pypa.io/en/latest/"><code>virtualenv</code></a></li>
<li>Also endorses <a href="https://python-poetry.org/">Poetry</a></li>
</ul>
</li>
<li>
<p>Many Python developers also rely on <a href="https://github.com/pyenv/pyenv">PyEnv</a></p>
</li>
<li>
<p>Many data scientists use <a href="https://www.anaconda.com/">Anaconda</a></p>
</li>
</ul>
</section><section>
<h2 id="python-ecosystem">Python ecosystem</h2>
<ol>
<li>
<p>By default, Python is installed <em>system-wide</em></p>
<ul>
<li>i.e. there should be <em>one</em> (and <strong>only</strong> one) Python interpreter on the system</li>
<li><strong>Problem 1</strong>: two different projects cannot use different versions of Python!</li>
</ul>
</li>
<li>
<p>All Python installations come with <code>pip</code>, the <em>package installer</em> for Python</p>
<ul>
<li>Python packages are supposed to be installed <em>system-wide</em> with <code>pip install PACKAGE_NAME</code></li>
<li><strong>Problem 2</strong>: Two different projects cannot use different versions of the same package!</li>
</ul>
</li>
</ol>
<ul>
<li>
<p><code>PyEnv</code> is a tool to manage <em>multiple</em> Python <strong>installations</strong> <em>on the same system</em></p>
<ul>
<li><em>tackles Problem 1</em></li>
<li><strong>Poetry</strong> checks that the right Python version is used, but does not manage Python installations</li>
</ul>
</li>
<li>
<p><code>virtualenv</code> and <code>venv</code> create <em>virtual</em> Python installations <em>on the same system</em></p>
<ul>
<li><code>virtualenv</code> is a <em>third-party</em> tool, <code>venv</code> is <em>built-in</em> in Python 3.3 and later</li>
<li><em>tackles Problem 2</em></li>
<li><strong>Poetry</strong> automatically creates and manages virtual environments for each project</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="poetrys-canonical-project-structure">Poetry’s canonical project structure</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>root-directory/
</span></span><span style="display:flex;"><span>├── main_package/
</span></span><span style="display:flex;"><span>│   ├── __init__.py
</span></span><span style="display:flex;"><span>│   ├── sub_module.py
</span></span><span style="display:flex;"><span>│   └── sub_package/ 
</span></span><span style="display:flex;"><span>│       ├── __init__.py 
</span></span><span style="display:flex;"><span>│       └── sub_sub_module.py 
</span></span><span style="display:flex;"><span>├── test/
</span></span><span style="display:flex;"><span>│   ├── test_something.py
</span></span><span style="display:flex;"><span>│   └── test_something_else.py/ 
</span></span><span style="display:flex;"><span>├── pyproject.toml <span style="color:#888"># File where project configuration (metadata, dependencies, etc.) is stored</span>
</span></span><span style="display:flex;"><span>├── poetry.toml <span style="color:#888"># File where Poetry configuration is stored</span>
</span></span><span style="display:flex;"><span>├── poetry.lock <span style="color:#888"># File where Poetry locks the dependencies</span>
</span></span><span style="display:flex;"><span>└── README.md
</span></span></code></pre></div><p>If you already use Python, notice:</p>
<ul>
<li>no <code>requirements.txt</code> nor <code>requirements-dev.txt</code></li>
<li><code>pyproject.toml</code>, <code>poetry.toml</code>, and <code>poetry.lock</code> are <strong>Poetry-specific</strong></li>
<li><code>poetry.lock</code> is generated <em>automatically</em> by Poetry, and should not be edited manually</li>
</ul>
</section><section>
<h2 id="a-python-calculator">A Python <a href="https://github.com/unibo-dtm-se/calculator"><code>calculator</code></a></h2>
<p>(courtesy of Giovanni Ciatto)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>[tool.poetry]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># publication metadata</span>
</span></span><span style="display:flex;"><span>name = <span style="color:#d20;background-color:#fff0f0">"unibo-dtm-se-calculator"</span>
</span></span><span style="display:flex;"><span>packages = [ <span style="color:#888"># files to be included for publication</span>
</span></span><span style="display:flex;"><span>    { include = <span style="color:#d20;background-color:#fff0f0">"calculator"</span> },
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>version = <span style="color:#d20;background-color:#fff0f0">"0.1.1"</span>
</span></span><span style="display:flex;"><span>description = <span style="color:#d20;background-color:#fff0f0">"A simple calculator toolkit written in Python, with several UIs."</span>
</span></span><span style="display:flex;"><span>authors = [<span style="color:#d20;background-color:#fff0f0">"Giovanni Ciatto &lt;giovanni.ciatto@unibo.it&gt;"</span>]
</span></span><span style="display:flex;"><span>license = <span style="color:#d20;background-color:#fff0f0">"Apache 2.0"</span>
</span></span><span style="display:flex;"><span>readme = <span style="color:#d20;background-color:#fff0f0">"README.md"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># dependencies (notice that Python is considered a dependency)</span>
</span></span><span style="display:flex;"><span>[tool.poetry.dependencies] 
</span></span><span style="display:flex;"><span>python = <span style="color:#d20;background-color:#fff0f0">"^3.10.0"</span>
</span></span><span style="display:flex;"><span>Kivy = <span style="color:#d20;background-color:#fff0f0">"^2.3.0"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># development dependencies</span>
</span></span><span style="display:flex;"><span>[tool.poetry.group.dev.dependencies]
</span></span><span style="display:flex;"><span>poetry = <span style="color:#d20;background-color:#fff0f0">"^1.7.0"</span>
</span></span><span style="display:flex;"><span>pytest = <span style="color:#d20;background-color:#fff0f0">"^8.1.0"</span>
</span></span><span style="display:flex;"><span>coverage = <span style="color:#d20;background-color:#fff0f0">"^7.4.0"</span>
</span></span><span style="display:flex;"><span>mypy = <span style="color:#d20;background-color:#fff0f0">"^1.9.0"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># executable commands that will be created then installing this package</span>
</span></span><span style="display:flex;"><span>[tool.poetry.scripts]
</span></span><span style="display:flex;"><span>calculator-gui = <span style="color:#d20;background-color:#fff0f0">"calculator.ui.gui:start_app"</span>
</span></span><span style="display:flex;"><span>calculator = <span style="color:#d20;background-color:#fff0f0">"calculator.ui.cli:start_app"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># where to download the dependencies from</span>
</span></span><span style="display:flex;"><span>[[tool.poetry.source]]
</span></span><span style="display:flex;"><span>name = <span style="color:#d20;background-color:#fff0f0">"PyPI"</span>
</span></span><span style="display:flex;"><span>priority = <span style="color:#d20;background-color:#fff0f0">"primary"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># packaging dependencies</span>
</span></span><span style="display:flex;"><span>[build-system]
</span></span><span style="display:flex;"><span>requires = [<span style="color:#d20;background-color:#fff0f0">"poetry-core"</span>]
</span></span><span style="display:flex;"><span>build-backend = <span style="color:#d20;background-color:#fff0f0">"poetry.core.masonry.api"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># the project-specific environment will be created in the local .venv folder</span>
</span></span><span style="display:flex;"><span>[virtualenvs]
</span></span><span style="display:flex;"><span>in-project = <span style="color:#080;font-weight:bold">true</span> 
</span></span></code></pre></div><p>Pure TOML: completely declarative</p>
</section><section>
<h2 id="poetry-build-lifecycle">Poetry: build lifecycle</h2>
<p>Poetry is used via the <code>poetry</code> command line tool:</p>
<ul>
<li><code>poetry install</code> – resolves and installs dependencies</li>
<li><code>poetry run &lt;command&gt;</code> – runs a command within the virtual environment</li>
</ul>
<h3 id="actual-behavior-of-poetry-install">Actual behavior of <code>poetry install</code></h3>
<ol>
<li><em>Validate</em> the project is correct and all necessary information is available</li>
<li><em>Verify</em> the version of Python is correct</li>
<li><em>Resolve</em> the dependencies, or use the ones in <code>poetry.lock</code> if already available</li>
<li><em>Retrieve</em> the dependencies from the specified sources</li>
<li><em>Create</em> a virtual environment if not already available</li>
<li><em>Install</em> the dependencies in the virtual environment</li>
</ol>
<p>Subsequent lifecycle phases are managed by the <code>poetry run</code> command, and are thus custom.</p>
<p>❗ Except for <code>install</code>, Poetry does not provide a predefined lifecycle</p>
</section><section>
<h2 id="a-structured-build-lifecycle-apache-maven">A structured build lifecycle: Apache Maven</h2>
<p>A build lifecycle typical of <em>declarative automators</em>, composed by <em>phases</em>.</p>
<p>⚠️ Selecting a phase implies executing all previous phases.</p>
<ol>
<li><code>validate</code> – validate the project is correct and all necessary information is available</li>
<li><code>compile</code> – compile the source code of the project</li>
<li><code>test</code> – test the compiled source code using a suitable unit testing framework. These tests should not require the code be packaged or deployed</li>
<li><code>package</code> – take the compiled code and package it in its distributable format, such as a JAR.</li>
<li><code>verify</code> – run any checks on results of integration tests to ensure quality criteria are met</li>
<li><code>install</code> – install the package into the local repository, for use as a dependency in other projects locally</li>
<li><code>deploy</code> – done in the build environment, copies the final package to the remote repository for sharing with other developers and projects.</li>
</ol>
<ul>
<li>Phases are made of <em>plugin goals</em></li>
<li><strong>Execution</strong> requires the name of a <em>phase</em> or <em>goal</em> (dependent goals will get executed)</li>
<li><strong>Convention over configuration</strong>: <em>sensible defaults</em></li>
</ul>
<p>What if there is no plugin for something peculiar of the project?</p>
</section><section>
<h2 id="a-meta-build-lifecycle-a-lifecycle-for-build-lifecycles">A meta-build lifecycle: a lifecycle for build lifecycles</h2>
<ol>
<li><strong>Initialization</strong>: understand what is part of a build</li>
<li><strong>Configuration</strong>: create the necessary phases / goals and configure them
<ul>
<li>Define the <em>goals</em> (or <em>tasks</em>)</li>
<li>Configure the <em>options</em></li>
<li>Define <em>dependencies</em> among tasks
<ul>
<li>Forming a <em>directed acyclic graph</em></li>
</ul>
</li>
</ul>
</li>
<li><strong>Execution</strong>: run the tasks necessary to achieve the build goal</li>
</ol>
<p>Rather than declaratively fit the build into a predefined lifecycle, declaratively define a build lifecycle</p>
<p>$\Rightarrow$ Typical of <em>hybrid automators</em></p>
</section><section>
<h2 id="gradle">Gradle</h2>
<p>A paradigmatic example of a hybrid automator:</p>
<ul>
<li>Written mostly in Java</li>
<li>with an outer Groovy layer and DSL</li>
<li>…and, more recently, a Kotlin layer and DSL</li>
</ul>
<h3 id="our-approach-to-gradle">Our approach to Gradle</h3>
<ul>
<li>We are <strong>not</strong> going to learn “how to <em>use</em> Gradle”</li>
<li>We are going to <em>explore how to drive Gradle from scratch</em>
<ul>
<li>Gradle is flexible enough to allow an exploration of its core concepts</li>
<li>It will work as an exemplary case for most hybrid automators</li>
<li>Other automation systems can be driven similarly once the basics are understood</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="gradle-main-concepts">Gradle: main concepts</h2>
<ul>
<li><strong>Project</strong> – A collection of files composing the software
<ul>
<li>The <em>root</em> project can contain <em>subprojects</em></li>
</ul>
</li>
<li><strong>Build file</strong> – A special file, with the build information
<ul>
<li>situated in the root directory of a project</li>
<li>instructs Gradle on the organization of the project</li>
</ul>
</li>
<li><strong>Dependency</strong> – A resource required by some operation.
<ul>
<li>May have dependencies itself</li>
<li>Dependencies of dependencies are called <em>transitive</em> dependencies</li>
</ul>
</li>
<li><strong>Configuration</strong> – A group of dependencies with <em>three roles</em>:
<ol>
<li><em>Declare</em> dependencies</li>
<li><em>Resolve</em> dependency declarations to actual artifacts/resources</li>
<li><em>Present</em> the dependencies to consumers in a suitable format</li>
</ol>
</li>
<li><strong>Task</strong> – An atomic operation on the project, which can
<ul>
<li>have input and output files</li>
<li>depend on other tasks (can be executed only if those are completed)</li>
<li>Tasks <em>bridge the declarative and imperative worlds</em></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="gradle-from-scratch-empty-project">Gradle from scratch: empty project</h2>
<p>Let’s start as empty as possible, just point your terminal to an empty folder and:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>touch build.gradle.kts
</span></span><span style="display:flex;"><span>gradle tasks
</span></span></code></pre></div><p>Stuff happens: if nothing is specified,
<br>
<em>Gradle considers the folder where it is invoked as a project</em>
<br>
<em>The project name matches the folder name</em></p>
<p>Let’s understand what:
<br></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Welcome to Gradle &lt;version&gt;!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Here are the highlights of this release:
</span></span><span style="display:flex;"><span> - Blah blah blah
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Starting a Gradle Daemon (subsequent builds will be faster)
</span></span></code></pre></div><p>Up to there, it’s just performance stuff:
Gradle uses a background service to speed up cacheable operations</p>
</section><section>
<h2 id="gradle-from-scratch-empty-project-1">Gradle from scratch: empty project</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>&gt; Task :tasks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>Tasks runnable from root project
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Build Setup tasks
</span></span><span style="display:flex;"><span>-----------------
</span></span><span style="display:flex;"><span>init - Initializes a new Gradle build.
</span></span><span style="display:flex;"><span>wrapper - Generates Gradle wrapper files.
</span></span></code></pre></div><p>Some tasks exist already!
They are built-in.
Let’s ignore them for now.</p>
</section><section>
<h2 id="gradle-from-scratch-empty-project-2">Gradle from scratch: empty project</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Help tasks
</span></span><span style="display:flex;"><span>----------
</span></span><span style="display:flex;"><span>buildEnvironment - Displays all buildscript dependencies declared in root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span><span style="display:flex;"><span>components - Displays the components produced by root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>. [incubating]
</span></span><span style="display:flex;"><span>dependencies - Displays all dependencies declared in root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span><span style="display:flex;"><span>dependencyInsight - Displays the insight into a specific dependency in root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span><span style="display:flex;"><span>dependentComponents - Displays the dependent components of components in root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>. [incubating]
</span></span><span style="display:flex;"><span><span style="color:#038">help</span> - Displays a <span style="color:#038">help</span> message.
</span></span><span style="display:flex;"><span>model - Displays the configuration model of root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>. [incubating]
</span></span><span style="display:flex;"><span>outgoingVariants - Displays the outgoing variants of root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span><span style="display:flex;"><span>projects - Displays the sub-projects of root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span><span style="display:flex;"><span>properties - Displays the properties of root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span><span style="display:flex;"><span>tasks - Displays the tasks runnable from root project <span style="color:#d20;background-color:#fff0f0">'00-empty'</span>.
</span></span></code></pre></div><p>Informational tasks. Among them, the <code>tasks</code> task we just invoked</p>
</section><section>
<h2 id="gradle-configuration-vs-execution">Gradle: configuration vs execution</h2>
<p>It is time to create our first <em>task</em>
<br>
Create a <code>build.gradle.kts</code> file as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>(<span style="color:#d20;background-color:#fff0f0">"brokenTask"</span>) { <span style="color:#888">// creates a new task
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    println(<span style="color:#d20;background-color:#fff0f0">"this is executed at CONFIGURATION time!"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now launch gradle with <code>gradle brokenTask</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>gradle broken
</span></span><span style="display:flex;"><span>this is executed at CONFIGURATION time!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD SUCCESSFUL in 378ms
</span></span></code></pre></div><p>Looks ok, but it’s <strong>utterly broken</strong></p>
</section><section>
<h2 id="gradle-configuration-vs-execution-1">Gradle: configuration vs execution</h2>
<p>Try launching <code>gradle tasks</code></p>
<ul>
<li>We do not expect our task to run, we are launching something else</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>❯ gradle tasks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Task :tasks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>Tasks runnable from root project
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>this is executed at CONFIGURATION time!
</span></span><span style="display:flex;"><span>Build Setup tasks
</span></span></code></pre></div><p><strong>Ouch!</strong></p>
<p><strong>Reason</strong>: the build script executes when Gradle is invoked, and <em>configures</em> tasks and dependencies.
<br>
Only later, when a task is invoked, the block gets <em>actually executed</em></p>
</section><section>
<h2 id="gradle-configuration-vs-execution-2">Gradle: configuration vs execution</h2>
<p>Let’s write a <em>correct</em> task</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>(<span style="color:#d20;background-color:#fff0f0">"helloWorld"</span>) {
</span></span><span style="display:flex;"><span>    doLast { <span style="color:#888">// This method takes as argument a Task.() -&gt; Unit
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        println(<span style="color:#d20;background-color:#fff0f0">"Hello, World!"</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Execution with <code>gradle helloWorld</code></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>gradle helloWorld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Task :helloWorld
</span></span><span style="display:flex;"><span>Hello, World!
</span></span></code></pre></div></section><section>
<h2 id="gradle-configuration-vs-execution-3">Gradle: configuration vs execution</h2>
<ul>
<li>The <em>build configuration</em> happens <strong>first</strong>
<ul>
<li>Tasks and their dependencies are a <strong>result of the configuration</strong></li>
</ul>
</li>
<li>The <em>task execution</em> happens <strong>later</strong>
<ul>
<li>As per the “meta-lifecycle” discussed before</li>
</ul>
</li>
</ul>
<p>Delaying the execution allows for <em>more flexible configuration</em></p>
<p>This will be especially useful when <em>modifying existing behavior</em></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val helloWorld = tasks.<span style="color:#369">register</span>(<span style="color:#d20;background-color:#fff0f0">"helloWorld"</span>) {
</span></span><span style="display:flex;"><span>    doLast { <span style="color:#888">// This method takes as argument a Task.() -&gt; Unit
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        println(<span style="color:#d20;background-color:#fff0f0">"Hello, World!"</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helloWorld.<span style="color:#369">configure</span> { <span style="color:#888">// Note the `configure` method: late configuration of the task
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    doFirst {
</span></span><span style="display:flex;"><span>        println(<span style="color:#d20;background-color:#fff0f0">"About to say hello..."</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>output of <code>gradle helloWorld</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Configuring task: helloWorld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Task :helloWorld
</span></span><span style="display:flex;"><span>About to say hello...
</span></span><span style="display:flex;"><span>Hello, World!
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD SUCCESSFUL in 231ms
</span></span><span style="display:flex;"><span>1 actionable task: 1 executed
</span></span></code></pre></div></section><section>
<h2 id="gradle-configuration-avoidance">Gradle: configuration avoidance</h2>
<p>While task execution happens only for those tasks that are invoked (or their dependencies),
task configuration happens for <em>all</em> tasks declared in the build script.</p>
<ul>
<li>This can lead to <em>performance issues</em> in large builds</li>
</ul>
<p>In Gradle, tasks are registered lazily, and can be configured lazily as well, using the <code>configure</code> and <code>configureEach</code> methods.</p>

<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val helloWorld = tasks.<span style="color:#369">register</span>(<span style="color:#d20;background-color:#fff0f0">"helloWorld"</span>) {
</span></span><span style="display:flex;"><span>    doLast { <span style="color:#888">// This method takes as argument a Task.() -&gt; Unit
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        println(<span style="color:#d20;background-color:#fff0f0">"Hello, World!"</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helloWorld.<span style="color:#369">configure</span> { <span style="color:#888">// Note the `configure` method: late configuration of the task
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    doFirst {
</span></span><span style="display:flex;"><span>        println(<span style="color:#d20;background-color:#fff0f0">"About to say hello..."</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">withType</span>&lt;Task&gt;().<span style="color:#369">configureEach</span> {
</span></span><span style="display:flex;"><span>    println(<span style="color:#d20;background-color:#fff0f0">"Configuring task: ${this.name}"</span>)
</span></span><span style="display:flex;"><span>    doLast {
</span></span><span style="display:flex;"><span>        println(<span style="color:#d20;background-color:#fff0f0">"Finished task: ${this.name}"</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    doFirst {
</span></span><span style="display:flex;"><span>        println(<span style="color:#d20;background-color:#fff0f0">"Starting task: ${this.name}"</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p><code>gradle helloWorld</code> output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Configuring task: helloWorld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Task :helloWorld
</span></span><span style="display:flex;"><span>Starting task: helloWorld
</span></span><span style="display:flex;"><span>About to say hello...
</span></span><span style="display:flex;"><span>Hello, World!
</span></span><span style="display:flex;"><span>Finished task: helloWorld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD SUCCESSFUL in 395ms
</span></span><span style="display:flex;"><span>1 actionable task: 1 executed
</span></span></code></pre></div><p><code>gradle tasks</code> output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Configuring task: tasks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Task :tasks
</span></span><span style="display:flex;"><span>Starting task: tasks
</span></span><span style="display:flex;"><span>Configuring task: help        # Configuration happens only when a task is needed!
</span></span><span style="display:flex;"><span>Configuring task: projects
</span></span><span style="display:flex;"><span>... list of tasks ...
</span></span><span style="display:flex;"><span>Configuring task: helloWorld
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>Tasks runnable from root project 'configuration-avoidance'
</span></span><span style="display:flex;"><span>------------------------------------------------------------
</span></span><span style="display:flex;"><span>... list of tasks ...
</span></span><span style="display:flex;"><span>BUILD SUCCESSFUL in 239ms
</span></span><span style="display:flex;"><span>1 actionable task: 1 executed
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="gradle-task-types">Gradle: task types</h2>
<p>Gradle offers some facilities to make writing new tasks easier
<br>
An example is the <a href="https://docs.gradle.org/current/javadoc/org/gradle/api/tasks/Exec.html"><code>org.gradle.api.Exec</code></a> task type, representing a command to be executed on the underlying command line</p>
<p>The task type can be specified at task registration time.
<br>
Any <code>open class</code> implementing <a href="https://docs.gradle.org/current/javadoc/org/gradle/api/Task.html"><code>org.gradle.api.Task</code></a> can be instanced.</p>
<p>Tasks of unspecified type are plain <code>DefaultTask</code>s</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">org.gradle.internal.jvm.Jvm</span> <span style="color:#888">// Jvm is part of the Gradle API
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"printJavaVersion"</span>) { <span style="color:#888">// Do you Recognize this? inline function with reified type!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#888">// Configuration action is of type T.() -&gt; Unit, in this case Exec.T() -&gt; Unit
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    val javaExecutable = Jvm.<span style="color:#369">current</span>().<span style="color:#369">javaExecutable</span>.<span style="color:#369">absolutePath</span>
</span></span><span style="display:flex;"><span>    commandLine( <span style="color:#888">// this is a method of class org.gradle.api.Exec
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        javaExecutable, <span style="color:#d20;background-color:#fff0f0">"-version"</span>
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>    <span style="color:#888">// There is no need of doLast / doFirst, actions are already configured
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#888">// Still, we may want to do something before or after the task has been executed
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    doLast { println(<span style="color:#d20;background-color:#fff0f0">"$javaExecutable invocation complete"</span>) }
</span></span><span style="display:flex;"><span>    doFirst { println(<span style="color:#d20;background-color:#fff0f0">"Ready to invoke $javaExecutable"</span>) }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>&gt; Task :printJavaVersion
</span></span><span style="display:flex;"><span>Ready to invoke /usr/lib/jvm/java-11-openjdk/bin/java
</span></span><span style="display:flex;"><span>openjdk version <span style="color:#d20;background-color:#fff0f0">"11.0.8"</span> 2020-07-14
</span></span><span style="display:flex;"><span>OpenJDK Runtime Environment (build 11.0.8+10)
</span></span><span style="display:flex;"><span>OpenJDK 64-Bit Server VM (build 11.0.8+10, mixed mode)
</span></span><span style="display:flex;"><span>/usr/lib/jvm/java-11-openjdk/bin/java invocation <span style="color:#038">complete</span>
</span></span></code></pre></div></section><section>
<h2 id="gradle-compiling-from-scratch">Gradle: compiling from scratch</h2>
<p>Let’s compile a simple <code>src/HelloWorld.java</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">HelloWorld</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">main</span>(String...<span style="color:#bbb"> </span>args)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>System.<span style="color:#369">out</span>.<span style="color:#369">println</span>(<span style="color:#d20;background-color:#fff0f0">"Hello, World!"</span>);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><p>Build logic:</p>
<ol>
<li>Find the Java compiler executable</li>
<li>Find the sources to be compiled</li>
<li>Invoke <code>javac -d destination &lt;files&gt;</code></li>
</ol>
<p>Which step should be in configuration, and which in execution?</p>
<p><strong>General rule</strong>: move as much as possible to execution</p>
<ul>
<li>The less is done at configuration time, the faster the build when the task is not executed</li>
<li>Delaying to execution allows for more flexible configuration</li>
</ul>
</section><section>
<h2 id="lazy-configuration-inputs-outputs">Lazy configuration, inputs, outputs</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// Computed at configuration time</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>val<span style="color:#bbb"> </span>sources<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>TODO(<span style="color:#d20;background-color:#fff0f0">"assume this is expensive"</span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888">// configuration that needs "sources"</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>doFirst<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#888">// We need to compute the sources and classpath as late as possible!</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>sources.<span style="color:#369">forEach</span><span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>...<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div><ul>
<li>Problem: we need to run the <em>expensive</em> operation even if the task is <em>not executed</em>!
<ul>
<li>We must <strong>delay</strong> the execution as much as possible</li>
</ul>
</li>
<li>Problem: other tasks may <em>generate sources</em>, and should thus run before
<ul>
<li>We must understand that the output of some tasks is the input of other tasks</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="task-inputs-and-outputs">Task inputs and outputs</h2>
<p>How can Gradle determine which tasks some task depends on?</p>
<ul>
<li>Explicit dependencies (later)</li>
<li>Implicit dependencies, via <em>inputs</em> and <em>outputs</em>
<ul>
<li>If a task <em>input</em> is the <em>output</em> of another task, then the first task depends on the second</li>
</ul>
</li>
</ul>
<p>Inputs and outputs can be configured via the <code>inputs</code> and <code>outputs</code> properties of a task.</p>
<p>Inputs and outputs are also used by Gradle to determine if a task is <code>UP-TO-DATE</code>,
namely, if it can be skipped because its inputs have not changed since the last execution.</p>
<ul>
<li>This is called <em>incremental build</em>.</li>
<li>Large builds can be sped up significantly.</li>
</ul>
</section><section>
<h2 id="lazy-configuration-in-gradle">Lazy configuration in Gradle</h2>
<p>Gradle supports the construction of <em>lazy</em> properties and providers:</p>
<ol>
<li>Wire together Gradle components without worrying about values, just knowing their <em>provider</em>.
<ul>
<li>Configuration happens <em>before</em> execution, some values are unknown</li>
<li>yet their provider is known at configuration time</li>
</ul>
</li>
</ol>
<h4 id="in-the-gradle-api">In the gradle API</h4>
<p><code>Provider</code> – a value that can only be queried and cannot be changed</p>
<ul>
<li>Transformable through a <code>map</code> method</li>
<li>Easily built via <code>project.provider { ... }</code> (<code>project</code> can be omitted in build scripts)</li>
</ul>
<p><code>Property</code> – a value that can be queried and also changed</p>
<ul>
<li>Subtype of Provider</li>
<li>Can be <code>set</code> by passing a value or a <code>Provider</code></li>
<li>A new property can be created via <code>project.objects.property&lt;Type&gt;()</code> (<code>project</code> can be omitted in build scripts)</li>
</ul>
</section><section>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">org.gradle.internal.jvm.Jvm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) { <span style="color:#888">// This is a Kotlin lambda with receiver!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    val sourceDir = projectDir.<span style="color:#369">resolve</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>)
</span></span><span style="display:flex;"><span>    inputs.<span style="color:#369">dir</span>(sourceDir)
</span></span><span style="display:flex;"><span>    val outputDir = layout.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>.<span style="color:#369">absolutePath</span>
</span></span><span style="display:flex;"><span>    outputs.<span style="color:#369">dir</span>(outputDir)
</span></span><span style="display:flex;"><span>    val javacExecutable = Jvm.<span style="color:#369">current</span>().<span style="color:#369">javacExecutable</span>.<span style="color:#369">absolutePath</span> <span style="color:#888">// Use the current JVM's javac
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    executable(javacExecutable)
</span></span><span style="display:flex;"><span>    doFirst { <span style="color:#888">// We need to compute the sources and classpath as late as possible
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        val sources = sourceDir.<span style="color:#369">walkTopDown</span>().<span style="color:#369">filter</span> { it.<span style="color:#369">isFile</span> &amp;&amp; it.<span style="color:#369">extension</span> == <span style="color:#d20;background-color:#fff0f0">"java"</span> }.<span style="color:#369">toList</span>()
</span></span><span style="display:flex;"><span>        println(sources)
</span></span><span style="display:flex;"><span>        when {
</span></span><span style="display:flex;"><span>            sources.<span style="color:#369">isEmpty</span>() -&gt; {
</span></span><span style="display:flex;"><span>                println(<span style="color:#d20;background-color:#fff0f0">"No source files found, skipping compilation."</span>)
</span></span><span style="display:flex;"><span>                args(<span style="color:#d20;background-color:#fff0f0">"-version"</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">else</span> -&gt; args(
</span></span><span style="display:flex;"><span>                <span style="color:#888">// destination folder: the output directory of Gradle, inside "bin"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-d"</span>, outputDir,
</span></span><span style="display:flex;"><span>                *sources.<span style="color:#369">toTypedArray</span>(),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Execution:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>gradle compileJava
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD SUCCESSFUL in 693ms
</span></span></code></pre></div><p>Compiled files are in <code>build/bin</code>!</p>
</section><section>
<h2 id="gradle-dependency-management">Gradle: dependency management</h2>
<p>Dependency management in Gradle is rooted in two fundamental concepts:</p>
<ul>
<li><strong>Dependency</strong>, a resource of some kind, possibly having other (<em>transitive</em>) dependencies</li>
<li><strong>Configuration</strong>, a <em>resolvable</em> (mappable to actual resources) set of dependencies
<ul>
<li>$\Rightarrow$ Not to be confused with the configuration <strong>phase</strong>!</li>
</ul>
</li>
</ul>
<p>Let’s see a use case: compiling a Java source with a dependency</p>
<ul>
<li>In <code>javac</code> terms, we need to feed some jars to the <code>-cp</code> flag of the compiler</li>
<li>In Gradle (automation) terms, we need:
<ul>
<li>a <em>configuration</em> representing the compile classpath</li>
<li>one <em>dependency</em> for each library we need to compile</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="gradle-dependency-management-1">Gradle: dependency management</h2>
<p>Conceptually, we want something like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Gradle way to create a configuration
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">compileClasspath</span> ... <span style="color:#888">// Delegation!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>dependencies {
</span></span><span style="display:flex;"><span>    compileClasspath.add(dir(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).files.filter { <span style="color:#080;font-weight:bold">it</span>.extension == <span style="color:#d20;background-color:#fff0f0">"jar"</span> })
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To be consumed by our improved compile task:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.register&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) {
</span></span><span style="display:flex;"><span>    ...
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">else</span> -&gt; args(
</span></span><span style="display:flex;"><span>        <span style="color:#d20;background-color:#fff0f0">"-d"</span>, outputDir,
</span></span><span style="display:flex;"><span>        <span style="color:#888">// classpath from the configuration
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#33b;background-color:#fff0f0">${File.pathSeparator}${compileClasspath.asPath}</span><span style="color:#d20;background-color:#fff0f0">"</span>,
</span></span><span style="display:flex;"><span>        *sources.toTypedArray(),
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="gradle-using-custom-configurations">Gradle: using custom configurations</h2>
<p>A minimal DSL to simplify file access:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Minimal file access DSL
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>object AllFiles
</span></span><span style="display:flex;"><span>val Project.<span style="color:#369">allFiles</span>: AllFiles get() = AllFiles <span style="color:#888">// We need this to prevent "Object AllFiles captures the script class instance" error
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>data <span style="color:#080;font-weight:bold">class</span> <span style="color:#06b;font-weight:bold">Finder</span>(val <span style="color:#369;font-style:italic">path:</span> File) {
</span></span><span style="display:flex;"><span>    fun <span style="color:#06b;font-weight:bold">withExtension</span>(<span style="color:#369;font-style:italic">extension:</span> String): List&lt;File&gt; =
</span></span><span style="display:flex;"><span>        path.<span style="color:#369">walkTopDown</span>().<span style="color:#369">filter</span> { it.<span style="color:#369">isFile</span> &amp;&amp; it.<span style="color:#369">extension</span> == extension }.<span style="color:#369">toList</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>fun AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#369;font-style:italic">path:</span> String) = Finder(projectDir.<span style="color:#369">resolve</span>(path))
</span></span></code></pre></div><p>Dependency declaration (configuration time):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> <span style="color:#888">// Delegation!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>dependencies { <span style="color:#888">// built-in in Gradle
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> { <span style="color:#888">// Not Gradle: defined below
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        compileClasspath(files(it)) <span style="color:#888">// The Configuration class overrides the invoke operator
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Dependency use (execution time):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>    doFirst { <span style="color:#888">// We need to compute the sources and classpath as late as possible
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        val sources = AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>)
</span></span><span style="display:flex;"><span>        println(sources)
</span></span><span style="display:flex;"><span>        when {
</span></span><span style="display:flex;"><span>            sources.<span style="color:#369">isEmpty</span>() -&gt; {
</span></span><span style="display:flex;"><span>                println(<span style="color:#d20;background-color:#fff0f0">"No source files found, skipping compilation."</span>)
</span></span><span style="display:flex;"><span>                args(<span style="color:#d20;background-color:#fff0f0">"-version"</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">else</span> -&gt; args(
</span></span><span style="display:flex;"><span>                <span style="color:#888">// destination folder: the output directory of Gradle, inside "bin"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-d"</span>, outputDir,
</span></span><span style="display:flex;"><span>                <span style="color:#888">// classpath from the configuration
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"${File.pathSeparator}${compileClasspath.asPath}"</span>,
</span></span><span style="display:flex;"><span>                *sources.<span style="color:#369">toTypedArray</span>(),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span></code></pre></div></section><section>
<h2 id="gradle-using-custom-configurations-1">Gradle: using custom configurations</h2>
<p>Full example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">org.gradle.internal.jvm.Jvm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> <span style="color:#888">// Delegation!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>dependencies { <span style="color:#888">// built-in in Gradle
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> { <span style="color:#888">// Not Gradle: defined below
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        compileClasspath(files(it)) <span style="color:#888">// The Configuration class overrides the invoke operator
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) { <span style="color:#888">// This is a Kotlin lambda with receiver!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    inputs.<span style="color:#369">dir</span>(projectDir.<span style="color:#369">resolve</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>))
</span></span><span style="display:flex;"><span>    val outputDir = layout.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>.<span style="color:#369">absolutePath</span>
</span></span><span style="display:flex;"><span>    outputs.<span style="color:#369">dir</span>(outputDir)
</span></span><span style="display:flex;"><span>    val javacExecutable = Jvm.<span style="color:#369">current</span>().<span style="color:#369">javacExecutable</span>.<span style="color:#369">absolutePath</span> <span style="color:#888">// Use the current JVM's javac
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    executable(javacExecutable)
</span></span><span style="display:flex;"><span>    doFirst { <span style="color:#888">// We need to compute the sources and classpath as late as possible
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        val sources = AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>)
</span></span><span style="display:flex;"><span>        println(sources)
</span></span><span style="display:flex;"><span>        when {
</span></span><span style="display:flex;"><span>            sources.<span style="color:#369">isEmpty</span>() -&gt; {
</span></span><span style="display:flex;"><span>                println(<span style="color:#d20;background-color:#fff0f0">"No source files found, skipping compilation."</span>)
</span></span><span style="display:flex;"><span>                args(<span style="color:#d20;background-color:#fff0f0">"-version"</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">else</span> -&gt; args(
</span></span><span style="display:flex;"><span>                <span style="color:#888">// destination folder: the output directory of Gradle, inside "bin"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-d"</span>, outputDir,
</span></span><span style="display:flex;"><span>                <span style="color:#888">// classpath from the configuration
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"${File.pathSeparator}${compileClasspath.asPath}"</span>,
</span></span><span style="display:flex;"><span>                *sources.<span style="color:#369">toTypedArray</span>(),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Minimal file access DSL
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>object AllFiles
</span></span><span style="display:flex;"><span>val Project.<span style="color:#369">allFiles</span>: AllFiles get() = AllFiles <span style="color:#888">// We need this to prevent "Object AllFiles captures the script class instance" error
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>data <span style="color:#080;font-weight:bold">class</span> <span style="color:#06b;font-weight:bold">Finder</span>(val <span style="color:#369;font-style:italic">path:</span> File) {
</span></span><span style="display:flex;"><span>    fun <span style="color:#06b;font-weight:bold">withExtension</span>(<span style="color:#369;font-style:italic">extension:</span> String): List&lt;File&gt; =
</span></span><span style="display:flex;"><span>        path.<span style="color:#369">walkTopDown</span>().<span style="color:#369">filter</span> { it.<span style="color:#369">isFile</span> &amp;&amp; it.<span style="color:#369">extension</span> == extension }.<span style="color:#369">toList</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>fun AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#369;font-style:italic">path:</span> String) = Finder(projectDir.<span style="color:#369">resolve</span>(path))
</span></span></code></pre></div></section><section>
<h2 id="gradle-task-dependencies">Gradle: task dependencies</h2>
<p>Next step: we can compile, why not executing the program as well?</p>
<ol>
<li>Let’s define a <code>runtimeClasspath</code> configuration
<ul>
<li>“inherits” from <code>compileClasspath</code></li>
<li>includes the output folder</li>
<li>In general we may need stuff at runtime that we don’t need at compile time
<ul>
<li>E.g. stuff loaded via reflection</li>
</ul>
</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">runtimeClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> {
</span></span><span style="display:flex;"><span>    extendsFrom(compileClasspath)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies { <span style="color:#888">// built-in in Gradle
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> { <span style="color:#888">// Not Gradle: defined below
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        compileClasspath(files(it)) <span style="color:#888">// The Configuration class overrides the invoke operator
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="2">
<li>Let’s write the task</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"runJava"</span>) {
</span></span><span style="display:flex;"><span>    inputs.<span style="color:#369">dir</span>(compilationDestination)
</span></span><span style="display:flex;"><span>    dependsOn(compileJava) <span style="color:#888">// IMPORTANT! This is a task dependency, we must compile before running
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    executable(Jvm.<span style="color:#369">current</span>().<span style="color:#369">javaExecutable</span>.<span style="color:#369">absolutePath</span>)
</span></span><span style="display:flex;"><span>    doFirst {
</span></span><span style="display:flex;"><span>        args(
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"${compilationDestination}${File.pathSeparator}${runtimeClasspath.asPath}"</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"HelloMath"</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>

<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">org.gradle.internal.jvm.Jvm</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">runtimeClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> {
</span></span><span style="display:flex;"><span>    extendsFrom(compileClasspath)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies { <span style="color:#888">// built-in in Gradle
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> { <span style="color:#888">// Not Gradle: defined below
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        compileClasspath(files(it)) <span style="color:#888">// The Configuration class overrides the invoke operator
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compilationDestination:</span> String = layout.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>.<span style="color:#369">absolutePath</span>
</span></span><span style="display:flex;"><span>val compileJava = tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) { <span style="color:#888">// This is a Kotlin lambda with receiver!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    inputs.<span style="color:#369">dir</span>(projectDir.<span style="color:#369">resolve</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>))
</span></span><span style="display:flex;"><span>    outputs.<span style="color:#369">dir</span>(compilationDestination)
</span></span><span style="display:flex;"><span>    val javacExecutable = Jvm.<span style="color:#369">current</span>().<span style="color:#369">javacExecutable</span>.<span style="color:#369">absolutePath</span> <span style="color:#888">// Use the current JVM's javac
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    executable(javacExecutable)
</span></span><span style="display:flex;"><span>    doFirst { <span style="color:#888">// We need to compute the sources and classpath as late as possible
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        val sources = AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>)
</span></span><span style="display:flex;"><span>        println(sources)
</span></span><span style="display:flex;"><span>        when {
</span></span><span style="display:flex;"><span>            sources.<span style="color:#369">isEmpty</span>() -&gt; {
</span></span><span style="display:flex;"><span>                println(<span style="color:#d20;background-color:#fff0f0">"No source files found, skipping compilation."</span>)
</span></span><span style="display:flex;"><span>                args(<span style="color:#d20;background-color:#fff0f0">"-version"</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">else</span> -&gt; args(
</span></span><span style="display:flex;"><span>                <span style="color:#888">// destination folder: the output directory of Gradle, inside "bin"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-d"</span>, compilationDestination,
</span></span><span style="display:flex;"><span>                <span style="color:#888">// classpath from the configuration
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"${File.pathSeparator}${compileClasspath.asPath}"</span>,
</span></span><span style="display:flex;"><span>                *sources.<span style="color:#369">toTypedArray</span>(),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;Exec&gt;(<span style="color:#d20;background-color:#fff0f0">"runJava"</span>) {
</span></span><span style="display:flex;"><span>    inputs.<span style="color:#369">dir</span>(compilationDestination)
</span></span><span style="display:flex;"><span>    dependsOn(compileJava) <span style="color:#888">// IMPORTANT! This is a task dependency, we must compile before running
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    executable(Jvm.<span style="color:#369">current</span>().<span style="color:#369">javaExecutable</span>.<span style="color:#369">absolutePath</span>)
</span></span><span style="display:flex;"><span>    doFirst {
</span></span><span style="display:flex;"><span>        args(
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"${compilationDestination}${File.pathSeparator}${runtimeClasspath.asPath}"</span>,
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"HelloMath"</span>,
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Minimal file access DSL
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>object AllFiles
</span></span><span style="display:flex;"><span>val Project.<span style="color:#369">allFiles</span>: AllFiles get() = AllFiles <span style="color:#888">// We need this to prevent "Object AllFiles captures the script class instance" error
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>data <span style="color:#080;font-weight:bold">class</span> <span style="color:#06b;font-weight:bold">Finder</span>(val <span style="color:#369;font-style:italic">path:</span> File) {
</span></span><span style="display:flex;"><span>    fun <span style="color:#06b;font-weight:bold">withExtension</span>(<span style="color:#369;font-style:italic">extension:</span> String): List&lt;File&gt; =
</span></span><span style="display:flex;"><span>        path.<span style="color:#369">walkTopDown</span>().<span style="color:#369">filter</span> { it.<span style="color:#369">isFile</span> &amp;&amp; it.<span style="color:#369">extension</span> == extension }.<span style="color:#369">toList</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>fun AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#369;font-style:italic">path:</span> String) = Finder(projectDir.<span style="color:#369">resolve</span>(path))
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="gradle-task-dependencies-1">Gradle: task dependencies</h2>
<p>Let us temporarily comment:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>    dependsOn(compileJava) <span style="color:#888">// IMPORTANT! This is a task dependency, we must compile before running
</span></span></span></code></pre></div><p>and run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>&gt; Task :runJava FAILED
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[Incubating] Problems report is available at: file:///home/danysk/LocalProjects/spe-slides/examples/run-java-deps/build/reports/problems/problems-report.html
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>FAILURE: Build failed with an exception.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>* What went wrong:
</span></span><span style="display:flex;"><span>A problem was found with the configuration of task <span style="color:#d20;background-color:#fff0f0">':runJava'</span> (<span style="color:#038">type</span> <span style="color:#d20;background-color:#fff0f0">'Exec'</span>).
</span></span><span style="display:flex;"><span>  - Type <span style="color:#d20;background-color:#fff0f0">'org.gradle.api.tasks.Exec'</span> property <span style="color:#d20;background-color:#fff0f0">'$1'</span> specifies directory <span style="color:#d20;background-color:#fff0f0">'/home/danysk/LocalProjects/spe-slides/examples/run-java-deps/build/bin'</span> which doesn<span style="color:#d20;background-color:#fff0f0">'t exist.
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    Reason: An input file was expected to be present but it doesn'</span>t exist.
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    Possible solutions:
</span></span><span style="display:flex;"><span>      1. Make sure the directory exists before the task is called.
</span></span><span style="display:flex;"><span>      2. Make sure that the task which produces the directory is declared as an input. <span style="color:#888"># &lt;&lt;&lt;&lt; OUR PROBLEM!!</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    For more information, please refer to https://docs.gradle.org/8.14/userguide/validation_problems.html#input_file_does_not_exist in the Gradle documentation.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>* Try:
</span></span><span style="display:flex;"><span>&gt; Make sure the directory exists before the task is called
</span></span><span style="display:flex;"><span>&gt; Make sure that the task which produces the directory is declared as an input
</span></span><span style="display:flex;"><span>&gt; Run with --scan to get full insights.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD FAILED in 752ms
</span></span><span style="display:flex;"><span><span style="color:#00d;font-weight:bold">1</span> actionable task: <span style="color:#00d;font-weight:bold">1</span> executed
</span></span></code></pre></div><p>$\Rightarrow$ The code was not compiled!</p>
<ul>
<li>We need <code>runJava</code> to run after <code>compileJava</code></li>
<li>One task depends on another!</li>
</ul>
</section><section>
<h2 id="gradle-task-dependencies-2">Gradle: task dependencies</h2>
<p><code>gradle runJava</code> with the dependency correctly set:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>&gt; Task :compileJava
</span></span><span style="display:flex;"><span>[/home/danysk/LocalProjects/spe-slides/examples/run-java-deps/src/HelloMath.java]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>&gt; Task :runJava
</span></span><span style="display:flex;"><span><span style="color:#369">avg</span>=3.0, std.dev=1.5811388300841898
</span></span><span style="display:flex;"><span>regression: <span style="color:#369">y</span> = 2.0300000000000002 * x + -0.030000000000001137
</span></span><span style="display:flex;"><span>R²=0.998957626296907
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>BUILD SUCCESSFUL in 581ms
</span></span><span style="display:flex;"><span><span style="color:#00d;font-weight:bold">2</span> actionable tasks: <span style="color:#00d;font-weight:bold">2</span> executed
</span></span></code></pre></div></section><section>
<h2 id="build-automation-dependencies-everywhere">Build automation: dependencies everywhere</h2>
<p>Dependencies permeate the world of build automation.</p>
<ul>
<li>At the <em>“task”</em> level
<ul>
<li>Compile dependencies</li>
<li>Runtime dependencies</li>
</ul>
</li>
<li>At the <em>“build”</em> level
<ul>
<li>Phases of the lifecycle (<em>configurations</em> in Gradle) depend on other phases</li>
<li><em>Tasks</em> depend on other tasks</li>
</ul>
</li>
</ul>
<p>$\Rightarrow$ <em>at the <strong>global</strong> level as well!</em></p>
<p><em>no guarantee</em>  that automation written with some tool at version <code>X</code>, will work at version <code>Y</code>!</p>
</section><section>
<h2 id="the-gradle-wrapper">The Gradle wrapper</h2>
<ul>
<li>A global dependency on the build tool is <strong>hard to capture</strong></li>
<li>Often, it becomes a <em>prerequisite expressed in natural language</em>
<ul>
<li>e.g., “you need Maven 3.6.1 to build this software”</li>
</ul>
</li>
<li><em>Critical</em> issues when different pieces of the same system depend on different build tool versions</li>
</ul>
<p>Gradle proposes a (partial) solution with the so-called <em>Gradle wrapper</em></p>
<ul>
<li><em>A minimal program</em> that simply downloads the version of gradle written in a configuration file</li>
<li><em>Generable</em> with the built-in task <code>wrapper</code>
<ul>
<li><code>gradle wrapper --gradle-version=&lt;VERSION&gt;</code></li>
</ul>
</li>
<li>Prepares scripts for bash and cmd to run Gradle at the specified version
<ul>
<li><code>gradlew</code></li>
<li><code>gradlew.bat</code></li>
</ul>
</li>
</ul>
<p>The Gradle wrapper is <em><strong>the</strong> correct way</em> to use gradle, and we’ll be using it from now on.</p>
</section><section>
<h2 id="mixed-imperativity-and-declarativity">Mixed imperativity and declarativity</h2>
<p>At the moment, we have part of the project that’s declarative, and part that’s imperative:</p>
<ul>
<li><strong>Declarative</strong>
<ul>
<li>configurations and their relationships</li>
<li>dependencies</li>
<li>task dependencies</li>
</ul>
</li>
<li><strong>Imperative</strong>
<ul>
<li>Operations on the file system</li>
<li>some of the actual task logics</li>
<li>resolution of configurations</li>
</ul>
</li>
</ul>
<p>The <em>declarative</em> part is the one <em>for which we had a built-in API for</em>!</p>
</section><section>
<h2 id="unavoidability-of-imperativity">Unavoidability of imperativity</h2>
<h3 id="and-its-isolation">(and its isolation)</h3>
<p>The base mechanism at work here is <em>hiding imperativity under a clean, declarative API</em>.</p>
<p>Also <em>“purely declarative”</em> build systems, such as Maven, which are driven with markup files, <em>hide</em> their imperativity behind a curtain (in the case of Maven, plugins that are configured in the <code>pom.xml</code>, but implemented elsewhere).</p>
<p><em>Usability</em>, <em>understandability</em>, and, ultimately, <em>maintability</em>, get increased when:</p>
<ul>
<li><em>Imperativity</em> gets <em>hidden</em> under the hood</li>
<li>Most (if not all) the operations can be <em>configured</em> rather than <em>written</em></li>
<li>Configuration can be <em>minimal for common tasks</em>
<ul>
<li><strong>Convention over configuration</strong>, we’ll get back to this</li>
</ul>
</li>
<li>Users can <em>resort to imperativity</em> in case of need</li>
</ul>
</section><section>
<h2 id="isolation-of-imperativity">Isolation of imperativity</h2>
<h3 id="task-type-definition">Task type definition</h3>
<p>Let’s begin our operation of isolation of imperativity by refactoring our hierarchy of operations.</p>
<ul>
<li>We have a number of “Java-related” tasks.</li>
<li>All of them have a classpath</li>
<li>All of them have an executable that depend on the operation they perform</li>
<li>One has an output directory and input sources</li>
<li>One has a “main class” input</li>
</ul>

<div class="multiCol">
    <div class="col  ">
    <div class="mermaid" data-processed="true" pre-rendered="true"><svg aria-roledescription="classDiagram" role="graphics-document document" viewBox="0 0 679.1875 246" style="max-width: 679.1875px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg g.classGroup text{fill:#9370DB;stroke:none;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:10px;}#my-svg g.classGroup text .title{font-weight:bolder;}#my-svg .nodeLabel,#my-svg .edgeLabel{color:#131300;}#my-svg .edgeLabel .label rect{fill:#ECECFF;}#my-svg .label text{fill:#131300;}#my-svg .edgeLabel .label span{background:#ECECFF;}#my-svg .classTitle{font-weight:bolder;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .divider{stroke:#9370DB;stroke-width:1;}#my-svg g.clickable{cursor:pointer;}#my-svg g.classGroup rect{fill:#ECECFF;stroke:#9370DB;}#my-svg g.classGroup line{stroke:#9370DB;stroke-width:1;}#my-svg .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5;}#my-svg .classLabel .label{fill:#9370DB;font-size:10px;}#my-svg .relation{stroke:#333333;stroke-width:1;fill:none;}#my-svg .dashed-line{stroke-dasharray:3;}#my-svg .dotted-line{stroke-dasharray:1 2;}#my-svg #compositionStart,#my-svg .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #compositionEnd,#my-svg .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #dependencyStart,#my-svg .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #dependencyStart,#my-svg .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #extensionStart,#my-svg .extension{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #extensionEnd,#my-svg .extension{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #aggregationStart,#my-svg .aggregation{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #aggregationEnd,#my-svg .aggregation{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #lollipopStart,#my-svg .lollipop{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#my-svg #lollipopEnd,#my-svg .lollipop{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#my-svg .edgeTerminals{font-size:11px;line-height:initial;}#my-svg .classTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="18" class="marker aggregation classDiagram" id="my-svg_classDiagram-aggregationStart"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="1" class="marker aggregation classDiagram" id="my-svg_classDiagram-aggregationEnd"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="18" class="marker extension classDiagram" id="my-svg_classDiagram-extensionStart"><path d="M 1,7 L18,13 V 1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="1" class="marker extension classDiagram" id="my-svg_classDiagram-extensionEnd"><path d="M 1,1 V 13 L18,7 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="18" class="marker composition classDiagram" id="my-svg_classDiagram-compositionStart"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="1" class="marker composition classDiagram" id="my-svg_classDiagram-compositionEnd"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="6" class="marker dependency classDiagram" id="my-svg_classDiagram-dependencyStart"><path d="M 5,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="13" class="marker dependency classDiagram" id="my-svg_classDiagram-dependencyEnd"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="13" class="marker lollipop classDiagram" id="my-svg_classDiagram-lollipopStart"><circle r="6" cy="7" cx="7" fill="transparent" stroke="black"></circle></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="1" class="marker lollipop classDiagram" id="my-svg_classDiagram-lollipopEnd"><circle r="6" cy="7" cx="7" fill="transparent" stroke="black"></circle></marker></defs><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_Task_TaskWithClasspath_1" d="M76.281,128.5L77.448,128.5C78.615,128.5,80.948,128.5,86.281,128.5C91.615,128.5,99.948,128.5,104.115,128.5L108.281,128.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_TaskWithClasspath_JavaCompileTask_2" d="M343.918,81.636L352.517,77.78C361.117,73.924,378.316,66.212,391.083,62.356C403.849,58.5,412.182,58.5,416.349,58.5L420.516,58.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_TaskWithClasspath_JavaRunTask_3" d="M343.918,175.364L352.517,179.22C361.117,183.076,378.316,190.788,394.047,194.644C409.779,198.5,424.042,198.5,431.173,198.5L438.305,198.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(33.140625, 128.5)" id="classId-Task-0" class="node default"><rect height="57" width="50.28125" y="-28.5" x="-25.140625" class="outer title-state" style=""></rect><line y2="1.5" y1="1.5" x2="25.140625" x1="-25.140625" class="divider"></line><line y2="17.5" y1="17.5" x2="25.140625" x1="-25.140625" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -17.640625, -21)" height="18" width="35.28125" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Task</span></div></foreignObject></g></g><g transform="translate(239.3984375, 128.5)" id="classId-TaskWithClasspath-1" class="node default"><rect height="79" width="262.234375" y="-39.5" x="-131.1171875" class="outer title-state" style=""></rect><line y2="-9.5" y1="-9.5" x2="131.1171875" x1="-131.1171875" class="divider"></line><line y2="28.5" y1="28.5" x2="131.1171875" x1="-131.1171875" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -73.1328125, -32)" height="18" width="146.265625" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">TaskWithClasspath</span></div></foreignObject><foreignObject transform="translate( -123.6171875, 2)" height="18" width="247.234375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Property&lt;FileCollection&gt; classpath</span></div></foreignObject></g></g><g transform="translate(545.8515625, 58.5)" id="classId-JavaCompileTask-2" class="node default"><rect height="101" width="250.671875" y="-50.5" x="-125.3359375" class="outer title-state" style=""></rect><line y2="-20.5" y1="-20.5" x2="125.3359375" x1="-125.3359375" class="divider"></line><line y2="39.5" y1="39.5" x2="125.3359375" x1="-125.3359375" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -67, -43)" height="18" width="134" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JavaCompileTask</span></div></foreignObject><foreignObject transform="translate( -117.8359375, -9)" height="18" width="235.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Property&lt;FileCollection&gt; sources</span></div></foreignObject><foreignObject transform="translate( -117.8359375, 13)" height="18" width="226.75"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">DirectoryProperty destinationDir</span></div></foreignObject></g></g><g transform="translate(545.8515625, 198.5)" id="classId-JavaRunTask-3" class="node default"><rect height="79" width="215.09375" y="-39.5" x="-107.546875" class="outer title-state" style=""></rect><line y2="-9.5" y1="-9.5" x2="107.546875" x1="-107.546875" class="divider"></line><line y2="28.5" y1="28.5" x2="107.546875" x1="-107.546875" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -50.9921875, -32)" height="18" width="101.984375" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JavaRunTask</span></div></foreignObject><foreignObject transform="translate( -100.046875, 2)" height="18" width="200.09375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Property&lt;String&gt; mainClass</span></div></foreignObject></g></g></g></g></g></svg></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">TaskWithClasspath</span> : Task {
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">classpath:</span> Property&lt;FileCollection&gt;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">JavaCompileTask</span> : TaskWithClasspath {
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">sources:</span> Property&lt;FileCollection&gt;
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">destinationDir:</span> DirectoryProperty
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">JavaRunTask</span> : TaskWithClasspath {
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">mainClass:</span> Property&lt;String&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="isolation-of-imperativity-1">Isolation of imperativity</h2>
<h3 id="task-design">Task design</h3>
<p>Next step: let’s inherit the behavior of our tasks from <code>Exec</code>:</p>
<div class="mermaid" data-processed="true" pre-rendered="true"><svg aria-roledescription="classDiagram" role="graphics-document document" viewBox="0 0 842.90625 363" style="max-width: 842.90625px;" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns="http://www.w3.org/2000/svg" width="100%" id="my-svg"><style>#my-svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;fill:#333;}#my-svg .error-icon{fill:#552222;}#my-svg .error-text{fill:#552222;stroke:#552222;}#my-svg .edge-thickness-normal{stroke-width:1px;}#my-svg .edge-thickness-thick{stroke-width:3.5px;}#my-svg .edge-pattern-solid{stroke-dasharray:0;}#my-svg .edge-thickness-invisible{stroke-width:0;fill:none;}#my-svg .edge-pattern-dashed{stroke-dasharray:3;}#my-svg .edge-pattern-dotted{stroke-dasharray:2;}#my-svg .marker{fill:#333333;stroke:#333333;}#my-svg .marker.cross{stroke:#333333;}#my-svg svg{font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:16px;}#my-svg p{margin:0;}#my-svg g.classGroup text{fill:#9370DB;stroke:none;font-family:"trebuchet ms",verdana,arial,sans-serif;font-size:10px;}#my-svg g.classGroup text .title{font-weight:bolder;}#my-svg .nodeLabel,#my-svg .edgeLabel{color:#131300;}#my-svg .edgeLabel .label rect{fill:#ECECFF;}#my-svg .label text{fill:#131300;}#my-svg .edgeLabel .label span{background:#ECECFF;}#my-svg .classTitle{font-weight:bolder;}#my-svg .node rect,#my-svg .node circle,#my-svg .node ellipse,#my-svg .node polygon,#my-svg .node path{fill:#ECECFF;stroke:#9370DB;stroke-width:1px;}#my-svg .divider{stroke:#9370DB;stroke-width:1;}#my-svg g.clickable{cursor:pointer;}#my-svg g.classGroup rect{fill:#ECECFF;stroke:#9370DB;}#my-svg g.classGroup line{stroke:#9370DB;stroke-width:1;}#my-svg .classLabel .box{stroke:none;stroke-width:0;fill:#ECECFF;opacity:0.5;}#my-svg .classLabel .label{fill:#9370DB;font-size:10px;}#my-svg .relation{stroke:#333333;stroke-width:1;fill:none;}#my-svg .dashed-line{stroke-dasharray:3;}#my-svg .dotted-line{stroke-dasharray:1 2;}#my-svg #compositionStart,#my-svg .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #compositionEnd,#my-svg .composition{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #dependencyStart,#my-svg .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #dependencyStart,#my-svg .dependency{fill:#333333!important;stroke:#333333!important;stroke-width:1;}#my-svg #extensionStart,#my-svg .extension{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #extensionEnd,#my-svg .extension{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #aggregationStart,#my-svg .aggregation{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #aggregationEnd,#my-svg .aggregation{fill:transparent!important;stroke:#333333!important;stroke-width:1;}#my-svg #lollipopStart,#my-svg .lollipop{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#my-svg #lollipopEnd,#my-svg .lollipop{fill:#ECECFF!important;stroke:#333333!important;stroke-width:1;}#my-svg .edgeTerminals{font-size:11px;line-height:initial;}#my-svg .classTitleText{text-anchor:middle;font-size:18px;fill:#333;}#my-svg :root{--mermaid-font-family:"trebuchet ms",verdana,arial,sans-serif;}</style><g><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="18" class="marker aggregation classDiagram" id="my-svg_classDiagram-aggregationStart"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="1" class="marker aggregation classDiagram" id="my-svg_classDiagram-aggregationEnd"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="18" class="marker extension classDiagram" id="my-svg_classDiagram-extensionStart"><path d="M 1,7 L18,13 V 1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="1" class="marker extension classDiagram" id="my-svg_classDiagram-extensionEnd"><path d="M 1,1 V 13 L18,7 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="18" class="marker composition classDiagram" id="my-svg_classDiagram-compositionStart"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="1" class="marker composition classDiagram" id="my-svg_classDiagram-compositionEnd"><path d="M 18,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="6" class="marker dependency classDiagram" id="my-svg_classDiagram-dependencyStart"><path d="M 5,7 L9,13 L1,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="28" markerWidth="20" refY="7" refX="13" class="marker dependency classDiagram" id="my-svg_classDiagram-dependencyEnd"><path d="M 18,7 L9,13 L14,7 L9,1 Z"></path></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="13" class="marker lollipop classDiagram" id="my-svg_classDiagram-lollipopStart"><circle r="6" cy="7" cx="7" fill="transparent" stroke="black"></circle></marker></defs><defs><marker orient="auto" markerHeight="240" markerWidth="190" refY="7" refX="1" class="marker lollipop classDiagram" id="my-svg_classDiagram-lollipopEnd"><circle r="6" cy="7" cx="7" fill="transparent" stroke="black"></circle></marker></defs><g class="root"><g class="clusters"></g><g class="edgePaths"><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_Task_TaskWithClasspath_1" d="M69.018,215.284L71.395,212.487C73.772,209.689,78.527,204.095,85.071,201.297C91.615,198.5,99.948,198.5,104.115,198.5L108.281,198.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_Task_Exec_2" d="M64.432,300.561L67.574,304.884C70.715,309.208,76.998,317.854,101.795,322.177C126.591,326.5,169.901,326.5,191.556,326.5L213.211,326.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_TaskWithClasspath_JavaCompileTask_3" d="M296.847,146.983L313.291,132.236C329.736,117.488,362.626,87.994,383.237,73.247C403.849,58.5,412.182,58.5,416.349,58.5L420.516,58.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_TaskWithClasspath_JavaRunTask_4" d="M388.516,198.5L389.682,198.5C390.849,198.5,393.182,198.5,401.48,198.5C409.779,198.5,424.042,198.5,431.173,198.5L438.305,198.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_TaskWithClasspath_AbstractJvmExec_5" d="M345.234,245.277L353.614,248.98C361.994,252.684,378.755,260.092,399.75,267.908C420.745,275.723,445.974,283.946,458.589,288.058L471.203,292.169"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_Exec_AbstractJvmExec_6" d="M283.586,326.5L302.241,326.5C320.896,326.5,358.206,326.5,389.475,325.661C420.745,324.822,445.974,323.144,458.589,322.305L471.203,321.465"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_JavaCompileTask_JavaCompile_7" d="M689.188,58.5L690.354,58.5C691.521,58.5,693.854,58.5,699.188,58.5C704.521,58.5,712.854,58.5,717.021,58.5L721.188,58.5"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_AbstractJvmExec_JavaCompile_8" d="M579.883,273.942L599.267,249.702C618.651,225.461,657.419,176.981,684.892,145.824C712.364,114.667,728.541,100.833,736.63,93.917L744.718,87"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_JavaRunTask_JavaRun_9" d="M671.398,198.5L675.53,198.5C679.661,198.5,687.924,198.5,702.404,213.417C716.884,228.333,737.58,258.167,747.928,273.083L758.276,288"></path><path marker-start="url(#my-svg_classDiagram-extensionStart)" style="fill:none" class="edge-pattern-solid relation" id="id_AbstractJvmExec_JavaRun_10" d="M638.5,316.5L648.115,316.5C657.729,316.5,676.958,316.5,693.408,316.5C709.857,316.5,723.526,316.5,730.361,316.5L737.195,316.5"></path></g><g class="edgeLabels"><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g><g class="edgeLabel"><g transform="translate(0, 0)" class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="edgeLabel"></span></div></foreignObject></g></g></g><g class="nodes"><g transform="translate(33.140625, 257.5)" id="classId-Task-0" class="node default"><rect height="57" width="50.28125" y="-28.5" x="-25.140625" class="outer title-state" style=""></rect><line y2="1.5" y1="1.5" x2="25.140625" x1="-25.140625" class="divider"></line><line y2="17.5" y1="17.5" x2="25.140625" x1="-25.140625" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -17.640625, -21)" height="18" width="35.28125" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Task</span></div></foreignObject></g></g><g transform="translate(239.3984375, 198.5)" id="classId-TaskWithClasspath-1" class="node default"><rect height="79" width="262.234375" y="-39.5" x="-131.1171875" class="outer title-state" style=""></rect><line y2="-9.5" y1="-9.5" x2="131.1171875" x1="-131.1171875" class="divider"></line><line y2="28.5" y1="28.5" x2="131.1171875" x1="-131.1171875" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -73.1328125, -32)" height="18" width="146.265625" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">TaskWithClasspath</span></div></foreignObject><foreignObject transform="translate( -123.6171875, 2)" height="18" width="247.234375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Property&lt;FileCollection&gt; classpath</span></div></foreignObject></g></g><g transform="translate(239.3984375, 326.5)" id="classId-Exec-2" class="node default"><rect height="57" width="52.375" y="-28.5" x="-26.1875" class="outer title-state" style=""></rect><line y2="1.5" y1="1.5" x2="26.1875" x1="-26.1875" class="divider"></line><line y2="17.5" y1="17.5" x2="26.1875" x1="-26.1875" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -18.6875, -21)" height="18" width="37.375" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Exec</span></div></foreignObject></g></g><g transform="translate(545.8515625, 58.5)" id="classId-JavaCompileTask-3" class="node default"><rect height="101" width="250.671875" y="-50.5" x="-125.3359375" class="outer title-state" style=""></rect><line y2="-20.5" y1="-20.5" x2="125.3359375" x1="-125.3359375" class="divider"></line><line y2="39.5" y1="39.5" x2="125.3359375" x1="-125.3359375" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -67, -43)" height="18" width="134" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JavaCompileTask</span></div></foreignObject><foreignObject transform="translate( -117.8359375, -9)" height="18" width="235.671875"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Property&lt;FileCollection&gt; sources</span></div></foreignObject><foreignObject transform="translate( -117.8359375, 13)" height="18" width="226.75"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">DirectoryProperty destinationDir</span></div></foreignObject></g></g><g transform="translate(545.8515625, 198.5)" id="classId-JavaRunTask-4" class="node default"><rect height="79" width="215.09375" y="-39.5" x="-107.546875" class="outer title-state" style=""></rect><line y2="-9.5" y1="-9.5" x2="107.546875" x1="-107.546875" class="divider"></line><line y2="28.5" y1="28.5" x2="107.546875" x1="-107.546875" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -50.9921875, -32)" height="18" width="101.984375" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JavaRunTask</span></div></foreignObject><foreignObject transform="translate( -100.046875, 2)" height="18" width="200.09375"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">Property&lt;String&gt; mainClass</span></div></foreignObject></g></g><g transform="translate(545.8515625, 316.5)" id="classId-AbstractJvmExec-5" class="node default"><rect height="57" width="149.296875" y="-28.5" x="-74.6484375" class="outer title-state" style="fill:#fbf;stroke:#333;stroke-width:4px;"></rect><line y2="1.5" y1="1.5" x2="74.6484375" x1="-74.6484375" class="divider"></line><line y2="17.5" y1="17.5" x2="74.6484375" x1="-74.6484375" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -67.1484375, -21)" height="18" width="134.296875" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">AbstractJvmExec</span></div></foreignObject></g></g><g transform="translate(778.046875, 58.5)" id="classId-JavaCompile-6" class="node default"><rect height="57" width="113.71875" y="-28.5" x="-56.859375" class="outer title-state" style="fill:#f7f;stroke:#333;stroke-width:4px;"></rect><line y2="1.5" y1="1.5" x2="56.859375" x1="-56.859375" class="divider"></line><line y2="17.5" y1="17.5" x2="56.859375" x1="-56.859375" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -49.359375, -21)" height="18" width="98.71875" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JavaCompile</span></div></foreignObject></g></g><g transform="translate(778.046875, 316.5)" id="classId-JavaRun-7" class="node default"><rect height="57" width="81.703125" y="-28.5" x="-40.8515625" class="outer title-state" style="fill:#f7f;stroke:#333;stroke-width:4px;"></rect><line y2="1.5" y1="1.5" x2="40.8515625" x1="-40.8515625" class="divider"></line><line y2="17.5" y1="17.5" x2="40.8515625" x1="-40.8515625" class="divider"></line><g class="label"><foreignObject height="0" width="0"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel"></span></div></foreignObject><foreignObject transform="translate( -33.3515625, -21)" height="18" width="66.703125" class="classTitle"><div style="display: inline-block; white-space: nowrap;" xmlns="http://www.w3.org/1999/xhtml"><span class="nodeLabel">JavaRun</span></div></foreignObject></g></g></g></g></g></svg></div>

</section><section>
<h2 id="creating-a-new-task-type-in-gradle">Creating a new Task type in Gradle</h2>
<p>Gradle supports the definition of new task types:</p>
<ul>
<li>New tasks <em>must implement</em> the <code>Task</code> interface
<ul>
<li>They <em>usually inherit</em> from <code>DefaultTask</code></li>
</ul>
</li>
<li>They must be <code>abstract</code>
<ul>
<li>Gradle creates subclasses on the fly under the hood and injects methods</li>
</ul>
</li>
<li>A public method can be marked as <code>@TaskAction</code>, and will get invoked to execute the task</li>
</ul>
</section><section>
<h3 id="input-output-caching-and-continuous-build-mode">Input, output, caching, and continuous build mode</h3>
<p>In recent Gradle versions, it is mandatory
to <em>annotate every public property’s <strong>getter</strong></em> of a task with a marker annotation
for gradle to mark it as an <em>input</em> or an <em>output</em>.</p>
<ul>
<li><code>@Input</code>, <code>@InputFile</code>, <code>@InputFiles</code>, <code>@InputDirectory</code>, <code>@InputDirectories</code>, <code>@Classpath</code></li>
<li><code>@OutputFile</code>, <code>@OutputFiles</code>, <code>@OutputDirectory</code>, <code>@OutputDirectories</code>
<ul>
<li><code>@Internal</code> marks <em>internal</em> output properties (not reified on the file system)</li>
<li><code>@Internal</code> marks <em>internal</em> output properties (not reified on the file system)</li>
</ul>
</li>
<li>In practice, these appear in Kotlin code as <code>@get:Input</code>, etc.
<ul>
<li>Otherwise, Kotlin would generate the annotation on the <em>field</em>, not on the <em>getter</em>, and Gradle would ignore it</li>
</ul>
</li>
</ul>
<h4 id="why">Why?</h4>
<ol>
<li><strong>Performance</strong>
<ul>
<li>Gradle caches intermediate build results, using input and output markers to undersand whether or not some task is <em>up to date</em></li>
<li>This allows for <em>much</em> faster builds while working on large projects
<ul>
<li>Time to build completion can decrease a dozen minutes to seconds!</li>
</ul>
</li>
</ul>
</li>
<li><strong>Continuous build</strong>
<ul>
<li>Re-run tasks upon changes with the <code>-t</code> option</li>
<li>(In/Out)put markers are used to understand <em>what</em> to re-run</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="custom-task-types-in-gradle">Custom Task types in Gradle</h2>

<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">abstract</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">AbstractJvmExec</span> : TaskWithClasspath, Exec() {
</span></span><span style="display:flex;"><span>    <span style="color:#555">@get</span>:Classpath
</span></span><span style="display:flex;"><span>    override val <span style="color:#369;font-style:italic">classpath:</span> Property&lt;FileCollection&gt; = project.<span style="color:#369">objects</span>.<span style="color:#369">property</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    init {
</span></span><span style="display:flex;"><span>        executable(Jvm.<span style="color:#369">current</span>().<span style="color:#369">jvmExecutableForTask</span>().<span style="color:#369">absolutePath</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Extension function with virtual dispatch receiver!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">protected</span> <span style="color:#080;font-weight:bold">abstract</span> fun Jvm.<span style="color:#369">jvmExecutableForTask</span>(): File
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">abstract</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#06b;font-weight:bold">JavaRun</span>() : JavaRunTask, AbstractJvmExec() {
</span></span><span style="display:flex;"><span>    <span style="color:#555">@get</span>:Input
</span></span><span style="display:flex;"><span>    override val <span style="color:#369;font-style:italic">mainClass:</span> Property&lt;String&gt; = project.<span style="color:#369">objects</span>.<span style="color:#369">property</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    override fun Jvm.<span style="color:#369">jvmExecutableForTask</span>(): File = javaExecutable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@TaskAction</span>
</span></span><span style="display:flex;"><span>    override fun <span style="color:#06b;font-weight:bold">exec</span>() {
</span></span><span style="display:flex;"><span>        args(
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, classpath.<span style="color:#369">get</span>().<span style="color:#369">asPath</span>,
</span></span><span style="display:flex;"><span>            mainClass.<span style="color:#369">get</span>(),
</span></span><span style="display:flex;"><span>        )
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">super</span>.<span style="color:#369">exec</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">abstract</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">JavaCompile</span>: JavaCompileTask, AbstractJvmExec() {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@get</span>:InputFiles
</span></span><span style="display:flex;"><span>    override val <span style="color:#369;font-style:italic">sources:</span> Property&lt;FileCollection&gt; = project.<span style="color:#369">objects</span>.<span style="color:#369">property</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#555">@get</span>:OutputDirectory
</span></span><span style="display:flex;"><span>    override val <span style="color:#369;font-style:italic">destinationDir:</span> DirectoryProperty = project.<span style="color:#369">objects</span>.<span style="color:#369">directoryProperty</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    override fun Jvm.<span style="color:#369">jvmExecutableForTask</span>(): File = javacExecutable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@TaskAction</span>
</span></span><span style="display:flex;"><span>    override fun <span style="color:#06b;font-weight:bold">exec</span>() {
</span></span><span style="display:flex;"><span>        when {
</span></span><span style="display:flex;"><span>            sources.<span style="color:#369">get</span>().<span style="color:#369">isEmpty</span> -&gt; {
</span></span><span style="display:flex;"><span>                println(<span style="color:#d20;background-color:#fff0f0">"No source files found, skipping compilation."</span>)
</span></span><span style="display:flex;"><span>                args(<span style="color:#d20;background-color:#fff0f0">"-version"</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">else</span> -&gt; args(
</span></span><span style="display:flex;"><span>                <span style="color:#888">// destination folder: the output directory of Gradle, inside "bin"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-d"</span>, destinationDir.<span style="color:#369">get</span>().<span style="color:#369">asFile</span>.<span style="color:#369">absolutePath</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#888">// classpath from the configuration
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>                <span style="color:#d20;background-color:#fff0f0">"-cp"</span>, <span style="color:#d20;background-color:#fff0f0">"${File.pathSeparator}${classpath.get().asPath}"</span>,
</span></span><span style="display:flex;"><span>                *sources.<span style="color:#369">get</span>().<span style="color:#369">files</span>.<span style="color:#369">toTypedArray</span>(),
</span></span><span style="display:flex;"><span>            )
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">super</span>.<span style="color:#369">exec</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="isolation-of-imperativity-2">Isolation of imperativity</h2>
<h3 id="problem">Problem</h3>
<p>In our main <code>build.gradle.kts</code>, we have:</p>

<div class="multiCol">
    <div class="col  ">
    <p>a <em>declarative</em> part</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// DECLARATIVE (what)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>val compilationDestination = layout.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">runtimeClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> {
</span></span><span style="display:flex;"><span>    extendsFrom(compileClasspath)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies { <span style="color:#888">// built-in in Gradle
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    allFiles.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> { <span style="color:#888">// Not Gradle: defined below
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        compileClasspath(files(it)) <span style="color:#888">// The Configuration class overrides the invoke operator
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>    runtimeClasspath(files(compilationDestination))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaCompile&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = compileClasspath
</span></span><span style="display:flex;"><span>    destinationDir = compilationDestination
</span></span><span style="display:flex;"><span>    sources = files(project.<span style="color:#369">allFiles</span>.<span style="color:#369">inFolder</span>(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaRun&gt;(<span style="color:#d20;background-color:#fff0f0">"runJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = runtimeClasspath
</span></span><span style="display:flex;"><span>    mainClass = <span style="color:#d20;background-color:#fff0f0">"HelloMath"</span>
</span></span><span style="display:flex;"><span>    dependsOn(tasks.<span style="color:#369">named</span>(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p>an <em>imperative</em> part</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// IMPERATIVE (how)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Minimal file access DSL
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>object AllFiles
</span></span><span style="display:flex;"><span>val Project.<span style="color:#369">allFiles</span>: AllFiles get() = AllFiles <span style="color:#888">// We need this to prevent "Object AllFiles captures the script class instance" error
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>data <span style="color:#080;font-weight:bold">class</span> <span style="color:#06b;font-weight:bold">Finder</span>(val <span style="color:#369;font-style:italic">path:</span> File) {
</span></span><span style="display:flex;"><span>    fun <span style="color:#06b;font-weight:bold">withExtension</span>(<span style="color:#369;font-style:italic">extension:</span> String): List&lt;File&gt; =
</span></span><span style="display:flex;"><span>        path.<span style="color:#369">walkTopDown</span>().<span style="color:#369">filter</span> { it.<span style="color:#369">isFile</span> &amp;&amp; it.<span style="color:#369">extension</span> == extension }.<span style="color:#369">toList</span>()
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>fun AllFiles.<span style="color:#369">inFolder</span>(<span style="color:#369;font-style:italic">path:</span> String) = Finder(projectDir.<span style="color:#369">resolve</span>(path))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">TaskWithClasspath</span> : Task {
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">classpath:</span> Property&lt;FileCollection&gt;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">JavaCompileTask</span> : TaskWithClasspath {
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">sources:</span> Property&lt;FileCollection&gt;
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">destinationDir:</span> DirectoryProperty
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">JavaRunTask</span> : TaskWithClasspath {
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">mainClass:</span> Property&lt;String&gt;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">abstract</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">AbstractJvmExec</span> : TaskWithClasspath, Exec() {
</span></span></code></pre></div><p>(continues a lot further)</p>
</div>

</div>

<h3 id="idea">Idea</h3>
<p><strong>Hide</strong> the <em>imperative</em> part <em>under the hood</em>,
and <strong>expose</strong> a purely <em>declarative API</em> to the <em>user</em>.</p>
</section><section>
<h2 id="isolation-of-imperativity-3">Isolation of imperativity</h2>
<h3 id="project-wise-api-extension">Project-wise API extension</h3>
<p>Gradle provides a way to define project-wise build APIs using a special <code>buildSrc</code> folder</p>
<ul>
<li>Requires a Gradle configuration file
<ul>
<li>What it actually does will be clearer in future</li>
</ul>
</li>
</ul>

<div class="multiCol">
    <div class="col  ">
    <p>Directory structure:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>project-folder
</span></span><span style="display:flex;"><span>├── build.gradle.kts
</span></span><span style="display:flex;"><span>├── buildSrc
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; ├── build.gradle.kts
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; └── src
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;     └── main
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;         └── kotlin
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;             ├── ImperativeAPI.kt
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;             └── MoreImperativeAPIs.kt
</span></span><span style="display:flex;"><span>└── settings.gradle.kts
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p><code>buildSrc/build.gradle.kts</code>’ contents (clearer in future):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    <span style="color:#a61717;background-color:#e3d2d2">`</span>kotlin-dsl<span style="color:#a61717;background-color:#e3d2d2">`</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>repositories {
</span></span><span style="display:flex;"><span>    mavenCentral()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="isolation-of-imperativity-4">Isolation of imperativity</h2>
<h3 id="project-wise-api-extension-1">Project-wise API extension</h3>

<div class="multiCol">
    <div class="col  ">
    <p>Directory structure for our Java infrastructure:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>examples/buildsrc
</span></span><span style="display:flex;"><span>├── build.gradle.kts
</span></span><span style="display:flex;"><span>├── buildSrc
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; ├── build.gradle.kts
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; └── src
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;     └── main
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;         └── kotlin
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;             ├── AllFiles.kt
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;             ├── JavaCompile.kt
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;             ├── JavaRun.kt
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp;             └── JavaTasksAPI.kt
</span></span><span style="display:flex;"><span>├── gradlew
</span></span><span style="display:flex;"><span>├── gradlew.bat
</span></span><span style="display:flex;"><span>├── libs
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; └── commons-math3-3.6.1.jar
</span></span><span style="display:flex;"><span>└── src
</span></span><span style="display:flex;"><span>    └── HelloMath.java
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p>our new <code>build.gradle.kts</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val compilationDestination = project.<span style="color:#369">layout</span>.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">runtimeClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> {
</span></span><span style="display:flex;"><span>    extendsFrom(compileClasspath)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    allFilesIn(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> {
</span></span><span style="display:flex;"><span>        compileClasspath(files(it))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    runtimeClasspath(files(compilationDestination))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaCompile&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = compileClasspath
</span></span><span style="display:flex;"><span>    destinationDir = compilationDestination
</span></span><span style="display:flex;"><span>    sources = files(allFilesIn(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaRun&gt;(<span style="color:#d20;background-color:#fff0f0">"runJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = runtimeClasspath
</span></span><span style="display:flex;"><span>    dependsOn(tasks.<span style="color:#369">named</span>(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

<p>we can use all types defined in <code>buildSrc/src/main/kotlin/</code> in the main project’s <code>build.gradle.kts</code>!</p>
</section><section>
<h2 id="isolation-of-imperativity-5">Isolation of imperativity</h2>
<h3 id="project-wise-conventions">Project-wise conventions</h3>

<div class="multiCol">
    <div class="col  ">
    <p>What our <code>build.gradle.kts</code> defines is now a <em>convention</em> for Java projects:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val compilationDestination = project.<span style="color:#369">layout</span>.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">runtimeClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> {
</span></span><span style="display:flex;"><span>    extendsFrom(compileClasspath)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    allFilesIn(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> {
</span></span><span style="display:flex;"><span>        compileClasspath(files(it))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    runtimeClasspath(files(compilationDestination))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaCompile&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = compileClasspath
</span></span><span style="display:flex;"><span>    destinationDir = compilationDestination
</span></span><span style="display:flex;"><span>    sources = files(allFilesIn(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaRun&gt;(<span style="color:#d20;background-color:#fff0f0">"runJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = runtimeClasspath
</span></span><span style="display:flex;"><span>    dependsOn(tasks.<span style="color:#369">named</span>(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <ul>
<li>There exist two configurations:
<ul>
<li><code>compileClasspath</code></li>
<li><code>runtimeClasspath</code>, which extends from <code>compileClasspath</code></li>
</ul>
</li>
<li>All jars in <code>libs</code> are added to both configurations</li>
<li>There is a <code>compileJava</code> task that compiles all Java sources in <code>src</code></li>
<li>There is a <code>runJava</code> task that runs a specified main class</li>
</ul>
<p>These could be valid for <em>any Java project</em>!</p>
</div>

</div>

</section><section>
<h2 id="isolation-of-imperativity-6">Isolation of imperativity</h2>
<h3 id="project-wise-conventions-1">Project-wise conventions</h3>
<ul>
<li>Conventional build logic can be defined in <code>buildSrc/src/main/kotlin/convention-name.gradle.kts</code>,</li>
<li>and imported in the main <code>build.gradle.kts</code> via:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    id(<span style="color:#d20;background-color:#fff0f0">"convention-name"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
<div class="multiCol">
    <div class="col  ">
    <p><code>buildSrc/src/main/kotlin/java-convention.gradle.kts</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>val compilationDestination = project.<span style="color:#369">layout</span>.<span style="color:#369">buildDirectory</span>.<span style="color:#369">dir</span>(<span style="color:#d20;background-color:#fff0f0">"bin"</span>).<span style="color:#369">get</span>().<span style="color:#369">asFile</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">compileClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span>
</span></span><span style="display:flex;"><span>val <span style="color:#369;font-style:italic">runtimeClasspath:</span> Configuration by configurations.<span style="color:#369">creating</span> {
</span></span><span style="display:flex;"><span>    extendsFrom(compileClasspath)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    allFilesIn(<span style="color:#d20;background-color:#fff0f0">"libs"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"jar"</span>).<span style="color:#369">forEach</span> {
</span></span><span style="display:flex;"><span>        compileClasspath(files(it))
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    runtimeClasspath(files(compilationDestination))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaCompile&gt;(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = compileClasspath
</span></span><span style="display:flex;"><span>    destinationDir = compilationDestination
</span></span><span style="display:flex;"><span>    sources = files(allFilesIn(<span style="color:#d20;background-color:#fff0f0">"src"</span>).<span style="color:#369">withExtension</span>(<span style="color:#d20;background-color:#fff0f0">"java"</span>))
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">register</span>&lt;JavaRun&gt;(<span style="color:#d20;background-color:#fff0f0">"runJava"</span>) {
</span></span><span style="display:flex;"><span>    classpath = runtimeClasspath
</span></span><span style="display:flex;"><span>    dependsOn(tasks.<span style="color:#369">named</span>(<span style="color:#d20;background-color:#fff0f0">"compileJava"</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p><code>build.gradle.kts</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    id(<span style="color:#d20;background-color:#fff0f0">"java-convention"</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>tasks.<span style="color:#369">runJava</span>.<span style="color:#369">configure</span> { <span style="color:#888">// We must set the main class here
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    mainClass = <span style="color:#d20;background-color:#fff0f0">"HelloMath"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="build-hierarchies">Build hierarchies</h2>
<p>Sometimes projects are <em>modular</em>
<br>
Where a module is a sub-project with a clear identity, possibly reusable elsewhere</p>
<p>Examples:</p>
<ul>
<li>A smartphone application with:
<ul>
<li>A common library</li>
<li>A software that uses such library for the actual app</li>
</ul>
</li>
<li>Bluetooth control software comprising:
<ul>
<li>Platform-specific drivers</li>
<li>A platform-agnostic bluetooth API and service</li>
<li>A CLI interface to the library</li>
<li>A Graphical interface</li>
</ul>
</li>
</ul>
<p>Modular software <em>simplifies maintenance</em> and <em>improves understandability</em>
<br>
Modules may <strong>depend</strong> on other modules
<br>
Some build tasks of some module may require build tasks <em>of other modules</em> to be complete before execution</p>
</section><section>
<h2 id="hierarchial-project">Hierarchial project</h2>
<p>Let us split our project into two components:</p>
<ul>
<li>A base library</li>
<li>A stand-alone application using the library</li>
</ul>
<p>We need to reorganize the build logic to something similar to</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>hierarchial-project
</span></span><span style="display:flex;"><span>|__:library
</span></span><span style="display:flex;"><span>\__:app
</span></span></code></pre></div><p>Desiderata:</p>
<ul>
<li>We can compile any of the two projects from the root</li>
<li>We can run the app from the root</li>
<li>Calling a run of the app implies a compilation of the library</li>
<li>We can clean both projects</li>
</ul>
</section><section>
<h2 id="authoring-subprojects-in-gradle">Authoring subprojects in Gradle</h2>
<p>Gradle (as many other build automators)
offers built-in support for <em>hierarchial projects</em>.
<br>
Gradle is limited to <em>two levels</em>, other products such as Maven have no limitation</p>
<p>Subprojects are listed in a <code>settings.gradle.kts</code> file
<br>
Incidentally, it’s the same place where the project name can be specified</p>
<p>Subprojects <em>must have their own</em> <code>build.gradle.kts</code>
<br>
They can also have their own <code>settings.gradle.kts</code>, e.g. for selecting a name different than their folder</p>
</section><section>
<h2 id="authoring-subprojects-in-gradle-1">Authoring subprojects in Gradle</h2>
<ol>
<li>Create a settings.gradle.kts and declare your modules:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>rootProject.<span style="color:#369">name</span> = <span style="color:#d20;background-color:#fff0f0">"project-with-hierarchy"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>include(<span style="color:#d20;background-color:#fff0f0">":library"</span>) <span style="color:#888">// There must be a folder named "library"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>include(<span style="color:#d20;background-color:#fff0f0">":app"</span>) <span style="color:#888">// There must be a folder named "app"
</span></span></span></code></pre></div><ol start="2">
<li>In the root project, configure the part common to <strong>all</strong> projects (included the root project) in a <code>allprojects</code> block</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>allprojects {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Executed for every project, included the root one
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#888">// here, `project` refers to the current project
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div><ol start="3">
<li>Put the part shared by <em>solely the sub-projects</em> into a <code>subprojects</code> block</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>subprojects {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Executed for all subprojects
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#888">// here, `project` refers to the current project
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div><ol start="4">
<li>In each subproject’s <code>build.gradle.kts</code>, add further customization as necessary</li>
<li>Connect configurations to each other using dependencies</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    compileClasspath(project(<span style="color:#d20;background-color:#fff0f0">":library"</span>)) { <span style="color:#888">// My compileClasspath configuration depends on project library
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        targetConfiguration = <span style="color:#d20;background-color:#fff0f0">"runtimeClasspath"</span> <span style="color:#888">// Specifically, from its runtime
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="6">
<li>Declare inter-subproject task dependencies
<ul>
<li>Tasks may fail if ran out of order! Compiling <code>app</code> requires <code>library</code> to be compiled.</li>
</ul>
</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.<span style="color:#369">compileJava</span> { dependsOn(project(<span style="color:#d20;background-color:#fff0f0">":library"</span>).<span style="color:#369">tasks</span>.<span style="color:#369">compileJava</span>) }
</span></span></code></pre></div></section><section>
<h2 id="reusability-across-multiple-projects">Reusability across multiple projects</h2>
<p>We now have a rudimental infrastructure for building and running Java projects
<br>
What if we want to reuse it?</p>
<p>Of course, copy/pasting the same file across projects is to be avoided whenever possible</p>
<h2 id="the-concept-of-plugin">The concept of plugin</h2>
<p>Gradle (as many other build systems) allow extensibility via <em>plugins</em>
<br>
A <em>plugin</em> is a software component that <em>extends the API</em> of the base system
<br>
It usually includes:</p>
<ul>
<li>A set of <code>Task</code>s</li>
<li>An <code>Extension</code> – An object incapsulating the global configuration options
<ul>
<li>leveraging an appropriate <em>DSL</em></li>
</ul>
</li>
<li>A <code>Plugin</code> object, implementing an <code>apply(Project)</code> function
<ul>
<li>Application must create the extension, the tasks, and the rest of the imperative stuff</li>
</ul>
</li>
<li>A <strong>manifest</strong> file declaring which of the classes implementing <code>Plugin</code> is the entry point of the declared plugin
<ul>
<li>located in <code>META-INF/gradle-plugins/&lt;plugin-name&gt;.properties</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="divide-conquer-encapsulate-adorn">Divide, conquer, encapsulate, adorn</h2>
<p>General approach to a <em>new</em> build automation problem:</p>
<p><strong>Divide</strong>: Identify the <em>base steps</em>, they could become your tasks</p>
<ul>
<li>Or any concept your build system exposes to model atomic operations</li>
</ul>
<p><strong>Conquer</strong>: Clearly express the <em>dependencies</em> among them</p>
<ul>
<li>Build a <em>pipeline</em></li>
<li>Implement them Providing a <em>clean API</em></li>
</ul>
<p><strong>Encapsulate</strong>: confine imperative logic, make it an <em>implementation detail</em></p>
<p><strong>Adorn</strong>: provide a DSL that makes the library <em>easy and intuitive</em></p>
<p><em>Not very different than what’s usually done in (good) software development</em></p>
</section><section>
<h2 id="using-a-plugin">Using a plugin</h2>
<ul>
<li>Plugins are loaded from the <em>build environment</em>
<ul>
<li>the <em>classpath</em> used for such tasks can be explored with the built-in task <code>buildEnvironment</code></li>
<li>if a plugin is not found, then if a version for it is available it’s <em>fetched from remote repositories</em>
<ul>
<li>by default the <a href="https://plugins.gradle.org/">Gradle plugin portal</a></li>
</ul>
</li>
</ul>
</li>
<li>Plugins need to be <strong>applied</strong>
<ul>
<li>Which actually translates to calling the <code>apply(Project)</code> function</li>
<li>Application for <em>hierarchial</em> projects is <em>not automatic</em>
<ul>
<li>You might want your plugin to be applied only in some subprojects!</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><strong>Example code</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    pluginName <span style="color:#888">// Loads a plugin from the "buildEnvironment" classpath
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#a61717;background-color:#e3d2d2">`</span>plugin-name<span style="color:#a61717;background-color:#e3d2d2">`</span> <span style="color:#888">// Syntax for non Kotlin-compliant plugin names
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    id(<span style="color:#d20;background-color:#fff0f0">"plugin2-name"</span>) <span style="color:#888">// Alternative to the former
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    id(<span style="color:#d20;background-color:#fff0f0">"some-custom-plugin"</span>) version <span style="color:#d20;background-color:#fff0f0">"1.2.3"</span> <span style="color:#888">// if not found locally, gets fetched from the Gradle plugin portal
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span><span style="display:flex;"><span><span style="color:#888">// In case of non-hierarchial projects, plugins are also "applied"
</span></span></span><span style="display:flex;"><span><span style="color:#888">// Otherwise, they need to get applied manually, e.g.:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>allprojects {
</span></span><span style="display:flex;"><span>    apply(plugin = <span style="color:#d20;background-color:#fff0f0">"pluginName"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="built-in-gradle-plugins">Built-in Gradle plugins</h2>
<p>The default Gradle distribution includes a large number of plugins, e.g.:</p>
<ul>
<li><code>java</code> plugin, for Java written applications
<ul>
<li>a full fledged version of the custom local plugin we created!</li>
</ul>
</li>
<li><code>java-library</code> plugin, for Java libraries (with no main class)</li>
<li><code>scala</code> plugin</li>
<li><code>cpp</code> plugin, for C++</li>
<li><code>kotlin</code> plugin, supporting Kotlin with multiple targets (JVM, Javascript, native)</li>
</ul>
<p>We are going to use the Kotlin JVM plugin to build our first standalone plugin!
<br>
(yes we already did write our first one: code in <code>buildSrc</code> is <em>project-local plugin code</em>)</p>
</section><section>
<h2 id="a-greeting-plugin">A Greeting plugin</h2>
<p>A very simple plugin that greets the user</p>
<p><strong>Desiderata</strong></p>
<ul>
<li>adds a <code>greet</code> task that prints a greeting</li>
<li>the default output should be configurable with something like:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    id(<span style="color:#d20;background-color:#fff0f0">"org.danilopianini.template-for-gradle-plugins"</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>hello {
</span></span><span style="display:flex;"><span>    author.<span style="color:#369">set</span>(<span style="color:#d20;background-color:#fff0f0">"Danilo Pianini"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="setting-up-a-kotlin-build">Setting up a Kotlin build</h2>
<p>First step: we need to set up a Kotlin build, we’ll write our plugin in Kotlin</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// No magic: calls a method running behind the scenes, equivalent to id("org.jetbrains.kotlin-$jvm")
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    kotlin(<span style="color:#d20;background-color:#fff0f0">"jvm"</span>) version <span style="color:#d20;background-color:#fff0f0">"2.2.20"</span> <span style="color:#888">// version is necessary
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div><p>The Kotlin <em>plugin</em> introduces tasks and configurations to compile and package Kotlin code</p>
<p>Second step: we need to declare where to find dependencies</p>
<ul>
<li>Maven repositories are a de-facto standard for shipping JVM libraries</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Configuration of software sources
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>repositories {
</span></span><span style="display:flex;"><span>    mavenCentral() <span style="color:#888">// points to Maven Central
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>     <span style="color:#888">// "implementation" is a configuration created by by the Kotlin JVM plugin
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    implementation(...) <span style="color:#888">// we can load libraries here
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div><p>Third step, we need the Gradle API</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    implementation(gradleApi()) <span style="color:#888">// Built-in method, returns a `Dependency` to the current Gradle version
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    api(gradleKotlinDsl()) <span style="color:#888">// Built-in method, returns a `Dependency` to the Gradle Kotlin DSL library
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div></section><section>
<h2 id="plugin-name-and-entry-point">Plugin name and entry point</h2>
<p>Gradle expects the plugin entry point (the class implementing the <code>Plugin</code> interface) to be specified in a <strong>manifest file</strong></p>
<ul>
<li>in a <em>property file</em></li>
<li>located in <code>META-INF/gradle-plugins</code></li>
<li>whose file name is <code>&lt;plugin-name&gt;.properties</code></li>
</ul>
<p>The name is usually a “reverse url”, similarly to Java packages.
<br>
e.g., <code>it.unibo.spe.greetings</code></p>
<p>The file content is just a pointer to the class implementing <code>Plugin</code>, for instance:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#369">implementation-class</span>=<span style="color:#d20;background-color:#fff0f0">it.unibo.spe.firstplugin.GreetingPlugin</span>
</span></span></code></pre></div></section><section>
<h2 id="plugin-implementation">Plugin implementation</h2>
<p>Usually, composed of:</p>
<ul>
<li>A <em>clean API</em>, if the controlled system is not trivial</li>
<li>A set of <em>tasks</em> incapuslating the imperative logic</li>
<li>An <em>extension</em> containing the DSL for configuring the plugin</li>
<li>A <em>plugin</em>
<ul>
<li>Creates the extension</li>
<li>Creates the tasks</li>
<li>Links tasks and extension</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="a-gradle-plugin-implementation">A Gradle plugin implementation</h2>
<p>inside <code>src/main/kotlin/&lt;package-path&gt;/</code>:</p>

<div class="multiCol">
    <div class="col  ">
    <p><code>HelloTask</code> implementation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>open <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">HelloTask</span> : DefaultTask() {
</span></span><span style="display:flex;"><span>    <span style="color:#888">/**
</span></span></span><span style="display:flex;"><span><span style="color:#888">     * The author of the greeting, lazily set.
</span></span></span><span style="display:flex;"><span><span style="color:#888">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@get</span>:Input
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">author:</span> Property&lt;String&gt; = project.<span style="color:#369">objects</span>.<span style="color:#369">property</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">/**
</span></span></span><span style="display:flex;"><span><span style="color:#888">     * Read-only property calculated from the greeting.
</span></span></span><span style="display:flex;"><span><span style="color:#888">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@get</span>:Internal
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">message:</span> Provider&lt;String&gt; = author.<span style="color:#369">map</span> { <span style="color:#d20;background-color:#fff0f0">"Hello from $it"</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">/**
</span></span></span><span style="display:flex;"><span><span style="color:#888">     * This is the code that is executed when the task is run.
</span></span></span><span style="display:flex;"><span><span style="color:#888">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@TaskAction</span>
</span></span><span style="display:flex;"><span>    fun <span style="color:#06b;font-weight:bold">printMessage</span>() {
</span></span><span style="display:flex;"><span>        logger.<span style="color:#369">quiet</span>(message.<span style="color:#369">get</span>())
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p><code>HelloExtension</code>, the DSL entrypoint:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>open <span style="color:#080;font-weight:bold">class</span> <span style="color:#06b;font-weight:bold">HelloExtension</span>(<span style="color:#369;font-style:italic">objects:</span> ObjectFactory) {
</span></span><span style="display:flex;"><span>    <span style="color:#888">/**
</span></span></span><span style="display:flex;"><span><span style="color:#888">     * This is where you write your DSL to control the plugin.
</span></span></span><span style="display:flex;"><span><span style="color:#888">     */</span>
</span></span><span style="display:flex;"><span>    val <span style="color:#369;font-style:italic">author:</span> Property&lt;String&gt; = objects.<span style="color:#369">property</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>HelloGradle</code>, the plugin entrypoint:</p>
<ul>
<li>whose <code>apply</code> method is called upon application</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>open <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">HelloGradle</span> : Plugin&lt;Project&gt; {
</span></span><span style="display:flex;"><span>    override fun <span style="color:#06b;font-weight:bold">apply</span>(<span style="color:#369;font-style:italic">target:</span> Project) {
</span></span><span style="display:flex;"><span>        val extension = target.<span style="color:#369">extensions</span>.<span style="color:#369">create</span>&lt;HelloExtension&gt;(<span style="color:#d20;background-color:#fff0f0">"hello"</span>)
</span></span><span style="display:flex;"><span>        <span style="color:#888">// Enables `hello { ... }` in build.gradle.kts
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        target.<span style="color:#369">tasks</span>.<span style="color:#369">register</span>&lt;HelloTask&gt;(<span style="color:#d20;background-color:#fff0f0">"hello"</span>) {
</span></span><span style="display:flex;"><span>            author.<span style="color:#369">set</span>(extension.<span style="color:#369">author</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="plugin-application-from-plugins-and-reaction-to-plugin-applications">Plugin application from plugins and reaction to plugin applications</h2>
<ul>
<li>The <code>Plugin</code> configures the project as needed for the tasks and the extension to work</li>
<li>Plugins can forcibly <em>apply</em> other plugins
<ul>
<li>e.g., the Kotlin plugin applies the <code>java-library</code> plugin behind the scenes</li>
<li>although it is generally preferred to <em>react</em> to the application of other plugins</li>
</ul>
</li>
<li>Plugins can <em>react</em> to the application of other plugins
<ul>
<li>e.g., enable additional features or provide compatibility</li>
<li>doing so is possible by the <code>plugins</code> property of <code>Project</code>, e.g.:</li>
</ul>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>project.plugins.withType(JavaPlugin::<span style="color:#080;font-weight:bold">class</span>.java) {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Stuff you want to do only if someone enables the Java plugin for the current project
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div></section><section>
<h2 id="testing-a-plugin">Testing a plugin</h2>
<ol>
<li>Push the gradle plugin into the <em>build classpath</em></li>
<li>Prepare a Gradle <em>workspace</em></li>
<li><em>Launch the tasks</em> of interest</li>
<li><em>Verify</em> the task success (or failure, if expected), or the program output</li>
</ol>
<p>Gradle provides a <strong>test kit</strong>, to launch Gradle programmatically and inspect the execution results</p>
</section><section>
<h2 id="importing-the-gradle-dependencies-and-the-test-kit">Importing the Gradle dependencies and the test kit</h2>
<p>It’s just matter of pulling the right dependencies</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    implementation(gradleApi())
</span></span><span style="display:flex;"><span>    implementation(gradleKotlinDsl())
</span></span><span style="display:flex;"><span>    testImplementation(gradleTestKit()) <span style="color:#888">// Test implementation: available for testing compile and testing runtime
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div><h3 id="plugin-classpath-injection">Plugin Classpath injection</h3>
<p>By default, the Gradle test kit just runs Gradle.
We want to inject our plugin into the distribution:</p>
<ol>
<li>Create the list of files composing our <em>runtime classpath</em></li>
<li>Make sure that the list is always up to date and ready before test execution</li>
<li>Use such list as our classpath for running Gradle</li>
</ol>
<p>This operation is now built-in the test kit:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Configure a Gradle runner
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">runner</span> = <span style="color:#b06;font-weight:bold">GradleRunner</span>.create()
</span></span><span style="display:flex;"><span>    .withProjectDir()
</span></span><span style="display:flex;"><span>    .withPluginClasspath(classpath) <span style="color:#888">// we need Gradle **and** our plugin
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    .withArguments(<span style="color:#d20;background-color:#fff0f0">":tasks"</span>, <span style="color:#d20;background-color:#fff0f0">":you"</span>, <span style="color:#d20;background-color:#fff0f0">":need"</span>, <span style="color:#d20;background-color:#fff0f0">":to"</span>, <span style="color:#d20;background-color:#fff0f0">":run:"</span>, <span style="color:#d20;background-color:#fff0f0">"--and"</span>, <span style="color:#d20;background-color:#fff0f0">"--cli"</span>, <span style="color:#d20;background-color:#fff0f0">"--options"</span>)
</span></span><span style="display:flex;"><span>    .build() <span style="color:#888">// This actually runs Gradle
</span></span></span><span style="display:flex;"><span><span style="color:#888">// Inspect results
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>runner.task(<span style="color:#d20;background-color:#fff0f0">":someExistingTask"</span>)?.outcome shouldBe <span style="color:#b06;font-weight:bold">TaskOutcome</span>.SUCCESS
</span></span><span style="display:flex;"><span>runner.output shouldContain <span style="color:#d20;background-color:#fff0f0">"Hello from Gradle"</span>
</span></span></code></pre></div></section><section>
<h2 id="dry-with-dependencies-declaration">DRY with dependencies declaration</h2>
<p>Look at the following example code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    testImplementation(<span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-runner-junit5:4.2.5"</span>)
</span></span><span style="display:flex;"><span>    testImplementation(<span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-assertions-core:4.2.5"</span>)
</span></span><span style="display:flex;"><span>    testImplementation(<span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-assertions-core-jvm:4.2.5"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>It is <em>repetitive</em> and <em>fragile</em> (what if you change the version of a single kotest module?)</p>
<p>Let’s patch all this fragility:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">kotestVersion</span> = <span style="color:#d20;background-color:#fff0f0">"4.2.5"</span>
</span></span><span style="display:flex;"><span>    testImplementation(<span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-runner-junit5:</span><span style="color:#33b;background-color:#fff0f0">$kotestVersion</span><span style="color:#d20;background-color:#fff0f0">"</span>)
</span></span><span style="display:flex;"><span>    testImplementation(<span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-assertions-core:</span><span style="color:#33b;background-color:#fff0f0">$kotestVersion</span><span style="color:#d20;background-color:#fff0f0">"</span>)
</span></span><span style="display:flex;"><span>    testImplementation(<span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-assertions-core-jvm:</span><span style="color:#33b;background-color:#fff0f0">$kotestVersion</span><span style="color:#d20;background-color:#fff0f0">"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Still, quite repetitive…</p>
</section><section>
<h2 id="dry-with-dependencies-declaration-1">DRY with dependencies declaration</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    val kotestVersion = <span style="color:#d20;background-color:#fff0f0">"4.2.5"</span>
</span></span><span style="display:flex;"><span>    fun <span style="color:#06b;font-weight:bold">kotest</span>(<span style="color:#369;font-style:italic">module:</span> String) = <span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-$module:$kotestVersion"</span>
</span></span><span style="display:flex;"><span>    testImplementation(kotest(<span style="color:#d20;background-color:#fff0f0">"runner-junit5"</span>)
</span></span><span style="display:flex;"><span>    testImplementation(kotest(<span style="color:#d20;background-color:#fff0f0">"assertions-core"</span>)
</span></span><span style="display:flex;"><span>    testImplementation(kotest(<span style="color:#d20;background-color:#fff0f0">"assertions-core-jvm"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Uhmm…</p>
<ul>
<li>it’s still repetitive (can be furter factorized by bundling the kotest modules)</li>
<li>the function and version could be included in <code>buildSrc</code></li>
<li>custom solutions can be nice, but:
<ol>
<li>they can be hard to understand, as they are not standard</li>
<li>may make further automation harder (e.g., bots that run automatic updates may not be aware of your custom solution)</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="declaring-dependencies-in-a-catalog">Declaring dependencies in a <em>catalog</em></h2>
<p>Gradle 7 introduced the <em>catalogs</em>, a standardized way to collect and bundle dependencies.</p>
<p>Catalogs can be declared in:</p>
<ul>
<li>the <code>build.gradle.kts</code> file (they are API, of course)</li>
<li>a <a href="https://github.com/toml-lang/toml">TOML</a> configuration file (default: <code>gradle/libs.versions.toml</code>)</li>
</ul>

<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>[versions]
</span></span><span style="display:flex;"><span>dokka = <span style="color:#d20;background-color:#fff0f0">"2.0.0"</span>
</span></span><span style="display:flex;"><span>konf = <span style="color:#d20;background-color:#fff0f0">"1.1.2"</span>
</span></span><span style="display:flex;"><span>kotest = <span style="color:#d20;background-color:#fff0f0">"6.0.4"</span>
</span></span><span style="display:flex;"><span>kotlin = <span style="color:#d20;background-color:#fff0f0">"2.2.21"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[libraries]
</span></span><span style="display:flex;"><span>apache-commons-lang3 = <span style="color:#d20;background-color:#fff0f0">"org.apache.commons:commons-lang3:3.19.0"</span>
</span></span><span style="display:flex;"><span>classgraph = <span style="color:#d20;background-color:#fff0f0">"io.github.classgraph:classgraph:4.8.184"</span>
</span></span><span style="display:flex;"><span>konf-yaml = { module = <span style="color:#d20;background-color:#fff0f0">"com.uchuhimo:konf-yaml"</span>, version.<span style="color:#369">ref</span> = <span style="color:#d20;background-color:#fff0f0">"konf"</span> }
</span></span><span style="display:flex;"><span>kotest-junit5-jvm = { module = <span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-runner-junit5-jvm"</span>, version.<span style="color:#369">ref</span> = <span style="color:#d20;background-color:#fff0f0">"kotest"</span> }
</span></span><span style="display:flex;"><span>kotest-assertions-core-jvm = { module = <span style="color:#d20;background-color:#fff0f0">"io.kotest:kotest-assertions-core-jvm"</span>, version.<span style="color:#369">ref</span> = <span style="color:#d20;background-color:#fff0f0">"kotest"</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[bundles]
</span></span><span style="display:flex;"><span>kotlin-testing = [ <span style="color:#d20;background-color:#fff0f0">"kotest-junit5-jvm"</span>, <span style="color:#d20;background-color:#fff0f0">"kotest-assertions-core-jvm"</span> ]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>[plugins]
</span></span><span style="display:flex;"><span>dokka = { id = <span style="color:#d20;background-color:#fff0f0">"org.jetbrains.dokka"</span>, version.<span style="color:#369">ref</span> = <span style="color:#d20;background-color:#fff0f0">"dokka"</span> }
</span></span><span style="display:flex;"><span>gitSemVer = <span style="color:#d20;background-color:#fff0f0">"org.danilopianini.git-sensitive-semantic-versioning:7.0.6"</span>
</span></span><span style="display:flex;"><span>gradlePluginPublish = <span style="color:#d20;background-color:#fff0f0">"com.gradle.plugin-publish:2.0.0"</span>
</span></span><span style="display:flex;"><span>jacoco-testkit = <span style="color:#d20;background-color:#fff0f0">"pl.droidsonroids.jacoco.testkit:1.0.12"</span>
</span></span><span style="display:flex;"><span>kotlin-jvm = { id = <span style="color:#d20;background-color:#fff0f0">"org.jetbrains.kotlin.jvm"</span>, version.<span style="color:#369">ref</span> = <span style="color:#d20;background-color:#fff0f0">"kotlin"</span> }
</span></span><span style="display:flex;"><span>kotlin-qa = <span style="color:#d20;background-color:#fff0f0">"org.danilopianini.gradle-kotlin-qa:0.96.0"</span>
</span></span><span style="display:flex;"><span>multiJvmTesting = <span style="color:#d20;background-color:#fff0f0">"org.danilopianini.multi-jvm-test-plugin:4.3.2"</span>
</span></span><span style="display:flex;"><span>publishOnCentral = <span style="color:#d20;background-color:#fff0f0">"org.danilopianini.publish-on-central:9.1.7"</span>
</span></span><span style="display:flex;"><span>taskTree = <span style="color:#d20;background-color:#fff0f0">"com.dorongold.task-tree:4.0.1"</span>
</span></span></code></pre></div>
</div>
<div class="col  ">
    <p>Gradle generates <em>type-safe accessors</em> for the definitions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>dependencies {
</span></span><span style="display:flex;"><span>    api(gradleApi())
</span></span><span style="display:flex;"><span>    api(gradleKotlinDsl())
</span></span><span style="display:flex;"><span>    api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-jdk8"</span>))
</span></span><span style="display:flex;"><span>    testImplementation(gradleTestKit())
</span></span><span style="display:flex;"><span>    testImplementation(libs.<span style="color:#369">apache</span>.<span style="color:#369">commons</span>.<span style="color:#369">lang3</span>)
</span></span><span style="display:flex;"><span>    testImplementation(libs.<span style="color:#369">konf</span>.<span style="color:#369">yaml</span>)
</span></span><span style="display:flex;"><span>    testImplementation(libs.<span style="color:#369">classgraph</span>)
</span></span><span style="display:flex;"><span>    testImplementation(libs.<span style="color:#369">bundles</span>.<span style="color:#369">kotlin</span>.<span style="color:#369">testing</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Also for the plugins:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    <span style="color:#a61717;background-color:#e3d2d2">`</span>java-gradle-plugin<span style="color:#a61717;background-color:#e3d2d2">`</span>
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">dokka</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">gitSemVer</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">gradlePluginPublish</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">jacoco</span>.<span style="color:#369">testkit</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">kotlin</span>.<span style="color:#369">jvm</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">kotlin</span>.<span style="color:#369">qa</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">publishOnCentral</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">multiJvmTesting</span>)
</span></span><span style="display:flex;"><span>    alias(libs.<span style="color:#369">plugins</span>.<span style="color:#369">taskTree</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>

</div>

</section><section>
<h2 id="build-vs-compile-vs-test-toolchains">Build vs. Compile vs. Test toolchains</h2>
<p>We now have three different runtimes at play:</p>
<ol>
<li>One or more <strong>compilation targets</strong>
<ul>
<li>In case of JVM projects, the target bytecode version</li>
<li>In case of .NET projects, the target .NET</li>
<li>In case of native projects, the target OS / architecture</li>
</ul>
</li>
<li>One or more <strong>runtime targets</strong>
<ul>
<li>In case of JVM or .NET projects the virtual machines we want to support</li>
</ul>
</li>
<li>A <strong>built-time runtime</strong>
<ul>
<li>In case of Gradle, the JVM running the build system</li>
</ul>
</li>
</ol>
<p>These toolchains <em>should be controlled indipendently</em>!</p>
<p>You may want to use Java 17 to run Gradle, but compile in a Java 8-compatible bytecode, and then test on Java 11.</p>
</section><section>
<h2 id="gradle-and-the-toolchains">Gradle and the toolchains</h2>
<p>Default behaviour: Gradle uses <em>the same JVM it is running in</em> as:</p>
<ul>
<li>build runtime (you don’t say)</li>
<li>compile target</li>
<li>test runtime</li>
</ul>
<p>Supporting multiple toolchains may not be easy!</p>
<ul>
<li>Cross-compilers?</li>
<li>Automatic retrieval of runtime environments?</li>
<li>Emulators for native devices?</li>
</ul>
<p>Targeting a portable runtime (such as the JVM) <em>helps a lot</em>.</p>
</section><section>
<h2 id="introducing-the-gradle-toolchains">Introducing the Gradle toolchains</h2>
<p>Define the reference toolchain version (<em>compilation target</em>):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>java {
</span></span><span style="display:flex;"><span>    toolchain {
</span></span><span style="display:flex;"><span>        languageVersion.<span style="color:#369">set</span>(JavaLanguageVersion.<span style="color:#369">of</span>(<span style="color:#00d;font-weight:bold">11</span>))
</span></span><span style="display:flex;"><span>        vendor.<span style="color:#369">set</span>(JvmVendorSpec.<span style="color:#369">ADOPTOPENJDK</span>) <span style="color:#888">// Optionally, specify a vendor
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        implementation.<span style="color:#369">set</span>(JvmImplementation.<span style="color:#369">J9</span>) <span style="color:#888">// Optionally, select an implementation
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Create tasks for running tests on specific environments:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.<span style="color:#369">withType</span>&lt;Test&gt;().<span style="color:#369">toList</span>().<span style="color:#369">takeIf</span> { it.<span style="color:#369">size</span> == <span style="color:#00d;font-weight:bold">1</span> }?.<span style="color:#369">let</span>{ it.<span style="color:#369">first</span> }.<span style="color:#369">run</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// If there exist a "test" task, run it with some specific JVM version
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    javaLauncher.<span style="color:#369">set</span>(javaToolchains.<span style="color:#369">launcherFor</span> { languageVersion.<span style="color:#369">set</span>(JavaLanguageVersion.<span style="color:#369">of</span>(<span style="color:#00d;font-weight:bold">8</span>)) })
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#888">// Register another test task, with a different JVM
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>val testWithJVM17 by tasks.<span style="color:#369">registering</span>&lt;Test&gt; { <span style="color:#888">// Also works with JavaExec
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    javaLauncher.<span style="color:#369">set</span>(javaToolchains.<span style="color:#369">launcherFor</span> { languageVersion.<span style="color:#369">set</span>(JavaLanguageVersion.<span style="color:#369">of</span>(<span style="color:#00d;font-weight:bold">17</span>)) })
</span></span><span style="display:flex;"><span>} <span style="color:#888">// You can pick JVM's not yet supported by Gradle!
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>tasks.<span style="color:#369">findByName</span>(<span style="color:#d20;background-color:#fff0f0">"check"</span>)?.<span style="color:#369">configure</span> { it.<span style="color:#369">dependsOn</span>(testWithJVM17) } <span style="color:#888">// make it part of the QA suite
</span></span></span></code></pre></div></section><section>
<h2 id="making-the-plugin-available">Making the plugin available</h2>
<p>We now know how to build a plugin, we know how to test it,
<br>
<em>we don’t know how to make it available to other projects!</em></p>
<p>We want something like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    id(<span style="color:#d20;background-color:#fff0f0">"our.plugin.id"</span>) version <span style="color:#d20;background-color:#fff0f0">"our.plugin.version"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To do so, we need to ship our plugin to the <a href="https://plugins.gradle.org/">Gradle plugin portal</a>
<br>
Gradle provides <a href="https://plugins.gradle.org/docs/publish-plugin">a plugin publishing plugin</a> to simplify delivery</p>
<p>…but before, we need to learn how to</p>
<ol>
<li>
<p>click $\Rightarrow{}$ <a href="../05-version-selection"><strong>pick a version number</strong></a> $\Leftarrow{}$ click</p>
</li>
<li>
<p>click $\Rightarrow{}$ <a href="../06-licenses"><strong>select a software license</strong></a>! $\Leftarrow{}$ click</p>
</li>
</ol>
</section><section>
<h1 id="setting-a-version">Setting a version</h1>
<p>The project version can be specified in Gradle by simply setting the <code>version</code> property of the project:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>version = <span style="color:#d20;background-color:#fff0f0">"0.1.0"</span>
</span></span></code></pre></div><ul>
<li>Drawback: <em>manual management</em>!</li>
</ul>
<p>It would be better to <em>rely on the underlying DVCS</em>
<br>
to compute a Semantic Versioning compatible version!</p>
</section><section>
<h2 id="dvcs-based-automatic-semantic-versioning">DVCS-based Automatic semantic versioning</h2>
<p>There are a number of plugins that do so
<br>
including <a href="https://github.com/DanySK/git-sensitive-semantic-versioning-gradle-plugin">one I’ve developed</a></p>
<p>Minimal configuration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    id (<span style="color:#d20;background-color:#fff0f0">"org.danilopianini.git-sensitive-semantic-versioning"</span>) version <span style="color:#d20;background-color:#fff0f0">"&lt;latest version&gt;"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span> ./gradlew printGitSemVer
</span></span><span style="display:flex;"><span>&gt; Task :printGitSemVer
</span></span><span style="display:flex;"><span>Version computed by GitSemVer: 0.1.0-archeo+cf5b4c0
</span></span></code></pre></div><p>Another possibility is <em>writing a plugin yourself</em>
<br>
But at the moment we are stuck: we don’t know yet how to expose plugins to other builds</p>
</section><section>
<h1 id="selecting-a-license">Selecting a license</h1>
<p>There’s not really much I want to protect in this example, so I’m going to pick one of the most open licenses: MIT (BSD would have been a good alternative)</p>
<ol>
<li>Create a LICENSE file</li>
<li>Copy the text from the MIT license</li>
<li>If needed, edit details</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Copyright 2020 Danilo Pianini
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated
</span></span><span style="display:flex;"><span>documentation files (the "Software"), to deal in the Software without restriction, including without limitation
</span></span><span style="display:flex;"><span>the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to
</span></span><span style="display:flex;"><span>permit persons to whom the Software is furnished to do so, subject to the following conditions:
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the
</span></span><span style="display:flex;"><span>Software.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE
</span></span><span style="display:flex;"><span>WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS
</span></span><span style="display:flex;"><span>OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
</span></span><span style="display:flex;"><span>OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
</span></span></code></pre></div></section><section>
<h1 id="maven-style-packaging">Maven-style packaging</h1>
<p>JVM artifacts are normally shipped in form of jar archives
<br>
the de-facto convention is <em>inherited from Maven</em>:</p>
<ul>
<li>Each distribution has a <strong>groupId</strong>, an <strong>artifactId</strong>, and a <strong>version</strong>
<ul>
<li>e.g. <code>com.google.guava:guava:29.0-jre</code>
<ul>
<li>groupId: <code>com.google.guava</code></li>
<li>artifactId: <code>guava</code></li>
<li>version: <code>29.0-jre</code></li>
</ul>
</li>
</ul>
</li>
<li>Further <strong>metadata</strong> is stored in a <code>pom.xml</code> file</li>
<li>Multiple artifacts in the same distributions are identified by a <strong>classifier</strong>
<ul>
<li>e.g., a project having executables, sources, and javadoc, may have:
<ul>
<li><code>guava-29.0-jre.jar</code></li>
<li><code>guava-29.0-jre-javadoc.jar</code></li>
<li><code>guava-29.0-jre-sources.jar</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="setting-the-details">Setting the details</h2>
<p>In order to create Maven-compatible artifacts, we need first to set the <strong>groupId</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>group = <span style="color:#d20;background-color:#fff0f0">"it.unibo.firstplugin"</span>
</span></span></code></pre></div><p>Many repositories require to register the group and associate developer identities to it</p>
<p>The project name set in <code>settings.gradle.kts</code> is usually used as <strong>artifactId</strong></p>
<ul>
<li>In case of hierarchical projects, each subproject is a separate artifact and its name is used as artifactId</li>
</ul>
</section><section>
<h2 id="preparing-the-plugin-publication">Preparing the plugin publication</h2>
<p>Gradle provides two plugins to simplify the assembly and upload of plugins</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>  <span style="color:#a61717;background-color:#e3d2d2">`</span>java-gradle-plugin<span style="color:#a61717;background-color:#e3d2d2">`</span>
</span></span><span style="display:flex;"><span>  id(<span style="color:#d20;background-color:#fff0f0">"com.gradle.plugin-publish"</span>) version <span style="color:#d20;background-color:#fff0f0">"2.0.0"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>gradlePlugin {
</span></span><span style="display:flex;"><span>    plugins {
</span></span><span style="display:flex;"><span>        website.<span style="color:#369">set</span>(info.<span style="color:#369">website</span>)
</span></span><span style="display:flex;"><span>        vcsUrl.<span style="color:#369">set</span>(info.<span style="color:#369">vcsUrl</span>)
</span></span><span style="display:flex;"><span>        create(<span style="color:#d20;background-color:#fff0f0">""</span>) {
</span></span><span style="display:flex;"><span>            id = <span style="color:#d20;background-color:#fff0f0">"$group.${project.name}"</span>
</span></span><span style="display:flex;"><span>            displayName = info.<span style="color:#369">longName</span>
</span></span><span style="display:flex;"><span>            description = project.<span style="color:#369">description</span>
</span></span><span style="display:flex;"><span>            implementationClass = info.<span style="color:#369">pluginImplementationClass</span>
</span></span><span style="display:flex;"><span>            tags.<span style="color:#369">set</span>(info.<span style="color:#369">tags</span>)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>They add the <code>publishPlugins</code> task</p>
</section><section>
<h2 id="credentials">Credentials</h2>
<p>In order to publish on the Gradle Plugin Portal (but it is true for any repository) users need to be <em>authenticated</em>
<br>
This is most frequently done via authentication tokens, and more rarely by username and password.</p>
<p>It is first required to <a href="https://plugins.gradle.org/user/register">register</a>,
once done, an <strong>API Key</strong> will be available from the web interface, along with a <strong>secret</strong>.</p>
<p>These data is required to be able to publish, and can be fed to Gradle in two ways:</p>
<ol>
<li>By editing the <code>~/.gradle/gradle.properties</code> file, adding:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>gradle.publish.key=YOUR_KEY
</span></span><span style="display:flex;"><span>gradle.publish.secret=YOUR_SECRET
</span></span></code></pre></div><ol start="2">
<li>Via command line, using <code>-P</code> flags:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>./gradlew -Pgradle.publish.key=&lt;key&gt; -Pgradle.publish.secret=&lt;secret&gt; publishPlugins
</span></span></code></pre></div><p>The result is a published plugin:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>❯ ./gradlew publishPlugins
</span></span><span style="display:flex;"><span>&gt; Task :publishPlugins
</span></span><span style="display:flex;"><span>Publishing plugin it.unibo.spe.greetings-plugin version 0.1.0-archeo+ea6b9d7
</span></span><span style="display:flex;"><span>Publishing artifact build/libs/greetings-plugin-0.1.0-archeo+ea6b9d7.jar
</span></span><span style="display:flex;"><span>Publishing artifact build/libs/greetings-plugin-0.1.0-archeo+ea6b9d7-sources.jar
</span></span><span style="display:flex;"><span>Publishing artifact build/libs/greetings-plugin-0.1.0-archeo+ea6b9d7-javadoc.jar
</span></span><span style="display:flex;"><span>Publishing artifact build/publish-generated-resources/pom.xml
</span></span><span style="display:flex;"><span>Activating plugin it.unibo.spe.greetings-plugin version 0.1.0-archeo+ea6b9d7
</span></span></code></pre></div></section><section>
<h1 id="quality-control-beyond-testing">Quality control beyond testing</h1>
<h3 id="static-analysis">Static analysis</h3>
<p>Static analysis is the <strong>automatic inspection of source code</strong> to detect potential problems, without executing it.</p>
<ul>
<li>If you execute your code, it is called <em>dynamic analysis</em> (or, more frequently, <em>testing</em>)</li>
</ul>
<h3 id="test-coverage">Test coverage</h3>
<p>Test coverage tools measure <strong>how much of the code is executed while running tests</strong>.</p>
<ul>
<li>Helps identifying <em>untested</em> parts of the codebase</li>
<li>

<span class="fragment ">
  Coverage cannot tell anything about the <strong>covered</strong> code, it can only spot <strong>uncovered</strong> fragments
</span>
</li>
</ul>
<h2 id="quality-control-in-gradle">Quality control in Gradle</h2>
<p>If the <code>lifecycle</code> plugin is applied (it is auto-applied by most language-specific plugins), then a <code>check</code> task is available</p>
<ul>
<li><code>check</code> is meant to run all quality control tasks</li>
<li>any additional quality-control task should be made a dependency of <code>check</code></li>
<li>by default, <code>check</code> depends on <code>test</code></li>
</ul>
<p>QA tasks normally produce <em>reports</em> that can be inspected to understand what went wrong (if anything)</p>
<ul>
<li>Typically under <code>build/reports/</code>
<ul>
<li>For instance, <em>test results</em> are published in <code>$buildDir/reports/tests</code></li>
</ul>
</li>
<li>If you want to write a reporting task, extend from <code>AbstractReportTask</code></li>
</ul>
</section><section>
<h2 id="qa-in-kotlingradle">QA in Kotlin+Gradle</h2>
<p>Useful Kotlin tools:</p>
<ol>
<li>The <strong>Kotlin compiler</strong> can be set aggressively: “<em>warnings as errors</em>” mode</li>
<li>The preferred <em>coverage</em> tool is <strong>Kover</strong>, but <strong>Jacoco</strong> also supports Kotlin</li>
<li><strong>Ktlint</strong> is an opinionated style checker originally from Pinterest</li>
<li><strong>Detekt</strong> runs further verification (e.g., known suboptimal programming patterns)</li>
</ol>
<h2 id="dry">DRY!</h2>
<p>You know how to build and publish Gradle plugins: <strong>factorize the common part!</strong></p>
<h3 id="example-preconfigured-kotlin-qa">Example: Preconfigured Kotlin QA</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Just applies and pre-configures jacoco, detekt, and ktlint
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    id(<span style="color:#d20;background-color:#fff0f0">"org.danilopianini.gradle-kotlin-qa"</span>) version <span style="color:#d20;background-color:#fff0f0">"0.2.1"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Just applies and pre-configures jacoco, Spotbugs, PMD, and checkstyle
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    id(<span style="color:#d20;background-color:#fff0f0">"org.danilopianini.gradle-java-qa"</span>) version <span style="color:#d20;background-color:#fff0f0">"0.2.1"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="code-documentation">Code documentation</h2>
<p>It is a good practice to automate the generation of the API documentation.</p>
<ul>
<li>The <code>java[-library]</code> plugin adds a <code>javadoc</code> task to generate the Javadoc</li>
<li>The <code>scala</code> plugin includes a task of type <code>ScalaDoc</code></li>
<li>Documentation for Kotlin can be generated using <a href=""><strong>Dokka</strong></a>
<ul>
<li>A Gradle plugin is available: !</li>
</ul>
</li>
</ul>
<p>In general:</p>
<ul>
<li>documentation generation tasks produce artifacts that can be shipped along the main artifact</li>
<li>most languages do provide tools for documentation generation</li>
<li>well-maintained plugins may exist $\Rightarrow$ use them</li>
<li>if they don’t, write them!</li>
</ul>
</section><section>
<h2 id="creating-artifacts">Creating artifacts</h2>
<p>Software products are usually shipped as (possibly executable) <strong>archives</strong> of some sort.</p>
<p>In the JVM world, the de-facto standard format is <strong>jar</strong> (Java ARchive)</p>
<ul>
<li>Gradle provides a task of type <code>Jar</code> to create such archives</li>
<li>The <code>java-library</code> and <code>java</code> plugins (applied behind the scenes by the <code>kotlin-jvm</code> plugin as well)
automatically create an <code>assemble</code> task which generates a task of type <code>Jar</code>
creating a non-executable jar with the project contents.</li>
<li>Runnable Jars can be created via the “shadowJar” third-party plugin</li>
<li>Runnable software including the Java runtime can be created using JPackage</li>
</ul>
<h2 id="signing-artifacts">Signing artifacts</h2>
<p>Many repositories require artifacts to be <strong>signed</strong> in order for them to be delivered/deployed
If you do not have a signature yet, <a href="https://central.sonatype.org/pages/working-with-pgp-signatures.html">time to create one</a></p>
<ul>
<li>Creation: <code>gpg --gen-key</code></li>
<li>List: <code>gpg --list-keys</code></li>
<li>Distribution: <code>gpg --keyserver keyserver.ubuntu.com --send-keys &lt;KEY-ID&gt;</code></li>
</ul>
<p>Once you have a key, you can use the <code>signing</code> plugin to have Gradle generate signatures</p>
<p>To set a default signatory, add to your <code>~/.gradle/gradle.properties</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#369">signing.keyId</span> = <span style="color:#d20;background-color:#fff0f0">&lt;your key id&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#369">signing.password</span> = <span style="color:#d20;background-color:#fff0f0">&lt;redacted&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#369">signing.secretKeyRingFile</span> = <span style="color:#d20;background-color:#fff0f0">&lt;your user home&gt;/.gnupg/secring.gpg</span>
</span></span></code></pre></div></section><section>
<h2 id="software-repositories">Software repositories</h2>
<p>Software repositories are services hosting software artifacts for distribution</p>
<ul>
<li>They usually provide file hosting and metadata management in a format compatible with some build automation tool</li>
<li>There’s typically one reference (de jure or de facto) such service per programming language/ecosystem</li>
<li>It is important to learn the <em>retraction</em> and <em>update</em>/<em>yanking</em> policies before publishing</li>
</ul>
<h3 id="prominent-examples">Prominent examples</h3>
<ul>
<li><a href="https://search.maven.org/">Maven Central</a> is the de-facto standard repository for JVM artifacts
<ul>
<li>It can host any artifact compatible with the Maven format, including non-JVM artifacts, as far as packaged as jars</li>
<li><strong>No-retract</strong>, <strong>no-yanking</strong> policy
<ul>
<li><strong>Errors</strong> <a href="https://central.sonatype.com/artifact/commons-io/commons-io/versions">stay there forever</a></li>
</ul>
</li>
<li><em>Requires</em> both <em>sources</em> and <em>Javadoc</em> artifacts</li>
<li>Artifacts on Central <em>should</em> only depend from other artifacts on Central
<ul>
<li>Not really enforced, but strongly recommended</li>
</ul>
</li>
</ul>
</li>
<li><em>NPM</em> for Javascript
<ul>
<li>Supports package <strong>retraction</strong> within *72-hours <em>if</em> there are <em>no dependents</em>, or after only if:
<ul>
<li>there are no dependents, fewer than 300 downloads last wee, and a single owner.</li>
<li>retracted versions are banned</li>
</ul>
</li>
</ul>
</li>
<li><em>PyPI</em>: for Python code
<ul>
<li>Supports <strong>yanking</strong> (preferred), deletion is being discussed.
<ul>
<li>Yanked versions must be ignored by dependency resolvers when a non-yanked version satisfies the constraints</li>
</ul>
</li>
</ul>
</li>
<li><em>RubyGems.org</em>: for Ruby code
<ul>
<li><code>gem yank</code> retracts a package</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="publishing-artifacts-on-maven-central">Publishing artifacts on Maven Central</h2>
<p><strong>Requirements</strong></p>
<ul>
<li>A valid <em>public signature</em></li>
<li>A registered <strong>groupId</strong>
<ul>
<li>Registration of GitHub (<code>io.github.yourghusername</code>) domains is semi-automatic
<ul>
<li>The system verifies identity by asking for the creation of a repository named as a token</li>
</ul>
</li>
<li>Custom domains are handled manually, contact service</li>
</ul>
</li>
<li>Complete <em>project metadata</em> in a <code>pom.xml</code> file
<ul>
<li>Including developers, urls, project description, etc.</li>
</ul>
</li>
</ul>
<p>The submission procedures has been greatly simplified recently with the Gradle plugin portal:</p>
<ol>
<li>Create all artifact in a maven-repository-compatible layout</li>
<li>Sign all artifacts</li>
<li>Create a zip archive including the repository layout</li>
<li>Upload to Maven Central Portal</li>
</ol>
<ul>
<li>Gradle plugins are available for automating publications via Gradle!
<ul>
<li><a href="https://central.sonatype.org/publish/publish-portal-gradle/">https://central.sonatype.org/publish/publish-portal-gradle/</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="inspecting-dependencies">Inspecting dependencies</h2>
<p>In rich projects, most of the build-related issues are due to pesky stuff going on with <em>dependencies</em></p>
<ul>
<li>Transitive conflicts
<ul>
<li>dependency A requires B at version 1, dependency C requires B at version 2</li>
</ul>
</li>
<li>Multiple names for the same artifact</li>
<li>Unexpected differences between configurations</li>
</ul>
<p>Gradle allows for <strong>inspection</strong> of the dependencies:</p>
<ul>
<li><code>./gradlew dependencies</code> prints the dependency trees for each configuration</li>
</ul>
<p>Inspecting multiple large trees can be difficult</p>
<ul>
<li>A single dependency inspection is available</li>
<li><code>./gradlew dependencyInsight --dependency &lt;DepName&gt; </code>
<ul>
<li>Optionally, fiterable by configuration: <code>--configuration &lt;ConfName&gt;</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="inspecting-dependencies-among-tasks">Inspecting dependencies <em>among tasks</em></h2>
<p>When developing plugins or rich builds, the issue of dependencies also affect <strong>tasks</strong></p>
<p>Gradle <em>does not</em> provide tools to ispect the task graph graphically, but a plugin exists.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    id <span style="color:#d20;background-color:#fff0f0">"com.dorongold.task-tree"</span> version <span style="color:#d20;background-color:#fff0f0">"4.0.1"</span>
</span></span><span style="display:flex;"><span>}</span></span></code></pre></div>
<p>Generates a <code>taskTree</code> task printing the task tree of the tasks listed along with <code>taskTree</code>.</p>
</section><section>
<h2 id="build-scans">Build scans</h2>
<ul>
<li>As any software, complex builds need rich inspection tools
<ul>
<li>Performance issues may arise</li>
<li>Some tests may run anomalously slow</li>
<li>Dependency trees may get hard to analyze in a terminal</li>
<li>Plugin behaviour could be different than expected</li>
</ul>
</li>
</ul>
<p>Gradle supports a reporting system called <em>Gradle build scans</em></p>
<ul>
<li>Executable by appending <code>--scan</code> to the build</li>
<li>Requires terminal interaction (or use of the <a href="https://docs.gradle.com/enterprise/gradle-plugin/">enterprise plugin</a>)</li>
</ul>
<p>Example scans:</p>
<ul>
<li><a href="https://scans.gradle.com/s/5i6ai7gz6qzmc">https://scans.gradle.com/s/5i6ai7gz6qzmc</a></li>
<li><a href="https://scans.gradle.com/s/5jmd7avh2gnvi">https://scans.gradle.com/s/5jmd7avh2gnvi</a></li>
</ul>
</section><section>
<h2 id="automated-scans-without---scan">Automated scans without <code>--scan</code></h2>
<p>In <code>settings.gradle.kts</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>develocity {
</span></span><span style="display:flex;"><span>    buildScan {
</span></span><span style="display:flex;"><span>        termsOfUseUrl = <span style="color:#d20;background-color:#fff0f0">"https://gradle.com/terms-of-service"</span>
</span></span><span style="display:flex;"><span>        termsOfUseAgree = <span style="color:#d20;background-color:#fff0f0">"yes"</span>
</span></span><span style="display:flex;"><span>        uploadInBackground = !System.<span style="color:#369">getenv</span>(<span style="color:#d20;background-color:#fff0f0">"CI"</span>).<span style="color:#369">toBoolean</span>()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h1 id="build-automation-2">Build Automation</h1>
<h2 id="hahahugoshortcode1s0hbhb">Software Process Engineering</h2>
<br>
<h3 id="danilo-pianini"><a href="mailto:danilo.pianini@unibo.it">Danilo Pianini — <code>danilo.pianini@unibo.it</code></a></h3>
<br>
<p>Compiled on: 2025-11-03
 — <a href="?print-pdf&amp;pdfSeparateFragments=false"><i class="fa fa-print" aria-hidden="true"></i> printable version</a></p>
<p><a href=".."><i class="fa fa-undo" aria-hidden="true"></i> back</a></p>
</section>

  


</div>
      

    </div>
<script type="text/javascript" src="/reveal-hugo/object-assign.js"></script>

<a href="/reveal-js/dist/print/" id="print-location" style="display: none;"></a>

<script type="application/json" id="reveal-hugo-site-params">{"custom_theme":"custom-theme.scss","custom_theme_compile":true,"height":"1080","history":true,"mermaid":[{"fontFamily":"Inconsolata","gitGraph":{"mainBranchName":"master","rotateCommitLabel":true},"startOnLoad":false,"theme":"default","useMaxWidth":false}],"pdfseparatefragments":false,"slide_number":true,"theme":"white","transition":"slide","transition_speed":"fast","width":"1920"}</script>
<script type="application/json" id="reveal-hugo-page-params">{"custom_theme":"custom-theme.scss","custom_theme_compile":true,"custom_theme_options":{"enablesourcemap":true,"targetpath":"css/custom-theme.css"},"transition":"slide","transition_speed":"fast"}</script>

<script src="/reveal-js/dist/reveal.js"></script>


  
  
  <script type="text/javascript" src="/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/zoom/zoom.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/notes/notes.js"></script>
  
  
  <script type="text/javascript" src="/reveal-js/plugin/notes/notes.js"></script>




<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };

  var revealHugoPlugins = {
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom ]
   };
  var revealHugoSiteParams = JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);
  var revealHugoPageParams = JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);
  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins));
  Reveal.initialize(options);
</script>







  
    
  
  

  
    
  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  



  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({"fontFamily":"Inconsolata","gitGraph":{"mainBranchName":"master","rotateCommitLabel":true},"startOnLoad":false,"theme":"default","useMaxWidth":false});

    let render = (event) => {
      let mermaidElems = event.currentSlide.querySelectorAll('.mermaid');
      if (!mermaidElems.length){
          return
      }
      mermaidElems.forEach(mermaidElem => {
          let processed = mermaidElem.getAttribute('data-processed');
          if (!processed){
              
              mermaid.init(undefined, mermaidElem);
          }
      });
    };
    
    render({currentSlide: Reveal.getCurrentSlide()});

    Reveal.on('slidechanged', render);
    Reveal.on('ready', render);
  </script>



    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
</script>

<script type="text/javascript" id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

<script>
  if (/.*?(\?|&)print-pdf/.test(window.location.toString())) {
      var ytVideos = document.getElementsByTagName("iframe")
      for (let i = 0; i < ytVideos.length; i++) {
          var videoFrame = ytVideos[i]
          var isYouTube = /^https?:\/\/(www.)youtube\.com\/.*/.test(videoFrame.src)
          if (isYouTube) {
              var div = videoFrame.parentElement
              var parent = div.parentElement
              videoFrame.remove()
              div.remove()
              var p = document.createElement('p')
              p.append(
                  document.createTextNode(
                      "There was an embedded video here, but it is disabled in the printed version of the slides."
                  )
              )
              p.append(document.createElement('br'))
              p.append(document.createTextNode("Visit instead:"))
              p.append(document.createElement('br'))
              const anchor1 = document.createElement('a');
              anchor1.href = videoFrame.src;
              anchor1.textContent = videoFrame.src;
              p.append(anchor1);
              p.append(document.createElement('br'))
              const altSrc = videoFrame.src.replace(
                  /(^https?:\/\/(www.)youtube\.com)\/(embed\/)(\w+).*/,
                  "https://www.youtube.com/watch?v=$4"
              );
              const anchor2 = document.createElement('a');
              anchor2.href = altSrc;
              anchor2.textContent = altSrc;
              p.append(document.createTextNode("or:"))
              p.append(document.createElement('br'))
              p.append(anchor2);
              p.append(document.createElement('br'))
              p.append(document.createTextNode("to watch the content."))
              parent.appendChild(p)
          }
      }
  }
</script>

    
  

</body></html>