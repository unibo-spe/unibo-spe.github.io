<!DOCTYPE html><html lang="en"><head>
    <meta charset="utf-8">
<title>Multi-platform programming</title>
<meta name="description" content="Theory and practice of multi-platform programming">

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><link rel="stylesheet" href="/reveal-js/dist/reset.css">
<link rel="stylesheet" href="/reveal-js/dist/reveal.css">
  <link rel="stylesheet" href="/css/custom-theme.min.f2c7adbc4e1966516650f994979920854f1f6804d229d73c7cb5f507ac9e61f7.css" id="theme"><link rel="stylesheet" href="/highlight-js/default.min.css">
<link rel="stylesheet" href="https://raw.githubusercontent.com/DanySK/css-blur-animation/master/blur.css">
<link href="https://fonts.googleapis.com/css?family=Roboto Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Oxygen Mono" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Ubuntu Mono" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
<script src="https://unibo-spe.github.io//plantuml.js"></script>

  </head>
  <body>
    
    <div class="reveal">
      <div class="slides">
  

    <section><style>
.reveal blockquote {
    font-family: 'Georgia';
}
.reveal blockquote::before{
    content: "";
}
.reveal blockquote::after{
    content: "";
}
</style>
<h1 id="multi-platform-programming">Multi-platform programming</h1>
<h2 id="hahahugoshortcode1s0hbhb">Software Process Engineering</h2>
<br>
<h3 id="giovanni-ciatto-----giovanniciattouniboitmailtogiovanniciattouniboit"><a href="mailto:giovanni.ciatto@unibo.it">Giovanni Ciatto — <code>giovanni.ciatto@unibo.it</code></a></h3>
<br>
<p>Compiled on: 2024-12-21
 — <a href="?print-pdf&amp;pdfSeparateFragments=false"><i class="fa fa-print" aria-hidden="true"></i> printable version</a></p>
<p><a href=".."><i class="fa fa-undo" aria-hidden="true"></i> back</a></p>
</section><section>
<h1 id="multi-platform-programming-1">Multi-platform programming</h1>
<h2 id="preliminaries">Preliminaries</h2>
</section><section>


<section data-shortcode-section="">
<h1 id="what-are-software-platforms">What are software platforms?</h1>
<ul>
<li>
<p>Fuzzy concept</p>
<ul>
<li>often mentioned in courses / literature, yet not precisely defined</li>
</ul>
</li>
<li>
<p>Insight:</p>
</li>
</ul>
<blockquote>
<p>The <strong>substratum</strong> upon which <strong>software applications</strong> <em>run</em></p>
</blockquote>
</section><section>
<h1 id="what-are-software-platforms-1">What are software platforms?</h1>
<h2 id="operative-systems-">Operative systems (?)</h2>
<ul>
<li>
<p>Most software runs on top of an <strong>operative system</strong> (OS)</p>
</li>
<li>
<p>So yes, all operative systems are platforms</p>
</li>
<li>
<p>Is there more?</p>
<ul>
<li>e.g. <a href="https://www.jabref.org/">JabRef</a>: <strong>Java</strong> application running on top of <strong>JVM</strong>
<ul>
<li>the JVM is an application for the OS</li>
</ul>
</li>
<li>e.g. <a href="https://app.diagrams.net/">Draw.io</a>: <strong>Web</strong> application running on top of <strong>browsers</strong>
<ul>
<li>the browser is an application for the OS</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h1 id="what-are-software-platforms-2">What are software platforms?</h1>
<h2 id="operative-systems--">Operative systems + ???</h2>
<ul>
<li>
<p>Programming languages?</p>
<ul>
<li>not that simple
<ul>
<li>e.g. Scala apps can <em>call</em> Java code</li>
</ul>
</li>
</ul>
</li>
<li>
<p>Runtimes</p>
<ul>
<li>i.e. the set of libraries and conventions backing programming languages</li>
</ul>
</li>
</ul>

</section>
</section><section>
<h1 id="what-are-software-platforms">What are software platforms?</h1>
<h2 id="definition-attempt">Definition attempt</h2>
<blockquote>
<p><strong>Software platform</strong> $\stackrel{\Delta}{=}$ anything having an <strong>API</strong> enabling the writing of applications,
and the <strong>runtime</strong> supporting the execution of those applications</p>
</blockquote>
<ul>
<li>thank you chap, what are API and runtimes then?</li>
</ul>
</section><section>


<section data-shortcode-section="">
<h1 id="what-are-api-and-runtimes">What are API and runtimes?</h1>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/API"><strong>API</strong></a> $\equiv$ application programming interface(s) $\stackrel{\Delta}{=}$ a <em>formal</em> specification of the set of <strong>functionalities</strong> provided by a software (sub-)system for <em>external</em> usage, there including their <strong>input</strong>, <strong>outputs</strong>, and <em>environmental</em> <strong>preconditions</strong> and <strong>effects</strong></p>
</blockquote>
<ul>
<li>client-server metaphor is implicit</li>
</ul>
<blockquote>
<p><a href="https://en.wikipedia.org/wiki/Runtime_system"><strong>Runtime</strong></a> [system/environment] $\approx$ the set of computational resources backing the execution of a software (sub-)system</p>
</blockquote>
<ul>
<li>we say that “runtimes <em>support</em> API”</li>
</ul>
</section><section>
<h1 id="what-are-api-and-runtimes-1">What are API and runtimes?</h1>
<h2 id="examples-of-api">Examples of API</h2>
<ul>
<li>
<p>all possible <em>public interfaces</em> / classes / structures in an <strong>OOP module</strong></p>
<ul>
<li>and their public/protected methods / fields / properties / constructors
<ul>
<li>and their formal arguments, return types, throwable exceptions</li>
</ul>
</li>
</ul>
</li>
<li>
<p>all possible <em>commands</em> a <strong>CLI application</strong> accept as <em>input</em></p>
<ul>
<li>and their admissible sub-commands, options, and arguments
<ul>
<li>and the corresponding outputs, exit values, and side effects</li>
</ul>
</li>
</ul>
</li>
<li>
<p>all possible <em>routes</em> a <strong>Web service</strong> may accept HTTP request onto</p>
<ul>
<li>and their admissible HTTP methods
<ul>
<li>and their admissible query / path / body / header parameters
<ul>
<li>and the corresponding status codes, and response bodies</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h1 id="what-are-api-and-runtimes-2">What are API and runtimes?</h1>
<h2 id="examples-of-runtimes">Examples of runtimes</h2>
<ul>
<li>
<p>any <em>interpreter</em> (JVM, CRL, CPython, V8)</p>
<ul>
<li>and their standard libraries</li>
<li>and their type system and internal conventions
<ul>
<li>eg value/reference types in JVM/CRL, global lock in CPython</li>
</ul>
</li>
</ul>
</li>
<li>
<p>any <em>operative system</em> (Win, Mac, Linux)</p>
<ul>
<li>and their system calls, daemons, package managers, default commands, etc</li>
<li>and their program memory, access control, file system models</li>
</ul>
</li>
<li>
<p>any <em>Web service</em></p>
<ul>
<li>and the protocols they leverage upon</li>
<li>and their URL structuring model</li>
<li>the data schema of their input/output objects</li>
<li>the authentication / authorization mechanisms they support</li>
</ul>
</li>
</ul>

</section>
</section><section>
<h1 id="notable-platforms">Notable platforms</h1>
<ul>
<li>
<p>The <strong>Java Virtual Machine</strong> (JVM)</p>
<ul>
<li>supported languages: Java, Kotlin, Scala, Clojure, etc.</li>
</ul>
</li>
<li>
<p>.NET’s [pronounced “dot NET”] <strong>Common Language Runtime</strong> (CRL)</p>
<ul>
<li>supported languages: C#, VB.NET, F#, etc.</li>
</ul>
</li>
<li>
<p><strong>Python</strong> 3</p>
<ul>
<li>supported language: Python</li>
</ul>
</li>
<li>
<p><strong>NodeJS</strong> (V8)</p>
<ul>
<li>supported language: JavaScript, TypeScript, etc.</li>
</ul>
</li>
<li>
<p>Each <strong>browser</strong> may be considered as a platform per se</p>
<ul>
<li>supported language: JavaScript</li>
</ul>
</li>
<li>
<p>…</p>
</li>
</ul>
</section><section>
<h1 id="practical-features-of-platforms">Practical features of platforms</h1>
<ul>
<li>
<p><em>standard libraries</em></p>
<ul>
<li>i.e. pre-cooked functionalities developers / users may exploit</li>
</ul>
</li>
<li>
<p>predefined <em>design decisions</em></p>
<ul>
<li>e.g. global lock in Python, event loop in JavaScript, etc.</li>
</ul>
</li>
<li>
<p>organizational, stylistic, technical <em>conventions</em></p>
<ul>
<li>e.g. project structure, code linting, nomenclature, etc.</li>
</ul>
</li>
<li>
<p><em>packaging</em> conventions, <em>import mechanisms</em>, and <em>software repositories</em></p>
<ul>
<li>e.g. classpath for the JVM, NPM for JS, Pip + Pypi for Python, etc.</li>
</ul>
</li>
<li>
<p>user <em>communities</em></p>
<ul>
<li>e.g. many Data scientists use Python, many Web developers use JVM / JS</li>
</ul>
</li>
</ul>
</section><section>


<section data-shortcode-section="">
<h1 id="example-the-jvm-platform">Example: the JVM platform</h1>
</section><section>
<h2 id="standard-libraries">Standard libraries</h2>
<ul>
<li>
<p>Types from the <code>java.*</code> and <code>javax.*</code> packages are usable from <em>any</em> JVM language</p>
</li>
<li>
<p>Many nice <em>functionalities</em> covering:</p>
<ul>
<li>multi-threading, non-blocking IO, asynchronous programming</li>
<li>OS-independent GUI, or IO management</li>
<li>data structures and algorithms for collections and streams</li>
<li>unlimited precision arithmetic</li>
</ul>
</li>
<li>
<p>Many functionalities are provided by <em>community-driven</em> <strong>third party</strong> <em>libraries</em></p>
<ul>
<li>e.g. YAML/JSON parsing / generation, CSV parsing, complex numbers</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="predefined-design-decisions">Predefined design decisions</h2>
<ul>
<li>
<p>Everything is (indirectly) a <em>subclass/instance</em> of <code>Object</code></p>
<ul>
<li>except fixed set of primitive types, and static stuff</li>
</ul>
</li>
<li>
<p>Every object is potentially a <em>lock</em></p>
<ul>
<li>useful for concurrency</li>
</ul>
</li>
<li>
<p>Default methods inherited by <code>Object</code> class</p>
<ul>
<li>e.g. <code>toString</code>, <code>equals</code>, <code>hashCode</code></li>
</ul>
</li>
<li>
<p>All methods are <em>virtual by default</em></p>
</li>
<li>
<p>…</p>
</li>
</ul>
</section><section>
<h2 id="organizational-stylistic-technical-conventions">Organizational, stylistic, technical conventions</h2>
<ul>
<li>
<p><em>Project</em> should be organized according to the Maven’s <a href="https://maven.apache.org/guides/introduction/introduction-to-the-standard-directory-layout.html">standard directory layout</a></p>
</li>
<li>
<p>Official <em>stylistic conventions</em> for most JVM languages</p>
<ul>
<li>e.g. type names in <code>PascalCase</code>, members names in <code>camelCase</code></li>
<li>e.g. getters/setters in Java vs. Kotlin’s or Scala’s properties</li>
</ul>
</li>
<li>
<p>Many technical conventions:</p>
</li>
</ul>
<ul>
<li><em>iterable</em> data structures should implement the <code>Iterable</code> interface</li>
<li><em>variadic</em> arguments are considered <em>arrays</em></li>
<li><em>constructors</em> for collections subclasses accept <code>Iterable</code>s as input</li>
<li>…</li>
</ul>
</section><section>
<h2 id="packaging-conventions-import-mechanisms-and-software-repositories">Packaging conventions, import mechanisms, and software repositories</h2>
<ul>
<li>
<p><em>Project files</em> are organized into <em>packages</em></p>
<ul>
<li>packages must correspond to <em>directory structures</em></li>
</ul>
</li>
<li>
<p>Code <em>archives</em> (<code>.jar</code>) are <em>Zip files</em> containing compiled classes</p>
</li>
<li>
<p>Basic <em>import mechanism</em>: the <strong>class path</strong></p>
<ul>
<li>i.e. the path where classes are looked for</li>
<li>commonly set at application startup</li>
</ul>
</li>
<li>
<p>Many <em>third-party repositories</em> for JVM libraries</p>
<ul>
<li><a href="https://central.sonatype.com">Maven central repository</a> is the most relevant one</li>
<li>many tools for dependency management (e.g. Maven, Gradle)</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="user-communities">User communities</h2>
<ul>
<li>
<p><em>Android</em> developers</p>
</li>
<li>
<p><em>Back-end</em> Web developers</p>
</li>
<li>
<p><em>Desktop applications</em> developers</p>
</li>
<li>
<p>Researchers in the fields of: <em>semantic Web</em>, <em>multi-agent systems</em>, etc.</p>
</li>
<li>
<p>…</p>
</li>
</ul>

</section>
</section><section>


<section data-shortcode-section="">
<h1 id="example-the-python-platform">Example: the Python platform</h1>
</section><section>
<h2 id="standard-libraries">Standard libraries</h2>
<ul>
<li>
<p>Notably, one the <em>richest</em> <strong>standard libraries</strong> ever</p>
</li>
<li>
<p>Many nice <em>functionalities</em> covering:</p>
<ul>
<li>all the stuff covered by Java</li>
<li>plus many more, e.g. complex numbers, JSON and CSV parsing, etc</li>
</ul>
</li>
<li>
<p>Many functionalities are provided by community-driven <em>third party libraries</em></p>
<ul>
<li>e.g. <em>scientific</em> or <em>ML</em> libraries</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="predefined-design-decisions">Predefined design decisions</h2>
<ul>
<li>
<p>Everything is (indirectly) a <em>subclass/instance</em> of <code>object</code></p>
<ul>
<li>no exceptions</li>
</ul>
</li>
<li>
<p><a href="https://realpython.com/python-gil/">Global Interpreter Lock</a> (GIL)</p>
</li>
<li>
<p><em>Magic methods</em> supporting various language features</p>
<ul>
<li>e.g. <code>__str__</code>, <code>__eq__</code>, <code>__iter__</code></li>
</ul>
</li>
<li>
<p>No support for <em>overloading</em></p>
</li>
<li>
<p><em>Variadic</em> and <em>keywords</em> <strong>arguments</strong></p>
</li>
<li>
<p>…</p>
</li>
</ul>
</section><section>
<h2 id="organizational-stylistic-technical-conventions">Organizational, stylistic, technical conventions</h2>
<ul>
<li>
<p><em>Project files</em> should be organized according to <a href="https://docs.python-guide.org/writing/structure/">Kenneth Reitz’s layout</a></p>
</li>
<li>
<p>Official <em>stylistic conventions</em> for Python (<a href="https://peps.python.org/pep-0008/">PEP8</a>)</p>
<ul>
<li>e.g. type names in <code>PascalCase</code>, members names in <code>snake_case</code></li>
<li>e.g. <em>indentation-aware</em> syntax, blank line conventions, etc.</li>
<li>…</li>
</ul>
</li>
<li>
<p>Many <em>technical conventions</em>:</p>
</li>
</ul>
<ul>
<li><a href="https://realpython.com/lessons/duck-typing/">duck typing</a></li>
<li>iterable data structures should implement the <code>__iter__</code> method</li>
<li><em>variadic</em> arguments are considered <em>tuples</em></li>
<li><em>keyword</em> arguments are considered <em>sets</em></li>
<li>…</li>
</ul>
</section><section>
<h2 id="packaging-conventions-import-mechanisms-and-software-repositories">Packaging conventions, import mechanisms, and software repositories</h2>
<ul>
<li>
<p><em>Project files</em> are organized into <strong>packages</strong> and <strong>modules</strong></p>
<ul>
<li>packages $\leftrightarrow$ <em>directories</em></li>
<li>modules $\leftrightarrow$ <em>files</em></li>
</ul>
</li>
<li>
<p>Code <em>archives</em> (<code>.whl</code>) are <em>Zip files</em> containing Python sources</p>
</li>
<li>
<p>Each Python <em>environment</em> has an <em>internal folder</em> where <strong>installed libraries</strong> are stored</p>
<ul>
<li><code>pip</code> simply <em>unzips</em> modules/packages in there</li>
<li><code>import</code> statements <em>look for</em> packages/modules in there</li>
</ul>
</li>
<li>
<p><a href="https://pypi.org/">Pypi</a> as the <em>official repository</em> for Python libraries</p>
<ul>
<li><code>pip</code> as the official tool for dependency management</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="user-communities">User communities</h2>
<ul>
<li>
<p><em>Data-science</em> community</p>
</li>
<li>
<p><em>Back-end</em> Web developers</p>
</li>
<li>
<p><em>Desktop applications</em> developers</p>
</li>
<li>
<p><em>System administrators</em></p>
</li>
<li>
<p>…</p>
</li>
</ul>

</section>
</section><section>


<section data-shortcode-section="">
<h1 id="example-the-nodejs-platform">Example: the NodeJS platform</h1>
</section><section>
<h2 id="standard-library">Standard library</h2>
<ul>
<li>
<p>Very <strong>limited</strong> <em>standard library</em> from JavaScript</p>
<ul>
<li>enriched with many <em>Node modules</em></li>
</ul>
</li>
<li>
<p>Many nice <em>functionalities</em> covering:</p>
<ul>
<li>networking and IPC</li>
<li>OS, multiprocess, and cryptographic utilities</li>
</ul>
</li>
<li>
<p>Many functionalities are provided by <em>community-driven</em> <strong>third party</strong> <em>libraries</em></p>
<ul>
<li>you can find virtually anything on <a href="https://www.npmjs.com/">npmjs.com</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="predefined-design-decisions">Predefined design decisions</h2>
<ul>
<li>
<p><em>Object orientation</em> based on <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Object_prototypes">prototypes</a></p>
</li>
<li>
<p><em>Single threaded</em> design + <a href="https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick">event loop</a></p>
</li>
<li>
<p><em>Asynchronous programming</em> via <a href="https://matt.might.net/articles/by-example-continuation-passing-style/">continuation-passing style</a></p>
</li>
</ul>
</section><section>
<h2 id="organizational-stylistic-technical-conventions">Organizational, stylistic, technical conventions</h2>
<ul>
<li>
<p><em>Project structure</em> is somewhat <strong>arbitrary</strong> (no established convention)</p>
<ul>
<li>the project must contain a <code>package.json</code> file in the <em>root</em> directory</li>
<li>declaring the entry point of the project</li>
</ul>
</li>
<li>
<p>Many <em>structure conventions</em> co-exist</p>
<ul>
<li>e.g. <a href="https://www.w3schools.com/js/js_conventions.asp">W3School’s one</a></li>
</ul>
</li>
<li>
<p>Many <em>technical conventions</em>:</p>
<ul>
<li>duck typing</li>
<li>magic variables, e.g. for prototype</li>
<li>…</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="packaging-conventions-import-mechanisms-and-software-repositories">Packaging conventions, import mechanisms, and software repositories</h2>
<ul>
<li>
<p><em>Project files</em> are organized into <strong>modules</strong></p>
<ul>
<li>modules are file containing anything</li>
<li>and declaring what to export</li>
</ul>
</li>
<li>
<p>Code <em>archives</em> (<code>.tar.?z</code>) are compressed <em>tarball files</em> containing JS sources</p>
</li>
<li>
<p>Third-party <em>libraries</em> can be <strong>installed</strong> via <code>npm</code></p>
<ul>
<li>locally, for the user, or globally</li>
</ul>
</li>
<li>
<p><a href="https://www.npmjs.com/">NPM</a> as the official <em>repository</em> for JS libraries</p>
<ul>
<li><code>npm</code> as the official tool for dependency management</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="user-communities">User communities</h2>
<ul>
<li>
<p><em>Front-end</em> Web developers</p>
</li>
<li>
<p><em>Back-end</em> Web developers</p>
</li>
<li>
<p><em>GUI</em> developers</p>
</li>
<li>
<p>…</p>
</li>
</ul>

</section>
</section><section>


<section data-shortcode-section="">
<h1 id="platforms-from-software-developers-perspective">Platforms from software developers’ perspective</h1>
<p>The <strong>choice</strong> of a <em>platform</em> impacts developers during:</p>
<ul>
<li>
<p>the <em>design</em> phase</p>
</li>
<li>
<p>the <em>implementation</em> phase</p>
</li>
<li>
<p>the <em>testing</em> phase</p>
</li>
<li>
<p>the <em>release</em> phase</p>
</li>
</ul>
</section><section>
<h2 id="how-platform-affects-the-design-phase">How platform affects the <strong>design</strong> phase</h2>
<ul>
<li>One may choose the platform which minimizes the <strong>abstraction gap</strong> w.r.t. the problem at hand</li>
</ul>
<blockquote>
<p><strong>Abstraction gap</strong> $\approx$ the space among the <strong>problem</strong> and the prior functionalities offered by a <strong>platform</strong>.
Ideally, the bigger the space the more <em>effort</em> is required to build the solution</p>
</blockquote>
<figure><img src="/12-multiplatform/abstraction-gap.svg" width="70%">
</figure>
</section><section>
<h2 id="how-platform-affects-the-implementation-phase">How platform affects the <strong>implementation</strong> phase</h2>
<ul>
<li>
<p>Developers <em>write</em> solutions by leveraging the <em>API</em> of the <strong>platform</strong></p>
</li>
<li>
<p>… as well as the API of any <strong>third-party library</strong> available for that platform</p>
</li>
</ul>
<figure><img src="/12-multiplatform/third-party.svg" width="80%">
</figure>
</section><section>
<h2 id="how-platform-affects-the-testing-phase">How platform affects the <strong>testing</strong> phase</h2>
<ul>
<li>
<p><em>Test suites</em> are a <strong>“project in the project”</strong></p>
<ul>
<li>so remarks are similar w.r.t. the implementation phase</li>
</ul>
</li>
<li>
<p>One may test the system against <em>as many versions as possible</em> of the underlying platforms</p>
</li>
<li>
<p>One may test the system against <em>as many OS</em> as possible</p>
<ul>
<li>virtual platforms may behave differently depending on the OS</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="how-platform-affects-the-release-phase">How platform affects the <strong>release</strong> phase</h2>
<blockquote>
<p><strong>Release</strong> $\approx$ publishing some packaged software system onto a repository, hence enabling its import and exploitation</p>
</blockquote>
<ul>
<li>
<p><em>Packaging systems</em> are platform-specific…</p>
</li>
<li>
<p><em>Repositories</em> are platform-specific…</p>
</li>
<li>
<p>… <em>release</em> is therefore platform specific</p>
</li>
</ul>

</section>
</section><section>
<h2 id="platform-choice-for-a-new-sw-project">Platform choice for a new SW project</h2>
<ul>
<li>
<p>Choice is commonly driven by design / technical decisions</p>
<ul>
<li>which platform would ease developers’ work the most?</li>
</ul>
</li>
<li>
<p>However, choosing the platform is a business decision as well</p>
<ul>
<li>platforms have user communities</li>
<li>SW project benefit from wide(r) user communities</li>
</ul>
</li>
<li>
<p>Business decision: which user communities to target?</p>
<ul>
<li>what are the most relevant platforms for that communities?</li>
</ul>
</li>
<li>
<p>Coherency is key for success in platform selection</p>
<ol>
<li>coherently choose the target community w.r.t SW goal</li>
<li>coherently choose the platform w.r.t. target community</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="general-benefits-of-coherence">General benefits of coherence</h2>
<ul>
<li>
<p>The abstraction gap is likely lower</p>
</li>
<li>
<p>More third party libraries are likey available</p>
</li>
<li>
<p>The potential audience is wider</p>
<ul>
<li>implies the SW project is more valuable</li>
</ul>
</li>
<li>
<p>Easier to find support / help in case of issues</p>
</li>
<li>
<p>More likely that third-party issues are timely fixed</p>
</li>
</ul>
</section><section>


<section data-shortcode-section="">
<h2 id="what-about-__research-oriented__-software-pt-1">What about <strong>research-oriented</strong> software? (pt. 1)</h2>
<blockquote>
<p>Researchers may act as software developers</p>
</blockquote>
<ol>
<li>
<p>to elaborate data</p>
</li>
<li>
<p>to create in-silico experiments</p>
</li>
<li>
<p>to study software system</p>
</li>
<li>
<p>to create software tools improving their research</p>
</li>
<li>
<p>to create software tools for the community</p>
<ul>
<li>this is how many FOSS tools have been created</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="what-about-__research-oriented__-software-pt-2">What about <strong>research-oriented</strong> software? (pt. 2)</h2>
<blockquote>
<p>Research institutions are <em>not</em> software houses</p>
</blockquote>
<ul>
<li>
<p>Personnel can only dedicate a fraction of their time to development</p>
</li>
<li>
<p>Most software artifacts are disposable (1, 2, 4)</p>
</li>
<li>
<p>Development efforts are discontinuous</p>
</li>
<li>
<p>Development teams are small</p>
</li>
<li>
<p>Software is commonly a means, not an objective</p>
</li>
<li>
<p>Commitment to software development is:</p>
<ul>
<li>commonly on the individual</li>
<li>sometimes on the project</li>
<li>rarely on the institution</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="what-about-__research-oriented__-software-pt-3">What about <strong>research-oriented</strong> software? (pt. 3)</h2>
<blockquote>
<p>Research-oriented software development should maximise audience and impact, while minimising development and maintenance effort</p>
</blockquote>
<ul>
<li>
<p>Science requires reproducibility</p>
<ul>
<li>wide(r) user base is a facilitator for reproducility</li>
</ul>
</li>
<li>
<p>The wider the community, the wider the impact of community-driven research software</p>
<ul>
<li>more potential citations</li>
</ul>
</li>
<li>
<p>Minimising effort can be done by improving efficiency</p>
<ul>
<li>by means of software engineering</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="general-benefits-of-coherence-__for-researchers__">General benefits of coherence, <strong>for researchers</strong></h2>
<blockquote>
<p>Choosing the right community / platform is strategical for research-oriented software</p>
</blockquote>
<ul>
<li>
<p>The abstraction gap is likely lower</p>
<ul>
<li>less development effort</li>
</ul>
</li>
<li>
<p>More third party libraries are likely available</p>
<ul>
<li>less development effort</li>
</ul>
</li>
<li>
<p>The potential audience is wider</p>
<ul>
<li>more value, more impact, more reproducibility</li>
</ul>
</li>
<li>
<p>Easier to find support / help in case of issues</p>
<ul>
<li>potentially, less development effort</li>
</ul>
</li>
<li>
<p>More likely that third-party issues are timely fixed</p>
<ul>
<li>potentially, less development effort</li>
</ul>
</li>
</ul>

</section>
</section><section>


<section data-shortcode-section="">
<h2 id="about-technological-silos">About technological silos</h2>
<blockquote>
<p><strong>Silos</strong> (in IT) are software components / systems / ecosystems having poor external interoperability
(i.e. software from silos A hardly interoperates with software from silos B)</p>
</blockquote>
<ul>
<li>
<p>Platforms are (pretty wide) software silos</p>
<ul>
<li>making software from any two platforms interoperate is non-trivial</li>
<li>making software from the same platform interoperate is easier</li>
</ul>
</li>
<li>
<p>Examples:</p>
<ul>
<li>intra-platform: Kotlin program calling Java library</li>
<li>inter-platform: Python program calling native library</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="open-research-communities-vs-technological-silos">Open research communities vs. technological silos</h2>
<ul>
<li>
<p>Research communities in CS / AI may overlap with platforms communities:</p>
<ul>
<li>e.g. neural networks researchers $\rightarrow$ Python</li>
<li>e.g. data science $\rightarrow$ Python | R</li>
<li>e.g. symbolic AI $\rightarrow$ JVM | Prolog</li>
<li>e.g. multi-agent systems $\rightarrow$ JVM</li>
<li>e.g. semantic-web $\rightarrow$ JVM | Python</li>
</ul>
</li>
<li>
<p>What about inter-community research efforts?</p>
<ul>
<li>they may need interoperability among different silos</li>
<li>in lack of which, research is slowed down</li>
</ul>
</li>
</ul>
<blockquote>
<p>Multi-platform programming is an enabler for inter-community research</p>
</blockquote>

</section>
</section><section>
<h2 id="the-need-for-multi-platform-programming">The need for multi-platform programming</h2>
<ul>
<li>Ideal goal:</li>
</ul>
<blockquote>
<p>let the same software tool run on multiple platforms</p>
</blockquote>
<ul>
<li>More reasonable goal:</li>
</ul>
<blockquote>
<p>Create multiple artifacts, one per each supported platform, sharing the same design and functioning</p>
</blockquote>
<ul>
<li>Practical goal:</li>
</ul>
<blockquote>
<p>design and write the software once, then port it to several platforms</p>
</blockquote>
</section><section>


<section data-shortcode-section="">
<h2 id="approaches-for-multi-platform-programming">Approaches for multi-platform programming</h2>
<ol>
<li>
<p>Write once, build anywhere</p>
<ul>
<li>software is developed using some sort of “super-language”</li>
<li>code from the “super-language” is automatically compiled for all platforms</li>
</ul>
</li>
<li>
<p>Write first, wrap elsewhere</p>
<ul>
<li>software is developed for some principal platform</li>
<li>implementations for all other platforms are wrappers of the first one</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="write-once-build-anywhere-concept">Write once, build anywhere (concept)</h2>
<figure><img src="/12-multiplatform/write-once-build-everywhere.svg" width="70%">
</figure>
</section><section>
<h2 id="write-once-build-anywhere-explanation">Write once, build anywhere (explanation)</h2>
<ul>
<li>
<p>Assumptions:</p>
<ul>
<li>one “super-language” exists, having:
<ol>
<li>a code-generator targetting multiple platforms
<ul>
<li>e.g. compiler, transpiler, etc.</li>
</ul>
</li>
<li>the same standard library implemented for all those platforms</li>
</ol>
</li>
</ul>
</li>
<li>
<p>Workflow:</p>
<ol>
<li>
<p>Design, implement, and test most of the project via the super-language</p>
<ul>
<li>this is the platform-agnostic (a.k.a. “common”) part of the project</li>
</ul>
</li>
<li>
<p>Complete, refine, or optimise platform-specific aspects via</p>
<ul>
<li>platform-specific code</li>
<li>platform-specific third-party libraries</li>
</ul>
</li>
<li>
<p>Build platform-specific artifacts, following platform-specific rules</p>
</li>
<li>
<p>Upload platform-specific artifacts on platform-specific repositories</p>
</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="write-once-build-anywhere-analysis">Write once, build anywhere (analysis)</h2>
<p>Let <code>N</code> be the amount of supported platforms</p>
<ul>
<li>
<p>Platform-agnostic functionalities require effort which is independent from <code>N</code></p>
</li>
<li>
<p>Platform-specific functionalities require effort proportional to <code>N</code></p>
</li>
<li>
<p>Better to minimise platform-specific code</p>
<ul>
<li>by maximising common code</li>
<li>this is true both for main code and for test code</li>
</ul>
</li>
<li>
<p>Relevant questions:</p>
<ul>
<li>what to realise as common code? what as platform-specific code?</li>
<li>how to set the boundary of the common (resp. platform-specific) code?</li>
</ul>
</li>
</ul>
</section><section>
<h3 id="takeaway">Takeaway</h3>
<blockquote>
<p>The abstraction gap of the common code is as wide as the one of the platform having the widest abstraction gap</p>
</blockquote>
<figure><img src="/12-multiplatform/abstraction-gap-mp.svg" width="50%">
</figure>
</section><section>
<h2 id="write-once-build-anywhere-strategy">Write once, build anywhere (strategy)</h2>
<p>Whenever a new functionality needs to be developed:</p>
<ol>
<li>
<p>Try to realise it with common std-lib only</p>
</li>
<li>
<p>If not possible, try to maximise the portion of platform-agnostic code</p>
</li>
</ol>
<ul>
<li>make it possible to plug platform-specific aspects</li>
</ul>
<ol start="3">
<li>For each functionality which cannot be realised as purely platform-agnostic:</li>
<li>design a platform-agnostic interface</li>
<li>implement the interface <code>N</code> times, one per target platform</li>
</ol>
</section><section>
<h2 id="write-first-wrap-elsewhere-concept">Write first, wrap elsewhere (concept)</h2>
<figure><img src="/12-multiplatform/write-first-wrap-elsewhere.svg" width="70%">
</figure>
</section><section>
<h2 id="write-first-wrap-elsewhere-explanation">Write first, wrap elsewhere (explanation)</h2>
<ul>
<li>
<p>Assumptions:</p>
<ul>
<li>one “main” platform exists such that
<ul>
<li>code from the “main” platform can be called from other target platforms</li>
</ul>
</li>
<li>the software has been designed in a platform-agnostic way</li>
</ul>
</li>
<li>
<p>Workflow:</p>
<ol>
<li>
<p>Fully implement, test, and deploy the software for the main platform</p>
</li>
<li>
<p>For all other platforms:</p>
</li>
<li>
<p>re-design and re-write platform-specific API code</p>
</li>
<li>
<p>implement platform-specific API by calling the main platform’s code</p>
</li>
<li>
<p>re-write test for API code</p>
</li>
<li>
<p>build platform-specific packages, wrapping the main platform’s package and runtime</p>
</li>
<li>
<p>Upload platform-specific artifacts on platform-specific repositories</p>
</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="write-first-wrap-elsewhere-analysis">Write first, wrap elsewhere (analysis)</h2>
<p>Let <code>N</code> be the amount of supported platforms</p>
<ul>
<li>
<p>Clear separation of API code from implementation code is quintessential</p>
</li>
<li>
<p>The effort required for writing API code is virtually the same on all platforms</p>
</li>
<li>
<p>Global effort is sub-linearly dependent on <code>N</code></p>
<ul>
<li>implementing API and wrapper code is a manual task</li>
<li>still less effort than implementing the same design <code>N</code> times</li>
</ul>
</li>
<li>
<p>The <code>i</code>-th platform’s wrapper code will only call the main platform’s API code</p>
</li>
<li>
<p>Relevant questions:</p>
<ul>
<li>how to deal with platform-specific aspects?</li>
<li>how to create platform-agnostic design?</li>
</ul>
</li>
</ul>

</section>
</section><section>
<h1 id="multi-platform-programming-2">Multi-platform programming</h1>
<h2 id="write-once-build-anywhere">Write once, build anywhere</h2>
</section><section>
<h2 id="write-once-build-anywhere-with-__kotlin__">Write once, build anywhere with <strong>Kotlin</strong></h2>
<ul>
<li>
<p>JetBrains-made modern programming language</p>
<ul>
<li>focused on “practical use” (whatever that means)</li>
</ul>
</li>
<li>
<p>Gaining momentum since Google adopted is as <em>official Android language</em></p>
<ul>
<li>along with Java and C++</li>
</ul>
</li>
<li>
<p>Clearly inspired by a mixture of Java, C#, Scala, and Groovy</p>
<ul>
<li>standard library clearly inspired to Java’s one</li>
</ul>
</li>
<li>
<p>Born in industry, for the industry</p>
<ul>
<li>initially considered <em>a better java</em></li>
<li>focused on getting productive quickly and reducing programming errors</li>
</ul>
</li>
<li>
<p>Acts as the “super language” supporting the “write once, build anywhere” approach</p>
<ul>
<li>Kotlin compilers are available for several platforms</li>
<li>standard library implemented for those platforms</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin-supported-platforms-aka-targets">Kotlin: supported platforms (a.k.a. targets)</h2>
<p>Reference: <a href="https://kotlinlang.org/docs/reference/mpp-dsl-reference.html">https://kotlinlang.org/docs/reference/mpp-dsl-reference.html</a></p>
<ul>
<li>
<p>JVM</p>
<ul>
<li>first and best supported platform</li>
<li>may target a specific JDK version: prefer <code>11</code></li>
</ul>
</li>
<li>
<p>JavaScript (JS)</p>
<ul>
<li>requires choosing among Browser support, Node support or both</li>
<li>the two sub-targets have different runtimes</li>
</ul>
</li>
<li>
<p>Native</p>
<ul>
<li>supporting native may imply dealing with 3+ targets</li>
<li>cross-compilation is not yet supported</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin-supported-platforms-native-sub-targets">Kotlin: supported platforms, Native sub-targets</h2>
<p>Reference: <a href="https://kotlinlang.org/docs/reference/mpp-dsl-reference.html">https://kotlinlang.org/docs/reference/mpp-dsl-reference.html</a></p>
<ul>
<li>
<p>Win by <a href="https://sourceforge.net/projects/mingw">MinGW</a>, Linux</p>
<ul>
<li>must pay attention to architecture</li>
<li>MinGW is not exactly “vanilla” Windows environment</li>
</ul>
</li>
<li>
<p>iOS, macOS</p>
<ul>
<li>requires Apple facilities (e.g. XCode)</li>
<li>may imply further costs</li>
</ul>
</li>
<li>
<p>Android</p>
<ul>
<li>requires Android SDK</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="__gradle__-as-the-tool-for-build-automation"><strong>Gradle</strong> as the tool for build automation</h2>
<ul>
<li>
<p>Building a multi-platform Kotlin project is <em>only</em> supported via <a href="https://gradle.com/">Gradle</a></p>
<ul>
<li>no real alternatives here</li>
</ul>
</li>
<li>
<p>Gradle is a build automation + dependency management system</p>
</li>
<li>
<p>Gradle simultaneously enables &amp; constrains the multi-platform workflow</p>
<ul>
<li>pre-defined project structure</li>
<li>pre-defined development workflow</li>
<li>enforced code partitioning</li>
<li>ad-hoc tasks for platform specific/agnostic compilation, testing, deploy, etc.</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin-multi-platform-project-structure">Kotlin multi-platform project structure</h2>
<h3 id="common">Common</h3>
<p>Kotlin enforces strong segregation of the platform-agnostic and platform-specific parts</p>
<ul>
<li>
<p><strong>common <em>main</em> code</strong>: platform-agnostic code which only depends on:</p>
<ul>
<li>the Kotlin std-lib</li>
<li>plus other third-party Kotlin multi-platform libraries</li>
</ul>
</li>
<li>
<p><strong>common <em>test</em> code</strong>: platform-agnostic <em>test</em> code which only depends on:</p>
<ul>
<li>the common main code and all its dependencies</li>
<li>some Kotlin multi-platform testing library (e.g. <a href="https://kotlinlang.org/api/latest/kotlin.test/"><code>kotlin.test</code></a> or <a href="https://kotest.io/">Kotest</a>)</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin-multi-platform-project-structure-1">Kotlin multi-platform project structure</h2>
<h3 id="platform-specific">Platform-specific</h3>
<ul>
<li>for each target platform <code>T</code> (e.g. <code>jvm</code>, <code>js</code>, etc.)
<ul>
<li>
<p><strong><code>T</code>-specific <em>main</em> code</strong>: main Kotlin code targeting the <code>T</code> platform, depending on:</p>
<ul>
<li>the common main code and all its dependencies</li>
<li><code>T</code>-specific standard library</li>
<li><code>T</code>-specific third-party libraries</li>
</ul>
</li>
<li>
<p><strong><code>T</code>-specific <em>test</em> code</strong>: test Kotlin code targeting the <code>T</code> platform, depending on:</p>
<ul>
<li><code>T</code>-specific main code</li>
<li><code>T</code>-specific test libraries</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin-multi-platform-project-structure-example">Kotlin multi-platform project structure (example)</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>&lt;root&gt;/
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>├── build.gradle.kts        <span style="color:#888"># multi-platform build description </span>
</span></span><span style="display:flex;"><span>├── settings.gradle.kts     <span style="color:#888"># root project settings</span>
</span></span><span style="display:flex;"><span>│
</span></span><span style="display:flex;"><span>└── src/
</span></span><span style="display:flex;"><span>    ├── commonMain/
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── kotlin/         <span style="color:#888"># platform-agnostic Kotlin code here	font-weight: normal;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    ├── commonTest/
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── kotlin/         <span style="color:#888"># platform-agnostic test code written in Kotlin here</span>
</span></span><span style="display:flex;"><span>    │
</span></span><span style="display:flex;"><span>    ├── jvmMain/
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; ├── java/           <span style="color:#888"># JVM-specific Java code here</span>
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; ├── kotlin/         <span style="color:#888"># JVM-specific Kotlin code here</span>
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── resources/      <span style="color:#888"># JVM-specific resources here</span>
</span></span><span style="display:flex;"><span>    ├── jvmTest
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; ├── java/           <span style="color:#888"># JVM-specific test code written in Java here</span>
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; ├── kotlin/         <span style="color:#888"># JVM-specific test code written in Kotlin here</span>
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── resources/      <span style="color:#888"># JVM-specific test resources here</span>
</span></span><span style="display:flex;"><span>    │
</span></span><span style="display:flex;"><span>    ├── jsMain/
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── kotlin/         <span style="color:#888"># JS-specific Kotlin code here</span>
</span></span><span style="display:flex;"><span>    ├── jsTest/
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── kotlin/         <span style="color:#888"># JS-specific Kotlin code here</span>
</span></span><span style="display:flex;"><span>    │
</span></span><span style="display:flex;"><span>    ├── &lt;TARGET&gt;Main/       
</span></span><span style="display:flex;"><span>    │&nbsp;&nbsp; └── kotlin/         <span style="color:#888"># &lt;TARGET&gt;-specific Kotlin code here</span>
</span></span><span style="display:flex;"><span>    └── &lt;TARGET&gt;Test/
</span></span><span style="display:flex;"><span>        └── kotlin/         <span style="color:#888"># &lt;TARGET&gt;-specific test code written in Kotlin here</span>
</span></span></code></pre></div></section><section>
<h2 id="kotlin-multi-platform-build-configuration-pt-1">Kotlin multi-platform build configuration (pt. 1)</h2>
<p>Defines several aspects of the project:</p>
<ul>
<li>
<p>which version of the Kotlin compiler to adopt</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    kotlin(<span style="color:#d20;background-color:#fff0f0">"multiplatform"</span>) version <span style="color:#d20;background-color:#fff0f0">"1.9.10"</span> <span style="color:#888">// defines plugin and compiler version
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div></li>
<li>
<p>which repositories should Gradle use when looking for dependencies</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>repositories { 
</span></span><span style="display:flex;"><span>    mavenCentral() <span style="color:#888">// use MCR for downloading dependencies (recommneded)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// other custom repositories here (discouraged)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>} 
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="kotlin-multi-platform-build-configuration-pt-2">Kotlin multi-platform build configuration (pt. 2)</h2>
<p>Defines several aspects of the project:</p>
<ul>
<li>
<p>which platforms to target (reference <a href="https://kotlinlang.org/docs/multiplatform-dsl-reference.html#targets">here</a>)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>kotlin {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// declares JVM as target
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    jvm {
</span></span><span style="display:flex;"><span>        withJava() <span style="color:#888">// jvm-specific targets may include java sources
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#888">// declares JavaScript as target
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    js {
</span></span><span style="display:flex;"><span>        useCommonJs() <span style="color:#888">// use CommonJS for JS depenencies management
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        <span style="color:#888">// or useEsModules() 
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        binaries.executable() <span style="color:#888">// enables tasks for Node packages generation
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        <span style="color:#888">// the target will consist of a Node project (with NodeJS's stdlib)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        nodejs {
</span></span><span style="display:flex;"><span>            runTask { <span style="color:#888">/* configure project running in Node here */</span> }
</span></span><span style="display:flex;"><span>            testRuns { <span style="color:#888">/* configure Node's testing frameworks */</span> }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#888">// alternatively, or additionally to nodejs:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        browser { <span style="color:#888">/* ... */</span> } 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// other targets here
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div></li>
<li>
<p>other admissible targets:</p>
<ul>
<li><code>android</code></li>
<li>various native sub-targets (details <a href="https://kotlinlang.org/docs/native-target-support.html">here</a>)</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin-multi-platform-build-configuration-pt-3">Kotlin multi-platform build configuration (pt. 3)</h2>
<ul>
<li>which third-party library should each target depend upon
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>kotlin {
</span></span><span style="display:flex;"><span>    sourceSets {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">commonMain</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-common"</span>))
</span></span><span style="display:flex;"><span>                implementation(<span style="color:#d20;background-color:#fff0f0">"group.of"</span>, <span style="color:#d20;background-color:#fff0f0">"multiplatform-library"</span>, <span style="color:#d20;background-color:#fff0f0">"X.Y.Z"</span>) <span style="color:#888">// or api
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">commonTest</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                implementation(kotlin(<span style="color:#d20;background-color:#fff0f0">"test-common"</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jvmMain</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-jdk8"</span>))
</span></span><span style="display:flex;"><span>                implementation(<span style="color:#d20;background-color:#fff0f0">"group.of"</span>, <span style="color:#d20;background-color:#fff0f0">"jvm-library"</span>, <span style="color:#d20;background-color:#fff0f0">"X.Y.Z"</span>) <span style="color:#888">// or api
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jvmTest</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                implementation(kotlin(<span style="color:#d20;background-color:#fff0f0">"test-junit"</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jsMain</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-js"</span>))
</span></span><span style="display:flex;"><span>                implementation(npm(<span style="color:#d20;background-color:#fff0f0">"npm-module"</span>, <span style="color:#d20;background-color:#fff0f0">"X.Y.Z"</span>)) <span style="color:#888">// lookup on https://www.npmjs.com
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jsTest</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                implementation(kotlin(<span style="color:#d20;background-color:#fff0f0">"test-js"</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="kotlin-multi-platform-build-configuration-pt-4">Kotlin multi-platform build configuration (pt. 4)</h2>
<ul>
<li>
<p>configure Kotlin compiler options</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>kotlin {
</span></span><span style="display:flex;"><span>    sourceSets.all {
</span></span><span style="display:flex;"><span>        languageSettings.apply {
</span></span><span style="display:flex;"><span>            <span style="color:#888">// provides source compatibility with the specified version of Kotlin.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            languageVersion = <span style="color:#d20;background-color:#fff0f0">"1.8"</span> <span style="color:#888">// possible values: "1.4", "1.5", "1.6", "1.7", "1.8", "1.9"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#888">// allows using declarations only from the specified version of Kotlin bundled libraries.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            apiVersion = <span style="color:#d20;background-color:#fff0f0">"1.8"</span> <span style="color:#888">// possible values: "1.3", "1.4", "1.5", "1.6", "1.7", "1.8", "1.9"
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#888">// enables the specified language feature
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            enableLanguageFeature(<span style="color:#d20;background-color:#fff0f0">"InlineClasses"</span>) <span style="color:#888">// language feature name
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#888">// allow using the specified opt-in
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            optIn(<span style="color:#d20;background-color:#fff0f0">"kotlin.ExperimentalUnsignedTypes"</span>) <span style="color:#888">// annotation FQ-name
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>            <span style="color:#888">// enables/disable progressive mode
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            progressiveMode = <span style="color:#080;font-weight:bold">true</span> <span style="color:#888">// false by default
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>details about:</p>
<ul>
<li>progressive mode <a href="https://kotlinlang.org/docs/whatsnew13.html#progressive-mode">here</a></li>
<li>opt-ins <a href="https://kotlinlang.org/docs/opt-in-requirements.html#opt-in-to-using-api">here</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="build-configuration-full-example">Build configuration: full example</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>plugins {
</span></span><span style="display:flex;"><span>    kotlin(<span style="color:#d20;background-color:#fff0f0">"multiplatform"</span>) version <span style="color:#d20;background-color:#fff0f0">"1.9.10"</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>repositories { 
</span></span><span style="display:flex;"><span>    mavenCentral() 
</span></span><span style="display:flex;"><span>} 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kotlin {
</span></span><span style="display:flex;"><span>    jvm {
</span></span><span style="display:flex;"><span>        withJava()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    js {
</span></span><span style="display:flex;"><span>        nodejs {
</span></span><span style="display:flex;"><span>            runTask { <span style="color:#888">/* ... */</span> }
</span></span><span style="display:flex;"><span>            testRuns { <span style="color:#888">/* ... */</span> }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#888">// alternatively, or additionally to nodejs:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        browser { <span style="color:#888">/* ... */</span> } 
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sourceSets {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">commonMain</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-common"</span>))
</span></span><span style="display:flex;"><span>                implementation(<span style="color:#d20;background-color:#fff0f0">"group.of"</span>, <span style="color:#d20;background-color:#fff0f0">"multiplatform-library"</span>, <span style="color:#d20;background-color:#fff0f0">"X.Y.Z"</span>) <span style="color:#888">// or api
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">commonTest</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                implementation(kotlin(<span style="color:#d20;background-color:#fff0f0">"test-common"</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jvmMain</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-jdk8"</span>))
</span></span><span style="display:flex;"><span>                implementation(<span style="color:#d20;background-color:#fff0f0">"group.of"</span>, <span style="color:#d20;background-color:#fff0f0">"jvm-library"</span>, <span style="color:#d20;background-color:#fff0f0">"X.Y.Z"</span>) <span style="color:#888">// or api
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jvmTest</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                implementation(kotlin(<span style="color:#d20;background-color:#fff0f0">"test-junit"</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jsMain</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                api(kotlin(<span style="color:#d20;background-color:#fff0f0">"stdlib-js"</span>))
</span></span><span style="display:flex;"><span>                implementation(npm(<span style="color:#d20;background-color:#fff0f0">"npm-module"</span>, <span style="color:#d20;background-color:#fff0f0">"X.Y.Z"</span>)) <span style="color:#888">// lookup on https://www.npmjs.com
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">jsTest</span> <span style="color:#080;font-weight:bold">by</span> getting {
</span></span><span style="display:flex;"><span>            dependencies {
</span></span><span style="display:flex;"><span>                implementation(kotlin(<span style="color:#d20;background-color:#fff0f0">"test-js"</span>))
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        all {
</span></span><span style="display:flex;"><span>            languageVersion = <span style="color:#d20;background-color:#fff0f0">"1.8"</span>
</span></span><span style="display:flex;"><span>            apiVersion = <span style="color:#d20;background-color:#fff0f0">"1.8"</span>
</span></span><span style="display:flex;"><span>            enableLanguageFeature(<span style="color:#d20;background-color:#fff0f0">"InlineClasses"</span>)
</span></span><span style="display:flex;"><span>            optIn(<span style="color:#d20;background-color:#fff0f0">"kotlin.ExperimentalUnsignedTypes"</span>)
</span></span><span style="display:flex;"><span>            progressiveMode = <span style="color:#080;font-weight:bold">true</span> <span style="color:#888">// false by default
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="gradle-tasks-for-multi-platform-projects-pt-1">Gradle tasks for multi-platform projects (pt. 1)</h2>
<p>Let <code>T</code> denote the target name (e.g. <code>jvm</code>, <code>js</code>, etc.)</p>
<ul>
<li>
<p><code>&lt;T&gt;MainClasses</code> compiles the main code for platform <code>T</code></p>
<ul>
<li>e.g. <code>jvmMainClasses</code>, <code>jsMainClasses</code></li>
</ul>
</li>
<li>
<p><code>&lt;T&gt;TestClasses</code> compiles the test code for platform <code>T</code></p>
<ul>
<li>e.g. <code>jvmTestClasses</code>, <code>jsTestClasses</code></li>
</ul>
</li>
<li>
<p><code>&lt;T&gt;Jar</code> compiles the main code for platform <code>T</code> and produces a JAR out of it</p>
<ul>
<li>e.g. <code>jvmJar</code>, <code>jsJar</code></li>
<li>depends on (hence implies) <code>&lt;T&gt;MainClasses</code>, but NOT <code>&lt;T&gt;TestClasses</code></li>
</ul>
</li>
<li>
<p><code>&lt;T&gt;Test</code> executes tests for platform <code>T</code></p>
<ul>
<li>e.g. <code>jvmTest</code>, <code>jsTest</code></li>
<li>depends on (hence implies) <code>&lt;T&gt;MainClasses</code>, AND on <code>&lt;T&gt;TestClasses</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="gradle-tasks-for-multi-platform-projects-pt-2">Gradle tasks for multi-platform projects (pt. 2)</h2>
<ul>
<li>
<p><code>compileProductionExecutableKotlinJs</code> compiles the JS main code into a Node project</p>
<ul>
<li>requires the <code>js</code> target to be enabled</li>
<li>requires the <code>binaries.executable()</code> configuration to be enabled</li>
</ul>
</li>
<li>
<p><code>assemble</code> creates all JARs (hence compiling for main code for all platforms)</p>
<ul>
<li>it also generates documentation and sources JAR
<ul>
<li>if publishing is configured</li>
</ul>
</li>
</ul>
</li>
<li>
<p><code>test</code> executes tests for all platforms</p>
</li>
<li>
<p><code>check</code> like <code>test</code> but it may also include other checks (e.g. style) if configured</p>
</li>
<li>
<p><code>build</code> $\approx$ <code>check</code> + <code>assemble</code></p>
</li>
</ul>
</section><section>
<h2 id="multi-platform-kotlin-sources">Multi-platform Kotlin sources</h2>
<ul>
<li>
<p>Ordinary Kotlin sources</p>
</li>
<li>
<p>When in <code>common</code>:</p>
<ul>
<li>only the platform-agnostic std-lib can be used
<ul>
<li>API reference <a href="https://kotlinlang.org/api/latest/jvm/stdlib/">here</a> (recall to disable all targets except <code>Common</code>)</li>
</ul>
</li>
<li>one may use third-party libraries, as long as they are <strong>multi-platform</strong> too</li>
<li>one may use the <a href="https://kotlinlang.org/docs/multiplatform-connect-to-apis.html"><code>expect</code> keyword</a></li>
<li>one may use platform-specific annotations
<ul>
<li>e.g. <code>@JvmStatic</code>, <code>@JsName</code>, etc.</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="multi-platform-kotlin-sources-1">Multi-platform Kotlin sources</h2>
<p>Let <code>T</code> denote some target platform</p>
<ul>
<li>
<p>When in <code>T</code>-specific source sets</p>
<ul>
<li>one may use the <code>T</code>-specific std-lib</li>
<li>one may use the <code>T</code>-specific Kotlin libraries</li>
<li>one may use the <code>T</code>-specific libraries</li>
<li>one may use the <a href="https://kotlinlang.org/docs/multiplatform-connect-to-apis.html"><code>actual</code> keyword</a></li>
</ul>
</li>
<li>
<p>Each platform <code>T</code> may allow for specific keywords</p>
<ul>
<li>e.g. the <a href="https://kotlinlang.org/docs/js-interop.html#external-modifier"><code>external</code> modifier</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="the-expectactual-mechanism-for-specialising-common-api">The <code>expect</code>/<code>actual</code> mechanism for specialising common API</h2>
<ul>
<li>
<p>Declaring an <code>expect</code>ed function / type <strong>declaration</strong> in common code…</p>
</li>
<li>
<p>… enforces the existence of a corresponding <code>actual</code> <strong>definition</strong> for <em>all</em> platforms</p>
<ul>
<li>compiler won’t succeed until an actual definition is provided <em>for each target</em></li>
</ul>
</li>
</ul>
<figure><img src="/12-multiplatform/expect-actual.png" width="50%">
</figure>

</section><section>
<h2 id="workflow-top-down">Workflow (top-down)</h2>
<ol>
<li>
<p>Draw a platform-agnostic design for your domain entities</p>
<ul>
<li>keep in mind that you can only rely on a very small std-lib / runtime</li>
<li>keep in mind that some API may be missing in the common std-lib:
<ul>
<li>e.g. file system API</li>
</ul>
</li>
<li>try to reason in a platform-agnostic way
<ul>
<li>e.g. file system makes no sense for in-browser JS</li>
</ul>
</li>
<li>separate interfaces from classes</li>
<li>rely on abstract classes with <a href="https://en.wikipedia.org/wiki/Template_method_pattern">template methods</a> to maximise common code</li>
<li>use <code>expect</code> keyword to declare platform-agnostic factories</li>
</ul>
</li>
<li>
<p>Assess the <em>abstraction gap</em>, <strong>for each target platform</strong></p>
</li>
<li>
<p>For each target platform:</p>
<ul>
<li>draw a platform-specific design extending the platform-agnostic one</li>
<li>… and filling the abstraction gap for that target</li>
<li>implement interfaces via platform-specific classes</li>
<li>implement platform-specific concrete classes for common abstract classes</li>
<li>use <code>actual</code> keyword to implement platform-specific factories</li>
</ul>
</li>
</ol>
</section><section>


<section data-shortcode-section="">
<h1 id="running-example">Running example</h1>
<h2 id="multi-platform-csv-parsing-lib">Multi-platform CSV parsing lib</h2>
<ul>
<li>
<p>CSV (comma-separated values) files, e.g.:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># HEADER_1, HEADER_2, HEADER_3, ...</span>
</span></span><span style="display:flex;"><span><span style="color:#888"># character '#' denotes the beginning of a single-line comment</span>
</span></span><span style="display:flex;"><span><span style="color:#888"># first line conventionally denotes columns names (headers)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>field1, filed2, field3, ...
</span></span><span style="display:flex;"><span><span style="color:#888"># character ',' acts as field separator</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">"field with spaces"</span>, <span style="color:#d20;background-color:#fff0f0">"another field, with comma"</span>, <span style="color:#d20;background-color:#fff0f0">"yet another field"</span>, ...
</span></span><span style="display:flex;"><span><span style="color:#888"># character '"' acts as field delimiter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># other characters may be used to denote comments, separators, or delimiters</span>
</span></span></code></pre></div></li>
<li>
<p>JVM and JS std-lib do not provide direct support for CSV</p>
</li>
<li>
<p>Requirements:</p>
<ul>
<li>library for parsing / manipulating CSV files</li>
<li>parsing = loading from file</li>
<li>manipulating = creating / editing / saving CSV files, programmatically</li>
<li>support for both JVM and JS</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="about-the-example">About the example</h2>
<ul>
<li>
<p>We’ll follow a domain-driven approach:</p>
<ol>
<li>focus on designing / implementing the domain entities</li>
<li>then, we’ll add functionalities for manipulating them</li>
<li>finally, we’ll write unit and integration tests</li>
</ol>
</li>
<li>
<p>Domain entities (can be realised as common code):</p>
<ul>
<li><code>Table</code>: in-memory representation of a CSV file</li>
<li><code>Row</code>: generic row in a CSV file</li>
<li><code>Header</code>: special row containing the names of the columns</li>
<li><code>Record</code>: special row containing the values of a line in a CSV file</li>
</ul>
</li>
<li>
<p>Main functionalities (require platform specific code):</p>
<ol>
<li>creating a <code>Table</code> programmatically</li>
<li>reading columns, rows, and values from a <code>Table</code></li>
<li>parsing a CSV file into a <code>Table</code></li>
<li>saving a <code>Table</code> into a CSV file</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="domain-entities">Domain entities</h2>
<figure id="plantuml-figure-0" class="plantuml" alt="" style="width: 50%;max-width: 95vw;max-height: 80vh;">
<p>top to bottom direction</p>
<p>package “kotlin” {
interface Iterable<t>
}</t></p>
<p>package “io github gciatto csv” {</p>
<pre><code>interface Row {
    + get(index: Int): String
    + size: Int
}

Row -up-|&gt; Iterable: //T// = String

interface Header {
    + columns: List&lt;String&gt;
    + contains(column: String): Boolean
    + indexOf(column: String): Int
}

Row &lt;|-- Header

interface Record {
    + header: Header
    + values: List&lt;String&gt;
    + contains(value: String): Boolean
    + get(column: String): String
}

Row &lt;|-- Record

Record "1" *-right- "*" Header

interface Table {
    + header: Header
    + records: List&lt;Record&gt;
    + get(row: Int): Row
    + size: Int
}

Table "1" *-u- "*" Header
Table "*" o-u- "*" Record
Table -u----|&gt; Iterable: //T// = Row
</code></pre>
<p>}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-0");
</script>
</section><section>
<h2 id="the-row-interface">The <code>Row</code> interface</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Represents a single row in a CSV file.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">Row</span> : Iterable&lt;String&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the value of the field at the given index.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">operator</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">get</span>(index: Int): String
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the number of fields in this row.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">size</span>: Int
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-header-interface">The <code>Header</code> interface</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Represents the header of a CSV file.
</span></span></span><span style="display:flex;"><span><span style="color:#888">// A header is a special row containing the names of the columns.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">Header</span> : Row {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the names of the columns.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">columns</span>: List&lt;String&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Checks whether the given column name is present in this header.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">operator</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">contains</span>(column: String): Boolean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the index of the given column name.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">indexOf</span>(column: String): Int
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-record-interface">The <code>Record</code> interface</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Represents a record in a CSV file.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">Record</span> : Row {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the header of this record (useful to know column names).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">header</span>: Header
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the values of the fields in this record.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">values</span>: List&lt;String&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Checks whether the given value is present in this record.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">operator</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">contains</span>(<span style="color:#080;font-weight:bold">value</span>: String): Boolean
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the value of the field in the given column.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">operator</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">get</span>(column: String): String
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-table-interface">The <code>Table</code> interface</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Represents a table (i.e. an in-memory representation of a CSV file).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">Table</span> : Iterable&lt;Row&gt; {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the header of this table (useful to know column names).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">header</span>: Header
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the records in this table.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">records</span>: List&lt;Record&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the row at the given index.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">operator</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">get</span>(row: Int): Row
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the number of rows in this table.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">size</span>: Int
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="common-implementations-of-domain-entities">Common implementations of domain entities</h2>
<figure id="plantuml-figure-1" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
    <p>top to bottom direction</p>
<p>package “io github gciatto csv <strong>impl</strong>” {
interface Row</p>
<pre><code>abstract class AbstractRow {
    - values: List&lt;String&gt;
    # constructor(values: List&lt;String&gt;)
    # toString(type: String?): String
}
<p>Row &lt;|-d- AbstractRow</p>
<p>interface Header</p>
<p>class DefaultHeader {
- indexesByName: Map&lt;String, Int&gt;
+ constructor(columns: Iterable&lt;String&gt;)
}</p>
<p>Row &lt;|-d- Header
Header &lt;|-d- DefaultHeader
AbstractRow &lt;|-d- DefaultHeader</p>
<p>interface Record</p>
<p>class DefaultRecord {
+ constructor(header: Header, values: Iterable&lt;String&gt;)
}</p>
<p>Row &lt;|-d- Record
Record &lt;|– DefaultRecord
AbstractRow &lt;|-d- DefaultRecord</p>
<p>class DefaultTable {
+ constructor(header: Header, records: Iterable&lt;Record&gt;)
}</p>
<p>interface Table</p>
</code><p><code>Table &lt;|– DefaultTable
</code></p></pre><p></p>
<p>}</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-1");
</script>
</section><section>
<h2 id="the-abstractrow-class">The <code>AbstractRow</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Base implementation for the Row interface.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">internal</span> <span style="color:#080;font-weight:bold">abstract</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">AbstractRow</span>(<span style="color:#080;font-weight:bold">protected</span> <span style="color:#080;font-weight:bold">open</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">values</span>: List&lt;String&gt;) : Row {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">size</span>: Int
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">get</span>() = values.size
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">get</span>(index: Int): String = values[index]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">equals</span>(other: Any?): Boolean {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#080;font-weight:bold">this</span> === other) <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (other == <span style="color:#080;font-weight:bold">null</span> || <span style="color:#080;font-weight:bold">this</span>::<span style="color:#080;font-weight:bold">class</span> <span style="color:#a61717;background-color:#e3d2d2">!= </span><span style="color:#b06;font-weight:bold">other</span>::<span style="color:#080;font-weight:bold">class</span>) <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> values == (other <span style="color:#080;font-weight:bold">as</span> AbstractRow).values
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">hashCode</span>(): Int = values.hashCode()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Returns a string representation of this row as "&lt;type&gt;(field1, field2, ...)".
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">protected</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">toString</span>(type: String?): String {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">prefix</span> = <span style="color:#d20;background-color:#fff0f0">""</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">suffix</span> = <span style="color:#d20;background-color:#fff0f0">""</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (type != <span style="color:#080;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>            prefix = <span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#33b;background-color:#fff0f0">$type</span><span style="color:#d20;background-color:#fff0f0">("</span>
</span></span><span style="display:flex;"><span>            suffix = <span style="color:#d20;background-color:#fff0f0">")"</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> values.joinToString(<span style="color:#d20;background-color:#fff0f0">", "</span>, prefix, suffix) { <span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#04d;background-color:#fff0f0">\"</span><span style="color:#33b;background-color:#fff0f0">$it</span><span style="color:#04d;background-color:#fff0f0">\"</span><span style="color:#d20;background-color:#fff0f0">"</span> }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Returns a string representation of this row as "Row(field1, field2, ...)".
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">toString</span>(): String = toString(<span style="color:#d20;background-color:#fff0f0">"Row"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Makes it possible to iterate over the fields of this row, via for-each loops.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">iterator</span>(): Iterator&lt;String&gt; = values.iterator()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-defaultheader-class">The <code>DefaultHeader</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Default implementation for the Header interface.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">internal</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">DefaultHeader</span>(columns: Iterable&lt;String&gt;) : Header, AbstractRow(columns.toList()) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Cache of column indexes, for faster lookup.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">indexesByName</span> = columns.mapIndexed { index, name -&gt; name to index }.toMap()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">columns</span>: List&lt;String&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">get</span>() = values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">contains</span>(column: String): Boolean = column <span style="color:#080;font-weight:bold">in</span> indexesByName.keys
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">indexOf</span>(column: String): Int = indexesByName[column] ?: -<span style="color:#00d;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">iterator</span>(): Iterator&lt;String&gt; = values.iterator()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">toString</span>(): String = toString(<span style="color:#d20;background-color:#fff0f0">"Header"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-defaultrecord-class">The <code>DefaultRecord</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">internal</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">DefaultRecord</span>(<span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">header</span>: Header, values: Iterable&lt;String&gt;) : Record, AbstractRow(values.toList()) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">init</span> {
</span></span><span style="display:flex;"><span>        require(header.size == <span style="color:#080;font-weight:bold">super</span>.values.size) {
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"Inconsistent amount of values (</span><span style="color:#33b;background-color:#fff0f0">${super.values.size}</span><span style="color:#d20;background-color:#fff0f0">) w.r.t. to header size (</span><span style="color:#33b;background-color:#fff0f0">${header.size}</span><span style="color:#d20;background-color:#fff0f0">)"</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">contains</span>(<span style="color:#080;font-weight:bold">value</span>: String): Boolean = values.contains(<span style="color:#080;font-weight:bold">value</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">values</span>: List&lt;String&gt;
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">get</span>() = <span style="color:#080;font-weight:bold">super</span>.values
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">get</span>(column: String): String =
</span></span><span style="display:flex;"><span>        header.indexOf(column).takeIf { <span style="color:#080;font-weight:bold">it</span> <span style="color:#080;font-weight:bold">in</span> <span style="color:#00d;font-weight:bold">0</span> ..&lt; size }?.let { values[<span style="color:#080;font-weight:bold">it</span>] }
</span></span><span style="display:flex;"><span>            ?: <span style="color:#080;font-weight:bold">throw</span> NoSuchElementException(<span style="color:#d20;background-color:#fff0f0">"No such column: </span><span style="color:#33b;background-color:#fff0f0">$column</span><span style="color:#d20;background-color:#fff0f0">"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">toString</span>(): String = toString(<span style="color:#d20;background-color:#fff0f0">"Record"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-defaulttable-class">The <code>DefaultTable</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">internal</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">DefaultTable</span>(<span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">header</span>: Header, records: Iterable&lt;Record&gt;) : Table {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Lazy, defensive copy of the records.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">records</span>: List&lt;Record&gt; <span style="color:#080;font-weight:bold">by</span> lazy { records.toList() }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">get</span>(row: Int): Row = <span style="color:#080;font-weight:bold">if</span> (row == <span style="color:#00d;font-weight:bold">0</span>) header <span style="color:#080;font-weight:bold">else</span> records[row - <span style="color:#00d;font-weight:bold">1</span>]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">size</span>: Int
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">get</span>() = records.size + <span style="color:#00d;font-weight:bold">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">iterator</span>(): Iterator&lt;Row&gt; = (sequenceOf(header) + records.asSequence()).iterator()
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">equals</span>(other: Any?): Boolean {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (<span style="color:#080;font-weight:bold">this</span> === other) <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (other == <span style="color:#080;font-weight:bold">null</span> || other !is DefaultTable) <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (header != other.header) <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> (records != other.records) <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">false</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">hashCode</span>(): Int {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">result</span> = header.hashCode()
</span></span><span style="display:flex;"><span>        result = <span style="color:#00d;font-weight:bold">31</span> * result + records.hashCode()
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> result
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">toString</span>(): String = <span style="color:#080;font-weight:bold">this</span>.joinToString(<span style="color:#d20;background-color:#fff0f0">", "</span>, <span style="color:#d20;background-color:#fff0f0">"Table("</span>, <span style="color:#d20;background-color:#fff0f0">")"</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="need-for-factory-methods">Need for factory methods</h2>
<ul>
<li>
<p>To enforce separation among API and implementation code, it’s better:</p>
<ul>
<li>to keep interfaces public, and classes internal</li>
<li>to provide factory methods for creating instances of the interfaces</li>
</ul>
</li>
<li>
<p>Convention in Kotlin is to create factory methods as package-level <code>fun</code>ctions</p>
<ul>
<li>e.g. contained into the <code>io/github/gciatto/csv/Csv.kt</code> file</li>
</ul>
</li>
<li>
<p>Factory methods may be named after the concept they create: <code>&lt;concept&gt;Of(args...)</code></p>
<ul>
<li>e.g. <code>headerOf(columns...)</code>, <code>recordOf(header, values...)</code>, etc.</li>
</ul>
</li>
<li>
<p>Class diagram:</p>
</li>
</ul>
<figure id="plantuml-figure-2" class="plantuml" alt="" style="width: 30%;max-width: 95vw;max-height: 80vh;">
<pre><code>@startuml
skinparam monochrome false
class Csv{
    + headerOf(columns): Header
    + anonymousHeader(size: Int): Header
    ..
    + recordOf(header, values): Record
    ..
    + tableOf(header, records): Table
    + tableOf(rows): Table
}
@enduml
</code></pre>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-2");
</script>
</section><section>
<h2 id="the-csvkt-file">The <code>Csv.kt</code> file</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Headers creation from columns names
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">headerOf</span>(columns: Iterable&lt;String&gt;): Header = DefaultHeader(columns)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">headerOf</span>(<span style="color:#080;font-weight:bold">vararg</span> columns: String): Header = headerOf(columns.asIterable())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Creates anonymous headers, with columns named after their index
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">anonymousHeader</span>(size: Int): Header = headerOf((<span style="color:#00d;font-weight:bold">0</span> ..&lt; size).map { <span style="color:#080;font-weight:bold">it</span>.toString() })
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Records creation from header and values
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">recordOf</span>(header: Header, columns: Iterable&lt;String&gt;): Record = DefaultRecord(header, columns)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">recordOf</span>(header: Header, <span style="color:#080;font-weight:bold">vararg</span> columns: String): Record = recordOf(header, columns.asIterable())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Tables creation from header and records
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">tableOf</span>(header: Header, records: Iterable&lt;Record&gt;): Table = DefaultTable(header, records)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">tableOf</span>(header: Header, <span style="color:#080;font-weight:bold">vararg</span> records: Record): Table = tableOf(header, records.asIterable())
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Tables creation from rows (anonymous header if none is provided)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">tableOf</span>(rows: Iterable&lt;Row&gt;): Table {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">records</span> = mutableListOf&lt;Record&gt;()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">header</span>: Header? = <span style="color:#080;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">for</span> (row <span style="color:#080;font-weight:bold">in</span> rows) {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">when</span> (row) {
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">is</span> Header -&gt; header = row
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">is</span> Record -&gt; records.add(row)
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    require(header != <span style="color:#080;font-weight:bold">null</span> || records.isNotEmpty())
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> tableOf(header ?: anonymousHeader(records[<span style="color:#00d;font-weight:bold">0</span>].size), records)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>Notice that each factory method is <strong>overloaded</strong>
<ul>
<li>to support both <code>Iterable</code> and <code>vararg</code> arguments</li>
<li>this is convenient for Kotlin programmers that will use our library</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="time-for-unit-testing">Time for unit testing</h2>
<ul>
<li>
<p>Dummy instances object:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">object</span> <span style="color:#b06;font-weight:bold">Tables</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">irisShortHeader</span> = headerOf(<span style="color:#d20;background-color:#fff0f0">"sepal_length"</span>, <span style="color:#d20;background-color:#fff0f0">"sepal_width"</span>, <span style="color:#d20;background-color:#fff0f0">"petal_length"</span>, <span style="color:#d20;background-color:#fff0f0">"petal_width"</span>, <span style="color:#d20;background-color:#fff0f0">"class"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">irisLongHeader</span> = headerOf(<span style="color:#d20;background-color:#fff0f0">"sepal length in cm"</span>, <span style="color:#d20;background-color:#fff0f0">"sepal width, in cm"</span>, <span style="color:#d20;background-color:#fff0f0">"petal length"</span>, <span style="color:#d20;background-color:#fff0f0">"petal width"</span>, <span style="color:#d20;background-color:#fff0f0">"class"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">iris</span>(header: Header): Table = tableOf(
</span></span><span style="display:flex;"><span>        header,
</span></span><span style="display:flex;"><span>        recordOf(header, <span style="color:#d20;background-color:#fff0f0">"5.1"</span>, <span style="color:#d20;background-color:#fff0f0">"3.5"</span>, <span style="color:#d20;background-color:#fff0f0">"1.4"</span>, <span style="color:#d20;background-color:#fff0f0">"0.2"</span>, <span style="color:#d20;background-color:#fff0f0">"Iris-setosa"</span>),
</span></span><span style="display:flex;"><span>        recordOf(header, <span style="color:#d20;background-color:#fff0f0">"4.9"</span>, <span style="color:#d20;background-color:#fff0f0">"3.0"</span>, <span style="color:#d20;background-color:#fff0f0">"1.4"</span>, <span style="color:#d20;background-color:#fff0f0">"0.2"</span>, <span style="color:#d20;background-color:#fff0f0">"Iris-setosa"</span>),
</span></span><span style="display:flex;"><span>        recordOf(header, <span style="color:#d20;background-color:#fff0f0">"4.7"</span>, <span style="color:#d20;background-color:#fff0f0">"3.2"</span>, <span style="color:#d20;background-color:#fff0f0">"1.3"</span>, <span style="color:#d20;background-color:#fff0f0">"0.2"</span>, <span style="color:#d20;background-color:#fff0f0">"Iris-setosa"</span>)
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>Some basic tests in file <code>TestCSV.kt</code>, e.g. (bad way of writing test methods, don’t do this at home)</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">recordBasics</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">record</span> = <span style="color:#b06;font-weight:bold">Tables</span>.iris(<span style="color:#b06;font-weight:bold">Tables</span>.irisShortHeader).records[<span style="color:#00d;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#d20;background-color:#fff0f0">"5.1"</span>, record[<span style="color:#00d;font-weight:bold">0</span>])
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#d20;background-color:#fff0f0">"5.1"</span>, record[<span style="color:#d20;background-color:#fff0f0">"sepal_length"</span>])
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#d20;background-color:#fff0f0">"0.2"</span>, record[<span style="color:#00d;font-weight:bold">3</span>])
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#d20;background-color:#fff0f0">"0.2"</span>, record[<span style="color:#d20;background-color:#fff0f0">"petal_width"</span>])
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#d20;background-color:#fff0f0">"Iris-setosa"</span>, record[<span style="color:#00d;font-weight:bold">4</span>])
</span></span><span style="display:flex;"><span>    assertEquals(<span style="color:#d20;background-color:#fff0f0">"Iris-setosa"</span>, record[<span style="color:#d20;background-color:#fff0f0">"class"</span>])
</span></span><span style="display:flex;"><span>    assertFailsWith&lt;IndexOutOfBoundsException&gt; { record[<span style="color:#00d;font-weight:bold">5</span>] }
</span></span><span style="display:flex;"><span>    assertFailsWith&lt;NoSuchElementException&gt; { record[<span style="color:#d20;background-color:#fff0f0">"missing"</span>] }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>Run tests via Gradle task <code>test</code> (also try to run tests for specific platforms, e.g. <code>jvmTest</code> or <code>jsTest</code>)</p>
</li>
</ul>
</section><section>
<h2 id="summary-of-what-we-did-so-far">Summary of what we did so far</h2>
<ol>
<li>
<p>We designed a set of domain entities</p>
<ul>
<li><code>Row</code>, <code>Header</code>, <code>Record</code>, <code>Table</code></li>
<li>we provided a set of factory methods for creating instances of those entities</li>
</ul>
</li>
<li>
<p>We implemented the domain entities as common code</p>
</li>
<li>
<p>We wrote some unit tests for the domain entities</p>
<ul>
<li>again as common code</li>
</ul>
</li>
<li>
<p>Let’s focus now on more complex functionalities</p>
<ul>
<li>e.g. parsing a CSV file into a <code>Table</code></li>
<li>e.g. saving a <code>Table</code> into a CSV file</li>
<li>all such features require I/O functionalities</li>
</ul>
</li>
</ol>
<blockquote>
<p>I/O is platform-specific, hence we need platform-specific code</p>
</blockquote>
</section><section>
<h2 id="how-much-platform-specific-code-is-needed">How much platform-specific code is needed?</h2>
<ul>
<li>
<p>I/O functionalities are supported by fairly different API in JVM and JS</p>
<ul>
<li>e.g. JVM’s <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/package-summary.html"><code>java.io</code> package</a> vs. JS’ <a href="https://nodejs.org/docs/latest-v20.x/api/fs.html"><code>fs</code> module</a></li>
<li>sadly, Kotlin std-lib does not provide a common API for I/O</li>
</ul>
</li>
<li>
<p>Do we need to rewrite the same business logic twice? (once for JVM, once for JS)</p>
<ul>
<li>yes, but we can minimise the amount of code to be rewritten</li>
</ul>
</li>
<li>
<p>Let’s try to decompose the problem as follows:</p>
<ul>
<li>parsing CSV into <code>Table</code>: file $\rightarrow$ string(s) $\rightarrow$ <code>Table</code></li>
<li>saving <code>Table</code> as CSV file: <code>Table</code> $\rightarrow$ string(s) $\rightarrow$ file</li>
</ul>
</li>
<li>
<p>Remarks:</p>
<ol>
<li>only the “file $\leftrightarrow$ string(s)” part is platform-specific</li>
<li>conversely, the “string(s) $\leftrightarrow$ <code>Table</code>” part is platform-agnostic
<ul>
<li>let’s realise this one first, as common code</li>
</ul>
</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="three-more-entities-to-be-modelled">Three more entities to be modelled</h2>
<ul>
<li>
<p><code>Configuration</code>: set of characters to be used to parse / represent CSV files</p>
<ul>
<li>e.g. separator, delimiter, comment, etc.</li>
</ul>
</li>
<li>
<p><code>Formatter</code>: converts <code>Rows</code> into strings, according to some <code>Configuration</code></p>
</li>
<li>
<p><code>Parser</code>: converts some source into a <code>Table</code>, according to some <code>Configuration</code></p>
<ul>
<li>source $\approx$ anything that can be interpreted as a string to be parsed (e.g. file, string, etc.)</li>
</ul>
</li>
</ul>
<figure id="plantuml-figure-3" class="plantuml" alt="" style="width: 35%;max-width: 95vw;max-height: 80vh;">
<p>@startuml
skinparam monochrome false</p>
<p>package “io github gciatto csv” {</p>
<pre><code>class Configuration {
    + separator: Char
    + delimiter: Char
    + comment: Char
    --
    + isComment(string: String): Boolean
    + isRecord(string: String): Boolean
    + isHeader(string: String): Boolean
    ..
    + getComment(string: String): String?
    + getFields(string: String): List&lt;String&gt;
    + getColumnNames(string: String): List&lt;String&gt;
}

interface Formatter {
    + source: Iterable&lt;Row&gt;
    + configuration: Configuration
    + format(): Iterable&lt;String&gt;
}

interface Parser {
    + source: Any
    + configuration: Configuration
    + parse(): Iterable&lt;Row&gt;
}

Formatter "1" o-- "1" Configuration
Parser "1" o-- "1" Configuration
</code></pre>
<p>}
@enduml</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-3");
</script>
</section><section>
<h2 id="the-configuration-class">The <code>Configuration</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">data</span> <span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">Configuration</span>(<span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">separator</span>: Char, <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">delimiter</span>: Char, <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">comment</span>: Char) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Checks whether the given string is a comment (i.e. starts with the comment character).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">isComment</span>(string: String): Boolean = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Gets the content of the comment line (i.e. removes the initial comment character).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">getComment</span>(string: String): String? = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Checks whether the given string is a record (i.e. it contains the delimiter character)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">isRecord</span>(string: String): Boolean = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Retrieves the fields in the given record (i.e. splits the string at the separator character)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">getFields</span>(string: String): List&lt;String&gt; = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Checks whether the given string is a header (i.e. simultaneously a record and a comment)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">isHeader</span>(string: String): Boolean = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Retrieves the column names in the given header
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">getColumnNames</span>(string: String): List&lt;String&gt; = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div><ul>
<li>implementation of methods is long and boring, but straightforward
<ul>
<li>it relies on regular expressions, which are supported by Kotlin’s common std-lib</li>
<li>details <a href="https://github.com/unibo-spe/multiplatform-example">here</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="the-formatter-interface">The <code>Formatter</code> interface</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">Formatter</span> {
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#888">// The source of this formatter (i.e. the rows to be formatted).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">source</span>: Iterable&lt;Row&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// The configuration of this formatter (i.e. the characters to be used).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">configuration</span>: Configuration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Formats the source of this formatter into a sequence of strings (one per each row in the source)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">format</span>(): Iterable&lt;String&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-parser-interface">The <code>Parser</code> interface</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">Parser</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// The source to be parsed by this parser (must be interpretable as string)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">source</span>: Any
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// The configuration of this parser (i.e. the characters to be used).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">configuration</span>: Configuration
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Parses the source of this parser into a sequence of rows (one per each row in the source)
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">parse</span>(): Iterable&lt;Row&gt;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="common-implementation-of-novel-entities">Common implementation of novel entities</h2>
<figure id="plantuml-figure-4" class="plantuml" alt="" style="width: 100%;max-width: 95vw;max-height: 80vh;">
<p>@startuml
skinparam monochrome false</p>
<p>package “io github gciatto csv impl” {</p>
<pre><code>class Configuration
interface Formatter
interface Parser

DefaultFormatter "1" o-- "1" Configuration
AbstractParser "1" o-- "1" Configuration

class DefaultFormatter {
    + constructor(source: Iterable&lt;Row&gt;, configuration: Configuration)
    - formatRow(row: Row): String
    - formatAsHeader(row: Row): String
    - formatAsRecord(row: Row): String
}

Formatter &lt;|-- DefaultFormatter

abstract class AbstractParser {
    # constructor(source: Any, configuration: Configuration)
    # beforeParsing()
    # afterParsing()
    # {abstract} sourceAsLines(): Sequence&lt;String&gt;
}

Parser &lt;|-- AbstractParser

class StringParser {
    + source: String
    + constructor(source: String, configuration: Configuration)
    + sourceAsLines(): Sequence&lt;String&gt;
}

AbstractParser &lt;|-- StringParser
</code></pre>
<p>}
@enduml</p>
</figure>
<script>
    handlePlantumlFigureByID("plantuml-figure-4");
</script>
</section><section>
<h2 id="the-defaultformatter-class">The <code>DefaultFormatter</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">DefaultFormatter</span>(<span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">source</span>: Iterable&lt;Row&gt;, <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">configuration</span>: Configuration) : Formatter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Lazily converts each row from the source into a string, according to the configuration.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">format</span>(): Iterable&lt;String&gt; = source.asSequence().map(<span style="color:#080;font-weight:bold">this</span>::formatRow).asIterable()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Converts the given row into a string, according to the configuration.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">formatRow</span>(row: Row): String = <span style="color:#080;font-weight:bold">when</span> (row) {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">is</span> Header -&gt; formatAsHeader(row)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">else</span> -&gt; formatAsRecord(row)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Formats the given row as a header (putting the comment character at the beginning).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">formatAsHeader</span>(row: Row): String = <span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#33b;background-color:#fff0f0">${configuration.comment}</span><span style="color:#d20;background-color:#fff0f0"> </span><span style="color:#33b;background-color:#fff0f0">${formatAsRecord(row)}</span><span style="color:#d20;background-color:#fff0f0">"</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Formats the given row as a record (using the separator and delimiter characters accordingly).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">formatAsRecord</span>(row: Row): String =
</span></span><span style="display:flex;"><span>        row.joinToString(<span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#33b;background-color:#fff0f0">${configuration.separator}</span><span style="color:#d20;background-color:#fff0f0"> "</span>) {
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">delimiter</span> = configuration.delimiter
</span></span><span style="display:flex;"><span>            <span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#33b;background-color:#fff0f0">$delimiter$it$delimiter</span><span style="color:#d20;background-color:#fff0f0">"</span>
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-abstractparser-class">The <code>AbstractParser</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">AbstractParser</span>(<span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">source</span>: Any, <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">configuration</span>: Configuration) : Parser {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Empty methods to be overridden by sub-classes to initialize/finalise parsing.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">protected</span> <span style="color:#080;font-weight:bold">open</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">beforeParsing</span>() { <span style="color:#888">/* does nothing by default */</span> }
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">protected</span> <span style="color:#080;font-weight:bold">open</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">afterParsing</span>() { <span style="color:#888">/* does nothing by default */</span> }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Template method that parses the source into a sequence of strings (one per line).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">protected</span> <span style="color:#080;font-weight:bold">abstract</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">sourceAsLines</span>(): Sequence&lt;String&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Parses the source into a sequence of rows (skipping comments, looking for at most 1 header).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">parse</span>(): Iterable&lt;Row&gt; = sequence {
</span></span><span style="display:flex;"><span>        beforeParsing()
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">header</span>: Header? = <span style="color:#080;font-weight:bold">null</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">i</span> = <span style="color:#00d;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">for</span> (line <span style="color:#080;font-weight:bold">in</span> sourceAsLines()) {
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">if</span> (line.isBlank()) {
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (configuration.isHeader(line)) {
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">if</span> (header == <span style="color:#080;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    header = headerOf(configuration.getColumnNames(line))
</span></span><span style="display:flex;"><span>                    yield(header)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (configuration.isComment(line)) {
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">continue</span>
</span></span><span style="display:flex;"><span>            } <span style="color:#080;font-weight:bold">else</span> <span style="color:#080;font-weight:bold">if</span> (configuration.isRecord(line)) {
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">fields</span> = configuration.getFields(line)
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">if</span> (header == <span style="color:#080;font-weight:bold">null</span>) {
</span></span><span style="display:flex;"><span>                    header = anonymousHeader(fields.size)
</span></span><span style="display:flex;"><span>                    yield(header)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">try</span> {
</span></span><span style="display:flex;"><span>                    yield(recordOf(header, fields))
</span></span><span style="display:flex;"><span>                } <span style="color:#080;font-weight:bold">catch</span> (e: IllegalArgumentException) {
</span></span><span style="display:flex;"><span>                    <span style="color:#080;font-weight:bold">throw</span> IllegalStateException(<span style="color:#d20;background-color:#fff0f0">"Invalid CSV at line </span><span style="color:#33b;background-color:#fff0f0">$i</span><span style="color:#d20;background-color:#fff0f0">: </span><span style="color:#33b;background-color:#fff0f0">$line</span><span style="color:#d20;background-color:#fff0f0">"</span>, e)
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#080;font-weight:bold">else</span> {
</span></span><span style="display:flex;"><span>                error(<span style="color:#d20;background-color:#fff0f0">"Invalid CSV line at </span><span style="color:#33b;background-color:#fff0f0">$i</span><span style="color:#d20;background-color:#fff0f0">: </span><span style="color:#33b;background-color:#fff0f0">$line</span><span style="color:#d20;background-color:#fff0f0">"</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            i++
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        afterParsing()
</span></span><span style="display:flex;"><span>    }.asIterable()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="the-stringparser-class">The <code>StringParser</code> class</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">StringParser</span>(<span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">source</span>: String, configuration: Configuration) 
</span></span><span style="display:flex;"><span>    : AbstractParser(source, configuration) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Splits the source string into lines.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">sourceAsLines</span>(): Sequence&lt;String&gt; = source.lineSequence()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></section><section>
<h2 id="providing-functionalities-via-extension-methods">Providing functionalities via extension methods</h2>
<ul>
<li>
<p>Additions to the <code>Csv.kt</code> file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">DEFAULT</span>_SEPARATOR = <span style="color:#d20;background-color:#fff0f0">','</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">DEFAULT</span>_DELIMITER = <span style="color:#d20;background-color:#fff0f0">'"'</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">const</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">DEFAULT</span>_COMMENT = <span style="color:#d20;background-color:#fff0f0">'#'</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Converts the current container of rows into a CSV string, using the given characters.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">Iterable</span>&lt;Row&gt;.formatAsCSV(
</span></span><span style="display:flex;"><span>    separator: Char = DEFAULT_SEPARATOR,
</span></span><span style="display:flex;"><span>    delimiter: Char = DEFAULT_DELIMITER,
</span></span><span style="display:flex;"><span>    comment: Char = DEFAULT_COMMENT
</span></span><span style="display:flex;"><span>): String = DefaultFormatter(<span style="color:#080;font-weight:bold">this</span>, Configuration(separator, delimiter, comment)).format().joinToString(<span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#04d;background-color:#fff0f0">\n</span><span style="color:#d20;background-color:#fff0f0">"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Parses the current CSV string into a table, using the given characters.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">String</span>.parseAsCSV(
</span></span><span style="display:flex;"><span>    separator: Char = DEFAULT_SEPARATOR,
</span></span><span style="display:flex;"><span>    delimiter: Char = DEFAULT_DELIMITER,
</span></span><span style="display:flex;"><span>    comment: Char = DEFAULT_COMMENT
</span></span><span style="display:flex;"><span>): Table = StringParser(<span style="color:#080;font-weight:bold">this</span>, Configuration(separator, delimiter, comment)).parse().let(::tableOf)
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="unit-tests-and-usage-examples-pt-1">Unit tests and usage examples (pt. 1)</h2>
<ul>
<li>Dummy instances for testing:
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">object</span> <span style="color:#b06;font-weight:bold">CsvStrings</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">iris</span>: String = <span style="color:#d20;background-color:#fff0f0">"""
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |# sepal_length, sepal_width, petal_length, petal_width, class
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |5.1,3.5,1.4,0.2,Iris-setosa
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |4.9,3.0,1.4,0.2,Iris-setosa
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |4.7,3.2,1.3,0.2,Iris-setosa
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    """</span>.trimMargin()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">irisWellFormatted</span>: String = <span style="color:#d20;background-color:#fff0f0">"""
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |# "sepal_length", "sepal_width", "petal_length", "petal_width", "class"
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |"5.1", "3.5", "1.4", "0.2", "Iris-setosa"
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |"4.9", "3.0", "1.4", "0.2", "Iris-setosa"
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    |"4.7", "3.2", "1.3", "0.2", "Iris-setosa"
</span></span></span><span style="display:flex;"><span><span style="color:#d20;background-color:#fff0f0">    """</span>.trimMargin()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// other dummy constants here
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="unit-tests-and-usage-examples-pt-2">Unit tests and usage examples (pt. 2)</h2>
<ul>
<li>
<p>Tests involving parsing be like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">parsingFromCleanString</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">parsed</span>: Table = <span style="color:#b06;font-weight:bold">CsvStrings</span>.iris.parseAsCSV()
</span></span><span style="display:flex;"><span>    assertEquals(
</span></span><span style="display:flex;"><span>        expected = <span style="color:#b06;font-weight:bold">Tables</span>.iris(<span style="color:#b06;font-weight:bold">Tables</span>.irisShortHeader),
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">actual</span> = parsed
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>Tests involving formatting be like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">formattingToString</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">iris</span>: Table = <span style="color:#b06;font-weight:bold">Tables</span>.iris(<span style="color:#b06;font-weight:bold">Tables</span>.irisShortHeader)
</span></span><span style="display:flex;"><span>    assertEquals(
</span></span><span style="display:flex;"><span>        expected = <span style="color:#b06;font-weight:bold">CsvStrings</span>.irisWellFormatted,
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">actual</span> = iris.formatAsCSV()
</span></span><span style="display:flex;"><span>    )
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="time-to-go-platform-specific">Time to go platform-specific</h2>
<ul>
<li>
<p>Further additions to the <code>Csv.kt</code> file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Reads and parses a CSV file from the given path, using the given characters.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">expect</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">parseCsvFile</span>(
</span></span><span style="display:flex;"><span>    path: String,
</span></span><span style="display:flex;"><span>    separator: Char = DEFAULT_SEPARATOR,
</span></span><span style="display:flex;"><span>    delimiter: Char = DEFAULT_DELIMITER,
</span></span><span style="display:flex;"><span>    comment: Char = DEFAULT_COMMENT
</span></span><span style="display:flex;"><span>): Table
</span></span></code></pre></div><ul>
<li>notice the <code>expect</code> keyword, and the the lack of function body</li>
<li>we’re just declaring the signature of a platform-specific function</li>
<li>there is no type for representing paths is Kotlin’s common std-lib
<ul>
<li>hence we’re using <code>String</code> as a platform-agnostic representation of paths
<ul>
<li>this is suboptimal choice</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="time-to-go-platform-specific-on-the-jvm-pt-1">Time to go platform-specific on the JVM (pt. 1)</h2>
<ul>
<li>
<p>I/O (over textual files) is mainly supported by means of the following classes:</p>
<ul>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/File.html"><code>java.io.File</code></a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/BufferedReader.html"><code>java.io.BufferedReader</code></a></li>
<li><a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/BufferedWriter.html"><code>java.io.BufferedWriter</code></a></li>
</ul>
</li>
<li>
<p>Buffered readers support reading a file <strong>line-by-line</strong></p>
</li>
<li>
<p>On Kotlin/JVM, Java’s std-lib is available as Kotlin’s std-lib</p>
<ul>
<li>hence, we may use Java’s std-lib directly</li>
<li>the abstraction gap is close to 0</li>
</ul>
</li>
<li>
<p>We may simply create a new sub-type of <code>AbstractParser</code></p>
<ul>
<li>using <code>File</code>s as sources</li>
<li>creating a <code>BufferedReader</code> behind the scenes to read files line-by-line</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="time-to-go-platform-specific-on-the-jvm-pt-2">Time to go platform-specific on the JVM (pt. 2)</h2>
<p>In the <code>jvmMain</code> source set</p>
<ul>
<li>
<p>let’s define the following JVM-specific class:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">FileParser</span>(
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">source</span>: File, <span style="color:#888">// source is now forced to be a File
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    configuration: Configuration
</span></span><span style="display:flex;"><span>) : AbstractParser(source, configuration) {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Lately initialised reader, corresponding to source
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">lateinit</span> <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">reader</span>: BufferedReader
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Opens the source file, hence initialising the reader, before each parsing
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">beforeParsing</span>() { reader = source.bufferedReader() }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Closes the reader, after each parsing
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">afterParsing</span>() { reader.close() }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Lazily reads the source file line-by-line
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">override</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">sourceAsLines</span>(): Sequence&lt;String&gt; = reader.lines().asSequence()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>let’s create the <code>Csv.jvm.kt</code> file containing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">actual</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">parseCsvFile</span>(
</span></span><span style="display:flex;"><span>    path: String,
</span></span><span style="display:flex;"><span>    separator: Char,
</span></span><span style="display:flex;"><span>    delimiter: Char,
</span></span><span style="display:flex;"><span>    comment: Char
</span></span><span style="display:flex;"><span>): Table = FileParser(File(path), Configuration(separator, delimiter, comment)).parse().let(::tableOf)
</span></span></code></pre></div><ul>
<li>this is how the <code>parseCsvFile</code> is implemented <strong>on the JVM</strong></li>
<li>notice the <code>actual</code> keyword, and the presence of a function body</li>
<li>notice the usage of <code>FileParser</code> in the function body
<ul>
<li>class <code>FileParser</code> is internal class for filling the abstraction gap on the JVM</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="time-to-go-platform-specific-on-the-js-pt-1">Time to go platform-specific on the JS (pt. 1)</h2>
<ul>
<li>
<p>I/O (over textual files) is mainly supported by means of the following things:</p>
<ul>
<li>the <a href="https://nodejs.org/docs/latest-v20.x/api/fs.html"><code>fs</code> module</a></li>
<li>the <a href="https://nodejs.org/api/fs.html#fsreadfilesyncpath-options"><code>fs.readFileSync</code> function</a></li>
<li>the <a href="https://nodejs.org/api/fs.html#fswritefilesyncfile-data-options"><code>fs.writeFileSync</code> function</a></li>
</ul>
</li>
<li>
<p>These function supports reading / writing a file <strong>in one shot</strong></p>
<ul>
<li>i.e. they return / generate the <em>whole</em> content of the file as a string</li>
<li>quite inefficient if the file is big</li>
</ul>
</li>
<li>
<p>On Kotlin/JS, Node’s std-lib is <strong>not</strong> directly available</p>
<ul>
<li>one must instruct the compiler about
<ol>
<li><strong>where</strong> to look up for std-lib function (module name)</li>
<li><strong>how</strong> to map JS functions to Kotlin functions (<code>external</code> declarations)</li>
</ol>
</li>
<li>the abstraction gap is non-negligible</li>
</ul>
</li>
<li>
<p>To-do list for Kotlin/JS:</p>
<ol>
<li>create <code>external</code> declarations for the Node’s std-lib functions to be used</li>
<li>implement JS-specific code via the <code>StringParser</code> (after reading the whole file)</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="time-to-go-platform-specific-on-the-js-pt-2">Time to go platform-specific on the JS (pt. 2)</h2>
<p>In the <code>jsMain</code> source set</p>
<ol>
<li>
<p>let’s create the <code>NodeFs.kt</code> file (containing <code>external</code> declarations for the <code>fs</code> module):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@file</span>:JsModule(<span style="color:#d20;background-color:#fff0f0">"fs"</span>)
</span></span><span style="display:flex;"><span><span style="color:#555">@file</span>:JsNonModule
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">package</span> <span style="color:#b06;font-weight:bold">io.github.gciatto.csv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Kotlin mapping for: https://nodejs.org/api/fs.html#fsreadfilesyncpath-options
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">external</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">readFileSync</span>(path: String, options: <span style="color:#080;font-weight:bold">dynamic</span> = definedExternally): String
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// Kotlin mapping for: https://nodejs.org/api/fs.html#fswritefilesyncfile-data-options
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">external</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">writeFileSync</span>(<span style="color:#080;font-weight:bold">file</span>: String, <span style="color:#080;font-weight:bold">data</span>: String, options: <span style="color:#080;font-weight:bold">dynamic</span> = definedExternally)
</span></span></code></pre></div><ul>
<li>the <code>@JsModule</code> annotation instructs the compiler about where to look up for the <code>fs</code> module</li>
<li><code>external</code> declarations are Kotlin signatures of JS function</li>
<li><code>dynamic</code> is a special type that can be used to represent any JS object
<ul>
<li>it overrides Kotlin’s type system, hence it should be used with care</li>
<li>it prevents developers from declaring too much <code>external</code> stuff</li>
<li>good to use when the JS API is not known in advance or uses union types</li>
</ul>
</li>
<li><code>definedExternally</code> is stating that a parameter is optional (default value is defined in JS)</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="time-to-go-platform-specific-on-the-js-pt-3">Time to go platform-specific on the JS (pt. 3)</h2>
<ol start="2">
<li>
<p>let’s create the <code>Csv.js.kt</code> file containing:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">actual</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">parseCsvFile</span>(
</span></span><span style="display:flex;"><span>    path: String,
</span></span><span style="display:flex;"><span>    separator: Char,
</span></span><span style="display:flex;"><span>    delimiter: Char,
</span></span><span style="display:flex;"><span>    comment: Char
</span></span><span style="display:flex;"><span>): Table = readFileSync(path, js(<span style="color:#d20;background-color:#fff0f0">"{encoding: 'utf8'}"</span>)).parseAsCSV(separator, delimiter, comment)
</span></span></code></pre></div><ul>
<li>this is how the <code>parseCsvFile</code> is implemented <strong>on JS</strong></li>
<li>notice the <code>actual</code> keyword, and the presence of a function body</li>
<li>notice the usage of <code>readFileSync</code> to read a file as a string in one shot</li>
<li>notice the exploitation of common code for parsing the string into a <code>Table</code> (namely, <code>parseAsCSV</code>)</li>
<li>notice the <code>js("...")</code> magic function
<ul>
<li>it allows to write JS code directly in Kotlin</li>
<li>the provided string should contain bare JS code, the compiler will output “as-is”</li>
<li>it’s a way to fill the abstraction gap on JS</li>
<li>we use it to create a JS object on the fly, to provide optional parameters to <code>readFileSync</code></li>
</ul>
</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="platform-agnostic-testing-strategy">Platform-agnostic testing (strategy)</h2>
<ul>
<li>
<p>We may test our CSV library in common-code</p>
<ul>
<li>so as to avoid repeating testing code</li>
</ul>
</li>
<li>
<p>The test suite may:</p>
<ol>
<li>create temporary files with known paths, containing known CSV data</li>
<li>read those paths, and parse them as CSV</li>
<li>assert that the parsed tables are as expected</li>
</ol>
</li>
<li>
<p>The hard part is <strong>step 1</strong>: two platform-specific steps</p>
<ol>
<li>discovering the temp directory of the current system</li>
<li>writing a file</li>
</ol>
</li>
</ul>
</section><section>
<h2 id="multi-platform-testing-preliminaries">Multi-platform testing (preliminaries)</h2>
<ul>
<li>
<p>file <code>Utils.kt</code> in <code>commonTest</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// Creates a temporary file with the given name, extension, and content, and returns its path.
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">expect</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">createTempFile</span>(name: String, extension: String, content: String): String
</span></span></code></pre></div><p>notice the <code>expect</code>ed function</p>
</li>
<li>
<p>file <code>Utils.jvm.kt</code> in <code>jvmTest</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">java.io.File</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">actual</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">createTempFile</span>(name: String, extension: String, content: String): String
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">file</span> = <span style="color:#b06;font-weight:bold">File</span>.createTempFile(name, extension)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">file</span>.writeText(content)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">file</span>.absolutePath
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>cf. documentation of method <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/File.html#createTempFile(java.lang.String,java.lang.String)"><code>File.createTempFile</code></a></li>
</ul>
</li>
<li>
<p>file <code>Utils.js.kt</code> in <code>jsTest</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">Math</span>: <span style="color:#080;font-weight:bold">dynamic</span> <span style="color:#080;font-weight:bold">by</span> lazy { js(<span style="color:#d20;background-color:#fff0f0">"Math"</span>) }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JsModule</span>(<span style="color:#d20;background-color:#fff0f0">"os"</span>) <span style="color:#555">@JsNonModule</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">external</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">tmpdir</span>(): String
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">actual</span> <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">createTempFile</span>(name: String, extension: String, content: String): String {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">tag</span> = <span style="color:#b06;font-weight:bold">Math</span>.random().toString().replace(<span style="color:#d20;background-color:#fff0f0">"."</span>, <span style="color:#d20;background-color:#fff0f0">""</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">path</span> = <span style="color:#d20;background-color:#fff0f0">"</span><span style="color:#33b;background-color:#fff0f0">$tmpDirectory</span><span style="color:#d20;background-color:#fff0f0">/</span><span style="color:#33b;background-color:#fff0f0">$name</span><span style="color:#d20;background-color:#fff0f0">-</span><span style="color:#33b;background-color:#fff0f0">$tag</span><span style="color:#d20;background-color:#fff0f0">.</span><span style="color:#33b;background-color:#fff0f0">$extension</span><span style="color:#d20;background-color:#fff0f0">"</span>
</span></span><span style="display:flex;"><span>    writeFileSync(path, content)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> path
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ul>
<li>cf. documentation of <a href="https://nodejs.org/docs/latest-v20.x/api/os.html#ostmpdir"><code>os.tmpdir</code></a> and <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Math"><code>Math</code></a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="multi-platform-testing-actual-tests">Multi-platform testing (actual tests)</h2>
<ul>
<li>
<p>file <code>CsvFiles.kt</code> in <code>commonMain</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">object</span> <span style="color:#b06;font-weight:bold">CsvFiles</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Path of the temporary file containing the string CsvStrings.iris
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#888">// (file lazily created upon first usage).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">iris</span>: String <span style="color:#080;font-weight:bold">by</span> lazy { createTempFile(<span style="color:#d20;background-color:#fff0f0">"iris.csv"</span>, <span style="color:#b06;font-weight:bold">CsvStrings</span>.iris) }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// Path of the temporary file containing the string CsvStrings.irisWellFormatted
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#888">// (file lazily created upon first usage).
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">irisWellFormatted</span>: String <span style="color:#080;font-weight:bold">by</span> lazy {
</span></span><span style="display:flex;"><span>        createTempFile(<span style="color:#d20;background-color:#fff0f0">"irisWellFormatted.csv"</span>, <span style="color:#b06;font-weight:bold">CsvStrings</span>.irisWellFormatted)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888">// other paths here, corresponding to other constants in CsvStrings
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>}
</span></span></code></pre></div></li>
<li>
<p>tests for parsing be like:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@Test</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">testParseIris</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">parsedFromString</span> = <span style="color:#b06;font-weight:bold">CsvStrings</span>.iris.parseAsCSV()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">readFromFile</span> = parseCsvFile(<span style="color:#b06;font-weight:bold">CsvFiles</span>.iris)
</span></span><span style="display:flex;"><span>    assertEquals(parsedFromString, readFromFile)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ul>

</section>
</section><section>


<section data-shortcode-section="">
<h2 id="output-of-a-multi-platform-build">Output of a multi-platform build</h2>
<ul>
<li>
<p>Kotlin multi-platform projects can be assembled as JARs</p>
<ul>
<li>enabling importing the project as dependency in other multi-platform projects</li>
</ul>
</li>
<li>
<p>The <code>jvmMain</code> source set is compiled into a JVM-compliant JARs</p>
<ul>
<li>enabling importing the project as dependency in JVM projects</li>
<li>enabling the creation of runnable JARs</li>
<li>via the various <code>*Jar</code> or <code>assemble</code> tasks</li>
</ul>
</li>
<li>
<p>The <code>jsMain</code> source set is compiled into either</p>
<ul>
<li>a Kotlin library (<code>.klib</code>), enabling imporing the project tas dependency in Kotlin/JS projects
<ul>
<li>via the various <code>*Jar</code> or <code>assemble</code> tasks</li>
</ul>
</li>
<li>a NodeJS project
<ul>
<li>via the <code>compileProductionExecutableKotlinJs</code> task</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="output-of-jvm-compilation">Output of JVM compilation</h2>
<ul>
<li>
<p>Task for JVM-only compilation of re-usable packages: <code>jvmJar</code></p>
</li>
<li>
<p>Effect:</p>
<ol>
<li>compile the project as JVM bytecode</li>
<li>pack the bytecode into a JAR file</li>
<li>move the JAR file into <code>$PROJ_DIR/build/libs/$PROJ_NAME-jvm-$PROJ_VERSION</code></li>
</ol>
</li>
<li>
<p>The JAR does not contain dependencies</p>
</li>
<li>
<p>Ad-hoc Gradle plugins/code is needed for creating <a href="https://www.baeldung.com/gradle-fat-jar">fat Jar</a></p>
</li>
</ul>
</section><section>
<h2 id="output-of-js-compilation">Output of JS compilation</h2>
<ul>
<li>
<p>Task for JS-only compilation of re-usable packages: <code>compileProductionExecutableKotlinJs</code></p>
</li>
<li>
<p>Effect:</p>
<ol>
<li>Generate Node project into <code>$ROOT_PROJ_DIR/build/js/packages/$ROOT_PROJ_NAME-$PROJ_NAME</code>:
<ul>
<li>JS code</li>
<li><code>package.json</code> file</li>
</ul>
</li>
<li><a href="https://kotlinlang.org/docs/javascript-dce.html">Dead code elimination</a> (DCE) removing unused code
<ul>
<li>i.e. code not (indirectly) called by main</li>
</ul>
</li>
</ol>
</li>
<li>
<p>Support for packing as NPM package via the <a href="https://npm-publish.petuska.dev/3.4/"><code>npm-publish</code></a> Gradle plugin</p>
</li>
</ul>

</section>
</section><section>


<section data-shortcode-section="">
<h2 id="calling-kotlin-from-other-platforms">Calling Kotlin from other platforms</h2>
<ul>
<li>
<p>Kotlin code can be called from the target platforms’ main languages</p>
<ul>
<li>e.g. Java, JavaScript, etc.</li>
</ul>
</li>
<li>
<p>Understading the mapping among Kotlin and other languages is key</p>
<ul>
<li>it impacts the usability of Kotlin libraries for ordinary platform users</li>
</ul>
</li>
</ul>
<blockquote>
<p>How are Kotlin’s syntactical categories mapped to other platforms/languages?</p>
</blockquote>
<ul>
<li>the answer varies on a per-platform basis</li>
</ul>
</section><section>
<h2 id="kotlin--java-mapping-pt-1">Kotlin–Java Mapping (pt. 1)</h2>
<ul>
<li>Kotlin class $\equiv$ Java class</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyClass</span> {}
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">MyType</span> {}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyClass</span><span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">MyType</span><span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>No syntactical difference among primitive and reference types
<ul>
<li><code>Int</code> $\leftrightarrow$ <code>int</code> / <code>Integer</code>, <code>Short</code> $\leftrightarrow$ <code>short</code> / <code>Short</code>, etc.</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: Int = <span style="color:#00d;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">y</span>: Int? = <span style="color:#080;font-weight:bold">null</span>
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>Integer<span style="color:#bbb"> </span>y<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">null</span>;<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>Some Kotlin types are replaced by Java types at compile time
<ul>
<li>e.g. <code>Any</code> $\rightarrow$ <code>Object</code>, <code>kotlin.collections.List</code> $\rightarrow$ <code>java.util.List</code>, etc.</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: Any = <span style="color:#d20;background-color:#fff0f0">"ciao"</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">y</span>: kotlin.collections.List&lt;Int&gt; = listOf(<span style="color:#00d;font-weight:bold">1</span>, <span style="color:#00d;font-weight:bold">2</span>, <span style="color:#00d;font-weight:bold">3</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">z</span>: kotlin.collections.MutableList&lt;String&gt; = mutableListOf(<span style="color:#d20;background-color:#fff0f0">"a"</span>, <span style="color:#d20;background-color:#fff0f0">"b"</span>, <span style="color:#d20;background-color:#fff0f0">"c"</span>)
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>Object<span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"ciao"</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java.<span style="color:#369">util</span>.<span style="color:#369">List</span>&lt;Integer&gt;<span style="color:#bbb"> </span>y<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>java.<span style="color:#369">util</span>.<span style="color:#369">Arrays</span>.<span style="color:#369">asList</span>(1,<span style="color:#bbb"> </span>2,<span style="color:#bbb"> </span>3);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>java.<span style="color:#369">util</span>.<span style="color:#369">List</span>&lt;String&gt;<span style="color:#bbb"> </span>z<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>java.<span style="color:#369">util</span>.<span style="color:#369">List</span>.<span style="color:#369">of</span>(<span style="color:#d20;background-color:#fff0f0">"a"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"b"</span>,<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">"c"</span>);<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>Other Kotlin types are mapped to homonymous Java types</li>
</ul>
</section><section>
<h2 id="kotlin--java-mapping-pt-2">Kotlin–Java Mapping (pt. 2)</h2>
<ul>
<li>Kotlin properties are mapped to getter / setter methods</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">MyType</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: Int
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">y</span>: String
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">interface</span> <span style="color:#b06;font-weight:bold">MyType</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">getX</span>();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>String<span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">getY</span>();<span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">setY</span>(String<span style="color:#bbb"> </span>y);<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>… unless the <code>JvmField</code> annotation is adopted</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.jvm.JvmField</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#555">@JvmField</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: Int = <span style="color:#00d;font-weight:bold">0</span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@JvmField</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">var</span> <span style="color:#369;font-weight:bold">y</span>: String = <span style="color:#d20;background-color:#fff0f0">""</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>0;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span>String<span style="color:#bbb"> </span>y<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#d20;background-color:#fff0f0">""</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>Kotlin’s package functions in file <code>X.kt</code> are mapped to static methods of class <code>XKt</code></li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// file MyFile.kt
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">f</span>() {}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyFileKt</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>()<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>… unless the <code>JvmName</code> annotation is exploited</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@file</span>:JvmName(<span style="color:#d20;background-color:#fff0f0">"MyModule"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.jvm.JvmName</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">f</span>() {}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyModule</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>()<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--java-mapping-pt-3">Kotlin–Java Mapping (pt. 3)</h2>
<ul>
<li>Kotlin’s <code>object X</code> is mapped to Java class <code>X</code> with
<ul>
<li>private constructor</li>
<li>public static final field named <code>INSTANCE</code> to access</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">object</span> <span style="color:#b06;font-weight:bold">MySingleton</span> {}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MySingleton</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">MySingleton</span>()<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span>MySingleton<span style="color:#bbb"> </span>INSTANCE<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>MySingleton();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>Class <code>X</code>’s companion object is mapped to public static final field named <code>Companion</code> on class <code>X</code></li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">constructor</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">companion</span> <span style="color:#080;font-weight:bold">object</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">of</span>(): MyType = MyType()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// usage:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: MyType = <span style="color:#b06;font-weight:bold">MyType</span>.of()
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">MyType</span>()<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">Companion</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span>MyType<span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">of</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>MyType();<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">final</span><span style="color:#bbb"> </span>Companion<span style="color:#bbb"> </span>Companion<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>Companion();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// usage:</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>MyType<span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>MyType.<span style="color:#369">Companion</span>.<span style="color:#369">of</span>();<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--java-mapping-pt-4">Kotlin–Java Mapping (pt. 4)</h2>
<ul>
<li>Class <code>X</code>’s companion object’s member <code>M</code> tagged with <code>@JvmStatic</code> is mapped to static member <code>M</code> on class <code>X</code></li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.jvm.JvmStatic</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">constructor</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">companion</span> <span style="color:#080;font-weight:bold">object</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#555">@JvmStatic</span>
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">of</span>(): MyType = MyType()
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// usage:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: MyType = <span style="color:#b06;font-weight:bold">MyType</span>.of()
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span><span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">private</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">MyType</span>()<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">static</span><span style="color:#bbb"> </span>MyType<span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">of</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">return</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>MyType();<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// usage:</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>MyType<span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>MyType.<span style="color:#369">of</span>();<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>Kotlin’s variadic functions are mapped to Java’s variadic methods</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">f</span>(<span style="color:#080;font-weight:bold">vararg</span> xs: Int) {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">ys</span>: Array&lt;Int&gt; = xs
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>(<span style="color:#888;font-weight:bold">int</span>...<span style="color:#bbb"> </span>xs)<span style="color:#bbb"> </span>{<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">    </span>Integer[]<span style="color:#bbb"> </span>ys<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>xs;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>}<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>Kotlin’s extension methods are mapped to ordinary Java methods with one more argument</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span> { }
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">MyType</span>.myMethod() {}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888">// usage:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span> = MyType()
</span></span><span style="display:flex;"><span>x.myMethod() <span style="color:#888">// postfix
</span></span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span><span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#080;font-weight:bold">public</span><span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">myMethod</span>(MyType<span style="color:#bbb"> </span>self)<span style="color:#bbb"> </span>{}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// usage:</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>MyType<span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>MyType();<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>myMethod(x);<span style="color:#bbb"> </span><span style="color:#888">// prefix</span><span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--java-mapping-pt-5">Kotlin–Java Mapping (pt. 5)</h2>
<ul>
<li>practical consequence: usability of fluent chains, in Java, is suboptimal
<ul>
<li>e.g. <a href="https://kotlinlang.org/docs/sequences.html">sequence operations</a> are implemented as extension methods</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.sequences.*</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span> = (<span style="color:#00d;font-weight:bold">0</span> ..&lt; <span style="color:#00d;font-weight:bold">10</span>).asSequence() <span style="color:#888">// 0, 1, 2, ..., 9
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    .filter { <span style="color:#080;font-weight:bold">it</span> % <span style="color:#00d;font-weight:bold">2</span> == <span style="color:#00d;font-weight:bold">0</span> } <span style="color:#888">// 0, 2, 4, ..., 8
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    .map { <span style="color:#080;font-weight:bold">it</span> + <span style="color:#00d;font-weight:bold">1</span> } <span style="color:#888">// 1, 3, 5, ..., 9
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>    .sum() <span style="color:#888">// 25
</span></span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import static</span><span style="color:#bbb"> </span><span style="color:#b06;font-weight:bold">kotlin.sequences.SequencesKt.*</span>;<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>x<span style="color:#bbb"> </span>=<span style="color:#bbb"> </span>sumOfInt(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>map(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>filter(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>asSequence(<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                            </span><span style="color:#080;font-weight:bold">new</span><span style="color:#bbb"> </span>IntRange(0,<span style="color:#bbb"> </span>9).<span style="color:#369">iterator</span>()<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                    </span>it<span style="color:#bbb"> </span>-&gt;<span style="color:#bbb"> </span>it<span style="color:#bbb"> </span>%<span style="color:#bbb"> </span>2<span style="color:#bbb"> </span>==<span style="color:#bbb"> </span>0<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>),<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">                </span>it<span style="color:#bbb"> </span>-&gt;<span style="color:#bbb"> </span>it<span style="color:#bbb"> </span>+<span style="color:#bbb"> </span>1<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">            </span>)<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">        </span>);<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
<ul>
<li>optional arguments exist in Kotlin but they do not exist in Java</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">f</span>(a: Int = <span style="color:#00d;font-weight:bold">1</span>, b: Int = <span style="color:#00d;font-weight:bold">2</span>, c: Int = <span style="color:#00d;font-weight:bold">3</span>) = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#888">// usage:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>f(b = <span style="color:#00d;font-weight:bold">5</span>)
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>(<span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>a,<span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>b,<span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>c)<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#888">/* ... */</span><span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// usage:</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span>f(1,<span style="color:#bbb"> </span>5,<span style="color:#bbb"> </span>3);<span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--java-mapping-pt-6">Kotlin–Java Mapping (pt. 6)</h2>
<ul>
<li>practical consequence:
<ul>
<li>arguments are handy in Kotlin, but…</li>
<li>… they are painful to use in Java</li>
<li>mitigation strategy: use <code>@JvmOverloads</code> to generate overloaded methods for Java
<ul>
<li>sadly, the does not take into account all possible ordered combinations of arguments</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.jvm.JvmOverloads</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JvmOverloads</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">f</span>(a: Int = <span style="color:#00d;font-weight:bold">1</span>, b: Int = <span style="color:#00d;font-weight:bold">2</span>, c: Int = <span style="color:#00d;font-weight:bold">3</span>) = <span style="color:#888">// ...
</span></span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>(<span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>a,<span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>b,<span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>c)<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span><span style="color:#888">/* ... */</span><span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>(<span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>a,<span style="color:#bbb"> </span><span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>b)<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>f(a,<span style="color:#bbb"> </span>b,<span style="color:#bbb"> </span>3);<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>(<span style="color:#888;font-weight:bold">int</span><span style="color:#bbb"> </span>a)<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>f(a,<span style="color:#bbb"> </span>2,<span style="color:#bbb"> </span>3);<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888;font-weight:bold">void</span><span style="color:#bbb"> </span><span style="color:#06b;font-weight:bold">f</span>()<span style="color:#bbb"> </span>{<span style="color:#bbb"> </span>f(1,<span style="color:#bbb"> </span>2,<span style="color:#bbb"> </span>3);<span style="color:#bbb"> </span>}<span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// missing overloads:</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// void f(int a, int c) { f(a, 2, c); }</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// void f(int b, int c) { f(1, b, c); }</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// void f(int c) { f(1, 2, c); }</span><span style="color:#bbb">
</span></span></span><span style="display:flex;"><span><span style="color:#bbb"></span><span style="color:#888">// void f(int b) { f(1, b, 3); }</span><span style="color:#bbb">
</span></span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--java-mapping-example">Kotlin–Java Mapping Example</h2>
<ul>
<li>
<p>Compile our CSV lib and import it as a dependency in a novel Java library</p>
</li>
<li>
<p>Alternatively, add Java sources to the <code>jvmTest</code> source set, and use the library</p>
</li>
<li>
<p>Listen to the teacher presenting key points</p>
</li>
</ul>
</section><section>
<h2 id="kotlin--javascript-mapping-pt-1">Kotlin–JavaScript Mapping (pt. 1)</h2>
<blockquote>
<p><strong>Disclaimer</strong>: the generated JS code is not really meant to be read by humans</p>
</blockquote>
<ul>
<li>DCE will eliminate unused code
<ul>
<li>“unused” $\equiv$ “not explicitly labelled as exported”</li>
<li>code is exported by means of the <code>@JsExport</code> annotation
<ul>
<li>to be used on API types and functions</li>
<li>requires the <code>kotlin.js.ExperimentalJsExport</code> <strong>opt-in</strong></li>
</ul>
</li>
<li>not all syntactical constructs or types are currently exportable
<ul>
<li>you should ignore the warning explicitly</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@file</span>:Suppress(<span style="color:#d20;background-color:#fff0f0">"NON_EXPORTABLE_TYPE"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">package</span> <span style="color:#b06;font-weight:bold">my.package</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.js.JsExport</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">kotlin.js.JsName</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JsExport</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyType</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">nonExportableType</span>: Long
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JsExport</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">myFunction</span>() = <span style="color:#888">// ...
</span></span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> module = require(<span style="color:#d20;background-color:#fff0f0">"project-name"</span>);
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> MyType = module.my.<span style="color:#080;font-weight:bold">package</span>.MyType;
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> myFunction = module.my.<span style="color:#080;font-weight:bold">package</span>.myFunction;
</span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--javascript-mapping-pt-2">Kotlin–JavaScript Mapping (pt. 2)</h2>
<ul>
<li>Kotlin supports <strong>overloading</strong>, JS does not
<ul>
<li>class / interface members names are <strong>mengled</strong> to avoid clashes</li>
<li>the <code>@JsName</code> annotation can be used to control the name of a member
<ul>
<li>to be used on API types and functions</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">package</span> <span style="color:#b06;font-weight:bold">my.package</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JsName</span>(<span style="color:#d20;background-color:#fff0f0">"sumNumbers"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">sum</span>(<span style="color:#080;font-weight:bold">vararg</span> numbers: Int): Int = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JsName</span>(<span style="color:#d20;background-color:#fff0f0">"sumIterableOfNumbers"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">sum</span>(numbers: Iterable&lt;Int&gt;): Int = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#555">@JsName</span>(<span style="color:#d20;background-color:#fff0f0">"sumSequenceOfNumbers"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">sum</span>(numbers: Sequence&lt;Int&gt;): Int = <span style="color:#888">// ...
</span></span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> module = require(<span style="color:#d20;background-color:#fff0f0">"project-name"</span>);
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> sumNumbers = module.my.<span style="color:#080;font-weight:bold">package</span>.sumNumbers;
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> sumIterableOfNumbers = module.my.<span style="color:#080;font-weight:bold">package</span>.sumIterableOfNumbers;
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">var</span> sumSequenceOfNumbers = module.my.<span style="color:#080;font-weight:bold">package</span>.sumSequenceOfNumbers;
</span></span></code></pre></div>
</div>
</div>
<ul>
<li>Kotlin class $\equiv$ <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Objects/Object_prototypes">JS prototype</a></li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">MyClass</span>(<span style="color:#080;font-weight:bold">private</span> <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">argument</span>: String) {
</span></span><span style="display:flex;"><span>    <span style="color:#555">@JsName</span>(<span style="color:#d20;background-color:#fff0f0">"method"</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">method</span>(): String = argument + <span style="color:#d20;background-color:#fff0f0">"!"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">function</span> MyClass(argument) {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">this</span>.randomName_1 = argument
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>MyClass.prototype.method = <span style="color:#080;font-weight:bold">function</span> () {
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">this</span>.randomName_1 + <span style="color:#d20;background-color:#fff0f0">"!"</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div>
</div>
</div>
</section><section>
<h2 id="kotlin--javascript-mapping-pt-3">Kotlin–JavaScript Mapping (pt. 3)</h2>
<ul>
<li>Primitive type mappings are non-trivial (cf. <a href="https://kotlinlang.org/docs/js-to-kotlin-interop.html#kotlin-types-in-javascript">documentation</a>)
<ul>
<li>
<p>Kotlin numeric types, except for <code>kotlin.Long</code>, are mapped to JavaScript <code>Number</code></p>
</li>
<li>
<p><code>kotlin.Char</code> is mapped to JS <code>Number</code> representing character code.</p>
</li>
<li>
<p>Kotlin preserves overflow semantics for <code>kotlin.Int</code>, <code>kotlin.Byte</code>, <code>kotlin.Short</code>, <code>kotlin.Char</code> and <code>kotlin.Long</code></p>
</li>
<li>
<p><code>kotlin.Long</code> is not mapped to any JS object, as there is no 64-bit integer number type in JS. It is emulated by a Kotlin class</p>
</li>
<li>
<p><code>kotlin.String</code> is mapped to JS <code>String</code></p>
</li>
<li>
<p><code>kotlin.Any</code> is mapped to JS <code>Object</code> (<code>new Object()</code>, <code>{}</code>, and so on)</p>
</li>
<li>
<p><code>kotlin.Array</code> is mapped to JS <code>Array</code></p>
</li>
<li>
<p>Kotlin collections (<code>List</code>, <code>Set</code>, <code>Map</code>, and so on) are not mapped to any specific JS type</p>
</li>
<li>
<p><code>kotlin.Throwable</code> is mapped to JS <code>Error</code></p>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin--javascript-mapping-pt-4">Kotlin–JavaScript Mapping (pt. 4)</h2>
<ul>
<li>
<p>practical consequence: no way to distinguish numbers by type</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">x</span>: Int = <span style="color:#00d;font-weight:bold">23</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">y</span>: Any = x
</span></span><span style="display:flex;"><span>println(y <span style="color:#080;font-weight:bold">as</span> Float) <span style="color:#888">// fails on JVM, works on JS
</span></span></span></code></pre></div></li>
<li>
<p>Kotlin’s <code>dynamic</code> overrides the type system, and it is translated “1-to-1”</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">string1</span>: String = <span style="color:#d20;background-color:#fff0f0">"some string"</span>
</span></span><span style="display:flex;"><span>string1.missingMethod() <span style="color:#888">// compilation error
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">string2</span>: <span style="color:#080;font-weight:bold">dynamic</span> = <span style="color:#d20;background-color:#fff0f0">"some string"</span>
</span></span><span style="display:flex;"><span>string2.missingMethod() <span style="color:#888">// compilation ok, runtime error
</span></span></span></code></pre></div><ul>
<li>Kotlin’s common std-lib is implemented in JS
<ul>
<li>cf. NPM package <a href="https://www.npmjs.com/package/kotlin"><code>kotlin</code></a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="kotlin--javascript-mapping-pt-5">Kotlin–JavaScript Mapping (pt. 5)</h2>
<ul>
<li>
<p>Companion objects are treated similarly to Kotlin/JVM</p>
</li>
<li>
<p>Extension methods are treated similarly to Kotlin/JVM</p>
</li>
<li>
<p>Variadic functions are compiled to JS functions accepting an array</p>
<ul>
<li>which are not really variadic in JS</li>
</ul>
</li>
</ul>
<div class="multiCol">
    <div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">fun</span> <span style="color:#06b;font-weight:bold">f</span>(<span style="color:#080;font-weight:bold">vararg</span> xs: String) = <span style="color:#888">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>
</span></span><span style="display:flex;"><span><span style="color:#888">// usage:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>f(<span style="color:#d20;background-color:#fff0f0">"a"</span>)
</span></span><span style="display:flex;"><span>f(<span style="color:#d20;background-color:#fff0f0">"a"</span>, <span style="color:#d20;background-color:#fff0f0">"b"</span>)
</span></span><span style="display:flex;"><span>f(<span style="color:#d20;background-color:#fff0f0">"a"</span>, <span style="color:#d20;background-color:#fff0f0">"b"</span>, <span style="color:#d20;background-color:#fff0f0">"c"</span>)
</span></span></code></pre></div>
</div>
<div class="col  ">
    <div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888">// usage:
</span></span></span><span style="display:flex;"><span><span style="color:#888"></span>f([<span style="color:#d20;background-color:#fff0f0">"a"</span>])
</span></span><span style="display:flex;"><span>f([<span style="color:#d20;background-color:#fff0f0">"a"</span>, <span style="color:#d20;background-color:#fff0f0">"b"</span>])
</span></span><span style="display:flex;"><span>f([<span style="color:#d20;background-color:#fff0f0">"a"</span>, <span style="color:#d20;background-color:#fff0f0">"b"</span>, <span style="color:#d20;background-color:#fff0f0">"c"</span>])
</span></span></code></pre></div>
</div>
</div>

</section>
</section><section>
<h2 id="multi-platform-cicd">Multi-platform CI/CD</h2>
<p>Conceptual workflow:</p>
<ol>
<li>Check style (e.g. via <a href="https://ktlint.github.io/">KtLint</a>) of all Kotlin sources</li>
<li>Automatic bug detection (e.g. via <a href="https://github.com/detekt/detekt">Detekt</a>)</li>
<li>For each operative system <code>O</code> (e.g. Win, Mac, Linux):
<ul>
<li>for each target platform <code>T</code>:
<ul>
<li>for each relevant version <code>V</code> of the platform <code>T</code> (e.g. LTS releases + latest)
<ol>
<li>ensure main code compiles (e.g. via Gradle task <code>&lt;T&gt;MainClasses</code>)</li>
<li>ensure test code compiles (e.g. via Gradle task <code>&lt;T&gt;TestClasses</code>)</li>
<li>ensure test passes (e.g. via Gradle task <code>&lt;T&gt;Test</code>)</li>
</ol>
</li>
</ul>
</li>
</ul>
</li>
<li>If need to release (e.g. commit on <code>master</code> branch)
<ul>
<li>for each target platform <code>T</code> $\cup$ <code>kotlin-multiplatform</code>:
<ol>
<li>assemble compiled code into archive</li>
<li>push archive on main repository <code>R</code> of platform <code>T</code></li>
</ol>
</li>
</ul>
</li>
</ol>
</section><section>
<h2 id="about-the-practical-cicd">About the practical CI/CD</h2>
<ul>
<li>
<p>Even more complicated, because release on Maven Central is complex</p>
</li>
<li>
<p>Setting up a CI/CD pipeline of this kind requires a lot of work</p>
<ul>
<li>and Gradle / GitHub Actions boilerplate</li>
</ul>
</li>
<li>
<p>Recommendations:</p>
<ol>
<li>Use templates, such as: <a href="https://github.com/gciatto/template-kt-mpp-project/">https://github.com/gciatto/template-kt-mpp-project/</a></li>
<li>Use Gradle plugins, such as: <a href="https://github.com/gciatto/kt-mpp">https://github.com/gciatto/kt-mpp</a></li>
<li>Use existing projects as examples, e.g. <a href="https://github.com/tuProlog/2p-kt">https://github.com/tuProlog/2p-kt</a></li>
</ol>
</li>
</ul>
</section><section>
<h2 id="repositories-by-platform-pt-1">Repositories by platform (pt. 1)</h2>
<blockquote>
<p><strong>Takeaway</strong>: each platform has some preferred main repository where users expect to find packages onto</p>
</blockquote>
<ul>
<li>
<p><code>JVM</code> $\rightarrow$ <a href="https://central.sonatype.com">Maven Central Repository</a> (MCR)</p>
<ul>
<li>other Maven repositories exist, but they are more fragile</li>
</ul>
</li>
<li>
<p>Kotlin / Multiplatform $\rightarrow$ MCR</p>
</li>
<li>
<p><code>JS</code> $\rightarrow$ <a href="https://www.npmjs.com/">NPM</a></p>
</li>
<li>
<p><code>Android</code> $\rightarrow$ <a href="https://play.google.com/store?hl=en">Google Play</a></p>
</li>
<li>
<p><code>Mac</code> / <code>iOS</code> $\rightarrow$ <a href="https://www.apple.com/ios/app-store/">App Store</a></p>
<ul>
<li>or <a href="https://brew.sh/">Homebrew</a></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="repositories-by-platform-pt-2">Repositories by platform (pt. 2)</h2>
<ul>
<li>
<p><code>Windows</code> $\rightarrow$ <a href="https://www.microsoft.com/en-us/store/apps/windows">Microsoft Store</a></p>
<ul>
<li>or <a href="https://chocolatey.org/">Chocolatey</a></li>
<li>or <a href="https://scoop.sh/">Scoop</a></li>
</ul>
</li>
<li>
<p><code>Linux</code> $\rightarrow$ depends on the distro</p>
<ul>
<li>e.g. <a href="https://archlinux.org/">Arch Linux</a> $\rightarrow$ <a href="https://aur.archlinux.org/">AUR</a></li>
<li>inter-distro: <a href="https://flatpak.org/">Flatpack</a> $\rightarrow$ <a href="https://flathub.org/home">Flathub</a></li>
</ul>
</li>
<li>
<p><code>Python</code> $\rightarrow$ <a href="https://pypi.org/">PyPI</a></p>
</li>
<li>
<p><code>.Net</code> $\rightarrow$ <a href="https://www.nuget.org/">NuGet</a></p>
</li>
</ul>
</section><section>
<h1 id="multi-platform-programming-3">Multi-platform programming</h1>
<h2 id="write-first-wrap-elsewhere">Write first, wrap elsewhere</h2>
</section><section>
<h2 id="write-first-wrap-elsewhere-the-case-of-jpypehttpsjpypereadthedocsio">Write first, wrap elsewhere: the case of <a href="https://jpype.readthedocs.io/">JPype</a></h2>
<ul>
<li>
<p>In the end of the day, the Python interpreter is C++ software</p>
</li>
<li>
<p>Most commonly, efficient Python code is written in C++ and then wrapped into Python</p>
</li>
<li>
<p>Put it simply, the JVM too is C++ software</p>
</li>
<li>
<p>Can Python code be written in Java and then wrapped into Python?</p>
</li>
<li>
<p>Apparently yes, via several ad-hoc bridging technologies:</p>
<ul>
<li><a href="https://jpype.readthedocs.io/">JPype</a> a bridge for calling JVM code from Python as a native library</li>
<li><a href="https://jython.org/">Jython</a> a JVM-based Python interpreter</li>
<li><a href="https://www.py4j.org/">Py4J</a> an RPC based bridge for calling Java from Python</li>
<li><a href="https://pyjnius.readthedocs.io/">Pyjnius</a> similar to JPype, but based on <a href="https://cython.org">Cython</a></li>
<li>and many others…</li>
</ul>
</li>
<li>
<p>Why exactly JPype?</p>
<ul>
<li>still maintained, works with vanilla CPython, good documentation, good interoperabilty with JVM types</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="jpype-overview">JPype Overview:</h2>
<ol>
<li>
<p>Ensure you have a JVM installed on your system</p>
<ul>
<li>with the <code>JAVA_HOME</code> environment variable set to the JVM installation directory</li>
</ul>
</li>
<li>
<p>Ensure your compiled Java code is available as a <code>.jar</code> file</p>
<ul>
<li>say, in <code>/path/to/my.jar</code></li>
</ul>
</li>
<li>
<p>Install the JPype package via <code>pip install JPype1</code></p>
</li>
<li>
<p>You first need JPype to start a JVM instance in your Python process</p>
<ul>
<li>tby default, JVM location is inferred from the <code>JAVA_HOME</code> environment variable</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># start the JVM</span>
</span></span><span style="display:flex;"><span>jpype.startJVM(classpath=[<span style="color:#d20;background-color:#fff0f0">"/path/to/my.jar"</span>])
</span></span></code></pre></div></li>
<li>
<p>Once the JVM is started, one can import Java classes and call their methods as if they were Python objects</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype.imports</span> <span style="color:#888"># this is necessary to import Java classes</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">java.lang</span> <span style="color:#080;font-weight:bold">import</span> System <span style="color:#888"># import the java.lang.System class</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>System.out.println(<span style="color:#d20;background-color:#fff0f0">"Hello World!"</span>)
</span></span></code></pre></div></li>
</ol>
</section><section>
<h2 id="jpypes-bridging-model-pt-1">JPype’s Bridging Model (pt. 1)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#classes-objects">official documentation</a></p>
<ul>
<li>
<p>Java <strong>classes</strong> are <strong>presented</strong> wherever possible <em>similar</em> to Python classes</p>
</li>
<li>
<p>the only major difference is that <strong>Java classes</strong> and objects are <em>closed</em> and <strong>cannot be modified</strong></p>
</li>
</ul>
<figure><img src="/12-multiplatform/jpype-types.png" alt="Java classes vs. Python classes in JPype" width="50%">
</figure>

</section><section>
<h2 id="jpypes-bridging-model-pt-2">JPype’s Bridging Model (pt. 2)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#exceptions">official documentation</a></p>
<ul>
<li>
<p>Java exceptions extend from Python exceptions</p>
</li>
<li>
<p>Java exceptions can be dealt with in the same way as Python native exceptions</p>
<ul>
<li>i.e. via <code>try</code>-<code>except</code> blocks</li>
</ul>
</li>
<li>
<p><code>JException</code> serves as the base class for all Java exceptions</p>
</li>
</ul>
<!-- ![Java exceptions vs. Python exceptions in JPype](./jpype-exceptions.png) -->
<figure><img src="/12-multiplatform/jpype-exceptions.png" alt="Java exceptions vs. Python exceptions in JPype" width="50%">
</figure>

</section><section>
<h2 id="jpypes-bridging-model-pt-3">JPype’s Bridging Model (pt. 3)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#primitives">official documentation</a></p>
<ul>
<li>
<p>most Python primitives <strong>directly map</strong> into Java primitives</p>
</li>
<li>
<p>however, Python does <em>not</em> have the <em>same</em> primitive types…</p>
</li>
<li>
<p>… hence, <strong>explicit casts</strong> may be needed in some cases</p>
</li>
<li>
<p>each primitive Java type is <strong>exposed</strong> in JPype (<code>jpype.JBoolean</code>, <code>.JByte</code>, <code>.JChar</code>, <code>.JShort</code>, <code>.JInt</code>, <code>.JLong</code>, <code>.JFloat</code>, <code>.JDouble</code>).</p>
</li>
</ul>
<figure><img src="/12-multiplatform/jpype-primitives.png" alt="Java primitives vs. Python primitives in JPype" width="50%">
</figure>

</section><section>
<h2 id="jpypes-bridging-model-pt-4">JPype’s Bridging Model (pt. 4)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#strings">official documentation</a></p>
<ul>
<li>
<p>Java strings are <strong>similar</strong> to Python strings</p>
</li>
<li>
<p>they are both <strong>immutable</strong> and produce a new string when altered</p>
</li>
<li>
<p>most operations can use Java strings <strong>in place</strong> of Python strings</p>
<ul>
<li>with minor exceptions, as Python strings are not completely <em>duck typed</em></li>
</ul>
</li>
<li>
<p>when comparing or using strings as dictionary keys, all <code>JString</code> objects should be converted to Python</p>
</li>
</ul>
<figure><img src="/12-multiplatform/jpype-strings.png" alt="Java strings vs. Python strings in JPype" width="50%">
</figure>

</section><section>
<h2 id="jpypes-bridging-model-pt-5">JPype’s Bridging Model (pt. 5)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#arrays">official documentation</a></p>
<ul>
<li>
<p>Java arrays are <strong>mapped</strong> to Python <strong>lists</strong></p>
</li>
<li>
<p>more precisely, they <strong>operate like</strong> Python <em>lists</em>, but they are <strong>fixed in size</strong></p>
</li>
<li>
<p>reading a <strong>slice</strong> from a Java array returns a <em>view</em> of the array, <strong>not a copy</strong></p>
</li>
<li>
<p>passing a <strong>slide</strong> of a Python list to Java will create a <strong>copy</strong> of the sub-list</p>
</li>
</ul>
<figure><img src="/12-multiplatform/jpype-arrays.png" alt="Java arrays vs. Python lists in JPype" width="50%">
</figure>

</section><section>
<h2 id="jpypes-bridging-model-pt-6">JPype’s Bridging Model (pt. 6)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#collections">official documentation</a></p>
<ul>
<li>
<p>Java collections are <strong>overloaded</strong> with Python <strong>syntax</strong> where possible</p>
<ul>
<li>to operate similarly to Python collections</li>
</ul>
</li>
<li>
<p>Java’s <code>Iterable</code>s are <strong>mapped</strong> to Python <em>iterables</em> by overriding the <code>__iter__</code> method</p>
</li>
<li>
<p>Java’s <code>Collection</code>s are <strong>mapped</strong> to Python containers by overriding <code>__len__</code></p>
</li>
<li>
<p>Java’s <code>Map</code>s support Python’s <strong>dictionaries</strong> syntax by overriding <code>__getitem__</code> and <code>__setitem__</code></p>
</li>
<li>
<p>Java’s <code>List</code>s support Python’s <strong>lists</strong> syntax by overriding <code>__getitem__</code> and <code>__setitem__</code></p>
</li>
</ul>
<figure><img src="/12-multiplatform/jpype-collections.png" alt="Java collections vs. Python collections in JPype" width="50%">
</figure>

</section><section>
<h2 id="jpypes-bridging-model-pt-7">JPype’s Bridging Model (pt. 7)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/quickguide.html#mplements-and-extension">official documentation</a></p>
<ul>
<li>
<p>Java <em>interfaces</em> can be <strong>implemented</strong> in Python, via JPype’s <strong>decorators</strong></p>
</li>
<li>
<p>Java’s open / abstract classes <strong>cannot be extended</strong> in Python</p>
</li>
<li>
<p>Python <strong>lambda expressions</strong> can be cast’d to Java’s <strong>functional interfaces</strong></p>
</li>
</ul>
<figure><img src="/12-multiplatform/jpype-implements.png" alt="Implementing Java interfaces in Python" width="50%">
</figure>

</section><section>
<h2 id="jpype-type-conversion-model-pt-1">JPype type conversion model (pt. 1)</h2>
<p>Overview on the <a href="https://jpype.readthedocs.io/en/latest/userguide.html#type-matching">official documentation</a></p>
<figure><img src="/12-multiplatform/jpype-conversions.png" alt="Explicit and implicit type conversions in JPype" width="70%">
</figure>

</section><section>
<h2 id="jpype-type-conversion-model-pt-2">JPype type conversion model (pt. 2)</h2>
<h3 id="legend">Legend</h3>
<ul>
<li>
<p>none, there is no way to convert</p>
</li>
<li>
<p><strong>explicit</strong> (<em>E</em>), JPype can convert the desired type, but only explicitly via casting</p>
</li>
<li>
<p><strong>implicit</strong> (<em>I</em>), JPype will convert as needed</p>
</li>
<li>
<p><strong>exact</strong> (<em>X</em>), like implicit, but takes <em>priority</em> in <strong>overload selection</strong></p>
</li>
</ul>
</section><section>
<h2 id="overload-selection">Overload selection</h2>
<ul>
<li>
<p>Consider the following example of Python code with JPype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype.imports</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">java.lang</span> <span style="color:#080;font-weight:bold">import</span> System
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>System.out.println(<span style="color:#00d;font-weight:bold">1</span>)
</span></span><span style="display:flex;"><span>System.out.println(<span style="color:#00d;font-weight:bold">2.0</span>)
</span></span><span style="display:flex;"><span>System.out.println(<span style="color:#d20;background-color:#fff0f0">'A'</span>)
</span></span></code></pre></div></li>
<li>
<p>Which overload of <code>System.out.println</code> is called among the <a href="https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/io/PrintStream.html">many admissible ones</a>?</p>
<ul>
<li>Python’s <code>1</code> is convertible to Java’s <code>int</code>, <code>long</code>, and <code>short</code>
<ul>
<li>but Java’s <code>int</code> is the <strong>exact</strong> match</li>
</ul>
</li>
<li>Python’s <code>2.0</code> is convertible to Java’s <code>float</code> and <code>double</code>
<ul>
<li>but Java’s <code>double</code> is the <strong>exact</strong> match</li>
</ul>
</li>
<li>Python’s <code>'A'</code> is convertible to Java’s <code>String</code> and <code>char</code>
<ul>
<li>but Java’s <code>String</code> is the <strong>exact</strong> match</li>
</ul>
</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="ambiguous-overload-selection">Ambiguous overload selection</h2>
<ul>
<li>
<p>Consider the following example of Python code with JPype:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>csv = jpype.JPackage(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv.Csv"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>csv.headerOf([<span style="color:#d20;background-color:#fff0f0">"filed"</span>, <span style="color:#d20;background-color:#fff0f0">"another field"</span>])
</span></span></code></pre></div></li>
<li>
<p>This would raise the following <strong>error</strong>:</p>
<pre tabindex="0"><code>TypeError: Ambiguous overloads found for io.github.gciatto.csv.Csv.headerOf(list) between:
    public static final io.github.gciatto.csv.Header io.github.gciatto.csv.Csv.headerOf(java.lang.Iterable)
    public static final io.github.gciatto.csv.Header io.github.gciatto.csv.Csv.headerOf(java.lang.String[])
</code></pre><ul>
<li>because Python’s <code>list</code> is convertible to both Java’s <code>Iterable</code> and <code>String[]</code>
<ul>
<li>but neither is the <strong>exact</strong> match</li>
</ul>
</li>
</ul>
</li>
<li>
<p>To solve this issue, one can <strong>explicitly</strong> cast the Python <code>list</code> to the desired Java type:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype.imports</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">java.lang</span> <span style="color:#080;font-weight:bold">import</span> Iterable <span style="color:#080;font-weight:bold">as</span> JIterable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>csv = jpype.JClass(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv.Csv"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>csv.headerOf(JIterable@[<span style="color:#d20;background-color:#fff0f0">"field"</span>, <span style="color:#d20;background-color:#fff0f0">"another field"</span>])
</span></span><span style="display:flex;"><span><span style="color:#888"># returns Header("field", "another field")</span>
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="customising-java-types-in-python-pt-1">Customising Java types in Python (pt. 1)</h2>
<ul>
<li>
<p>One may customise the behaviour of Java types in Python by <strong>providing custom implementations</strong> for them</p>
<ul>
<li>by means of the <code>@JImplementationFor</code> decorator</li>
</ul>
</li>
<li>
<p>In that case the special method <code>__jclass_init__</code> is called on the custom implementation, <em>just once</em>, to configure the class</p>
</li>
<li>
<p>In <em>type hierarchies</em>, implementations provided for superclasses are <strong>inherited</strong> by subclasses</p>
</li>
</ul>
</section><section>
<h2 id="customising-java-types-in-python-pt-2">Customising Java types in Python (pt. 2)</h2>
<p>Consider for instance the following customisations, allowing to use <em>Java collections</em> with <strong>Python syntax</strong></p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">typing</span> <span style="color:#080;font-weight:bold">import</span> Iterable, Sequence
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">"java.lang.Iterable"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_JIterable</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">__jclass_init__</span>(self):
</span></span><span style="display:flex;"><span>        Iterable.register(self) <span style="color:#888"># makes this class a subtype of Iterable, to speed up isinstance checks </span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __iter__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.iterator()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">"java.util.Collection"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_JCollection</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.size()      <span style="color:#888"># supports "len(coll)" syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __delitem__(self, i):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.remove(i)   <span style="color:#888"># supports "del coll[i]" syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __contains__(self, i):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.contains(i) <span style="color:#888"># supports "i in coll" syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888"># __iter__ is inherited from _JIterable</span>
</span></span><span style="display:flex;"><span>    <span style="color:#888"># because in Java: Collection extends Iterable</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">'java.util.List'</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_JList</span>(<span style="color:#038">object</span>):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">__jclass_init__</span>(self):
</span></span><span style="display:flex;"><span>        Sequence.register(self) <span style="color:#888"># makes this class a subtype of Sequence, to speed up isinstance checks</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __getitem__(self, ndx):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.get(ndx)   <span style="color:#888"># supports "list[i]" syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">append</span>(self, obj):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.add(obj)   <span style="color:#888"># supports "list.append(obj)" syntax</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#888"># __len__, __delitem__, __contains__, __iter__ are inherited from _JCollection</span>
</span></span></code></pre></div><p>this is taken directly from <a href="https://github.com/jpype-project/jpype/blob/7363ce8a357d0b64f537c31849bd4e43732d9cdf/jpype/_jcollection.py">JPype’s codebase</a></p>
</section><section>
<h2 id="making-wrapped-code-pythonic-pt-1">Making wrapped code Pythonic (pt. 1)</h2>
<ul>
<li>
<p>The code wrapped via JPype is <strong>not</strong> Pythonic by default</p>
<ul>
<li>it works in principle, but it is very <em>hard to use</em> for the average Python developer
<ul>
<li>we cannot assume the <em>average</em> Python developer is <em>familiar</em> with <em>Java</em>…</li>
<li>nor with JPype</li>
<li>and the developer should know both aspects to use the wrapped code <em>as is</em></li>
</ul>
</li>
</ul>
</li>
<li>
<p>It is important to make the wrapped code as <em>Pythonic</em> as possible</p>
<ul>
<li><strong>factory methods</strong> for building instances of types</li>
<li>simplified <strong>package structure</strong>
<ul>
<li>e.g. <code>io.github.gciatto.csv.Csv</code> $\rightarrow$ <code>jcsv.Csv</code></li>
</ul>
</li>
<li><strong>properties</strong> instead of <em>getters</em> and <em>setters</em></li>
<li><code>snake_case</code> instead of <code>camelCase</code></li>
<li><strong>magic methods</strong> implemented whenever possible
<ul>
<li>e.g. <code>__len__</code> for <code>java.util.Collection</code></li>
<li>e.g. <code>__getitem__</code> for <code>java.util.List</code></li>
</ul>
</li>
<li><strong>optional parameters</strong> in methods instead of <em>overloads</em></li>
</ul>
</li>
<li>
<p>All such refinements can be done in JPype via <strong>customisations</strong> of the Java types</p>
<ul>
<li><em>unit tests</em> should be written to ensure the customisations are <em>not broken</em> by future changes</li>
</ul>
</li>
</ul>
</section><section>
<h2 id="making-wrapped-code-pythonic-pt-2">Making wrapped code Pythonic (pt. 2)</h2>
<h3 id="workflow">Workflow</h3>
<p>For all <strong>public types</strong> in the wrapped <em>Java library</em>:</p>
<ul>
<li>decide their corresponding <strong>Python package</strong></li>
<li>provide Pythonic <strong>factory methods</strong></li>
<li><strong>customise</strong> the Python class to make it <em>Pythonic</em> (possibly exploiting <strong>type hierarchies</strong> to save time)
<ul>
<li>add <strong>properties</strong> calling <em>getters/setters</em></li>
<li><strong>override</strong> Java methods to make them <em>Pythonic</em>
<ul>
<li>e.g. use <em>magic methods</em> where possible</li>
<li>e.g. use <em>optional parameters</em> where possible, removing the need for <em>overloads</em></li>
</ul>
</li>
</ul>
</li>
<li>write <strong>unit tests</strong> for <em>Pythonic API</em></li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-1">Example: the <code>jcsv</code> package (pt. 1)</h2>
<ul>
<li>
<p>The <code>jcsv</code> package is a Pythonic wrapper for our JVM-based <code>io.github.gciatto.csv</code> library</p>
</li>
<li>
<p>Java’s type definition are brought to Python in <code>jcsv/__init__.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype.imports</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">java.lang</span> <span style="color:#080;font-weight:bold">import</span> Iterable <span style="color:#080;font-weight:bold">as</span> JIterable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>_csv = jpype.JPackage(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv"</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>Table = _csv.Table
</span></span><span style="display:flex;"><span>Row = _csv.Row
</span></span><span style="display:flex;"><span>Record = _csv.Record
</span></span><span style="display:flex;"><span>Header = _csv.Header
</span></span><span style="display:flex;"><span>Formatter = _csv.Formatter
</span></span><span style="display:flex;"><span>Parser = _csv.Parser
</span></span><span style="display:flex;"><span>Configuration = _csv.Configuration
</span></span><span style="display:flex;"><span>Csv = _csv.Csv
</span></span><span style="display:flex;"><span>CsvJvm = _csv.CsvJvm
</span></span></code></pre></div><p>making it possible to write the following code on the user side:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">jcsv</span> <span style="color:#080;font-weight:bold">import</span> Table, Record, Header
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-2">Example: the <code>jcsv</code> package (pt. 2)</h2>
<ul>
<li>
<p><strong>Parsing</strong> and <strong>formatting</strong> operations are mapped <em>straightforwardly</em> to Python functions:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/__init__.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">parse_csv_string</span>(string, separator = Csv.DEFAULT_SEPARATOR, delimiter = Csv.DEFAULT_DELIMITER, comment = Csv.DEFAULT_COMMENT):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> Csv.parseAsCSV(string, separator, delimiter, comment)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">parse_csv_file</span>(path, separator = Csv.DEFAULT_SEPARATOR, delimiter = Csv.DEFAULT_DELIMITER, comment = Csv.DEFAULT_COMMENT):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> CsvJvm.parseCsvFile(<span style="color:#038">str</span>(path), separator, delimiter, comment)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">format_as_csv</span>(rows, separator = Csv.DEFAULT_SEPARATOR, delimiter = Csv.DEFAULT_DELIMITER, comment = Csv.DEFAULT_COMMENT):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> Csv.formatAsCSV(JIterable<span style="color:#555">@rows</span>, separator, delimiter, comment)
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-3">Example: the <code>jcsv</code> package (pt. 3)</h2>
<ul>
<li>
<p>Ad-hoc <em>factory method</em> is provided for building <code>Header</code> instances:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/__init__.py</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">jcsv.python</span> <span style="color:#080;font-weight:bold">import</span> iterable_or_varargs
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">header</span>(*args):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">len</span>(args) == <span style="color:#00d;font-weight:bold">1</span> <span style="color:#080">and</span> <span style="color:#038">isinstance</span>(args[<span style="color:#00d;font-weight:bold">0</span>], <span style="color:#038">int</span>):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> Csv.anonymousHeader(args[<span style="color:#00d;font-weight:bold">0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> iterable_or_varargs(args, <span style="color:#080;font-weight:bold">lambda</span> xs: Csv.headerOf(JIterable<span style="color:#555">@map</span>(<span style="color:#038">str</span>, xs)))
</span></span></code></pre></div><p>making it possible to write the following code on the user side:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jcsv</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>header1 = jcsv.header(<span style="color:#d20;background-color:#fff0f0">"column1"</span>, <span style="color:#d20;background-color:#fff0f0">"column2"</span>, <span style="color:#d20;background-color:#fff0f0">"column3"</span>) 
</span></span><span style="display:flex;"><span>header2 = jcsv.header(<span style="color:#00d;font-weight:bold">3</span>) <span style="color:#888"># anonymous header with 3 columns</span>
</span></span><span style="display:flex;"><span>columns = (<span style="color:#d20;background-color:#fff0f0">f</span><span style="color:#d20;background-color:#fff0f0">"column</span><span style="color:#33b;background-color:#fff0f0">{</span>i<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">"</span> <span style="color:#080;font-weight:bold">for</span> i <span style="color:#080">in</span> <span style="color:#038">range</span>(<span style="color:#00d;font-weight:bold">1</span>, <span style="color:#00d;font-weight:bold">4</span>)) <span style="color:#888"># generator expression</span>
</span></span><span style="display:flex;"><span>header3 = jcsv.header(columns) <span style="color:#888"># same as header1, but passing an interable</span>
</span></span></code></pre></div></li>
<li>
<p>Function <code>iterable_or_varargs</code> aims at <em>simulating</em> <strong>multiple overloads</strong>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/python.py</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">typing</span> <span style="color:#080;font-weight:bold">import</span> Iterable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">iterable_or_varargs</span>(args, f):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">assert</span> <span style="color:#038">isinstance</span>(args, Iterable)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">len</span>(args) == <span style="color:#00d;font-weight:bold">1</span>:
</span></span><span style="display:flex;"><span>        item = args[<span style="color:#00d;font-weight:bold">0</span>]
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">isinstance</span>(item, Iterable):
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">return</span> f(item)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">return</span> f([item])
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> f(args)
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-4">Example: the <code>jcsv</code> package (pt. 4)</h2>
<ul>
<li>
<p>Ad-hoc <em>factory method</em> is provided for building <code>Record</code> instances:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/__init__.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">record</span>(header, *args):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> iterable_or_varargs(args, <span style="color:#080;font-weight:bold">lambda</span> xs: Csv.recordOf(header, JIterable<span style="color:#555">@map</span>(<span style="color:#038">str</span>, xs)))
</span></span></code></pre></div></li>
<li>
<p>Ad-hoc <em>factory method</em> is provided for building <code>Table</code> instances:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/__init__.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">__ensure_header</span>(h):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> h <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">isinstance</span>(h, Header) <span style="color:#080;font-weight:bold">else</span> header(h)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">__ensure_record</span>(r, h):
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> r <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">isinstance</span>(r, Record) <span style="color:#080;font-weight:bold">else</span> record(h, r)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">table</span>(header, *args):
</span></span><span style="display:flex;"><span>    header = __ensure_header(header)
</span></span><span style="display:flex;"><span>    args = [__ensure_record(row, header) <span style="color:#080;font-weight:bold">for</span> row <span style="color:#080">in</span> args]
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> iterable_or_varargs(args, <span style="color:#080;font-weight:bold">lambda</span> xs: Csv.tableOf(header, JIterable<span style="color:#555">@xs</span>))
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-5">Example: the <code>jcsv</code> package (pt. 5)</h2>
<ul>
<li>
<p>The <code>Row</code> class is customised to make it more Pythonic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/__init__.py</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv.Row"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_Row</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.getSize()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __getitem__(self, item):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">isinstance</span>(item, <span style="color:#038">int</span>) <span style="color:#080">and</span> item &lt; <span style="color:#00d;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>            item = <span style="color:#038">len</span>(self) + item
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">return</span> self.get(item)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">except</span> _java.IndexOutOfBoundsException <span style="color:#080;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">raise</span> <span style="color:#b06;font-weight:bold">IndexError</span>(<span style="color:#d20;background-color:#fff0f0">f</span><span style="color:#d20;background-color:#fff0f0">"index </span><span style="color:#33b;background-color:#fff0f0">{</span>item<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0"> out of range"</span>) <span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">e</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">size</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> <span style="color:#038">len</span>(self)
</span></span></code></pre></div><ul>
<li>supporting the syntax <code>len(row)</code> instead of <code>row.getSize()</code></li>
<li>supporting the syntax <code>row[i]</code> instead of <code>row.get(i)</code></li>
<li>supporting the syntax <code>row[-i]</code> instead of <code>row.get(row.getSize() - i - 1)</code></li>
<li>letting <code>IndexError</code> be raised instead of <code>IndexOutOfBoundsException</code></li>
<li>supporting the syntax <code>row.size</code> instead of <code>row.getSize()</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-6">Example: the <code>jcsv</code> package (pt. 6)</h2>
<ul>
<li>
<p>The <code>Header</code> shall inherit all customisation for <code>Row</code>, plus the following ones:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv.Header"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_Header</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">columns</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> [<span style="color:#038">str</span>(c) <span style="color:#080;font-weight:bold">for</span> c <span style="color:#080">in</span> self.getColumns()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __contains__(self, item):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.contains(item)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">index_of</span>(self, column):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.indexOf(column)
</span></span></code></pre></div><ul>
<li>supporting the syntax <code>header.columns</code> instead of <code>header.getColumns()</code></li>
<li>supporting the syntax <code>column in header</code> instead of <code>header.contains(column)</code></li>
<li>supporting the syntax <code>header.index_of(column)</code> instead of <code>header.indexOf(column)</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-7">Example: the <code>jcsv</code> package (pt. 7)</h2>
<ul>
<li>
<p>The <code>Record</code> shall inherit all customisation for <code>Row</code>, plus the following ones:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv.Record"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_Record</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">header</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.getHeader()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">values</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> [<span style="color:#038">str</span>(v) <span style="color:#080;font-weight:bold">for</span> v <span style="color:#080">in</span> self.getValues()]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __contains__(self, item):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.contains(item)
</span></span></code></pre></div><ul>
<li>supporting the syntax <code>record.header</code> instead of <code>record.getHeader()</code></li>
<li>supporting the syntax <code>record.values</code> instead of <code>record.getValues()</code></li>
<li>supporting the syntax <code>value in record</code> instead of <code>record.contains(value)</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="example-the-jcsv-package-pt-8">Example: the <code>jcsv</code> package (pt. 8)</h2>
<ul>
<li>
<p>The <code>Table</code> class is customised too, to make it more Pythonic:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#555">@jpype.JImplementationFor</span>(<span style="color:#d20;background-color:#fff0f0">"io.github.gciatto.csv.Table"</span>)
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">class</span> <span style="color:#b06;font-weight:bold">_Table</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">header</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.getHeader()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __len__(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.getSize()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> __getitem__(self, item):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">if</span> <span style="color:#038">isinstance</span>(item, <span style="color:#038">int</span>) <span style="color:#080">and</span> item &lt; <span style="color:#00d;font-weight:bold">0</span>:
</span></span><span style="display:flex;"><span>            item = <span style="color:#038">len</span>(self) + item
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">try</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">return</span> self.get(item)
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">except</span> _java.IndexOutOfBoundsException <span style="color:#080;font-weight:bold">as</span> e:
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">raise</span> <span style="color:#b06;font-weight:bold">IndexError</span>(<span style="color:#d20;background-color:#fff0f0">f</span><span style="color:#d20;background-color:#fff0f0">"index </span><span style="color:#33b;background-color:#fff0f0">{</span>item<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0"> out of range"</span>) <span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">e</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">records</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> self.getRecords()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#555">@property</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">size</span>(self):
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> <span style="color:#038">len</span>(self)
</span></span></code></pre></div><ul>
<li>supporting the syntax <code>table.header</code> instead of <code>table.getHeader()</code></li>
<li>supporting the syntax <code>len(table)</code> instead of <code>table.getSize()</code></li>
<li>supporting the syntax <code>table[i]</code> instead of <code>table.get(i)</code></li>
<li>supporting the syntax <code>table[-i]</code> instead of <code>table.get(table.getSize() - i - 1)</code></li>
<li>supporting the syntax <code>record in table</code> instead of <code>table.contains(record)</code></li>
<li>supporting the syntax <code>table.records</code> instead of <code>table.getRecords()</code></li>
</ul>
</li>
</ul>
</section><section>
<h2 id="including-jars-in-jpype-projects-pt-1">Including <code>.jar</code>s in JPype projects (pt. 1)</h2>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>csv-python/
</span></span><span style="display:flex;"><span>├── build.gradle.kts            <span style="color:#888"># this is where the generation of csv.jar is automated</span>
</span></span><span style="display:flex;"><span>├── jcsv
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; ├── __init__.py
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; ├── jvm
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; │&nbsp;&nbsp; ├── __init__.py         <span style="color:#888"># this is where JPype is loaded</span>
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; │&nbsp;&nbsp; └── csv.jar             <span style="color:#888"># this the Fat-JAR of the JVM-based library</span>
</span></span><span style="display:flex;"><span>│&nbsp;&nbsp; └── python.py
</span></span><span style="display:flex;"><span>├── requirements.txt
</span></span><span style="display:flex;"><span>└── <span style="color:#038">test</span>
</span></span><span style="display:flex;"><span> &nbsp;&nbsp; ├── __init__.py
</span></span><span style="display:flex;"><span> &nbsp;&nbsp; ├── test_parsing.py
</span></span><span style="display:flex;"><span> &nbsp;&nbsp; └── test_python_api.py
</span></span></code></pre></div><ol>
<li>
<p>We need to <strong>ensure</strong> that the <em>JVM-based library</em> is available on the system where <code>jcsv</code> is installed</p>
<ul>
<li>why not including it in the Python package?</li>
</ul>
</li>
<li>
<p>The <code>build.gradle.kts</code> file automates the generation of the <code>csv.jar</code> file</p>
<ul>
<li>it is a <em>Fat-JAR</em> containing all the dependencies of the JVM-based library</li>
<li>such JAR is placed in the <code>jcsv/jvm</code> directory</li>
<li>it is part of Python sources, so that it can be distributed with the Python library</li>
</ul>
</li>
<li>
<p>The <code>jcsv/jvm/__init__.py</code> file loads JPype and the <code>csv.jar</code> file</p>
</li>
</ol>
</section><section>
<h2 id="including-jars-in-jpype-projects-pt-2">Including <code>.jar</code>s in JPype projects (pt. 2)</h2>
<ol>
<li>
<p>Snippet from the <code>build.gradle.kts</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>tasks.create&lt;Copy&gt;(<span style="color:#d20;background-color:#fff0f0">"createCoreJar"</span>) {
</span></span><span style="display:flex;"><span>    group = <span style="color:#d20;background-color:#fff0f0">"Python"</span>
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">val</span> <span style="color:#369;font-weight:bold">shadowJar</span> <span style="color:#080;font-weight:bold">by</span> project(<span style="color:#d20;background-color:#fff0f0">":csv-core"</span>).tasks.getting(Jar::<span style="color:#080;font-weight:bold">class</span>)
</span></span><span style="display:flex;"><span>    dependsOn(shadowJar)
</span></span><span style="display:flex;"><span>    from(shadowJar.archiveFile) {
</span></span><span style="display:flex;"><span>        rename(<span style="color:#d20;background-color:#fff0f0">".*?</span><span style="color:#04d;background-color:#fff0f0">\\</span><span style="color:#d20;background-color:#fff0f0">.jar"</span>, <span style="color:#d20;background-color:#fff0f0">"csv.jar"</span>)
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    into(projectDir.resolve(<span style="color:#d20;background-color:#fff0f0">"jcsv/jvm"</span>))
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p>Content of the <code>jcsv/jvm/__init__.py</code> file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">pathlib</span> <span style="color:#080;font-weight:bold">import</span> Path
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># the directory where csv.jar is placed</span>
</span></span><span style="display:flex;"><span>CLASSPATH = Path(__file__).parent
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#888"># the list of all .jar files in CLASSPATH</span>
</span></span><span style="display:flex;"><span>JARS = [<span style="color:#038">str</span>(j.resolve()) <span style="color:#080;font-weight:bold">for</span> j <span style="color:#080">in</span> CLASSPATH.glob(<span style="color:#d20;background-color:#fff0f0">'*.jar'</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jpype.startJVM(classpath=JARS)
</span></span></code></pre></div></li>
<li>
<p>Important line in <code>jcsv/__init__.py</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jcsv.jvm</span>
</span></span></code></pre></div><p>this is forcing the startup of the JVM with the correct classpath whenever someone is using the <code>jcsv</code> module</p>
</li>
</ol>
</section><section>
<h2 id="including-jvm-in-jpype-projects">Including JVM in JPype projects</h2>
<ul>
<li>
<p>We need to <strong>ensure</strong> that some <strong>JVM is available</strong> on the system where <code>jcsv</code> is installed</p>
</li>
<li>
<p>Notice that the JVM is available as a <strong>Python dependency</strong> too:</p>
<ul>
<li><a href="https://pypi.org/project/jdk4py/">https://pypi.org/project/jdk4py/</a></li>
</ul>
</li>
<li>
<p>This means that the JVM can be <strong>automatically downloaded</strong> and <strong>installed</strong> via <code>pip</code>:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span>pip install jdk4py
</span></span></code></pre></div></li>
<li>
<p>… or added as a dependency to the <code>requirements.txt</code> file:</p>
<pre tabindex="0"><code>JPype1==1.4.1
jdk4py==17.0.7.0
</code></pre></li>
<li>
<p>so, one may simply need to configure JPype to use <em>that</em> JVM:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="nohighlight" data-noescape=""><span style="display:flex;"><span><span style="color:#888"># jcsv/jvm/__init__.py</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">import</span> <span style="color:#b06;font-weight:bold">jpype</span>, <span style="color:#b06;font-weight:bold">sys</span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">from</span> <span style="color:#b06;font-weight:bold">jdk4py</span> <span style="color:#080;font-weight:bold">import</span> JAVA_HOME
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">jvm_lib_file_names</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">if</span> sys.platform == <span style="color:#d20;background-color:#fff0f0">"win32"</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> {<span style="color:#d20;background-color:#fff0f0">"jvm.dll"</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">elif</span> sys.platform == <span style="color:#d20;background-color:#fff0f0">"darwin"</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> {<span style="color:#d20;background-color:#fff0f0">"libjli.dylib"</span>}
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">else</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">return</span> {<span style="color:#d20;background-color:#fff0f0">"libjvm.so"</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#080;font-weight:bold">def</span> <span style="color:#06b;font-weight:bold">jvmlib</span>(): 
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">for</span> name <span style="color:#080">in</span> __jvm_lib_file_names():
</span></span><span style="display:flex;"><span>        <span style="color:#080;font-weight:bold">for</span> path <span style="color:#080">in</span> JAVA_HOME.glob(<span style="color:#d20;background-color:#fff0f0">f</span><span style="color:#d20;background-color:#fff0f0">"**/</span><span style="color:#33b;background-color:#fff0f0">{</span>name<span style="color:#33b;background-color:#fff0f0">}</span><span style="color:#d20;background-color:#fff0f0">"</span>):
</span></span><span style="display:flex;"><span>            <span style="color:#080;font-weight:bold">if</span> path.exists:
</span></span><span style="display:flex;"><span>                <span style="color:#080;font-weight:bold">return</span> <span style="color:#038">str</span>(path)
</span></span><span style="display:flex;"><span>    <span style="color:#080;font-weight:bold">return</span> <span style="color:#080;font-weight:bold">None</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>jpype.startJVM(jvmpath=jvmlib())
</span></span></code></pre></div></li>
</ul>
</section><section>
<h2 id="about-unit-testing">About unit testing</h2>
<ul>
<li>
<p>Unit tests are <strong>essential</strong> to ensure the <em>correctness</em> of the Pythonic API</p>
<ul>
<li>they prevent <em>corruption</em> of the Pythonic API when the JAR is <strong>updated</strong></li>
</ul>
</li>
<li>
<p>Consider for instance tests in:</p>
<ul>
<li><code>test/test_parsing.py</code></li>
<li><code>test/test_python_api.py</code></li>
</ul>
</li>
<li>
<p>It is important to <strong>test</strong> all the <em>costumisations</em> and <em>factory methods</em></p>
<ul>
<li>because these are <strong>not covered</strong> by the unit tests of the <em>JVM-based library</em></li>
</ul>
</li>
</ul>
</section>

  


</div>
      

    </div>
<script type="text/javascript" src="/reveal-hugo/object-assign.js"></script>

<a href="/reveal-js/dist/print/" id="print-location" style="display: none;"></a>

<script type="application/json" id="reveal-hugo-site-params">{"custom_theme":"custom-theme.scss","custom_theme_compile":true,"height":"1080","history":true,"mermaid":[{"fontFamily":"Inconsolata","gitGraph":{"mainBranchName":"master","rotateCommitLabel":true},"startOnLoad":false,"theme":"default","useMaxWidth":false}],"pdfseparatefragments":false,"slide_number":true,"theme":"white","transition":"slide","transition_speed":"fast","width":"1920"}</script>
<script type="application/json" id="reveal-hugo-page-params">{"custom_theme_options":{"enablesourcemap":true,"targetpath":"css/custom-theme.css"}}</script>

<script src="/reveal-js/dist/reveal.js"></script>


  
  
  <script type="text/javascript" src="/reveal-js/plugin/markdown/markdown.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/highlight/highlight.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/zoom/zoom.js"></script>
  
  <script type="text/javascript" src="/reveal-js/plugin/notes/notes.js"></script>
  
  
  <script type="text/javascript" src="/reveal-js/plugin/notes/notes.js"></script>




<script type="text/javascript">
  
  
  function camelize(map) {
    if (map) {
      Object.keys(map).forEach(function(k) {
        newK = k.replace(/(\_\w)/g, function(m) { return m[1].toUpperCase() });
        if (newK != k) {
          map[newK] = map[k];
          delete map[k];
        }
      });
    }
    return map;
  }

  var revealHugoDefaults = { center: true, controls: true, history: true, progress: true, transition: "slide" };

  var revealHugoPlugins = {
    plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, RevealZoom ]
   };
  var revealHugoSiteParams = JSON.parse(document.getElementById('reveal-hugo-site-params').innerHTML);
  var revealHugoPageParams = JSON.parse(document.getElementById('reveal-hugo-page-params').innerHTML);
  
  var options = Object.assign({},
    camelize(revealHugoDefaults),
    camelize(revealHugoSiteParams),
    camelize(revealHugoPageParams),
    camelize(revealHugoPlugins));
  Reveal.initialize(options);
</script>







  
    
  
  

  
    
  
  

  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
  

  
    
  
  

  
  



  <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.3/dist/mermaid.min.js"></script>
  <script>
    mermaid.initialize({"fontFamily":"Inconsolata","gitGraph":{"mainBranchName":"master","rotateCommitLabel":true},"startOnLoad":false,"theme":"default","useMaxWidth":false});

    let render = (event) => {
      let mermaidElems = event.currentSlide.querySelectorAll('.mermaid');
      if (!mermaidElems.length){
          return
      }
      mermaidElems.forEach(mermaidElem => {
          let processed = mermaidElem.getAttribute('data-processed');
          if (!processed){
              
              mermaid.init(undefined, mermaidElem);
          }
      });
    };
    
    render({currentSlide: Reveal.getCurrentSlide()});

    Reveal.on('slidechanged', render);
    Reveal.on('ready', render);
  </script>



    <script>
    MathJax = {
      tex: {
        inlineMath: [['$', '$'], ['\\(', '\\)']]
      },
      svg: {
        fontCache: 'global'
      }
    };
</script>

<script type="text/javascript" id="MathJax-script" async="" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
</script>

<script>
  if (/.*?(\?|&)print-pdf/.test(window.location.toString())) {
      var ytVideos = document.getElementsByTagName("iframe")
      for (let i = 0; i < ytVideos.length; i++) {
          var videoFrame = ytVideos[i]
          var isYouTube = /^https?:\/\/(www.)youtube\.com\/.*/.test(videoFrame.src)
          if (isYouTube) {
              var div = videoFrame.parentElement
              var parent = div.parentElement
              videoFrame.remove()
              div.remove()
              var p = document.createElement('p')
              p.append(
                  document.createTextNode(
                      "There was an embedded video here, but it is disabled in the printed version of the slides."
                  )
              )
              p.append(document.createElement('br'))
              p.append(document.createTextNode("Visit instead:"))
              p.append(document.createElement('br'))
              const anchor1 = document.createElement('a');
              anchor1.href = videoFrame.src;
              anchor1.textContent = videoFrame.src;
              p.append(anchor1);
              p.append(document.createElement('br'))
              const altSrc = videoFrame.src.replace(
                  /(^https?:\/\/(www.)youtube\.com)\/(embed\/)(\w+).*/,
                  "https://www.youtube.com/watch?v=$4"
              );
              const anchor2 = document.createElement('a');
              anchor2.href = altSrc;
              anchor2.textContent = altSrc;
              p.append(document.createTextNode("or:"))
              p.append(document.createElement('br'))
              p.append(anchor2);
              p.append(document.createElement('br'))
              p.append(document.createTextNode("to watch the content."))
              parent.appendChild(p)
          }
      }
  }
</script>

    
  

</body></html>